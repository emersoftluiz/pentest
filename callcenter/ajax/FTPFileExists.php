<?
session_start();
session_register("session");

try {
  if ($_SERVER['REQUEST_METHOD'] != "POST") {
    throw new Exception('Acesso Negado');
  }

  if (!$session) {
    throw new Exception('Sesso Inexistente, efetue login novamente para continuar.');
  }

  $_POST = array_map('utf8_decode', $_POST);

  if (empty($_POST['servidor']) === true) {
    throw new Exception('Servidor no informado.');
  }

  if (empty($_POST['arquivo']) === true) {
    throw new Exception('Arquivo no informado.');
  }

  require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/func/Gravacao.php");


  $arr = array_merge(getArrPrefNomeGravacao_Uranet(), getArrPrefNomeGravacao_0900(), getArrPrefNomeGravacao_EmpVoIP(), getArrPrefNomeGravacao_Externo());
  $listaMP3 = implode("|", $arr);

  if ((preg_match("/^(".$listaMP3.")/i", $_POST["arquivo"]) && (strtoupper(substr($_POST['arquivo'], -4)) == '.MP3')) || ((strtoupper(substr($_POST['arquivo'], 0, 6)) == 'RECFAX') && (strtoupper(substr($_POST['arquivo'], -4)) == '.TIF')) || (strtoupper(substr($_POST['servidor'], 0, 4)) == 'FIXO') || (strtoupper($_POST['servidor']) == 'BLOQUEIO') || (strtoupper($_POST['servidor']) == 'METLIFE')) {
    //OBTER DATA DO ARQUIVO NO FORMATO TIMESTAMP
    if ((strtoupper(substr($_POST['servidor'], 0, 4)) == 'FIXO') || (strtoupper($_POST['servidor']) == 'BLOQUEIO')) {
      $tmsp_arquivo = time();
    } else {
      $arr_info = getInfoGravacao(substr($_POST['arquivo'], 0, -4));
      if (is_array($arr_info) === false) {
        throw new Exception($arr_info);
      }

      $tmsp_arquivo = mktime(intval($arr_info['hora'], 10), intval($arr_info['minuto'], 10), intval($arr_info['segundos'], 10), intval($arr_info['mes'], 10), intval($arr_info['dia'], 10), intval($arr_info['ano'], 10));
    }

    $tmp_arr = explode('', $_POST['servidor']);
    $tipo = $tmp_arr[0];
    $num = '';

    if (strtoupper($_POST['servidor']) == 'BLOQUEIO') {
      $tipo = 'fixo_bloqueio';
    }

    require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/func/ValidaVersao.php");
    if (!verificaValidaVersao('S3AMAZON')) {
    if (strtoupper($_POST['servidor']) == 'METLIFE') {
      if (preg_match("/^([A-Z]{6}_)/", $_POST['arquivo']) == 1) {
        $ano_mes = substr($_POST['arquivo'], 0, 6);
        $_POST['arquivo'] = substr($_POST['arquivo'], 7);

      } else {
        $ano_mes = '000000';
      }

      $q = "SELECT num, maquina AS name, ip AS host, porta AS port, usuario AS user, senha AS pass, timeout AS tout, CONCAT(raiz, pasta, dir_mp3) AS path FROM tb_nas_indice WHERE ambiente = '{$_SESSION['ambiente']}' AND anomes = '{$ano_mes}' AND ".((empty($num) === true) ? "status = 'A'" : "num = '".$num."'");
    } else {
      $q = "SELECT num, maquina AS name, ip AS host, porta AS port, usuario AS user, senha AS pass, timeout AS tout, CONCAT(raiz, ".((substr($tipo, 0, 4) == "fixo") ? "" : "pasta, ")."dir_".$tipo.") AS path FROM tb_nas_indice WHERE ambiente = '".$_SESSION["ambiente"]."' AND anomes = '".(($_SESSION["ambiente"] == "uracenter") ? ((intval(date("Ym", $tmsp_arquivo), 10) > 201108) ? date("Ym", $tmsp_arquivo) : "999999") : "999999")."' AND ".((empty($num) === true) ? "status = 'A'" : "num = '".$num."'");
    }
    unset($tmp_arr);
    unset($tipo);
    unset($num);

    require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/bd/ConexaoCallCenter.php");

    $conn = new ConexaoCallCenter();
    $conn->query($q);

    if (($conn->status === true) && ($conn->count > 0)) {
      $param_ftp = $conn->result;
    } else {
      throw new Exception("Servidor no disponvel [{$_POST['servidor']}].");
    }
    } else {
    if (strtoupper($_POST['servidor']) == 'METLIFE') {
      $tipo = 'mp3';

      if (preg_match("/^([A-Z]{6}_)/", $_POST['arquivo']) == 1) {
        $ano_mes = substr($_POST['arquivo'], 0, 6);

        $_POST['arquivo'] = substr($_POST['arquivo'], 7);
      } else {
        $ano_mes = '000000';
      }
    } else {
      $ano_mes = date("Ym", $tmsp_arquivo);
    }

    $param_ftp = getInfoNASConnect("{$tipo}{$num}", $ano_mes);

    if (is_array($param_ftp) === false) {
      throw new Exception("Servidor no disponvel [{$_POST['servidor']}].");
    }

    if ((isset($tmp_arr[2]) === true) && ($tmp_arr[0] == $tmp_arr[2])) {
      $param_ftp['armazenamento'] = '';
    }

    unset($tmp_arr);
    unset($tipo);
    unset($num);
    }

    if ((strtoupper(substr($_POST['servidor'], 0, 4)) == 'FIXO') || (strtoupper($_POST['servidor']) == 'BLOQUEIO')) {
      $_POST['diretorio'] = $param_ftp['path'].$_POST['diretorio'];
    } else if (strtoupper($_POST['servidor']) == 'METLIFE') {
      $_POST['diretorio'] = $param_ftp['path'];
    } else {
      $_POST['diretorio'] = $param_ftp['path'].$arr_info['grupo'].date("/y/m/d/", $tmsp_arquivo);
    }
  } else {
    $conn = new ConexaoCallCenter();
    $conn->query("SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = 'ADREC' AND representante = 'URANET' AND tipo_reg = 'I' AND vlr_classe = '{$_POST['servidor']}'");

    if (($conn->status === true) && ($conn->count > 0)) {
      $tmp_arr = explode('', $conn->result['desc_classe']);

      $param_ftp['name'] = $conn->result['vlr_classe'];
      $param_ftp['host'] = $tmp_arr[0];
      $param_ftp['port'] = intval($tmp_arr[1]);
      $param_ftp['user'] = $tmp_arr[2];
      $param_ftp['pass'] = $tmp_arr[3];
      $param_ftp['tout'] = intval($tmp_arr[4]);
      $param_ftp['path'] = $tmp_arr[5];
    } else {
      throw new Exception("Servidor no disponvel [{$_POST['servidor']}].");
    }
  }

  if (($param_ftp['armazenamento'] == 'S3') && ((strtoupper(substr($_POST['servidor'], 0, 4)) != 'FIXO') && (strtoupper($_POST['servidor']) != 'BLOQUEIO'))) {
    $_POST['diretorio'] = substr($_POST['diretorio'], 1);

    require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/tecnologia/web/libmp3amazon.php");

    if (!S3FileExists($_POST['diretorio'].((strtoupper($_POST['servidor']) == 'METLIFE') ? utf8_encode($_POST['arquivo']) : $_POST['arquivo']))) {
      throw new Exception("Arquivo No existe.  [{$param_ftp['armazenamento']} - {$_POST['diretorio']}".((strtoupper($_POST['servidor']) == 'METLIFE') ? utf8_encode($_POST['arquivo']) : $_POST['arquivo'])."].");
    }
  } else {
    require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/ctr/Valida.php");

    if (Valida::Ip($param_ftp['host']) === false) {
      throw new Exception("Host Invlido [{$param_ftp['host']}], no foi possvel conectar.");
    }

    if ($param_ftp['port'] == 0) {
      $param_ftp['port'] = 21;
    }

    if (($param_ftp['user'] === '') || ($param_ftp['pass'] === '')) {
      throw new Exception('Usurio ou Senha em branco.');
    }

    if ($param_ftp['tout'] == 0) {
      $param_ftp['tout'] = 5;
    }

    $conn_id = @ftp_connect($param_ftp['host'], $param_ftp['port'], $param_ftp['tout']);

    if (is_resource($conn_id) === false) {
      throw new Exception('No foi possvel Conectar.');
    }

    if (@ftp_login($conn_id, $param_ftp['user'], $param_ftp['pass']) === false) {
      @ftp_close($conn_id);

      throw new Exception("Conexo recusada para o usurio informado [{$param_ftp['user']}].");
    }

    if (@ftp_pasv($conn_id, true) === false) {
      @ftp_close($conn_id);

      throw new Exception('No foi possvel alterar para Modo Passivo.');
    }

    if (empty($_POST['diretorio']) === false) {
      if (@ftp_chdir($conn_id, $_POST['diretorio']) === false) {
        @ftp_close($conn_id);

        throw new Exception("No foi possvel mudar de pasta (Sem permisso / Pasta no existe) [{$_POST['diretorio']}].");
      }
    }

    if (ftp_size($conn_id, ((strtoupper($_POST['servidor']) == 'METLIFE') ? utf8_encode($_POST["arquivo"]) : $_POST["arquivo"])) == -1) {
      $tmp = tmpfile();
      fseek($tmp, 0);
      if (strtoupper($_POST['servidor']) == 'METLIFE') {
        $ret = @ftp_nb_fget($conn_id, $tmp, utf8_encode($_POST["arquivo"]), FTP_BINARY);
      } else {
        $ret = @ftp_nb_fget($conn_id, $tmp, $_POST["arquivo"], FTP_BINARY);
      }

      if ($ret == FTP_FAILED) {
        @ftp_close($conn_id);

        throw new Exception("Arquivo No existe. [{$_POST['diretorio']}{$_POST['arquivo']}].");
      }
    }

    @fclose($tmp);
    @ftp_close($conn_id);
  }

  print "OK";
} catch (Exception $e) {
  print "NO|{$e->getMessage()}";
}
?>