<?
session_start();
session_register("session");
include "cc_libcallcenter.php";
if (!isset($session)) {header ("Location:".HTTPHOST.DOCROOT."cc_login.php"); exit;}

//if ($session["operador"] == "conarec" || $deondePainel == "S" || $session["operador"] == "re005215") {
  // showvars();
  // exit();
  require_once('im_mail_view_v2.php');
   exit();
// }

require_once($_SERVER["DOCUMENT_ROOT"]."/libs/lang/tradutor.php");

$objTradutor = new Tradutor($session["idioma"], "ia_mail");

if ($_SERVER['REQUEST_METHOD'] == "GET") {
  $len = strlen($grv);

  if (((substr($grv, 0, 7) == "RecMail") && (($len == 41) || ($len == 58))) || ((substr($grv, 0, 6) == "RecFax") && ($len == 40))) {
    $msg = "POST";
  } else {
    $msg = "01";
  }
} else {
  require_once($_SERVER['DOCUMENT_ROOT']."/libs/ctr/RichText.php");

  /**
   * Retorna o Tamanho do Arquivo
   * (B - Bytes / KB - KiloBytes / MB - MegaBytes / GB - GigaBytes / TB - TeraBytes)
   *
   * @param integer $tam_bytes
   * @return string
   * @author Eduardo Pereira
   * @since 06/10/2008
   */
  function getDescTamanho($tam_bytes) {
    if ($tam_bytes > 1024) {
      return  number_format($tam_bytes / 1024, 1, ",", "")." KB";
    } else if ($tam_bytes > 1048576) {
      return number_format($tam_bytes / 1048576, 1, ",", "")." MB";
    } else if ($tam_bytes > 1073741824) {
      return number_format($tam_bytes / 1073741824, 1, ",", "")." GB";
    } else if ($tam_bytes > 1099511627776) {
      return number_format($tam_bytes / 1099511627776, 1, ",", "")." TB";
    }
    return $tam_bytes." B";
  }
  //LISTA DE EXTENSÕES QUE PODEM SER VISUALIZADAS ATRAVÉS DO CID
  $arr_ext_img = array(
  'jpg', 'jpeg', 'gif', 'bmp'
  );
  if (($_POST["tipo_mail"] == "ENV") || ($_POST["tipo_mail"] == "FAX")) {

    require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/ConexaoSistema.php");
    require_once($_SERVER['DOCUMENT_ROOT']."/callcenter/funcoes/iaEFView.php");

    $ano_ini = "20".substr($_POST["nome_arquivo"], 11, 2);
    $mes_ini = substr($_POST["nome_arquivo"], 13, 2);

    //Se a consulta for mais antiga que a última data de movimentação da EFPAR (URANET), busca os registros na tabela anual daquele ano desejado
    if ( $ano_ini.$mes_ini <= intval($ultimo_anomes_movido) ) {
      $tabela_email_fax = "tb_email_fax_".$ano_ini;
    } else {
      $tabela_email_fax = "tb_email_fax";
    }
    $conSis = new ConexaoSistema();
    $conSis->query("SELECT ano_mes, num, representante, grupo, data_ligacao, hora_ligacao_fim, origem_nome, email_origem, email_destino, destino_nome, email_cc, email_cc_nome, email_cco, email_cco_nome, assunto, email_qtd_anexo, tipo_arquivo, data_cri, hora_cri, status_envio, data_agenda, hora_agenda, data_prox_tentativa, data_envio, hora_envio, body_arq_tb, body, status_gravacao, midia_id, nome_anexo FROM ".$tabela_email_fax." WHERE arquivo_body = '".$_POST["nome_arquivo"]."'");
    if ($conSis->status === true) {
      if ($conSis->count > 0) {
        $ano_mes = $conSis->result["ano_mes"];
        $num = $conSis->result["num"];
        $repre = $conSis->result["representante"];
        $grupo = $conSis->result["grupo"];
        $data = $conSis->result["data_ligacao"];
        $hora = $conSis->result["hora_ligacao_fim"];
        $origem_nome = $conSis->result["origem_nome"];
        $origem = $conSis->result["email_origem"];
        $para_nome = $conSis->result["destino_nome"];
        $para = $conSis->result["email_destino"];
        $cc_nome = $conSis->result["email_cc_nome"];
        $cc = $conSis->result["email_cc"];
        $cco_nome = $conSis->result["email_cco_nome"];
        $cco = $conSis->result["email_cco"];
        $assunto = $conSis->result["assunto"];
        $qtd_anexo = intval($conSis->result["email_qtd_anexo"]);
        $tipo_arquivo = $conSis->result["tipo_arquivo"];
        $data_cri = $conSis->result["data_cri"];
        $hora_cri = $conSis->result["hora_cri"];
        $status_envio = $conSis->result["status_envio"];
        if ($status_envio == "T") {
          $data_ocorrencia = $conSis->result["data_envio"];
          $hora_ocorrencia = $conSis->result["hora_envio"];
        } else {
          $arr_data = explode(" ", $conSis->result["data_prox_tentativa"]);
          $data_ocorrencia = $arr_data[0];
          $hora_ocorrencia = $arr_data[1];
          unset($arr_data);
        }
        $tipo_doc = $conSis->result["body_arq_tb"];
        if ($tipo_arquivo != "T") {//H - K - M - N - Q
          $tipo_conteudo = "text/html";
        } else {//T
          $tipo_conteudo = "text/plain";
        }
        $body = $conSis->result["body"];
        $status_gravacao = $conSis->result["status_gravacao"];
        $midia_id = $conSis->result["midia_id"];
        $nome_anexo = $conSis->result["nome_anexo"];
        if (($tipo_arquivo == "N") && (empty($nome_anexo) === true)) {
          $nome_anexo = "Fax£".$_POST["nome_arquivo"]."|tif";
        }

        if (($tipo_arquivo != "K") && ($tipo_arquivo != "M")) {
          if (empty($body) === false) {
            $msg = "OK";
          } else {
            $msg = "07";//MENSAGEM EM BRANCO
          }
        } else {
          if ($tipo_doc == "T") {
            $conSis->query("SELECT body FROM tb_email_body WHERE ano_mes = '".$ano_mes."' AND num = '".$num."'");
            if (($conSis->status === true) && ($conSis->count === 1)) {
              $msg = "OK";
            } else {
              $msg = "07";//MENSAGEM EM BRANCO
            }
          } else {
            $msg = "07";//MENSAGEM EM BRANCO
          }
        }

        if ($msg == "OK") {
          if ($status_envio != "E") {
            if ($status_gravacao == "M") {
              $msg = "05";//MIDIA
            }
          } else {
            $msg = "04";//ERRO DE ENVIO
          }
        }
      } else {
        $msg = "03";//BD
      }
    } else {
      $msg = "02";//QUERY
    }
  } else if ($_POST["tipo_mail"] == "REC") {
    require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/ConexaoEmail.php");

    $ano_mes = substr($_POST["nome_arquivo"], 11, 4);

    $conEmail = new ConexaoEmail();
    $conEmail->query("SELECT num, representante, grupo, data_ligacao, hora_ligacao_fim, email_origem, origem_nome, email_destino, destino_nome, email_cc, email_cc_nome, email_cco, email_cco_nome, assunto, email_qtd_anexo, nome_anexo, status, data_cri, hora_cri, data_atualiza, hora_atualiza, status_gravacao, midia_id FROM tb_email_rec_".$ano_mes." WHERE nome_gravacao = '".$_POST["nome_arquivo"]."'");
    if ($conEmail->status === true) {
      if ($conEmail->count > 0) {
        $num = $conEmail->result["num"];
        $repre = $conEmail->result["representante"];
        $grupo = $conEmail->result["grupo"];
        $data = $conEmail->result["data_ligacao"];
        $hora = $conEmail->result["hora_ligacao_fim"];
        $origem = $conEmail->result["email_origem"];
        $origem_nome = $conEmail->result["origem_nome"];
        $para = $conEmail->result["email_destino"];
        $para_nome = $conEmail->result["destino_nome"];
        $cc = $conEmail->result["email_cc"];
        $cc_nome = $conEmail->result["email_cc_nome"];
        $cco = $conEmail->result["email_cco"];
        $cco_nome = $conEmail->result["email_cco_nome"];
        $assunto = $conEmail->result["assunto"];
        $qtd_anexo = intval($conEmail->result["email_qtd_anexo"]);
        $nome_anexo = $conEmail->result["nome_anexo"];
        $status_envio = $conEmail->result["status"];
        $data_cri = $conEmail->result["data_cri"];
        $hora_cri = $conEmail->result["hora_cri"];
        $status_gravacao = $conEmail->result["status_gravacao"];
        $midia_id = $conEmail->result["midia_id"];
        if ($status_envio == "N") {
          $data_ocorrencia = $conEmail->result["data_ligacao"];
          $hora_ocorrencia = $conEmail->result["hora_ligacao_fim"];
        } else {
          $data_ocorrencia = $conEmail->result["data_atualiza"];
          $hora_ocorrencia = $conEmail->result["hora_atualiza"];
        }
        $conEmail->query("SELECT tipo, dados FROM tb_email_rec_anexo_".$ano_mes." WHERE num = '".$num."' AND nome = '' AND extensao = '' AND tamanho > 0 AND content_id = ''");
        if ($conEmail->status === true) {
          if ($conEmail->count > 0) {
            //CORPO DO E-MAIL - PODE TER MAIS QUE 1 (TEXT/PLAIN OU TEXT/HTML)
            //PREFERENCIALMENTE SERÁ EXIBIDO HTML
            do {
              if ($tipo_conteudo != "text/html") {
                $body = $conEmail->result["dados"];
                $tipo_conteudo = $conEmail->result["tipo"];
              }
            } while ($conEmail->getFetchAssoc());

            //CRIA LISTA DE ANEXOS QUE FAZEM PARTE DO CORPO DO E-MAIL (POSSUEM CONTENT-ID)
            $conEmail->query("SELECT seq, nome, extensao, content_id FROM tb_email_rec_anexo_".$ano_mes." WHERE num = '".$num."' AND content_id <> ''");
            if ($conEmail->status === true) {
              if ($conEmail->count > 0) {
                do {
                  $arr_cid[$conEmail->result["seq"]]["cid"] = $conEmail->result["content_id"];
                  $arr_cid[$conEmail->result["seq"]]["link"] = "/comp/download.php"."?tipo=MAIL"."&origem=REC"."&anomes=".$ano_mes."&num=".$num."&seq=".$conEmail->result["seq"]."&arquivo=".urlencode($conEmail->result["nome"].".".$conEmail->result["extensao"]);
                } while ($conEmail->getFetchAssoc());
              }
            }

            //JÁ ESTÁ GRAVANDO CORRETAMENTE
            if (substr($nome_anexo, 0, 11) != "TabMailRec*") {
              $nome_anexo = "TabMailRec*".$nome_anexo;
            }

            //Pega campo DADOS para fazer verificação do CID
            $conEmail->query("SELECT dados FROM tb_email_rec_anexo_".$ano_mes." WHERE num = '".$num."' AND nome = '' AND extensao = '' AND tamanho > 0 AND content_id = '' AND tipo = 'text/html'");
            if ($conEmail->status === true) {
              if ($conEmail->count > 0) {
                if ($conEmail->result["dados"] != "") {
                  //dados AND dados LIKE '%cid:".$arr_cid[$doc[3]]["cid"]."%';
                  $dados_email_rec_anexo = $conEmail->result["dados"];
                }
              }
            }

            //RETIRA DA LISTA DE ANEXOS OS ANEXOS QUE FAZEM PARTE DO CORPO DO E-MAIL

            $arr_tmp = explode("?", $nome_anexo);

            foreach ($arr_tmp as $i => $str_anexo) {
              $arr_anexo = explode("*", $str_anexo);

               $arr_tmp2[$arr_anexo[0]] = explode(":", $arr_anexo[1]);
              foreach ($arr_tmp2[$arr_anexo[0]] as $i => $doc) {
                $doc = explode("|", $doc);

                if ($doc[0] != "") {

                  if ($arr_anexo[0] == "TabMailRec") {
                    if (is_array($arr_cid) === true) {
                      if ((array_key_exists($doc[3], $arr_cid) === true) && (in_array(strtolower($doc[1]), $arr_ext_img) === true)) {
                        if (strpos($dados_email_rec_anexo, "cid:".$arr_cid[$doc[3]]["cid"]) > 0) {
                         $qtd_anexo--;
                        } else {
                          $arr_doc[$arr_anexo[0]][$doc[3]] = $doc;
                        }
                      } else {
                        $arr_doc[$arr_anexo[0]][$doc[3]] = $doc;
                      }
                    } else {
                      $arr_doc[$arr_anexo[0]][$doc[3]] = $doc;
                    }
                  } else {
                    $arr_doc[$arr_anexo[0]][$doc[3]] = $doc;
                  }
                } else {
                  $qtd_anexo--;
                }
              }
            }

            unset($arr_tmp);
            unset($str_anexo);
            unset($arr_tmp2);
            unset($doc);
            unset($i);

            //MONTA A STRING NOME ANEXO NOVAMENTE
            if ((is_array($arr_doc) === true) && (count((array)$arr_doc) > 0)) {
              $nome_anexo = "";
              foreach ($arr_doc as $str_tmp => &$arr_tmp) {
                if ((is_array($arr_tmp) === true) && (count((array)$arr_tmp) > 0)) {
                  foreach ($arr_tmp as $i => &$arr_tmp2) {
                    $arr_tmp2 = implode("|", $arr_tmp2);
                  }
                  $arr_tmp = implode(":", $arr_tmp);
                }
                $nome_anexo .= $str_tmp."*".$arr_tmp."?";
              }
              $nome_anexo = substr($nome_anexo, 0, -1);
            }

            unset($arr_doc);
            unset($i);
            unset($arr_tmp2);
            unset($str_tmp);
            unset($arr_tmp);
          } else {
            $msg = "03";//BD
          }
        } else {
          $msg = "02";//QUERY
        }
        $msg = "OK";
      } else {
        $msg = "03";//BD
      }
    } else {
      $msg = "02";//QUERY
    }
  } else {
    $msg = "10";//TIPO DE E-MAIL INVÁLIDO
  }
}
?>
<html>
<head>
<title><?print $objTradutor->Traduzir($session["sistema"]);?></title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="Pragma" content="no-cache">

<meta http-equiv="Expires" content="-1">

<?print $v1_style_css;?>

<script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>

<?
if ($msg != "POST") {
?>
<script type="text/javascript" src="consistencia.js"></script>
<?
}
?>
<script type="text/javascript">
<?
if ((($msg == "OK") || ($msg == "04")) && (intval($qtd_anexo) > 0)) {
?>
<?
}
?>
function onLoadPag() {
<?
if ($msg == "POST") {
?>
  document.getElementById('iaMail').submit();
<?
}
?>
}
</script>
<?
if ($msg != "POST") {
?>
<link media="all" type="text/css" href="/comp/rte/rte.css" rel="stylesheet">
<style type="text/css">
td {
  font-family: Verdana, Arial, Helvetica, sans-serif;
  font-size: 10;
  font-style: normal;
  line-height: normal;
  font-variant: normal;
  text-transform: none;
  color: #000000;
  vertical-align: middle;
}
</style>
<?
}
?>
</head>
<body onload="javascript:onLoadPag();">
<?
if ($msg == "POST") {
?>
<form method="POST" id="iaMail" action="ia_mail_view.php">
  <input type="hidden" name="nome_arquivo" value="<?print $grv;?>">
  <input type="hidden" name="tipo_mail" value="<?print (($len == 41) ? "ENV" : (($len == 40) ? "FAX" : "REC"));?>">
  <input type="hidden" name="ano_ini" value="<?print $_GET["ano_ini"];?>">
</form>
<?
} else {
?>

<style>
  .download_anexo{
    cursor:pointer;
    display:inline-block;
    margin-left: 10px;
    padding: 5px;
    border: 1px solid #888;
    border-radius: 3px;
  }
  .download_anexo:hover{
    background-color: #888;
    color:#fff;
  }
  .alert-info {
    color: #31708f;
    background-color: #d9edf7;
    border-color: #bce8f1;
    cursor:pointer;
    display:inline-block;
    margin-left: 10px;
    padding: 5px;
    border: 1px solid #31708f;
    border-radius: 3px;
  }
  .alert-info:hover {
    color: #fff;
    background-color: #31708f;
  }
  .hide-print {
    display:none;
  }

</style>


<table border="0" cellpadding="0" cellspacing="0" width="95%" height="95%" align="center">
  <tr class="cabecalho-email">
    <td style="width: 10px; height: 70px; background-image: url(richtextedit/layout/ext_top_mail_left.gif);"></td>
    <td style="width: 355px; height: 70px; background-image: url(richtextedit/layout/ext_top_mail_middle.gif); background-repeat: repeat-x;"><img src="richtextedit/layout/ext_top_mail2.gif"></td>
    <td style="height: 70px; background-image: url(richtextedit/layout/ext_top_mail_middle.gif); background-repeat: repeat-x;" colspan="2"></td>
    <td style="width: 10px; height: 70px; background-image: url(richtextedit/layout/ext_top_mail_right.gif); background-position: bottom right;"></td>
  </tr>
  <tr>
    <td style="width: 10px; background-image: url(richtextedit/layout/ext_left.gif); background-repeat: repeat-y;"></td>
    <td style="background-image: url(richtextedit/layout/ext_bg.gif); background-repeat: repeat;" colspan="3">
      <table border="0" cellpadding="0" cellspacing="0" width="100%" height="100%">
        <tr>
          <td colspan="5" height="10"></td>
        </tr>
<?
  if (($msg == "OK") || ($msg == "04")) {
?>
        <tr>
          <td style="width: 100px; padding: 0px 0px 0px 10px; font-weight: bold;"><?= $objTradutor->Traduzir("Servico");?></td>
          <td colspan="4"><?print $grupo." - ".$objTradutor->Traduzir(ValorClasse("GRATE", $grupo, $repre));?></td>
        </tr>
        <tr>
          <td colspan="5" height="5"></td>
        </tr>
        <tr>
          <td style="width: 100px; padding: 0px 0px 0px 10px; font-weight: bold;"><?= $objTradutor->Traduzir("Criação");?></td>
          <td colspan="4">
          <?
          print BRDate($data_cri)." <strong>às</strong> ".$hora_cri;
          $tipo_email = 'Recebido';
          if ($_POST["tipo_mail"] != "REC") {
            $tipo_email = ValorClasse("URAE3", $status_envio, $repre, true);
          }
          if ($_SESSION['session']['representante'] == 'URANET') {
          ?>
            &nbsp;&nbsp;<span style="width: 100px; padding: 0px 0px 0px 10px; font-weight: bold;"><?= $objTradutor->Traduzir($tipo_email);?></span>
          <?
            print BRDate($data_ocorrencia)." <strong>às</strong> ".$hora_ocorrencia;
            if (($_POST["tipo_mail"] == "ENV") || ($_POST["tipo_mail"] == "FAX")) {
              print iaEFViewObs($ano_mes, $num);?><?
            }
          }
        ?>
</td>
        </tr>
        <tr>
          <td colspan="5" height="5"></td>
        </tr>
        <tr>
          <td style="width: 100px; padding: 0px 0px 0px 10px; font-weight: bold;"><?= $objTradutor->Traduzir("De");?></td>
          <td colspan="4"><?
    if ($origem_nome != "") {
      print $origem_nome." &lt ".$origem." &gt";
    } else {
      print $origem;
    }
?></td>
        </tr>
        <tr>
          <td colspan="5" height="5"></td>
        </tr>
<?
    if (empty($para) === false) {
      $arr_para = explode(";", $para);
      $arr_para_nome = explode(";", $para_nome);

      if (count((array)$arr_para) == count((array)$arr_para_nome)) {
        $para = "";
        foreach ($arr_para as $i => $str_tmp) {
          $title =  (($arr_para_nome[$i]) ? $arr_para_nome[$i] : $str_tmp);
          $conteudo = (($str_tmp) ? " {$arr_para_nome[$i]} < {$str_tmp} >" : $arr_para_nome[$i]);
          $para .= "<div style='display:inline-block'><label title='{$title}'>{$conteudo}</label></div>;";
          unset($title, $conteudo);
        }
        $para = substr($para, 0, -1);
      }

      unset($arr_para);
      unset($arr_para_nome);
?>
        <tr>
          <td style="width: 100px; padding: 0px 0px 0px 10px; font-weight: bold;"><?= $objTradutor->Traduzir("Para");?></td>
          <td colspan="4"><?print $para /*str_replace(";", " ; ", );*/?></td>
        </tr>
        <tr>
          <td colspan="5" height="5"></td>
        </tr>
<?
    }

    if (empty($cc) === false) {
      $arr_cc = explode(";", $cc);
      $arr_cc_nome = explode(";", $cc_nome);
      if (count((array)$arr_cc) == count((array)$arr_cc_nome)) {
        $cc = "";
        foreach ($arr_cc as $i => $str_tmp) {
          $cc .= "<label title=\"".(($arr_cc_nome[$i]) ? $arr_cc_nome[$i] : $str_tmp)."\">".(($str_tmp) ? $str_tmp: $arr_cc_nome[$i])."</label>;";
        }
        $cc = substr($cc, 0, -1);
      }
      unset($arr_cc);
      unset($arr_cc_nome);
?>
        <tr>
          <td style="width: 100px; padding: 0px 0px 0px 10px; font-weight: bold;">Cc</td>
          <td colspan="4"><?print str_replace(";", " ; ", $cc);?></td>
        </tr>
        <tr>
          <td colspan="5" height="5"></td>
        </tr>
<?
    }

    if (empty($cco) === false && $session["representante"] == "URANET") {
?>
        <tr>
          <td style="width: 100px; padding: 0px 0px 0px 10px; font-weight: bold;">Cco</td>
          <td colspan="4"><?print str_replace(";", " ; ", $cco);?></td>
        </tr>
        <tr>
          <td colspan="5" height="5"></td>
        </tr>
<?
    }
?>
        <tr>
          <td style="width: 100px; padding: 0px 0px 0px 10px; font-weight: bold;"><?= $objTradutor->Traduzir("Assunto");?></td>
          <td colspan="4"><?print $assunto;?></td>
        </tr>
        <tr>
          <td colspan="5" height="5"></td>
        </tr>
<?
    if (intval($qtd_anexo) > 0) {
?>
        <tr title="<?= $objTradutor->Traduzir("Clique sobre o nome do arquivo para efetuar o download.");?>">
          <td style="width:100px; padding:0px 0px 0px 10px; font-weight:bold;"><?= $objTradutor->Traduzir("Anexos");?></td>
          <td colspan="4">


<?

      if ($_POST["tipo_mail"] != "REC") {
        $nome_anexo = str_replace("£", "*", $nome_anexo);
        $nome_anexo = str_replace("¢", ":", $nome_anexo);
        $nome_anexo = str_replace("§", "?", $nome_anexo);
      } else {
        if (substr($nome_anexo, 0, 11) != "TabMailRec*") {
          $nome_anexo = "TabMailRec*".$nome_anexo;
        }
      }

      $arr_doc = explode("?", $nome_anexo);
      foreach ($arr_doc as $i => $param) {
        $arr_doc1 = explode("*", $param);

        $arr_doc2[$arr_doc1[0]] = explode(":", $arr_doc1[1]);
        foreach ($arr_doc2[$arr_doc1[0]] as $i => $doc) {
          $arr_tmp_doc = explode("|", $doc);
          if ($arr_tmp_doc[0] == "") {
            continue;
          }
?>
        <div  class="download_anexo" >
        <span onclick="$(this).closest('.download_anexo').addClass('alert-info');javascript:downloadAnexo('<?
          if (strtoupper($arr_doc1[0]) == "TABELA") {
            $arr_doc1[0] = "TABMAILENV";
          }
          print strtoupper($arr_doc1[0]).":";
          if ((strtoupper($arr_doc1[0]) == "DOCMAILFIXO") || (strtoupper($arr_doc1[0]) == "FAX")) {
            print $arr_tmp_doc[0];
            if ($arr_tmp_doc[1] != "") {
              print ".".$arr_tmp_doc[1];
            }
            print ":".((strtoupper($arr_doc1[0]) == "DOCMAILFIXO") ? "fixo_mail" : "fax").":";
            if (strtoupper($arr_doc1[0]) == "DOCMAILFIXO") {
              print $grupo."/";
            } else {
              print substr($doc, 6, 4)."/".substr($doc, 10, 2)."/".substr($doc, 12, 2)."/".substr($doc, 14, 2)."/";
            }
          } elseif ((strtoupper($arr_doc1[0]) == "TABMAILENV") || (strtoupper($arr_doc1[0]) == "TABMAILREC")) {
            print substr($ano_mes, -4).":".$num.":".$arr_tmp_doc[3].":".$arr_tmp_doc[0];
            if ($arr_tmp_doc[1] != "") {
              print ".".$arr_tmp_doc[1];
            }
          }
?>');">

  <?print $arr_tmp_doc[0];
    if ($arr_tmp_doc[1] != "") {
      print ".".$arr_tmp_doc[1];
    }
    if ($arr_tmp_doc[2] != "") {
      print " (".getDescTamanho($arr_tmp_doc[2]).")";
    }
  ?>

</span>
</div>
<?

        }
      }
?>

          </td>
        </tr>
        <tr>
          <td colspan="5" height="5"></td>
        </tr>
<?
    }
?>
        <tr style="height:95%;">
          <td colspan="5" style="vertical-align:top; text-align:left;">
            <input type="hidden" id="resize_frame" value="0">
            <iframe name="mensagem" id="mensagem" src="ia_mail_view_body.php?tipo_mail=<?print $_POST["tipo_mail"];?>&ano_mes=<?print $ano_mes;?>&num=<?print $num;?>" frameborder="1" marginwidth="5" marginheight="5" scrolling="auto" style="width:100%; height:100%;"></iframe>
          </td>
        </tr>
<?
  } else {
?>
        <tr>
          <td colspan="5" style="text-align:left;"><?print $msg." - ".$objTradutor->Traduzir(ValorClasse("ERIVM", $msg, "URANET"));?></td>
        </tr>
<?
  }
?>
        <tr>
          <td colspan="5" height="10"></td>
        </tr>
      </table>
    </td>
    <td style="width:10px; background-image:url(richtextedit/layout/ext_right.gif); background-repeat:repeat-y;"></td>
  </tr>
  <tr>
    <td style="width:10px; height:10px; background-image:url(richtextedit/layout/ext_bottom_left.gif);"></td>
    <td style="width:10px; background-image:url(richtextedit/layout/ext_bottom_middle.gif); background-repeat:repeat-x;" colspan="3"></td>
    <td style="width:10px; height:10px; background-image:url(richtextedit/layout/ext_bottom_right.gif);"></td>
  </tr>
</table>
<?
}
if ($_SESSION['session']['tp_user'] != 'OPE') {
  // Retirando funcionalidade por que deu erro em produção
?>
<div style="text-align: center; margin-top: 10px;">
  <img align="botton" id="printer"  style="cursor: pointer; position:absolute; top: 5px; right: 20px;" src="imagens/print.gif">
</div>

<script type="text/javascript">

  $('#printer').click(function() {
    $('.cabecalho-email').addClass('hide-print');

    /** @type {resize} Aumenta o tamanho do frame conforme a necessidade. */
    var  mensagem = document.getElementById('mensagem');
    var iframe = mensagem.contentWindow.document;
    var number = iframe.documentElement.clientHeight;

    var resize = '';
    number  = parseInt(number)  + parseInt(100);
    resize = String(number) + 'px';


    $('#mensagem').css('height', resize);
    $('#printer').addClass('hide-print');
    $('.div_impressao_body').css('display', 'block');
    window.print();
    $('#mensagem').css('height', '100%');
    $('.div_impressao_body').css('display', 'none');
    $('.hide-print').removeClass('hide-print');
  });
</script>
<?
}

print GerarRodape();
?>
</body>
</html>