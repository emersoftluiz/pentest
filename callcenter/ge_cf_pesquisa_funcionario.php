<?
//sequencia dos parâmetros
//NomeTd¢AlinhamentoTd¢WidthTd¢Funcao¢CampoTabela¢Classe¢Posicao¢ExibeNaTela
session_start();
session_register("session");
include "cc_libcallcenter.php";
if (!isset($session)) {header ("Location:".HTTPHOST.DOCROOT."cc_login.php"); exit;}

function converteStringUTF8($texto, $str_expr = "") {
  $texto = trim(strval($texto));

  if (mb_detect_encoding($texto."x", "UTF-8, ISO-8859-1") == "UTF-8") {
    $texto = utf8_decode($texto);
  }

  if ($str_expr != "") {
    $texto = preg_replace("/".$str_expr."/", "", $texto);
  }

  return $texto;
}


require_once($_SERVER['DOCUMENT_ROOT']."/libs/func/AJAXFunc.php");

//DESCRIPTOGRAFA AS VARIÁVEIS GLOBAIS
arrayr_map_globals("converteStringUTF8");

//showvars();
//print "<pre>";
//print_r($_GET);
//print_r($_POST);
//print_r($_REQUEST);
//exit();
//if ($carregou_string_func == "S") {
//  exit();
//}

$podeCarregar = "N";

if ($responsavel == "GOP9" || strtoupper(substr($responsavel, 0, 3)) == "ADM") {
  $classe_repre  = "REPRS";
  $classe_equipe = "EQUIS";
} else {
  $classe_repre  = "REPRE";
  $classe_equipe = "EQUIP";
}

// if (($responsavel == "GOP4" && $centro_custo == "0.0.1.00906") || $session["representante"] == "URACENTER-SACx") {
//   $classe_repre  = "REPRS";
//   $classe_equipe = "EQUIP";
// }

if ($responsavel == "GOP6" && $equipe_movimentacao == "todos") {
  ini_set("memory_limit", "60M");
}

if (empty($combo_repre_valores) === false) {
  $combo_repre_valores = str_replace("(a)", "", $combo_repre_valores);
  $combo_repre_valores = str_replace("(A)", "", $combo_repre_valores);
  $combo_repre_valores = str_replace(",", "§", $combo_repre_valores);
}

function montaRepre($classe, $obj, $representante, $combo_repre_valores) {
  global $_SESSION;
  global $session;
  global $where_cc;
  unset($retorno);

  if (empty($combo_repre_valores) === true) {
    if ($session["representante"] == "URANET" || $session["tp_user"] == "GSU" || $session["tp_user"] == "GER" || $session["tp_user"] == "UF9" || $session["tp_user"] == "UF8"  || $session["tp_user"] == "DIR" || $session["tp_user"] == "COO") {
      $where_adicional = " AND filtro_classe = 'ZZ' ";
    } else {
      $where_adicional = " AND filtro_classe = 'ZZ' AND vlr_classe <> 'URANETGOP' ";
    }
    //busca as informações da classe REPRE ****Utiliza a regra da REPRU/ADSEO dentro da getArrayClasse
    $connect_repre = ConnectDB();
    $arr_REPRE = getArrayClasse("tb_classe", $connect_repre, "descricao", $classe, $representante, "A", $where_adicional);
//    print "<pre>";
//    var_dump($arr_REPRE);
//    print "</pre>";
    if (empty($where_cc) === false) {
      $where_cc = str_replace("§§", "|", $where_cc);
      $where_cc = str_replace("§", "", $where_cc);
      $arr_empresa_centro_custo = explode("|", $where_cc);
      $arr_empresa_centro_custo = array_flip($arr_empresa_centro_custo);
//      var_dump($arr_empresa_centro_custo);
    }

    if (is_array($arr_REPRE)) {
      if ($session["print_sql"] != "N") {
        $retorno .= "<option value=\"\" style='background-color:FFAAAA;'>montaRepre(".$arr_REPRE["info_uranet"].") - URANETGOP SOMENTE  GSU, GER, UF9, UF8, DIR e COO</option>";
      }
      $retorno .= "<option value=\"\">-- ".$arr_REPRE["info_selecione"]." --</option>";
      if (is_array($arr_REPRE["itens"])) {
        foreach ($arr_REPRE["itens"] as $chave => $valor) {
          /*if (is_array($arr_empresa_centro_custo)) {
            if (!key_exists($valor["valor"], $arr_empresa_centro_custo)) {
//              print "<li>".var_dump($valor["valor"]);
              continue;
            }
          }*/
          if ($obj == $valor["valor"]) {
            $selected = " selected ";
            $resp_escolha_desc = $valor;
          } else {
            $selected = " ";
          }
          $retorno .= "<option style='background-color:".$valor["cor_bg"]."; color:".$valor["cor"].";' value='".$valor["valor"]."' ".$selected." >".$valor["descricao"]."</option>";
        }
      }
    } else {
      $retorno .= "<option value=\"\" style='background-color:FFAAAA;'>ERRO NA ROTINA montaRepre(".$arr_REPRE["info_uranet"].")</option>";
    }
    return $retorno;
  } else {
    $aux_repres = explode("§", $combo_repre_valores);
    $classe = $combo_repre_valores;
    foreach ($aux_repres as $chave_repre => $valor_repre) {
      if (empty($valor_repre) === false) {
        $mtr_classe_repre[$valor_repre] = valorClassePrint("REPRE", $valor_repre, $valor_repre);
      }
    }
    if ($session["print_sql"] != "N") {
      $retorno .= "<option value='' style='background-color:FFAAAA;'>montaRepre(".$classe.")</option>";
    }
    if (is_array($mtr_classe_repre) === true) {
      $retorno .= "<option value=\"\">--Selecione--</option>";
      foreach ($mtr_classe_repre as $chave => $valor) {
        if ($obj == $chave) {
          $selected = " selected ";
          $resp_escolha_desc = $valor;
        } else {
          $selected = " ";
        }
        $retorno .= "<option value=\"".$chave."\" ".$selected.">".$valor."</option>";
      }
    } else {
      $retorno .= "<option value=\"\">-- Sem Ítens --</option>";
    }
    return $retorno;
  }
}

if (empty($string_funcionario) === true) {
  $string_funcionario = ${$campo_string_func};
}

if (strtoupper($bloqueia_repre) == "S" && empty(${$campo_repre_seleciona}) === true && $carregou_string_func == "S") {
  print "<font class='txtvermelho'><strong>ERRO NO PARÂMETRO BLOQUEIA_REPRE <br><br>É obrigatório a passagem de um representante fixo para utilizar o BLOQUEIA_REPRE.";
  exit();
}

if (empty($select_campos_param) === true) {
  print "<font class='txtvermelho'><strong>ERRO NOS  PARÂMETRO SELECT_CAMPOS_PARAM <br><br>É obrigatório a passagem dos campos do select e suas descrições.<br><br>Ex: select_campos_param=nome,cargo_rh</strong></font>";
  exit();
} else {
  $aux_mtr_parametro_select = explode("§", $select_campos_param);
}
//echo "<pre>";
//print_r($aux_mtr_parametro_select);

$campos_lista = " login, ";
$mtr_parametro["login"]["DESCRICAO"] = "Login";
$mtr_parametro["login"]["ALIGN"]   = "left";
$mtr_parametro["login"]["WIDTH"]   = "13%";
$mtr_parametro["login"]["FUNCAO"]  = "";
$mtr_parametro["login"]["CLASSE"]  = "";
$mtr_parametro["login"]["EXIBE"]  = "";
$mtr_posicao[0] = "login";

if (empty($select_ordem) === true) {
  $select_ordem = " ORDER BY nome ";
}
//sequencia dos parâmetros
//NomeTd¢AlinhamentoTd¢WidthTd¢Funcao¢CampoTabela¢Classe¢Posicao¢ExibeNaTela
$x = 1;
foreach ($aux_mtr_parametro_select as $chave => $parametro) {
  $parametro = trim($parametro);
  if (empty($parametro) === false) {
    $aux_parametro = explode("¢", $parametro);
    if (strtolower($aux_parametro[4]) != "login") {
      $mtr_parametro[strtolower($aux_parametro[4])]["DESCRICAO"] = trim($aux_parametro[0]);
      $mtr_parametro[strtolower($aux_parametro[4])]["ALIGN"]     = trim($aux_parametro[1]);
      $mtr_parametro[strtolower($aux_parametro[4])]["WIDTH"]     = trim($aux_parametro[2]);
      $mtr_parametro[strtolower($aux_parametro[4])]["FUNCAO"]    = trim($aux_parametro[3]);
      $mtr_parametro[strtolower($aux_parametro[4])]["CLASSE"]    = trim($aux_parametro[5]);
      $mtr_parametro[strtolower($aux_parametro[4])]["EXIBE"]     = trim($aux_parametro[7]);
      $campos_lista .= $aux_parametro[4].", ";

      if ($aux_parametro[6]) {
        $aux_posicao = $aux_parametro[6];
      } else {
        $aux_posicao = $x;
      }

      if (array_key_exists($aux_posicao, $mtr_posicao) === true) {
        $aux_posicao++;
        while(array_key_exists($aux_posicao, $mtr_posicao) === true) {
          $aux_posicao++;
        }
        $mtr_posicao[$aux_posicao] = trim($aux_parametro[4]);
        $aux_posicao++;
        $x = $aux_posicao;
      } else {
        $mtr_posicao[$aux_posicao] = trim($aux_parametro[4]);
        $aux_posicao++;
        $x = $aux_posicao;
      }
    }
  }
}

ksort($mtr_posicao);
$campos_lista = substr($campos_lista, 0, -2);
//print "<pre>";
//print_r($mtr_posicao);
//echo "<hr><hr>";
//print_r($mtr_parametro);
?>
<!DOCTYPE html>
<html>
<head>
<title><?print $session["sistema"]?></title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="-1">
<?print $v1_style_css;?>

<script language="javascript" type="text/javascript" src="consistencia.js"></script>
<script language="javascript" type="text/javascript" src="/js/jquery.js"></script>
<script language="javascript">
function addFuncionario(login, atualiza) {
  var string_func_ant = document.getElementById('string_funcionario').value;
  if (document.getElementById('check_'+login).checked == true) {
    conteudo_string     = document.getElementById('string_funcionario').value;
    conteudo_add = document.getElementById('login_'+login).value;;
    <?
    foreach ($mtr_posicao as $posicao => $campo) {
      if (strtolower($campo) != "login") {
        ?>
        conteudo_add = conteudo_add + "¢" + document.getElementById('<?print $campo;?>_'+login).value;
        <?
      }
    }
    ?>
    conteudo_add = conteudo_add + "§";
    if (conteudo_string.indexOf(conteudo_add) == -1) {
      document.getElementById('string_funcionario').value = conteudo_string + conteudo_add;
    }
  } else {
    conteudo_string   = document.getElementById('string_funcionario').value;
    conteudo_remove   = document.getElementById('login_'+login).value;
    <?
    foreach ($mtr_posicao as $posicao => $campo) {
      if (strtolower($campo) != "login") {
        ?>
        conteudo_remove = conteudo_remove + "¢" + document.getElementById('<?print $campo;?>_'+login).value;
        <?
      }
    }
    ?>
    conteudo_remove = conteudo_remove + "§";
    document.getElementById('string_funcionario').value = conteudo_string.replace(conteudo_remove, "");
    if (atualiza != "N") {
      $("#seleciona_todos").attr("checked","");
    }
  }
  if ((string_func_ant == "" || document.getElementById('string_funcionario').value == "") && atualiza != "N") {
    document.cadatro_func.submit();
  }
}

function limpaSelecao() {
  if (document.getElementById('string_funcionario')) {
    document.getElementById('string_funcionario').value = "";
  }
  if (document.getElementById('equipe_movimentacao')) {
    document.getElementById('equipe_movimentacao').value = "";
  }
  document.cadatro_func.submit();
}
function enviaSelecao() {
  parent.opener.document.getElementById('<?print $campo_string_func;?>').value = document.getElementById('string_funcionario').value;
  parent.opener.document.getElementById('<?print $campo_repre_seleciona;?>').value = document.getElementById('<?print $campo_repre_seleciona;?>').value;
  <?if (strtoupper($bloqueia_repre) != "S") {?>
  if (document.getElementById('string_funcionario').value == '') {
    parent.opener.document.getElementById('<?print $campo_repre_seleciona;?>').value = '';
  }
  <?}?>
  <?if (empty($nome_funcao) === false) {?>
  opener.<?print $nome_funcao;?>();
  <?}?>
  window.close();
}
function pegaStringFunc(carregou_string_func) {
  if (carregou_string_func != 'S') {
    document.getElementById('string_funcionario').value = parent.opener.document.getElementById('<?print $campo_string_func;?>').value;
    <?if ($nro_sistema == "Z1") {?>
    document.getElementById('where_cc').value = parent.opener.document.getElementById('empresa_cc').value;
    <?}?>
    document.getElementById('<?print $campo_repre_seleciona;?>').value = parent.opener.document.getElementById('<?print $campo_repre_seleciona;?>').value;
    document.cadatro_func.submit();
  }
}

function checaTodos(obj) {
  var conteudo_string_ant = document.getElementById('string_funcionario').value;

  $("input[type='checkbox']").each(function(){
      if (this.id != "seleciona_todos") {
        if (obj.checked == true) {
          $("#"+this.id).attr("checked","true");
        } else {
          $("#"+this.id).attr("checked","");
        }
        addFuncionario(this.id.replace("check_",""), "N");
      }
  });
  <?if ($bloqueia_repre != "S") {?>
      if (conteudo_string_ant == "" || document.getElementById('string_funcionario').value == "") {
        document.cadatro_func.submit();
      }
  <?}?>
}

</script>
</head>
<?
if($responsavel != "GOP360"){
  $func_load = "onload=\"pegaStringFunc('".$carregou_string_func."');\"";
}
?>
<body <?print $func_load?>>
<style type="text/css">

<?
if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE') ){
  ?>

div.conteudodatabela {
   width: 100%;      /* table width will be 99% of this*/
   height: 100%;    /* must be greater than tbody*/
   overflow: auto;
   margin: 0 auto;
   }
  <?
} else {
  ?>
div.conteudodatabela {
   width: 100%;      /* table width will be 99% of this*/
   height: 100%;    /* must be greater than tbody*/
   overflow: none;
   margin: 0 auto;
   }
  <?
}
?>


table {
   width: 99%;      /*100% of container produces horiz. scroll in Mozilla*/
  /* border: none;*/
   }

table>tbody   {  /* child selector syntax which IE6 and older do not support*/
   overflow: auto;
   height: 99%;
   overflow-x: hidden;
   }

thead tr   {
   position:relative;
   top: expression(offsetParent.scrollTop); /*IE5+ only*/

   }
/*
thead td, thead th {
   text-align: center;
   font-size: 14px;
   background-color: oldlace;
   color: steelblue;
   font-weight: bold;
   border-top: solid 1px #d8d8d8;
   }
/*
td   {
   color: #000;
   padding-right: 2px;
   font-size: 12px;
   text-align: right;
   border-bottom: solid 1px #d8d8d8;
   border-left: solid 1px #d8d8d8;
   }
*/
table tfoot tr { /*idea of Renato Cherullo to help IE*/
      position: relative;
      overflow-x: hidden;
      top: expression(parentNode.parentNode.offsetHeight >=
     offsetParent.offsetHeight ? 0 - parentNode.parentNode.offsetHeight + offsetParent.offsetHeight + offsetParent.scrollTop : 0);
      }

/*
tfoot td   {
   text-align: center;
   font-size: 11px;
   font-weight: bold;
   background-color: papayawhip;
   color: steelblue;
   border-top: solid 1px slategray;
   }
*/
td:last-child {padding-right: 20px;} /*prevent Mozilla scrollbar from hiding cell content*/

</style>
<div class="conteudodatabela">
<form name="cadatro_func" method="POST" >
<table border="0" align="center" width="90%" style="border-collapse:collapse;">
	<input type="hidden" name="string_funcionario" id="string_funcionario"  value="<?print ${"string_funcionario"};?>">
	<input type="hidden" name="nro_sistema" id="nro_sistema" value="<?print $nro_sistema;?>">
	<input type="hidden" name="tipo_solicitacao" id="tipo_solicitacao" value="<?print $tipo_solicitacao;?>">
	<input type="hidden" name="where_cc" id="where_cc" value="<?print $where_cc;?>">
	<input type="hidden" name="deonde" id="deonde" value="<?print $deonde;?>">
	<input type="hidden" name="sindicato_movimentacao" id="sindicato_movimentacao" value="<?print $sindicato_movimentacao;?>">
	<?
	if ($data_ponto != "") {
		?>
		<input type="hidden" name="data_ponto" id="data_ponto" value="<?print $data_ponto;?>">
		<?
	}
	?>

	<?/*<input type="hidden" name="<?print $campo_repre_seleciona;?>" id="<?print $campo_repre_seleciona;?>" value="<?print ${$campo_repre_seleciona};?>">*/?>

	<input type="hidden" name="carregou_string_func" id="carregou_string_func" value="S">
	<input type="hidden" name="campo_string_func" id="campo_string_func" value="<?print $campo_string_func;?>">
	<input type="hidden" name="nome_funcao" id="nome_funcao" value="<?print $nome_funcao;?>">
	<input type="hidden" name="select_campos_param" id="select_campos_param" value="<?print $select_campos_param;?>">
	<input type="hidden" name="campo_repre_seleciona" id="campo_repre_seleciona" value="<?print $campo_repre_seleciona;?>">
	<input type="hidden" name="select_where" id="select_where" value="<?print $select_where;?>">
	<input type="hidden" name="select_ordem" id="select_ordem" value="<?print $select_ordem;?>">
	<input type="hidden" name="bloqueia_repre" id="bloqueia_repre" value="<?print $bloqueia_repre;?>">
	<input type="hidden" name="responsavel" id="responsavel" value="<?print $responsavel;?>">
	<input type="hidden" name="combo_repre_valores" id="combo_repre_valores" value="<?print $combo_repre_valores;?>">

<?
  //marcelo não mexer sem falar comigo
  // gerando matriz com os usuario que logaram no dia escolhido para a solicitação
  if ($data_ponto != "" && ${$campo_repre_seleciona} != "" && $carregou_string_func == "S") {
    $msg_tipo_solicitacao = " que trabalharam no dia <span style='background-color: #FFFFFF'><font color='Green' size='4'>".BRDate($data_ponto)."</strong></span></font></font>";
    $connect = ConnectDB();

    if ($sindicato_movimentacao == "1" || $sindicato_movimentacao == "3") {
      $q_ponto  = "SELECT login FROM tbponto WHERE data_entrada = '".$data_ponto."' AND (frequencia IN ('', 'AT', 'FT', 'HD', 'HJ', 'OT', 'TR') OR (frequencia IS NULL) OR (frequencia = 'SE' AND observacao <> '') or (frequencia = 'FD' and hora_ent_man <> '00:00:00')) and (".representanteRH("", "like_or").") and empresa = '".${$campo_repre_seleciona}."'";
    } else {
      $q_ponto  = "SELECT login FROM tbponto_adm WHERE data_entrada = '".$data_ponto."' and (".representanteRH("", "like_or").") and representante = '".${$campo_repre_seleciona}."'";//and rede_acesso <> 'Internet' removido por conta do home office todos logam pela internet.
    }
    if ($query_ponto = DescExecQuery($q_ponto, $connect)) {
      if ($rec_ponto = mysql_fetch_assoc($query_ponto)) {
        do {
          $mtr_login_ponto[$rec_ponto["login"]] = $rec_ponto["login"];
          $mtr_login_ponto2[$rec_ponto["login"]]["equipe"] = retornaEquipe($rec_ponto["login"]);
          $mtr_login_ponto2[$rec_ponto["login"]]["login"]  = $rec_ponto["login"];
        } while ($rec_ponto = mysql_fetch_assoc($query_ponto));
      } else {
        unset($mtr_login_ponto);
        $mtr_login_ponto["X"] = "";
      }
    } else {
      print "<div align='center'><strong><font class='txtvermelho3'>ERRO NA BUSCA DA MARCAÇÃO DO PONTO. ENTRE EM CONTATO COM O SAC URANET E INFORME O ERRO.<br><br>QUERY:".$q_ponto."<br><br>ERRO:".mysql_error($connect)."</font></strong></div>";
      exit();
    }


    if ($sindicato_movimentacao == "2" || $sindicato_movimentacao == "4") {//caso o funcionario tenha logado apenas com telefonia. cOMPLEMENTA A MATRIZ
      $q_ponto  = "SELECT login FROM tbponto WHERE data_entrada = '".$data_ponto."' AND (frequencia IN ('', 'AT', 'FT', 'HD', 'HJ', 'OT', 'TR') OR (frequencia IS NULL) OR (frequencia = 'SE' AND observacao <> '') or (frequencia = 'FD' and hora_ent_man <> '00:00:00')) and (".representanteRH("", "like_or").") and empresa = '".${$campo_repre_seleciona}."'";
      if ($query_ponto = DescExecQuery($q_ponto, $connect)) {
        if ($rec_ponto = mysql_fetch_assoc($query_ponto)) {
          do {
            $mtr_login_ponto[$rec_ponto["login"]] = $rec_ponto["login"];
            $mtr_login_ponto2[$rec_ponto["login"]]["equipe"] = retornaEquipe($rec_ponto["login"]);
            $mtr_login_ponto2[$rec_ponto["login"]]["login"]  = $rec_ponto["login"];
          } while ($rec_ponto = mysql_fetch_assoc($query_ponto));
        }
      } else {
        print "<div align='center'><strong><font class='txtvermelho3'>ERRO NA BUSCA DA MARCAÇÃO DO PONTO. ENTRE EM CONTATO COM O SAC URANET E INFORME O ERRO.<br><br>QUERY:".$q_ponto."<br><br>ERRO:".mysql_error($connect)."</font></strong></div>";
        exit();
      }
    }
  }
  //****************************************
?>

  <tr>
    <td>
      <table border="0" align="left" width="99%" style="border-collapse:collapse;">
        <?
        if (empty($tipo_solicitacao) === false) {
					?>
					<tr  bgcolor="<?print $session['td_destaque']?>" valign="middle">
						<td align="left"><font class="txt6"><strong>Pesquisa de Funcionários para <?print ValorClasse("GE".$nro_sistema."2", $tipo_solicitacao, "URANETGOP"); print $msg_tipo_solicitacao;?>:</strong></font></td>
					</tr>
					<?
				}
        ?>
        <tr  bgcolor="<?print $session['td_destaque1']?>" valign="middle">
          <td align="left"><font class="txt5"><strong>Empresa: </strong></font>
            <font class="txt5">
              <?
								// comentado para o RH fazer solicitações de demissão e demitido
							  // if ($session["usuario_rh"] == "S" && $session["operador"] != "adm" && empty($combo_repre_valores) === true) {
								  // $representante = "URACENTER-FFO";
							  // } else {
                  $representante = $session["representante"];
								// }

							// print "<pre>";
							// print_r($_REQUEST);
              if (empty($string_funcionario) === false || empty(${"string_funcionario"}) === false || $bloqueia_repre == "S") {
              ?>
                <input type="hidden" name="<?print $campo_repre_seleciona;?>" id="<?print $campo_repre_seleciona;?>" value="<?print ${$campo_repre_seleciona};?>" consistir="sempre" tipodado="preenchido" msg="Selecione a Empresa da Movimentação.">
              <?
              print ValorClasse($classe_repre, ${$campo_repre_seleciona}, $representante);
              } else {
              ?>
              <?
              $option_repre = montaRepre($classe_repre, ${$campo_repre_seleciona}, $representante, $combo_repre_valores);
              ?>
              <select name="<?print $campo_repre_seleciona;?>" id="<?print $campo_repre_seleciona;?>" onchange="javascript: limpaSelecao();" consistir="sempre" tipodado="preenchido" msg="Selecione a Empresa da Movimentação.">
                <?print $option_repre;?>
              </select>
              <?
              }
              ?>
            </strong></font>&nbsp;&nbsp;&nbsp;

          <?if (empty(${$campo_repre_seleciona}) === false) {
							$connect = ConnectDB();
							if ($responsavel == "GOP6" && ($equipe_movimentacao == "todos" || $equipe_movimentacao == "")) {
								$q_equipe = "SELECT vlr_classe, desc_classe FROM tb_classe WHERE representante = '".${$campo_repre_seleciona}."'  AND  cod_classe = '".$classe_equipe."' AND tipo_reg = 'I'";

								$query_equipe = DescExecQuery($q_equipe,$connect);
								if ($rec_equipe = mysql_fetch_assoc($query_equipe)) {
									 do{
										 $equipe_todos.= "'".$rec_equipe["vlr_classe"]."',";
									 }while ($rec_equipe = mysql_fetch_assoc($query_equipe));
								}
							}
							$equipe_todos =  substr($equipe_todos,0,-1);
?>
							<font class="txt5"><strong>Equipe: </strong></font>
							<select name="equipe_movimentacao" id="equipe_movimentacao" onchange="javascript: document.cadatro_func.submit();" consistir="sempre" tipodado="preenchido" msg="Selecione uma Equipe." >
								<?print MontaCombo($classe_equipe, $equipe_movimentacao, ${$campo_repre_seleciona}, "A", "ZZ");?>
								<?if ($responsavel == "GOP6") {?>
									<option value="todos" <?if ($equipe_movimentacao == "todos" || $equipe_movimentacao == ""){print "selected";}?>>TODOS</option>
								<?}?>
							</select>
							<?if ($session["usuario_rh"] == "S" || $session["operador"] == "adm" || $session["operador"] == "re000022" || $session["operador"] == "re003811") {?>
									&nbsp;&nbsp;&nbsp;
									<font class="txt5"><strong>Login: </strong></font>
									<input type="text" name="login_movimentacao" id="login_movimentacao" value="<?print $login_movimentacao?>" maxlength="14" consistir="sempre" tipodado="login" msg="Preencha Corretamente o Login!">
									<img src="imagens/lupa_transparente.gif" style="width: 15px; cursor: pointer;" onclick="javascript: if(consisteCampo(document.getElementById('login_movimentacao'))){document.cadatro_func.submit();}">
							<?}?>
          <?}?>
          </td>
        </tr>
      </table>
    </td>
  </tr>
<?
if ($equipe_movimentacao == "todos" || ($equipe_movimentacao == "" && ($responsavel == "GOP6" || $login_movimentacao))){
  $if_select = empty(${$campo_repre_seleciona}) === false;
}else{
  $if_select = empty(${$campo_repre_seleciona}) === false && empty($equipe_movimentacao) === false;
}

if ($if_select) {
  $connect = ConnectDB();
  if ($equipe_movimentacao == "todos" || ($equipe_movimentacao == "" && ($responsavel == "GOP6" || $login_movimentacao))) {
    if ($equipe_todos != ""){
      $where_equipe = "AND equipe in (".$equipe_todos.")";
    }else{
      $where_equipe = "";
    }
  }else{
    $where_equipe = "AND equipe = "."'".$equipe_movimentacao."'";
  }
  if($login_movimentacao) {
    $where_login = "AND login = '".$login_movimentacao."'";
  }

  $select_where = str_replace("#'","('",$select_where);
  $select_where = str_replace("'#","')",$select_where);


//
//  if ($tipo_solicitacao == "DE" || $tipo_solicitacao == "DV") {
//    $where_tp_user_select = " (tp_user <> 'DES' OR (tp_user = 'DES' AND data_atualiza >= '".date("Y-m-d", mktime(0,0,0,date("m"), date("d")-2, date("Y")))."')) ";
//  } else {
//    $where_tp_user_select = " tp_user <> 'DES' ";
//  }

  $where_tp_user_select = " tp_user <> 'DES' ";

  $q = "SELECT ".$campos_lista.", equipe, tp_user, data_admissao, ffo, ffo_cod_recusa, data_estabi_ferias, data_estabi_ffo, data_estabi_cipa, sindicato, flag_rec_vale_transp, ibm_login, flag_pcd FROM tbadmin WHERE empresa = '".${$campo_repre_seleciona}."' ".$where_equipe." AND ".$where_tp_user_select." ".$where_login.$select_where.$select_ordem;
  if ($query = DescExecQuery($q, $connect)) {
    if ($rec = mysql_fetch_assoc($query)) {
      $podeCarregar = "S";
      $total_func_select = 0;
      $tem_logado_selecao = 0;
      do {
        $mtr_tpuser[$rec["login"]] = $rec["tp_user"];
//        print "<li>".$rec["login"]." - ".valorclasse("EQUIP", $rec["equipe"], ${$campo_repre_seleciona})." -- ".$rec["data_admissao"]  . $data_ponto; ;
        foreach ($mtr_parametro as $campo => $arr_campo) {

          //marcelo não mexer sem falar comigo
          //caso seja solicitação que só possa ser feita se o usuário logou em um determinado dia verifica se logou caso não logou retira do retorno da tbadmin para não listar na tela
          if (is_array($mtr_login_ponto) === true) {
            if (key_exists($rec["login"], $mtr_login_ponto) === false || (($tipo_solicitacao == "VT" || $tipo_solicitacao == "VR") && $data_ponto != "" && $data_ponto != "1111-11-11" && $data_ponto < $rec["data_admissao"])) {
//              print "<li>".$rec["login"];
              continue;
            }
          }
          $tem_logado_selecao++;
          //*****************************************

          $mtr_funcionario[$rec["login"]][$campo]                 = trim($rec[$campo]);
          $mtr_funcionario[$rec["login"]]["ffo"]                  = trim($rec["ffo"]);
          $mtr_funcionario[$rec["login"]]["ffo_cod_recusa"]       = trim($rec["ffo_cod_recusa"]);
          $mtr_funcionario[$rec["login"]]["data_estabi_ffo"]      = trim($rec["data_estabi_ffo"]);
          $mtr_funcionario[$rec["login"]]["data_estabi_cipa"]     = trim($rec["data_estabi_cipa"]);
          $mtr_funcionario[$rec["login"]]["data_estabi_ferias"]   = trim($rec["data_estabi_ferias"]);
          $mtr_funcionario[$rec["login"]]["sindicato"]            = trim($rec["sindicato"]);
          $mtr_funcionario[$rec["login"]]["flag_rec_vale_transp"] = trim($rec["flag_rec_vale_transp"]);
          $mtr_funcionario[$rec["login"]]["flag_pcd"]             = trim($rec["flag_pcd"]);
          if (substr($hd_repre_sel, 0, 3) == "BMG") {
            $mtr_funcionario[$rec["login"]]["ibm_login"]          = trim($rec["ibm_login"]);
          }
        }
        $total_func_select++;
      } while ($rec = mysql_fetch_assoc($query));
      // print "<pre>";print_r($mtr_funcionario);

      if (is_array($mtr_funcionario) === true) {
        ?>
          <tr>
            <td style="display:inline;width:100%;height:300px;" valign="top">
              <div style="overflow-y:scroll;overflow-x:auto; height:500px;width:100%;">
                <table border="1%" align="left" width="100%" style="border-collapse:collapse;">
									<thead>
										<tr bgcolor="<?print $session["td_dado1"];?>">
										<?if ($deonde != "SOMENTE_RADIO") {?>
											<td width="5"><input type="checkbox" id="seleciona_todos" onclick="javascript: checaTodos(this);" OnMouseOver="style.cursor='pointer';" title="Selecionar todos."></td>
										<?} else {?>
                      <td width="5">&nbsp;</td>
										<?
                    }
										foreach ($mtr_posicao as $posicao => $campo) {
											if ($mtr_parametro[$campo]["EXIBE"] != "N") {
										?>
											<td nowrap width="<?print $mtr_parametro[$campo]["WIDTH"];?>" align="center"><font class="txt5"><strong><?print $mtr_parametro[$campo]["DESCRICAO"];?></strong></font></td>
										<?
											}
										}
										?>
										</tr>
									</thead>
									<tbody>
										<?
										$x=1;
										$string_todos_funcionario = "";
										$total_func_checked = 0;
										foreach ($mtr_funcionario as $chave => $valor) {
											if ($x % 2 == 0) {
												$cor_tr = "#FFFFFF";
											} else {
												$cor_tr = "#D6D6D6";
											}

											$title_tr = "";
											$cor_onmoseover = "#BBFBBB";

											if ($mtr_tpuser[$valor["login"]] == "DES") {
												$cor_tr = "#FF0000";
												$title_tr = "title='Usuário Desativado'";
												$cor_onmoseover = "#FE7676";
											}

											$permite_selecao = "S";
                      $complemento_nome = "";
											if ($valor["ffo"] == "S") {
												$cor_tr = "#FFBF1F";
												$cor_onmoseover = "#FFE5A3";
												if ($valor["ffo_cod_recusa"] == "001" || $valor["ffo_cod_recusa"] == "004") {
													$complemento_nome = "<br><font class='txtvermelho3'><li><i>&nbsp;Usuário está em FFO ativo.</i></li></font>";
												} else {
													$complemento_nome = "<br><font class='txtvermelho3'><li><i>&nbsp;Usuário está em FFO afastado.</i></li></font>";
												}
												if($valor["ffo_cod_recusa"] != "001" && $valor["ffo_cod_recusa"] != "004") {//ffo afastado
													if ($tipo_solicitacao != "DV" && $tipo_solicitacao != "MF" && $tipo_solicitacao != "TS") {
                            //FFO AFASTADO - GOP só pode solicitar DV - Pedido de Demissão, MF Alteração Motivo FFO, TS Transferência FFO para Responsável Restante das solicitações Somente RH ou TICO
														$permite_selecao = "N";
													}
												} else {
													if ($tipo_solicitacao == "DF" && $tipo_solicitacao == "PR") {
														//FFO ATIVO - GOP não pode efetuar solicitação caso seja DF - Dupla Função ou PR - Promoção Somente RH ou TICO
														$permite_selecao = "N";
													}
												}
                      }

                      if ($tipo_solicitacao == "TS" && $valor["ffo"] != "S") {
                        //tipo de solicitação TS Transferência FFO para Responsável porém funcionário não está em FFO.
                        $permite_selecao = "N";
                        $complemento_nome .= "<br><font class='txtvermelho3'><li><i>&nbsp;Este colaborador não está em FFO.</i></li></font>";
                      }

											if (($valor["sindicato"] == "2" || $valor["sindicato"] == "4") && $valor["data_estabi_ferias"] != "1111-11-11" && $valor["data_estabi_ferias"] >= date('Y-m-d')) {
												$cor_tr = "#FFBF1F";
												$cor_onmoseover = "#FFE5A3";
												$complemento_nome .= "<br><font class='txtvermelho3'><li><i>&nbsp;Estabilidade volta de férias até ".BRDate($valor["data_estabi_ferias"]).".</i></li></font>";
												if ($tipo_solicitacao == "DE") {
													$permite_selecao = "N";
												}
											}

											if ($valor["data_estabi_ffo"] != "1111-11-11" && $valor["data_estabi_ffo"] >=  date('Y-m-d')) {
												$cor_tr = "#FFBF1F";
												$cor_onmoseover = "#FFE5A3";
												$complemento_nome .= "<br><font class='txtvermelho3'><li><i>&nbsp;Estabilidade volta de FFO até ".BRDate($valor["data_estabi_ffo"]).".</i></li></font>";
												if ($tipo_solicitacao == "DE") {
													$permite_selecao = "N";
												}
											}

											if ($valor["data_estabi_cipa"] != "1111-11-11" && $valor["data_estabi_cipa"] >= date('Y-m-d')) {
												$cor_tr = "#FFBF1F";
												$cor_onmoseover = "#FFE5A3";
												$complemento_nome .= "<br><font class='txtvermelho3'><li><i>&nbsp;Estabilidade CIPA até ".BRDate($valor["data_estabi_cipa"]).".</i></li></font>";
												if ($tipo_solicitacao == "DE" || $tipo_solicitacao == "TE" || $tipo_solicitacao == "TI" || $tipo_solicitacao == "TP") {
													$permite_selecao = "N";
												}
											}


                      $title_tr = "";
											if ((($session["usuario_rh"] == "S" && ($session["tp_user"] == "UF9" || $session["tp_user"] == "UF8" || $session["tp_user"] == "DIR")) || $session["operador"] == "adm") && $permite_selecao == "N") {
												$permite_selecao = "S";
											} else {
												if ($permite_selecao == "N") {
													$complemento_nome = "<br><font class='txtvermelho3'><li><i>Para movimentar este funcionário entre em contato com o RH.</i></li>".$complemento_nome;
												}
                      }

                      require_once($_SERVER['DOCUMENT_ROOT']."/callcenter/funcoes/RHFuncoes.php");
                      $data_estabilidade_covid = estabilidadeCovid_Data($valor["login"]);
                      if ($data_estabilidade_covid != "1111-11-11") {
                        $mktime_data_atual         = mktime(0, 0, 0, date('m'), date('d'), date('Y'));
                        $mktime_estabilidade_covid = mktime(0, 0, 0, substr($data_estabilidade_covid, 5, 2), substr($data_estabilidade_covid, 8, 2), substr($data_estabilidade_covid, 0, 4));
                        if ($mktime_data_atual <= $mktime_estabilidade_covid) {
                          if ($tipo_solicitacao == "DE") {
                            $permite_selecao = "N";
                          }
                          $complemento_nome = "<br><font class='txtvermelho3'><li><i>Garantia provisória no emprego ao empregado com redução da jornada de trabalho e de salário<br>&nbsp;&nbsp;&nbsp;&nbsp;ou da suspensão temporária do contrato pela MP936.</li><br><li>Estabilidade até ".BRDate($data_estabilidade_covid)."</i></li>".$complemento_nome;
                        }
                      }

                      if ($valor["flag_pcd"] == "S") {
                        if ($tipo_solicitacao == "DE" || $tipo_solicitacao == "DV") {
                          if ($session["usuario_rh"] != "S") {
                            $permite_selecao = "N";
                            $complemento_nome = "<br><font class='txtvermelho3'><li><i>Entre em contato com o RH para efetuar esta movimentação.</i></li>".$complemento_nome;
                          } else {
                            $permite_selecao = "S";
                            $complemento_nome = "<br><font class='txtvermelho3'><li><i>Colaborador faz parte da cota PCD.</i></li>".$complemento_nome;
                          }
                        }
                      }

											$data_atual = mktime(0, 0, 0, date('m'), date('d'), date('Y'));
											$data_experiencia_45 = mktime(0, 0, 0, substr($valor["data_admissao"], 5, 2), (int)substr($valor["data_admissao"], 8, 2) + 44, (int)substr($valor["data_admissao"], 0, 4));
											$data_experiencia_90 = mktime(0, 0, 0, substr($valor["data_admissao"], 5, 2), (int)substr($valor["data_admissao"], 8, 2) + 89, (int)substr($valor["data_admissao"], 0, 4));

											if($data_atual <= $data_experiencia_45) {
												$complemento_nome  .= "<br><font class=\"txtvermelho3\"><li><i>&nbsp;Exp. ".date('d/m/Y', $data_experiencia_45)." (45 dias)</i></li></font>";
											}
											if($data_atual > $data_experiencia_45 && $data_atual <= $data_experiencia_90) {
												$complemento_nome  .= "<br><font class=\"txtvermelho3\"><li><i>&nbsp;Exp. ".date('d/m/Y', $data_experiencia_90)." (90 dias)</i></li></font>";
											}

											if($valor["flag_rec_vale_transp"] == "N") {
												$complemento_nome .= "<br><font class='txtvermelho3'><li><i>&nbsp;Não utiliza Vale Transporte.</i></li></font>";
											}
											if($valor["flag_rec_vale_transp"] == "N" && $tipo_solicitacao == "VT") {
												$permite_selecao = "N";
											}
											$login_busca = $valor["login"]."¢";
											?>
															<tr bgcolor="<?print $cor_tr;?>" <?print $title_tr?> onmouseover="style.background='<?print $cor_onmoseover;?>'" onmouseout="style.background='<?print $cor_tr;?>'">
																<td width="1%">
																	<?
																	if ($permite_selecao == "S") {
																		if ($deonde != "SOMENTE_RADIO") {
																			?>
																			<input type="checkbox" name="check_<?print $valor["login"];?>" id="check_<?print $valor["login"];?>" value="<?print $valor["login"];?>" onclick="javascript: addFuncionario('<?print $valor["login"];?>')" <?if (strpos("**".$string_funcionario."¢", $login_busca) > 0 || strpos("**".${"string_funcionario"}."¢", $login_busca) > 0) { print " checked "; $total_func_checked++;}?>>
																			<?
																		} else {
																			?>
																			<input type="radio" name="check_radio" id="check_<?print $valor["login"];?>" value="<?print $valor["login"];?>" onclick="javascript: addFuncionario('<?print $valor["login"];?>')" <?if (strpos("**".$string_funcionario."¢", $login_busca) > 0 || strpos("**".${"string_funcionario"}."¢", $login_busca) > 0) { print " checked "; $total_func_checked++;}?>>
																			<?
																		}
																	} else {
																		print "&nbsp;";
																	}
																	?>
																</td>
																<td nowrap width="13%" align="left"><font class="txt5">
                                  <?
                                    if (substr($hd_repre_sel, 0, 3) == "BMG") {
                                      print $valor["ibm_login"];
                                    } else {
                                      print $valor["login"];
                                    }
                                  ?>
																	</font>
																	<input type="hidden" name="login_<?print $valor["login"]?>" id="login_<?print $valor["login"];?>" value="<?print $valor["login"];?>">
																</td>
																<?
																$string_todos_funcionario .= $valor["login"];
																foreach ($mtr_posicao as $posicao => $campo) {
																	if ($campo != "login") {
																		$string_todos_funcionario .= "¢".$valor[$campo];
																		if ($mtr_parametro[$campo]["EXIBE"] != "N") {
																			if (empty($mtr_parametro[$campo]["CLASSE"]) === false) {
																				if ($mtr_parametro[$campo]["CLASSE"] == "CRORH") {
																					if (representanteRH($valor["login"], "sem_representante") == "URANET-RH") {
																						$repre_vlr_classe = "URANET-RH";
																					} else {
																						$repre_vlr_classe = "URANET";
																					}
																				} else {
																					$repre_vlr_classe = ${$campo_repre_seleciona};
																				}
																				$desc_valor_campo = ValorClassePrint($mtr_parametro[$campo]["CLASSE"], $valor[$campo], $repre_vlr_classe);
																			} else if (empty($mtr_parametro[$campo]["FUNCAO"]) === false) {
																				if ($valor[$campo] != "1111-11-11" && $valor[$campo] != "0000-00-00") {
																					eval("\$desc_valor_campo = \$mtr_parametro[\$campo]['FUNCAO'](\$valor[\$campo]);");
																				} else {
																					$desc_valor_campo = "S/Data";
																				}
																			} else {
																				$desc_valor_campo = $valor[$campo];
																			}

																			if ($campo == "nome") {
																				$desc_valor_campo .= $complemento_nome;
																			}
																		?>
																			<td nowrap width="<?print $mtr_parametro[$campo]["WIDTH"];?>" align="<?print $mtr_parametro[$campo]["ALIGN"];?>"><font class="txt5"><?print $desc_valor_campo;?></font>
																			<input type="hidden" name="<?print $campo."_".$valor["login"];?>" id="<?print $campo."_".$valor["login"];?>" value="<?print $valor[$campo];?>">
																			</td>
																		<?
																		} else {
																		?>
																			<input type="hidden" name="<?print $campo."_".$valor["login"];?>" id="<?print $campo."_".$valor["login"];?>" value="<?print $valor[$campo];?>">
																		<?
																		}
																	}
																}
																$string_todos_funcionario .= "§";
																?>
															</tr>
											<?
											$x++;
										}
										if ($total_func_checked == $total_func_select) {
											?>
												<script language="javascript">
												$("#seleciona_todos").attr("checked","true");
												</script>
											<?
										} else {
											?>
												<script language="javascript">
												$("#seleciona_todos").attr("checked","");
												</script>
											<?
										}
										?>
										<input type="hidden" name="string_todos_funcionario" id="string_todos_funcionario" value="<?print $string_todos_funcionario;?>">
									</tbody>
								</table>
							</div>
						</td>
					</tr>
        <?
      }
    } else {
      $podeCarregar = "N";
    ?>
      <tr>
        <td><font class="txtvermelho"><strong>Nenhum login Encontrado</strong></font></td>
      </tr>
    <?
    }


    if ($data_ponto != "" && ${$campo_repre_seleciona} != "" && $carregou_string_func == "S" && $tem_logado_selecao == 0) {
      $podeCarregar = "N";
    ?>
      <tr>
        <td><font class="txtvermelho"><strong>Nenhum funcionário logou no dia <?print BRDate($data_ponto);?> para a empresa e equipe escolhida. Efetue um novo filtro.</strong></font></td>
      </tr>
    <?
    }



  }
}
?>
</table>
</form>
<?
if ($podeCarregar == "S") {
?>
<table align="center">
  <tr>
    <td align="center">
      <input type="button" name="btn_envia" value="Enviar Seleção" class="but_proc_on" onclick="javascript: enviaSelecao();"></div>
    </td>
  </tr>
</table>
<?
}
?>
</div>
<?
if ($session["print_sql"] == "V" && $session["operador"] == "re003811") {
  print "<pre>";
  print "<li>REQUEST";
  print_r($_REQUEST);
  print "<li>GLOBALS";
  print_r($GLOBALS);
  print "</pre>";
}
?>
<?print GerarRodape($voltar);?>
</body>
</html>