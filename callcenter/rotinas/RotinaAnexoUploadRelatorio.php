<?
session_start();
session_register("session");
include $_SERVER['DOCUMENT_ROOT'] . "/callcenter/cc_libcallcenter.php";

if (strlen($_REQUEST["SID"]) > 1 && strlen($_REQUEST["SDE"]) > 1) {
  require_once("/libs/bd/ConexaoSession.php");
  $con_server_de = new ConexaoSession();
  $q = "SELECT session_data from tb_session_" . $_REQUEST["SDE"] . " where session_id = '" . $_REQUEST["SID"] . "' ";
  $con_server_de->query($q);

  if ($con_server_de->status === false) {
    ?>
      <script type="text/javascript">
        window.parent.postMessage("ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - ERRO BD01]¬¬", '*');
      </script>
    <?
    exit();
  }

  if ($con_server_de->count == 1) {
    $con_server_de->getFetchAssoc();
    session_decode($con_server_de->result["session_data"]);
    $_SESSION["itlg_host_return"] = $_REQUEST["host_return"];

    if ($usa_ajax == "sim") {
      if ($tipo_requisicao == "rotinaAnexoUPLOAD") {
        ini_set('memory_limit', '512M');
        require_once("{$_SERVER['DOCUMENT_ROOT']}/callcenter/mk_funcoes.php");
        require_once("{$_SERVER['DOCUMENT_ROOT']}/callcenter/funcoes/RotinasBD.php");
        require_once("{$_SERVER['DOCUMENT_ROOT']}/callcenter/funcoes/ClasseFuncoes.php");
        require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/func/String.php");
        require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/bd/ConexaoDocumentos.php");
        require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/bd/ConexaoBDADO.php");
        require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/bd/Conexao.php");

        if ($_REQUEST["nro_sistema_rotina"]) {
          $nro_sistema  = base64_decode($_REQUEST["nro_sistema_rotina"]);
        } else {
          $nro_sistema  = base64_decode($_REQUEST["nro_sistema"]);
        }
        if ($_REQUEST["mk_flag_rotina"]) {
          $mk_flag = base64_decode($_REQUEST["mk_flag_rotina"]);
        } else {
          $mk_flag = base64_decode($_REQUEST["mk_flag"]);
        }

        if ($mk_flag == "FIXO" || $mk_flag == "FIXO_ANOMES") {
        } else {
          $mkParam = carregaArrParam($mk_flag . $nro_sistema . "A", "URANET");
          $mkParam = carregaArrParam($mk_flag . $nro_sistema . "B", "URANET");
        }

        // ******************************************************************************************** //
        // ********************** INSERINDO O DOCUMENTO NA TABELA DE DOCUMENTOS *********************** //
        // ******************************************************************************************** //

        if (is_array($_FILES) === true) {
          if (count($_FILES) > 0) {
            if ($mk_flag == "FIXO" || $mk_flag == "FIXO_ANOMES") {

              $arrPAramFixo = explode(".", $nro_sistema);
              $conDocumentos = new ConexaoBDADO($arrPAramFixo[0]);

              if ($conDocumentos->status == false) {
    ?>
                <script type="text/javascript">
                  window.parent.postMessage("ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - <? print $conDocumentos->error ?>]¬¬", '*');
                </script>
              <?
                exit();
              }
              $mkParam['tabela_documentos'] = $arrPAramFixo[1];
            } else {
              if ($mkParam["host_documentos"] == "") {
              ?>
                <script type="text/javascript">
                  window.parent.postMessage("ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - Parametros de Banco de Dados dos Documentos não parametrizado]¬¬", '*');
                </script>
              <?
                exit();
              } else {
                $conDocumentos = new ConexaoDocumentos;
              }
            }

            if ($mkParam["tabela_documentos"] == "") {
              ?>
              <script type="text/javascript">
                window.parent.postMessage("ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - tabela documentos não parametrizada]¬¬", '*');
              </script>
              <?
              exit();
            }

            foreach ($_FILES as $arquivo => $param) {
              if ($arquivo == "arquivo_" . $_GET["indice_docto"]) {
                //O ARQUIVO ULTRAPASSA O LIMITE DE TAMANHO EM MAX_FILE_SIZE QUE FOI ESPECIFICADO NO FORMULÁRIO HTML
                if ($param['size'] > ($l_up * 1000)) {
                  $msg_docs = "O tamanho do arquivo " . $param["name"] . " é " . round($param['size'] / 1000) . "KB  -  maior que permitido (Tamanho Máximo " . $l_up . "KB).";
                  ?>
                    <script type="text/javascript">
                      window.parent.postMessage("<? print "ERRO¬" . $msg_docs . "¬¬"; ?>", '*');
                    </script>
                  <?
                  exit();
                }

                switch ($param["error"]) {
                  case 0;
                    //O UPLOAD FOI BEM SUCEDIDO
                    $fp  = fopen($param["tmp_name"], "rb");
                    $tmp = fread($fp, $param["size"]);
                    $tmp = addslashes($tmp);
                    
                    fclose($fp);
                    unlink($param["tmp_name"]);

                    if ($mkParam["repre_vendedor"] == "") {
                      $mkParam["repre_vendedor"] = $session["representante"];
                    }

                    if ($mk_flag == "FIXO_ANOMES") {
                      $arr_campos['classe_mkpro'] = $arrPAramFixo[2] ;
                    } else {
                      $arr_campos['classe_mkpro'] = $mk_flag.$nro_sistema;
                    }

                
                    $arr_campos['tipo'] = $param["type"];
                    $arr_campos['nome'] = $param["name"];
                    $arr_campos['representante'] = $mkParam["repre_vendedor"] ;
                    $arr_campos['data_cri'] = date("Y-m-d") ;
                    $arr_campos['hora_cri'] = date("H:i:s") ;
                    $arr_campos['login_cri'] = $session["operador"] ;
                    $arr_campos['ano_mes'] = date("Ym") ;
                    $arr_campos['arq_size'] = $param["size"] ;
                    $arr_campos['dados'] = "(INT)'{$tmp}'(INT)";


                    if(empty($_REQUEST['n_pedido']) != true) {
                      $arr_campos['n_pedido'] = $_REQUEST['n_pedido'];
                    } 

                    if (empty($_REQUEST['n_pedido']) == true && $mk_flag != "FIXO" && $mk_flag != "FIXO_ANOMES") {

                      if(empty($_REQUEST["ativ_num"]) != true) {
                          
                        $connProposta = new Conexao($mkParam['host_proposta'], $mkParam['bd_proposta'], $mkParam['user_proposta'], $mkParam['senha_proposta']);

                        if($connProposta->status === true) {
                          $connProposta->query("SELECT n_pedido FROM {$mkParam['tabela_proposta']} WHERE mk_flag = '{$_REQUEST['mk_flag']}' AND mk_numero = '{$_REQUEST['mk_numero']}' AND grupo_acesso = '{$_REQUEST['grupo_acesso']}' AND ativ_num = '{$_REQUEST['ativ_num']}'");

                          if($connProposta->status === true && $connProposta->count != 0) {
                            $arr_campos['n_pedido'] = $connProposta->result['n_pedido'];
                          }
                        }

                      }

                    }
                    
                    $conDocumentos->execInsert($arr_campos , $mkParam["tabela_documentos"]);

                    if ($conDocumentos->rowsAffected != 0) {
                      
                      $seq_nro = $conDocumentos->last_id();
                      $arr_ext = explode(".", $param["name"]);
                      $x_arq   = 0;
                      $extesao = "";
                      
                      while ($arr_ext[$x_arq]) {
                        $extesao = $arr_ext[$x_arq];
                        $x_arq++;
                      }

                      if ($mk_flag != "FIXO_ANOMES") {
                        $id_arquivo = "DocMK*" . str_replace("." . $extesao, "", $param["name"]) . "|" . $extesao . "|" . $param["size"] . "|" . $mk_flag . "|" . $nro_sistema . "|" . $seq_nro . "|" . $session["operador"] . "|" . Date("Y-m-d") . "|" . Date("H:i:s");
                      } else {
                        $aux_modelo = explode(".", $nro_sistema);
                        $id_arquivo = "DocMK*" . str_replace("." . $extesao, "", $param["name"]) . "|" . $extesao . "|" . $param["size"] . "|" . $mk_flag . "|" . $nro_sistema . "|" . $seq_nro . "|" . $session["operador"] . "|" . Date("Y-m-d") . "|" . Date("H-i-s");
                      }

                      ?>
                        <script type="text/javascript">
                          window.parent.postMessage("<? print "OK¬" . $_GET["indice_docto"] . "¬" . base64_encode($seq_nro) . "¬" . $id_arquivo; ?>", '*');
                        </script>
                      <?
                      exit();
                    } else {

                          $msg_docs = "Não foi possível gravar arquivo [" . $param["name"] . "]. (" . $conDocumentos->error . ")";
                        
                      ?>
                        <script type="text/javascript">
                          window.parent.postMessage("<? print "ERRO¬" . $msg_docs . "¬¬"; ?>", '*');
                        </script>
                      <?
                      exit();
                    }
                    unset($tmp);
                    break;
                  case 1:
                    //O ARQUIVO NO UPLOAD É MAIOR DO QUE O LIMITE DEFINIDO EM UPLOAD_MAX_FILESIZE NO PHP.INI
                    $msg_docs = "O tamanho do arquivo [" . $param["name"] . "] é maior que permitido (Tamanho Máximo " . $l_up . "k).(" . $param["error"] . ")";
                    ?>
                      <script type="text/javascript">
                        window.parent.postMessage("<? print "ERRO¬" . $msg_docs . "¬¬"; ?>", '*');
                      </script>
                    <?
                    exit();
                    break;
                  case 2:
                    //O ARQUIVO ULTRAPASSA O LIMITE DE TAMANHO EM MAX_FILE_SIZE QUE FOI ESPECIFICADO NO FORMULÁRIO HTML
                    $msg_docs = "O tamanho do arquivo " . $param["name"] . " é maior que permitido (Tamanho Máximo  " . $l_up . "k). (" . $param["error"] . ")";
                    ?>
                      <script type="text/javascript">
                        window.parent.postMessage("<? print "ERRO¬" . $msg_docs . "¬¬"; ?>", '*');
                      </script>
                    <?
                    exit();
                    break;
                  case 3:
                  case 4:
                    //O UPLOAD DO ARQUIVO FOI FEITO PARCIALMENTE
                    $msg_docs = "Não foi possível completar o upload do arquivo  " . $param["name"] . ". Tente novamente (3).";
                    ?>
                      <script type="text/javascript">
                        window.parent.postMessage("<? print "ERRO¬" . $msg_docs . "¬¬"; ?>", '*');
                      </script>
                    <?
                    exit();
                    break;
                  default:
                    //erro desconhecido
                    $msg_docs = "Não foi possível completar o upload do arquivo  " . $param["name"] . ". Tente novamente (4).";
                    ?>
                      <script type="text/javascript">
                        window.parent.postMessage("<? print "ERRO¬" . $msg_docs . "¬¬"; ?>", '*');
                      </script>
                    <?
                    exit();
                    break;
                }
              } else {
                ?>
                <script type="text/javascript">
                  window.parent.postMessage("<? print "ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - ARQUIVO NÃO IDENTIFICADO]¬¬"; ?>", '*');
                </script>
                <?
                exit();
              }
            }
          } else {
            ?>
            <script type="text/javascript">
              window.parent.postMessage("<? print "ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - NENHUM ARQUIVO ENVIADO]¬¬"; ?>", '*');
            </script>
            <?
            exit();
          }
        } else {
          ?>
            <script type="text/javascript">
              window.parent.postMessage("<? print "ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - _FILES NÃO DEFINIDO]¬¬"; ?>", '*');
            </script>
          <?
          exit();
        }
      } else {
        ?>
        <script type="text/javascript">
          window.parent.postMessage("<? print "ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - tipo_requisição NÃO DEFINIDA]¬¬"; ?>", '*');
        </script>
        <?
        exit();
      }
    } else {
      ?>
      <script type="text/javascript">
        window.parent.postMessage("<? print "ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - Acesso Negado 2]¬¬"; ?>", '*');
      </script>
      <?
      exit();
    }
  } else {
    print "<pre>";
    var_dump($con_server_de);
    ?>
    <script type="text/javascript">
      window.parent.postMessage("<? print "ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - Acesso Negado 3(" . $con_server_de->count . " - " . $q . ")]¬¬"; ?>", '*');
    </script>
    <?
    exit();
  }
} else {  
  ?>
  <script type="text/javascript">
    window.parent.postMessage("<? print "ERRO¬Não foi possível enviar o anexo. Entre em contato com o SAC e informe [ROTINA ANEXO REL - Acesso Negado 4]¬¬"; ?>", '*');
  </script>
  <?
  exit();
}
?>