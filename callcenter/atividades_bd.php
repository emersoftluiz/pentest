<?
session_start();
session_register("session");
include "cc_libcallcenter.php";
include "cores.php";
require_once("funcoes/RotinasBD.php");
if (!isset($session)) {header ("Location:".HTTPHOST.DOCROOT."cc_login.php"); exit;}
require_once("/libs/ctr/AlarmeCTR.php");
require_once("/libs/ctr/RichText.php");

//showvars();
//exit;

$connect = ConnectDOCS();

if($acao == "COMPARTILHAR") {
  // print $funcionarios; exit;
  /*************************************************************************************/
  /************ Select para buscar a anotação a ser enviada/compartilhada **************/
  /*************************************************************************************/
  $q     = "SELECT tipo, nome, dados, representante, prioridade FROM tb_documentos_usuario WHERE seq = '".addslashes($seq_documento)."'";
  $query = DescExecQuery($q, $connect, "N");
  $rec   = mysql_fetch_assoc($query);

  $arr_separa_func = explode("§", $funcionarios);
  if(is_array($arr_separa_func) === true) {
    foreach ($arr_separa_func as $key => $value) {
      if($value) {
        $arr_func = explode("¢", $value);
        
        if ($arr_func[0]) {

          $matriz_operadores[]      = $arr_func[0];
          $matriz["login_operador"] = $arr_func[0];
          $matriz["tipo"]           = $rec["tipo"];
          $matriz["nome"]           = strtolower($rec["nome"]);
          $matriz["dados"]          = RichText::slashCode($rec["dados"]);
          $matriz["representante"]  = $session["representante"];
          $matriz["data_atualiza"]  = Date("Y-m-d");
          $matriz["hora_atualiza"]  = Date("H:i:s");
          $matriz["prioridade"]     = $rec["prioridade"];
          $matriz["data_cri"]       = Date("Y-m-d");
          $matriz["hora_cri"]       = Date("H:i:s");
          $matriz["login_cri"]      = $session["operador"];
          $matriz["compartilhado"]  = "S";

          /*************************************************************************************/
          /*************** Inserindo a nova anotação para o usuário selecionado ****************/
          /*************************************************************************************/
          $incluir = FazInsert($matriz,"tb_documentos_usuario",$connect);

          if ($incluir == "OK") {
          	$msg = "Anotação Enviada com Sucesso";
          } else {
            $msg = "Erro ao enviar a Anotação (".$incluir.")";
          }

        }

      }

    }

  }

  print $msg;

  /*************************************************************************************/
  /********* Enviando msg de alerta para os funcionários que receberam cópia ***********/
  /*************************************************************************************/
  $msg_alarme = "Nova anotação para você (IntergrALL Notes).<br><b>Enviado por:</b> ".NomeResumido($session["operador"])."<br><b>Assunto:</b> ".strtolower($rec["nome"])."";

  AlarmeCTR::setAlarmeIntegrAll($matriz_operadores,$msg_alarme,"N");

  exit;

}

$conteudo = RichText::slashCode($conteudo);

$matriz["login_operador"] = $session["operador"];
$matriz["tipo"]           = "ATIVIDADE";
$matriz["nome"]           = strtolower($resumo);
$matriz["dados"]          = $conteudo;
$matriz["representante"]  = $session["representante"];
$matriz["data_atualiza"]  = Date("Y-m-d");
$matriz["hora_atualiza"]  = Date("H:i:s");
$matriz["prioridade"]     = $prioridade;



$retorno = FazDelete("tb_documentos_usuario","WHERE login_operador = '".$matriz["login_operador"]."' AND status = 'S' AND data_atualiza < '".strftime("%Y-%m-%d",mktime(date("H"),date("i"),date("s"),date("m")-1,date("d"),date("Y")))."'",$connect);
if ($retorno != "OK") {
  ?>
  <script>alert("Erro ao deletar dados antigos!!");</script>
  <?
}

if($acao == "Incluir")  {

  $incluir = FazInsert($matriz,"tb_documentos_usuario",$connect);
  $nro_seq = mysql_insert_id($connect);

    if($incluir == "OK") {?>
        <script>
        parent.document.getElementById('id_grava_doc').style.display="none";
        parent.xajax_ListaAtividades(parent.document.getElementById('ordem_resumo').value,'');
        alert("Incluído com Sucesso");
        window.location = "atividades_det.php?seq=<?print $nro_seq?>&acao=Consultar";
        </script>
  <?} else {?>
        <script>
        alert("Erro ao Incluir - <?print $incluir?>");
        window.location = "atividades_det.php";
        </script>
  <?}

} elseif($acao == "Alterar") {

  $altera = FazUpdate($matriz,"tb_documentos_usuario","WHERE seq = '".$seq."'",$connect);

    if($altera == "OK") {?>
        <script>
        parent.document.getElementById('id_grava_doc').style.display="none";
        parent.xajax_ListaAtividades(parent.document.getElementById('ordem_resumo').value,'');
        alert("Alterado com Sucesso");
        window.location = "atividades_det.php?seq=<?print $seq?>&acao=Consultar";
        </script>
  <?} else {?>
        <script>
        alert("Erro ao Alterar - <?print $altera?>");
        window.location = "atividades_det.php?seq=<?print $seq?>&acao=Consultar";
        </script>
  <?}

}?>