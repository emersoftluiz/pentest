<?php
session_start();
session_register("session");
include "cc_libcallcenter.php";
if (!isset($session)) {header ("Location:".HTTPHOST.DOCROOT."cc_login.php"); exit;}

require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/func/ValidaVersao.php");
require_once($_SERVER['DOCUMENT_ROOT']."/libs/pst/DacNetPST.php");

if ($form_campos_mk) {
  $array_campos_mk = explode("&", $form_campos_mk);
  if (count($array_campos_mk) > 0) {
    foreach ($array_campos_mk as $i => $aux) {
      if (strpos($aux, "amp;") !== false) {
        $aux = str_replace("amp;", "", $aux);
      }
      $aux_array = explode("=", $aux);
      $form_mk[$aux_array[0]] = urldecode($aux_array[1]);
    }
  }
}

$usa_anexo_rotina_nova = DacNetPST::getParamURATF($_REQUEST['repre'], $_REQUEST['servico'], 'usa_anexo_rotina_nova', 'EFPAR');
if ($usa_anexo_rotina_nova == 'S') {
  //***************************************************************\\
  //* INI - VERIFICANDO SE FOI REALIZADO ALGUM UPLOAD DE ARQUIVOS *\\
  //***************************************************************\\
  unset($IAM_fixo_anexo_itgl);
  for ($i=1; $i <= $_POST['anexo_permissao_qtd_max']; $i++) {
    if ($_POST[$_POST['prefixo_anexo_relatorio'].$i] != '') {
      //TRATANDO O SEPARADOR DE HORA QUE VEM DO L:\callcenter\rotinas\RotinaAnexoUploadRelatorio.php PELO PADRÃO DO WORKFLOW ENQUANTO NÃO DEFINIMOS
      // $tmpArrAnexoUp[] = str_replace(':', '-', $_POST[$_POST['prefixo_anexo_relatorio'].$i]);
      $IAM_fixo_anexo_itgl .= $tmpDoc = str_replace(':', '-', $_POST[$_POST['prefixo_anexo_relatorio'].$i]).'?';

      if (empty($mk_flag) || empty($mk_numero)) {
        $tmpArqDoc = explode('*', $tmpDoc);
        $tmpInfoDoc = explode('|', $tmpArqDoc[1]);

        if (empty($mk_flag)) {
          $mk_flag = $tmpInfoDoc[3];
        }

        if (empty($mk_numero)) {
          $mk_numero = $tmpInfoDoc[4];
        }
      }
    }
  }

  if (empty($IAM_fixo_anexo_itgl) === false) {
    $IAM_fixo_anexo_itgl = substr($IAM_fixo_anexo_itgl, 0, -1);
    //SE CHEGOU NESTA CONDIÇÃO SIGNIFICA QUE ESTAMOS ALTERANDO O PADRÃO DE ENVIOS ANTIGO PELO NOVO
    //SENDO ASSIM, PRECISAMOS LIMPAR O $_FILES PARA CAIR NA CONDIÇÃO JÁ PREPARADA PARA O $IAM_fixo_anexo_itgl DENTRO DO
    //L:\callcenter\funcoes\ScriptInteligente.php
    unset($_FILES);
  }

  //***************************************************************\\
  //* FIM - VERIFICANDO SE FOI REALIZADO ALGUM UPLOAD DE ARQUIVOS *\\
  //***************************************************************\\
} else {
  //VERIFICAR SE FOI EFETUADO O UPLOAD DE TODOS OS ANEXOS
  $isError = false;

  if (count($_FILES) > 0) {
    if ($_FILES["anexo"]["error"] == 0) {
      if ($_FILES["anexo"]["size"] > 0) {
        $tmp_pos = strrpos($_FILES["anexo"]["name"], ".");
        $tmp_arq = substr($_FILES["anexo"]["name"], 0, $tmp_pos);
        $tmp_ext = substr($_FILES["anexo"]["name"], ($tmp_pos + 1));

        $arr_anexo["tipo"] = $_FILES["anexo"]["type"];
        $arr_anexo["nome"] = $tmp_arq;
        $arr_anexo["extensao"] = $tmp_ext;
        $arr_anexo["tamanho"] = $_FILES["anexo"]["size"];
        $arr_anexo["arquivo"] = $_FILES["anexo"]["tmp_name"];
      } else {
        //TAMANHO DO ARQUIVO NULO
        $isError = true;
        $msgError = "10";
      }
    } elseif ($_FILES["anexo"]["error"] == 1) {
      //O ARQUIVO NO UPLOAD É MAIOR DO QUE O LIMITE DEFINIDO EM UPLOAD_MAX_FILESIZE NO PHP.INI
      $isError = true;
      $msgError = "11";
    } elseif ($_FILES["anexo"]["error"] == 2) {
      //O ARQUIVO ULTRAPASSA O LIMITE DE TAMANHO EM MAX_FILE_SIZE QUE FOI ESPECIFICADO NO FORMULÁRIO HTML
      $isError = true;
      $msgError = "11";
    } elseif ($_FILES["anexo"]["error"] == 3) {
      //O UPLOAD DO ARQUIVO FOI FEITO PARCIALMENTE
      $isError = true;
      $msgError = "12";
    }
    if ($isError === false) {
      ${"param_mail_{$servico}"}['anexo_obrigatorio'] = ValorClasse('EFPAR', "{$servico}-EMAIL_ANEXO_OBRIGATORIO", $repre);
      if (trim(${"param_mail_{$servico}"}['anexo_obrigatorio']) == '--') {
        ${"param_mail_{$servico}"}['anexo_obrigatorio'] = ValorClasse('EFPAR', 'EMAIL_ANEXO_OBRIGATORIO', $repre);
        if (trim(${"param_mail_{$servico}"}['anexo_obrigatorio']) == '--') {
          ${"param_mail_{$servico}"}['anexo_obrigatorio'] = ValorClasse('EFPAR', 'EMAIL_ANEXO_OBRIGATORIO', 'URANET');
          if (trim(${"param_mail_{$servico}"}['anexo_obrigatorio']) == '--') {
            ${"param_mail_{$servico}"}['anexo_obrigatorio'] = 'SIM';
          }
        }
      }

      if (${"param_mail_{$servico}"}['anexo_obrigatorio'] == 'SIM') {
        if (count($arr_anexo) == 0) {
          $isError = true;
          $msgError = "13";
        }
      }
    }
  }
}

require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/ctr/RichText.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/callcenter/funcoes/IntergrAllMail.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/callcenter/funcoes/ScriptInteligente.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/ctr/Valida.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/ctr/MKParam.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/bd/Conexao.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/func/ValidaVersao.php");

try {
  //CONDIÇÃO EM QUE O ENVIO É REALIZADO VIA AÇÃO INTELIGENTE
  if (((empty($mk_flag) === false) && $mk_flag != 'FIXO' ) && (empty($mk_numero) === false)) {
    $arr_msg_pd = explode('¢', $msg_pd);
    $IAM_fixo_anexo_tmp = $fixo_anexo_tmp;

    $mk_numero = $mk_flag.$mk_numero;
    $grupo_email = $grupo = $servico;

    $assunto_email = $assunto;
    $conteudo_email = $conteudo;

    $arr_ori = explode("¢", $_POST["origem"]);

    $origem_email = $arr_ori[0];
    $nome_email = $arr_ori[1];
    $destino_email_copia = $_POST['cc'];//QUANDO NA TELA ESTÁ DISPONÍVEL A CÓPIA MAS O ENVIO É FEITO VIA ACAO_INTELIGENTE

    mostraRegraScript(DefineRepre($repre), $email_sigla_script . "¢" . $campo_chave_2 . "¢" . $arr_msg_pd[1], "EXEC_ACAO");
    $msg = $AI_email_msg;
    $mk_numero = substr($mk_numero, 2);

  } else {
    $obj_email = new IntergrAllMail();
    if ($_POST["tipo_arquivo"] == "M") {
      //ANEXO FIXO
      $grupo = $servico;
      $arr_msg_pd = explode("¢", $msg_pd);
      $conteudo_arr = mostraRegraScript(DefineRepre($repre), "ENMAI¢".$campo_chave_2."¢".$arr_msg_pd[1], "ARR");
      $pos_sel = array_search($arr_msg_pd[1], $arrayAISeqs);
      $conteudo = $conteudo_arr[$pos_sel];
      $str_anexo = $arrayAIaux1[$pos_sel];

      if (empty($str_anexo) === false) {
        $arr_anexo = explode(";", $str_anexo);
      }

      if (is_array($arr_anexo) === true) {
        $obj_email->tipo_arquivo  = "M";

        foreach ($arr_anexo as $i => $doc) {
          $obj_email->addAnexo($doc);
        }
      } else {
        $obj_email->tipo_arquivo  = "H";
      }

    } else if ($_POST["tipo_arquivo"] == "K") {
      //ANEXO MANUAL
      if ($usa_anexo_rotina_nova == 'S') {
        try {
          if (empty($IAM_fixo_anexo_itgl) === false) {
            $obj_email->tipo_arquivo = 'K';
            $arrPAramFixo = explode('.', $mk_numero);
            require_once($_SERVER['DOCUMENT_ROOT'].'/libs/bd/ConexaoBDADO.php');
            $conDocs = new ConexaoBDADO($arrPAramFixo[0]);
            if ($conDocs->status === false) {
              throw new Exception($conDocs->getDescRetorno()."({$arrPAramFixo[0]})");
            }

            $mkParam['tabela_documentos'] = $arrPAramFixo[1];

            $arr_tmp = explode('?', $IAM_fixo_anexo_itgl);
            foreach ($arr_tmp as $i => $str_anexo) {
              $arr_anexo = explode('*', $str_anexo);

              $arr_tmp2[$arr_anexo[0]] = explode(':', $arr_anexo[1]);
              foreach ($arr_tmp2[$arr_anexo[0]] as $i => $doc) {
                $doc = explode('|', $doc);
                if ($arr_anexo[0] == 'DocMK') {
                  $conDocs->query("SELECT tipo, nome, dados, arq_size FROM {$mkParam['tabela_documentos']} WHERE num = '{$doc[5]}'");
                  if ($conDocs->status === true) {
                    $obj_email->addAnexo($conDocs->result['nome'], 'Tabela', array(
                      'conteudo' => $conDocs->result['dados'],
                      'tamanho' => $conDocs->result['arq_size'],
                      'tipo' => $conDocs->result['tipo']
                    ));
                  }
                }
              }
            }
          } else {
            $obj_email->tipo_arquivo = 'H';
          }

        } catch (Exception $e) {
          print $e->getMessage();
          exit;
        }

      } else {
        if ((is_array($_FILES) === true) && (count($_FILES) > 0)) {
          $obj_email->tipo_arquivo = "K";
          foreach ($_FILES as $campo => $dados) {
            if ($dados["error"] != 0) {
              continue;
            }
            if ($dados["size"] == 0) {
              continue;
            }

            $obj_email->addAnexo($dados["name"], "Tabela", array(
              "conteudo" => file_get_contents($dados["tmp_name"]),
              "tamanho" => $dados["size"],
              "tipo" => $dados["type"]
            ));
          }
        } else {
          $obj_email->tipo_arquivo = "H";
        }
      }


    } else if (empty($fixo_anexo_tmp) === false) {
      require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/ConexaoDocumentos.php");
      $conDocs = new ConexaoDocumentos();

      //*****************************************************************\\
      //* INI - ROTINA QUE PERMITE O ENVIO DE APENAS 01 ARQUIVO POR VEZ *\\
      //*****************************************************************\\
      $arr_docs = explode(":", $fixo_anexo_tmp);
      $conDocs->query("SELECT * FROM tb_tmp_doc WHERE seq = '".$arr_docs[1]."'");
      if ($conDocs->count === 1) {
        $obj_email->tipo_arquivo = "K";

        $obj_email->addAnexo($conDocs->result["nome"].".".$conDocs->result["extensao"], "Tabela", array(
          "conteudo" => $conDocs->result["dados"],
          "tamanho" => $conDocs->result["tamanho"],
          "tipo" => $conDocs->result["tipo"]
        ));
      } else {
        $obj_email->tipo_arquivo = "H";
      }
      //*****************************************************************\\
      //* FIM - ROTINA QUE PERMITE O ENVIO DE APENAS 01 ARQUIVO POR VEZ *\\
      //*****************************************************************\\


      //**********************************************************\\
      //* INI - ROTINA QUE PERMITE O ENVIO DE MULTIPLOS ARQUIVOS *\\
      //**********************************************************\\
      //* DEVE SUBSTITUIR A ROTINA DE CIMA, MAS AINDA NÃO PODE SER
      //* DEVIDAMENTE TESTADO
      //**********************************************************\\
      //CÓDIGO A SER TESTADO PARA SITUAÇÕES DE ENVIO DE ANEXO MULTIPLO
      //USANDO "?" COMO SEPARADOR DE ARQUIVOS
      /*
      $arr_tmp1 = explode('?', $fixo_anexo_tmp);
      if (is_array($arr_tmp1)) {
        foreach($arr_tmp1 as $key => $arr_tmp2) {
          $arr_tmp3 = explode(':', $arr_tmp2);

          $conDocs->query("SELECT * FROM tb_tmp_doc WHERE seq = '{$arr_tmp3[1]}'");
          if ($conDocs->count === 1) {
            $obj_email->tipo_arquivo = 'K';

            $obj_email->addAnexo($conDocs->result['nome'].'.'.$conDocs->result['extensao'], 'Tabela', array(
              'conteudo' => $conDocs->result['dados'],
              'tamanho' => $conDocs->result['tamanho'],
              'tipo' => $conDocs->result['tipo']
            ));
          } else {
            $obj_email->tipo_arquivo = 'H';
          }
        }
      }
      */
      //**********************************************************\\
      //* FIM - ROTINA QUE PERMITE O ENVIO DE MULTIPLOS ARQUIVOS *\\
      //**********************************************************\\

    } else {
      $obj_email->tipo_arquivo = $_POST["tipo_arquivo"];
    }

    //************************************************************\\
    //* INI - PROCESSO DE ENVIO GENÉRICO PARA TODAS AS SITUAÇÕES *\\
    //************************************************************\\

    $arr_ori = explode("¢", $_POST["origem"]);

    $obj_email->data_agenda   = $_POST["ano_agenda"]."-".$_POST["mes_agenda"]."-".$_POST["dia_agenda"];
    $obj_email->hora_agenda   = $_POST["hor_agenda"].":".$_POST["min_agenda"].":00";
    $obj_email->hora_ini      = $_POST["hora_ini"];

    $obj_email->representante = $_POST["repre"];
    $obj_email->empresa       = $_POST["empresa"];
    $obj_email->mk_flag       = $_POST["mk_flag"];
    $obj_email->mk_numero     = $_POST["mk_numero"];
    $obj_email->grupo_acesso  = $_POST["grupo_acesso"];
    $obj_email->servico       = $_POST["servico"];
    $obj_email->campo_chave   = $_POST["campo_chave"];

    $obj_email->operador      = $session["operador"];
    $obj_email->ramal         = $session["ramal"];
    $obj_email->equipe        = $session["equipe"];

    $obj_email->origem_mail   = $arr_ori[0];
    $obj_email->origem_nome   = $arr_ori[1];

    $obj_email->destino_mail  = $_POST["destino"];
    $obj_email->destino_nome  = $_POST["destino"];

    $obj_email->cc_mail       = $_POST["cc"];
    $obj_email->cc_nome       = $_POST["cc"];

    $obj_email->cco_mail      = $_POST["cco"];
    $obj_email->cco_nome      = $_POST["cco"];

    $obj_email->assunto       = $_POST["assunto"];
    $obj_email->conteudo      = $conteudo;

    $msg = $obj_email->EnviaMail();

    if ($msg == "OK") {
      $id_retorno = $obj_email->RetornoMail();
    }
    unset($email);
    //************************************************************\\
    //* FIM - PROCESSO DE ENVIO GENÉRICO PARA TODAS AS SITUAÇÕES *\\
    //************************************************************\\
  }

} catch (Exception $e) {
?>
<div style="background-color:#dc3545; color:white; border-radius:3px; padding:5px; margin-bottom:10px;">Erro: <?= $e->getMessage(); ?></div>
<?php
exit;
}
?>
<html>
<head>
</head>
<body onload="javascript: document.form_volta.submit();">
<form name="form_volta" id="form_volta" method="POST" action="ia_mail3.php?<?print $_SERVER['QUERY_STRING'];?>">
<?
  if (substr($_GET['repre'], 0, 7) == 'HONDA-U' && $_GET['mk_flag'] == 'MD' && $_GET['mk_numero'] == 'BI' ) {
    if ( $_POST['doc_anexo'] == "NAS:kit_multimarcas_pessoa_fisica_alienado.pdf:fixo_mail:E050/"
      || $_POST['doc_anexo'] == "NAS:kit_multimarcas_pessoa_fisica_quitado.pdf:fixo_mail:E050/"
      || $_POST['doc_anexo'] == "NAS:kit_multimarcas_pessoa_juridica_alienado.pdf:fixo_mail:E050/"
      || $_POST['doc_anexo'] == "NAS:kit_multimarcas_pessoa_juridica_quitado.pdf:fixo_mail:E050/"
    ) {
?>

<script type="text/javascript">
  parent.opener.geraRegAtdAutoMultimarcas();
</script>
<?
    }
  }
?>

  <input type="hidden" name="msg" id="msg" value="<?print $msg;?>">
  <input type="hidden" name="msg_err" id="msg_err" value="<?print $msg_err;?>">
  <input type="hidden" name="tipo_popup" id="tipo_popup" value="<?print $tipo_popup;?>">
  <input type="hidden" name="form_campos_mk" id="form_campos_mk" value="<?print $form_campos_mk;?>">

<?
if (($tipo_popup == "AJ") || ($tipo_popup == "AJ2")) {
  ?>
  <input type="hidden" name="id_envio" id="id_envio" value="<?print $id_envio;?>">
  <?
  if ($msg == "OK") {
    ?>
    <input type="hidden" name="id_retorno" id="id_retorno" value="<?print $id_retorno;?>">
    <?
  }
}

if ($msg != "OK") {
  //NAO TROCAR AS ASPAS SIMPLES POR ASPAS DUPLAS NO CAMPO FIXO CONTEUDO
  ?>
  <input type="hidden" name="conteudo" value='<?
  if ($tipo_arquivo == "T") {
    print addslashes($conteudo);
  } else {
    print RichText::safeCode($_POST["conteudo"]);
  }
  ?>'>
  <?
  foreach ($_POST as $chave => $valor) {
    if (($chave != "conteudo") && ($chave != "tipo_popup") && ($chave != "msg")) {
      if (is_array($valor)) {
        foreach ($valor as $chave1 => $valor1) {
          ?>
          <input type="hidden" name="<?print $chave1;?>[]" value="<?print $valor1;?>">
          <?
        }

      } else {
        ?>
        <input type="hidden" name="<?print $chave;?>" value="<?print $valor;?>">
        <?
      }
    }
  }
}
?>
</form>

</body>
</html>