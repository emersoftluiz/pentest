<?
session_start();
session_register("session");
include "cc_libcallcenter.php";
include "cores.php";
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/mk_funcoes.php");
if (!isset($session)) {header ("Location:".HTTPHOST.DOCROOT."cc_login.php"); exit;}

$connect3 = ConnectAPOIO();
$connect  = ConnectDB();

if (strrpos($_GET["where"], '&lt;&gt;')) {
  $where = str_replace("&lt;&gt;", "<>", $_GET["where"]);
}


function VerificaTime($time, $segundos){
  if($time == "seg"){
    return $segundos;
  }else{
    return CalcTime($segundos);
  }
}

If ($StrDataInicio){
  $dia_ini = Substr($StrDataInicio,"8","2");
  $mes_ini = Substr($StrDataInicio,"5","2");
  $ano_ini = Substr($StrDataInicio,"0","4");

  $dia_fim = Substr($StrDataFim,"8","2");
  $mes_fim = Substr($StrDataFim,"5","2");
  $ano_fim = Substr($StrDataFim ,"0","4");


  $hora_ini = Substr($StrHoraInicio,"0","2");
  $min_ini  = Substr($StrHoraInicio,"3","5");


  $hora_fim = Substr($StrHoraFim,"0","2");
  $min_fim  = Substr($StrHoraFim,"3","5");

}else{
  $StrDataInicio = $ano_ini. '-' .$mes_ini.'-'.$dia_ini;
  $StrDataFim    = $ano_fim.'-'.$mes_fim.'-'.$dia_fim;

  $StrHoraInicio = $hora_ini.':'.$min_ini;
  $StrHoraFim    = $hora_fim.':'.$min_fim;
}

//Esta chamada à função ConnectLOGS tem que estar aqui devido às variáveis que ela utiliza
$connect2 = ConnectLOGS($repre, $ano_ini.$mes_ini);

//Verificando qual o programa que esta sendo executado e fazendo a suas arvores
switch($campo){
  case "det":
  $campo      = "num";
  $campo_prox = "";
  $campo_prox1= "";
  $prog_ant   = "dac_con_regiao.php";
  $prog_prox  = "";
  $titulo     = "Gravacao";
  $titulo1    = "Grupo";
  break;

  default:
  break;
}


//*************************************************************************************************
//************************************ ---- Preparando os Wheres ------ ***************************
//*************************************************************************************************

if (!$where) {

  $where = "Where ";


  //*************Preparando o where dos servicos selecionados*********
  $x = 0;

  While($s[$x]){
    if($x == "0"){
      $where = $where." nb in('".$s[$x]."'";
    }else{
      $where = $where.",'".$s[$x]."'";
    }
    $x++;
  }
  $where = $where.")";
  //******************************************************************

  if($StrDataInicio == $StrDataFim){
    $where = $where." AND data_ligacao = '".$StrDataInicio."'";
  }else{
    $where = $where." AND data_ligacao BETWEEN '".$StrDataInicio."' AND '".$StrDataFim."'";
  }
  if($StrHoraInicio != "00:00" || $StrHoraFim != "24:00"){
    $where = $where." AND hora_ligacao_ini BETWEEN '".$StrHoraInicio.":00' AND  '".CalculaDifSegundos($StrHoraFim.":00",1)."' ";
  }

  if($ramal){
    $where = $where." and ramal = '".$ramal."'  ";
  }
  if($login_operador){
    $where = $where." and login_operador = '".$login_operador."'  ";
  }
  if($hora_operador){
    $where = $where." and hora_ligacao = '".$hora_ligacao."'  ";
  }
  if($ddd){
    $where = $where." and ddd = '".$ddd."'  ";
  }
  if($tel_prefixo){
    $where = $where." and prefixo_telefone = '".$tel_prefixo."'  ";
  }
  if($tel_sufixo){
    $where = $where." and sufixo_telefone = '".$tel_sufixo."'  ";
  }


}else{

  // Solicitação - Inclusão do grupo URANB selecionado
  // No where de grupos

  $aux_where_nb = explode("nb in(", $where);
  $where_nb     = explode(")", $aux_where_nb[1]);

  if($where_nb[0]){
    $where_nb = $where_nb[0];
  }



  if($campo1 == "hora_ligacao_ini") {
    $var_campo1 =  "left(".$campo1.",2) as ".$campo1;
  }else{
    $var_campo1 = $campo1;
  }

  $where = str_replace("\'" , "'" ,$where);

  if ($campo_aux == "hora_minuto") {
    if ($vlr_campo1) {
      if(($campo_ant)) {
        if($campo_ant == "hora_ligacao_ini"){
            $where = $where."and ".str_replace("\'","'",$campo_ant)." like '".trim($vlr_campo)."%' ";
        }else{
          $where = $where."and ".str_replace("\'","'",$campo_ant)." = '".trim($vlr_campo)."' ";
        }
      }
    } else {
      $vlr_campo_aux = explode(":",$vlr_campo);
      $where = $where."and ".str_replace("\'","'",$campo_ant)." between '".$vlr_campo_aux[0].":".$vlr_campo_aux[1].":".trim($vlr_campo_aux[2])."' AND  '".$vlr_campo_aux[0].":".($vlr_campo_aux[1]+29).":".($vlr_campo_aux[2]+59)."'  ";
    }

  } else {
    if(($campo_ant)){
        if($campo_ant == "hora_operador_ini" || $campo_ant == "hora_ligacao_ini" || $campo_ant == 'varchar1'){
            $where = $where."and ".str_replace("\'","'",$campo_ant)." like '".trim($vlr_campo)."%' ";
        }elseif($campo_ant == "ura_navegacao"){
          $where = $where."and (".$campo_ant." like '%;".trim($vlr_campo).";%' || ".$campo_ant." like '%;".trim($vlr_campo)."'  || ".$campo_ant." like '".trim($vlr_campo).";%'  || ".$campo_ant." = '".trim($vlr_campo)."')";
        }else{
          $where = $where."and ".str_replace("\'","'",$campo_ant)." = '".trim($vlr_campo)."' ";
        }


    }
  }
//showvars();

  if ($campo_aux == "hora_minuto") {
    if ($vlr_campo1) {
      $vlr_campo1_aux = explode(":",$vlr_campo1);
      $where = $where."and ".str_replace("\'","'",$campo_ant1)." between '".$vlr_campo1_aux[0].":".$vlr_campo1_aux[1].":".trim($vlr_campo1_aux[2])."' AND  '".$vlr_campo1_aux[0].":".($vlr_campo1_aux[1]+29).":".($vlr_campo1_aux[2]+59)."'  ";
    }
  } else {
    if(($campo_ant1) && ($campo_ant1 != $campo_ant)){

        if($campo_ant1 == "ura_navegacao"){
          $where = $where."and (".$campo_ant1." like '%;".trim($vlr_campo1).";%' || ".$campo_ant1." like '%;".trim($vlr_campo1)."'  || ".$campo_ant1." like '".trim($vlr_campo1).";%'  || ".$campo_ant1." = '".trim($vlr_campo1)."')";
        }else{
          if (strpos("*".$campo_ant1, "ura_maquina") > 0) {
            $where = $where." AND ".str_replace("\'","'",$campo_ant1)." = '".trim($vlr_campo1)."'";
          }elseif($campo_ant1 == "data_ligacao") {
            $where = $where." AND ".str_replace("\'","'",$campo_ant1)." = '".trim($vlr_campo1)."'";
          }else{
            $where = $where." AND ".str_replace("\'","'",$campo_ant1)." LIKE '".trim($vlr_campo1)."%'";
          }
        }
    }
  }

}

if($filtro_adicional) {
	$array_filtros    = explode("¢A¢",$filtro_adicional);
	$where_filtro_add = " ";
	$string_passa_get = "&filtro_adicional=".$filtro_adicional;

	foreach($array_filtros as $chave => $valor){
		if($valor){
			$consulta_parametros = explode("§",$valor);

			$ajax_parametros_aux_cp = explode(",",$consulta_parametros[0]);
			$consulta_parametros[0] = $ajax_parametros_aux_cp[0];
		  $ajax_parametros_aux_cp = $ajax_parametros_aux_cp[1];

			$ajax_parametros_aux_tp = explode(",",$consulta_parametros[1]);
			$consulta_parametros[1]     = $ajax_parametros_aux_tp[0];
			$ajax_parametros_aux_tp = $ajax_parametros_aux_tp[1];

			$ajax_parametros_aux_cd = explode(",",$consulta_parametros[2]);
			$consulta_parametros[2]     = $ajax_parametros_aux_cd[0];
			$ajax_parametros_aux_cd = $ajax_parametros_aux_cd[1];

			$ajax_parametros_aux_td = explode(",",$consulta_parametros[3]);
			$consulta_parametros[3]     = $ajax_parametros_aux_td[0];
			$ajax_parametros_aux_td = $ajax_parametros_aux_td[1];

			$ajax_parametros_aux_cs = explode(",",$consulta_parametros[4]);
			$consulta_parametros[4]     = $ajax_parametros_aux_cs[0];
			$ajax_parametros_aux_cs = $ajax_parametros_aux_cs[1];

			$ajax_parametros_aux_st = explode(",",$consulta_parametros[5]);
			$consulta_parametros[5]     = $ajax_parametros_aux_st[0];
			$ajax_parametros_aux_st = $ajax_parametros_aux_st[1];

			$ajax_parametros_aux_wh = explode(",",$consulta_parametros[6]);
			$consulta_parametros[6]     = $ajax_parametros_aux_wh[0];
			$ajax_parametros_aux_wh = $ajax_parametros_aux_wh[1];

			if($consulta_parametros[6]){
			  $consulta_parametros[6] = str_replace("(A)","'",$consulta_parametros[6]);
			}

			if(is_array(${$consulta_parametros[0]."_filtro"})) {
				$in_multiplos = "";
				foreach(${$consulta_parametros[0]."_filtro"} as $chave_fil => $valor_fil){
          $string_passa_get .= "&".$consulta_parametros[0]."_filtro[".$chave_fil."]=".$valor_fil;
          if($valor_fil){
        	  $in_multiplos .= "'".$valor_fil."',";
        	}
				}
        $in_multiplos = substr($in_multiplos,0,-1);
				if($in_multiplos){
				  $where_filtro_add .= " AND ".$consulta_parametros[0]." IN (".$in_multiplos.") ".$consulta_parametros[6];
				}
			}else{
				if(strtoupper($consulta_parametros[2]) == "IGUAL") {
					$string_passa_get .= "&".$consulta_parametros[0]."_filtro=".${$consulta_parametros[0]."_filtro"};
					if (strpos("a".${$consulta_parametros[0]."_filtro"},"³£³") > 0) {
						$in_multiplos = "";
						$array_filtro_todos = explode("³£³",${$consulta_parametros[0]."_filtro"});
						foreach($array_filtro_todos as $chave_fil => $valor_fil){
							if($valor_fil){
								$in_multiplos .= "'".$valor_fil."',";
							}
						}

						$in_multiplos = substr($in_multiplos,0,-1);
						if($in_multiplos){
							$where_filtro_add .= " AND ".$consulta_parametros[0]." IN (".$in_multiplos.") ".$consulta_parametros[6];
						}
					}else{
				    $where_filtro_add .= " AND ".$consulta_parametros[0]." = '".${$consulta_parametros[0]."_filtro"}."' ".$consulta_parametros[6];
					}
				}elseif(strtoupper($consulta_parametros[2]) != "LIKE") {
				  switch ($consulta_parametros[2]) {
				  	case "MAIOR":
				  	  $campo_compara = ">";
				  		break;
				  	case "MENOR":
				  	  $campo_compara = "<";
				  		break;
				  }
				  $string_passa_get .= "&".$consulta_parametros[0]."_filtro=".${$consulta_parametros[0]."_filtro"};
				  $where_filtro_add .= " AND ".$consulta_parametros[0]." ".$campo_compara." '".${$consulta_parametros[0]."_filtro"}."' ".$consulta_parametros[6];
				}else{
				  $string_passa_get .= "&".$consulta_parametros[0]."_filtro=".${$consulta_parametros[0]."_filtro"};
				  $where_filtro_add .= " AND ".$consulta_parametros[0]." LIKE '%".${$consulta_parametros[0]."_filtro"}."%' ".$consulta_parametros[6];
				}
			}

		  if($ajax_parametros_aux_cp) {
  			if($ajax_parametros_aux_wh){
  			  $ajax_parametros_aux_wh = str_replace("(A)","'",$ajax_parametros_aux_wh);
  			}

				if(is_array(${$ajax_parametros_aux_cp."_filtro"})) {
					$in_multiplos = "";
					foreach(${$ajax_parametros_aux_cp."_filtro"} as $chave_fil => $valor_fil){
						$string_passa_get .= "&".$ajax_parametros_aux_cp."_filtro[".$chave_fil."]=".$valor_fil;
						if($valor_fil){
							$in_multiplos .= "'".$valor_fil."',";
						}
					}
					$in_multiplos = substr($in_multiplos,0,-1);
					if($in_multiplos){
						$where_filtro_add .= " AND ".$ajax_parametros_aux_cp." IN (".$in_multiplos.") ".$ajax_parametros_aux_wh;
					}
				}else{
					if(strtoupper($ajax_parametros_aux_cd) == "IGUAL") {
						$string_passa_get .= "&".$ajax_parametros_aux_cp."_filtro=".${$ajax_parametros_aux_cp."_filtro"};
						if (strpos("a".${$ajax_parametros_aux_cp."_filtro"},"³£³") > 0) {
							$in_multiplos = "";
							$array_filtro_todos = explode("³£³",${$ajax_parametros_aux_cp."_filtro"});
							foreach($array_filtro_todos as $chave_fil => $valor_fil){
								if($valor_fil){
									$in_multiplos .= "'".$valor_fil."',";
								}
							}

							$in_multiplos = substr($in_multiplos,0,-1);
							if($in_multiplos){
								$where_filtro_add .= " AND ".$ajax_parametros_aux_cp." IN (".$in_multiplos.") ".$ajax_parametros_aux_wh;
							}
						}else{
							$where_filtro_add .= " AND ".$ajax_parametros_aux_cp." = '".${$ajax_parametros_aux_cp."_filtro"}."' ".$ajax_parametros_aux_wh;
						}
					}elseif(strtoupper($ajax_parametros_aux_cd) != "LIKE") {
					  switch ($ajax_parametros_aux_cd) {
  				  	case "MAIOR":
  				  	  $campo_compara = ">";
  				  		break;
  				  	case "MENOR":
  				  	  $campo_compara = "<";
  				  		break;
  				  }
					  $where_filtro_add .= " AND ".$ajax_parametros_aux_cp." ".$campo_compara." '".${$ajax_parametros_aux_cp."_filtro"}."' ".$ajax_parametros_aux_wh;
					}else{
						$where_filtro_add .= " AND ".$ajax_parametros_aux_cp." LIKE '%".${$ajax_parametros_aux_cp."_filtro"}."%' ".$ajax_parametros_aux_wh;
					}
				}
			}
		}
	}
	$string_passa_get .= "&";

	//print "<li>***".$where_filtro_add;
  //print "<li>***".$string_passa_get;
}


$IntergrAllHeader = true;
require_once("funcoes/Paginador.php");
$paginacao =  "<div class='row gap-top15'>";
$paginacao.=  "  <div class='col-xs-12'>";
$ano_mes_ini = substr($ano_ini, 2, 2).$mes_ini;
$ano_mes_fim = substr($ano_fim, 2, 2).$mes_fim;
$ano_mes = $ano_mes_ini;

while($ano_mes <= $ano_mes_fim){
 $x = $x+0;
 $tabela_bd  = "logura".$ano_mes;
 $paginador[$ano_mes] = new Paginador($ano_mes, $tabela_bd, substr($where,5), $connect2); //funcao alterada não passa mais a bd_logs no parâmetro 4;
 $paginador[$ano_mes]->setTitulo("Ligações: ");
 $paginacao .= $paginador[$ano_mes]->tabelaPaginacao();
 if((!$primeiro_paginador_com_registros) && ($paginador[$ano_mes]->total_registros > 0)){
   $primeiro_paginador_com_registros = $ano_mes;
 }
 $ano_mes = inc_ano_mes($ano_mes);
}
$paginacao .= "</div>";
$paginacao .= "</div>";



$y = 0;



if(!$fi_id_atual){
  if($primeiro_paginador_com_registros){
    $ano_mes = $primeiro_paginador_com_registros;
  }else{
    $ano_mes = substr($ano_ini, 2, 2).$mes_ini;
  }
}else{
  $ano_mes = $fi_id_atual;
}




$x = $x+0;
$pag = ((int)$vlr_campo1-1)*(int)$tot_por_pagina;
$limite       = "LIMIT ".$pag.",".$tot_por_pagina;
$x = $x+0;
if($x <= 9){$x = "0".$x;}
if($vlr_campo < 10){
  $vlr_campo = ((int)$vlr_campo)+0;
  $vlr_campo = "0".$vlr_campo;
}

if(strpos("xxx".$where, "grupo =") <= 0) {
  $where_grupo.= ",'0000'";
  $arrGrupos = getArrayClasse("tb_classe", $connect, "descricao", "GRATE", $repre, "S", "ZZ");
  if(is_array($arrGrupos["itens"]) === true) {
    foreach ($arrGrupos["itens"] as $key => $value) {
      if($value["valor"]) {
        $qtdGrupo++;
        $where_grupo.= ",'".$value["valor"]."'";
      }
    }
  }

  if($where_nb && !is_array($where_nb)) {
    $where_grupo = " AND grupo IN (".substr($where_grupo,1).", ".$where_nb.")";
  } else{
    $where_grupo = " AND grupo IN (".substr($where_grupo,1).")";
  }
}

while($ano_mes <= $ano_mes_fim){

    $tabela_bd  = "logura".$ano_mes;

    $sql = "SELECT " . $campo . ",num,status_gravacao,ura_navegacao,midia_id,nb,grupo,ramal,login_operador,nome_maquina,ura_canal,".
    "data_ligacao,hora_ligacao_ini,hora_ligacao_fim,duracao_ligacao,duracao_fila,ddi,ddd,prefixo_telefone,".
    "sufixo_telefone,tipo_atendimento,tipo_ligacao,midia_id,nome_gravacao,numero_gravacao,id_lig, nome_fax, posicao_fila,equipe".
    " FROM ".$tabela_bd." ".$where.$where_grupo.$where_filtro_add." ORDER BY data_ligacao, hora_ligacao_ini ".$paginador[$ano_mes]->limit;
    $sql = DescQuery($sql,$session["operador"],$PHP_SELF);
    //print $sql;

    if($session["print_sql"] == "S"){
      print "<table><tr><td>".$sql."</td></tr></table>";
    }

    if  ($rec = mysql_query($sql, $connect2)){
      if($vlr = mysql_fetch_array($rec)){
        do{
          $vlr[$campo]  = completa($vlr[$campo],"10"," ","D");
          $tabela       = completa($tabela,"10"," ","D");
          $indice       = $vlr[$campo].$tabela;
          if((BuscaNaMatriz($matriz_aux['indice'] , $indice) == -1)) {
            $matriz_aux['indice'][$y]          = $indice;
            $matriz[$indice][$campo]         = $vlr[$campo];
            if($y> $tot_matriz){$tot_matriz  = $y;}
            $y++;
          }
          //print $y."<br>";
          $matriz[$indice]['num']                  = $vlr['num'];
          $matriz[$indice]['status_gravacao']      = $vlr['status_gravacao'];
          $matriz[$indice]['ura_navegacao']        = $vlr['ura_navegacao'];
          $matriz[$indice]['midia_id']             = $vlr['midia_id'];
          $matriz[$indice]['nb']                   = $vlr['nb'];
          $matriz[$indice]['grupo']                = $vlr['grupo'];
          $matriz[$indice]['ramal']                = $vlr['ramal'];
          $matriz[$indice]['agente']               = $vlr['login_operador'];
          $matriz[$indice]["nome_maquina"]       = $vlr["nome_maquina"];
          $matriz[$indice]["ura_canal"]          = $vlr["ura_canal"];
          $matriz[$indice]['data_ligacao']         = $vlr['data_ligacao'];
          $matriz[$indice]['hora_ligacao_ini']     = $vlr['hora_ligacao_ini'];
          $matriz[$indice]['hora_ligacao_fim']     = $vlr['hora_ligacao_fim'];
          $matriz[$indice]['duracao_ligacao']      = $vlr['duracao_ligacao'] ;
          $matriz[$indice]['ddd']                  = $vlr['ddd']             ;
          $matriz[$indice]['prefixo_telefone']     = $vlr['prefixo_telefone'];
          $matriz[$indice]['sufixo_telefone']      = $vlr['sufixo_telefone'] ;
          $matriz[$indice]['tipo_atendimento']     = $vlr['tipo_atendimento']    ;
          $matriz[$indice]['tipo_ligacao']         = $vlr['tipo_ligacao']    ;
          $matriz[$indice]['midia_id']             = $vlr['midia_id']        ;
          $matriz[$indice]['nome_gravacao']        = $vlr['nome_gravacao'] ;
          $matriz[$indice]['nome_fax']           = $vlr['nome_fax'] ;
          $matriz[$indice]['numero_gravacao']    = $vlr['numero_gravacao'] ;
          $matriz[$indice]['id_lig'         ]    = $vlr['id_lig'         ];
          $matriz[$indice]['ddi'            ]    = $vlr['ddi'            ];
          $matriz[$indice]['duracao_fila'   ]    = $vlr['duracao_fila'   ];
          $matriz[$indice]['posicao_fila'   ]    = $vlr['posicao_fila'   ];
          $matriz[$indice]['equipe'   ]          = $vlr['equipe'   ];

          $matriz['TOTAL']['qtd']                    += 1;
        }while($vlr  = mysql_fetch_array($rec));

      }else{
        $msg_nao_conectou =  $msg_nao_conectou."<center><font class='txtvermelho'>No mês ".$x." não existe Ligações<br>";
      }
    }else{
      if(strtoupper($session['tp_user']) == "ADM"){
        $msg_nao_conectou =  $msg_nao_conectou."<center><font class='txtvermelho'><b>No mês ".$x." não existe Tabela<br>";
      }else{
        $msg_nao_conectou =  $msg_nao_conectou."<center><font class='txtvermelho'><b>No mês ".$x." não existe Ligações<br>";
      }
    }

    $ano_mes = inc_ano_mes($ano_mes);

}

$vez_volta = $vez+1;
if($agt==1){
  $voltar = "javascript:window.location='relat_ligacoes_agente.php?carrega_dados=sim';";
}else{
  $voltar = "javascript:window.location='relat_ligacoes.php?carrega_dados=sim';";
}
$titulo = "Pesquisa Detalhada";

?>
<!DOCTYPE HTML>
<html>
  <head>
    <title><?php print $session["sistema"];?></title>
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <?print IntergrAllHeader();?>
    <script type="text/javascript" src="consistencia.js"></script>
    <script type="text/javascript" src="/js/montaDivPopUp.js"></script>

</head>
<body>
<div class="container">

<?print GerarCabecalho($voltar, $titulo, "", "", "F2");?>

<div class='row'>
  <?if($mes_ini){?>
    <?if($campo){?>
      <div class='col-xs-4'><b>Relatório:</b> <?=$titulo?></div>
    <?}?>

    <?if($StrHoraInicio){?>
      <div class='col-xs-4'><b>Entre as:   </b><?=$StrHoraInicio?><b> as: </b><?=$StrHoraFim?></div>
    <?}?>

    <?if($StrDataInicio){?>
      <div class='col-xs-4'><b>Período de: </b><?=BrDate($StrDataInicio)?><b> até: </b><?=BrDate($StrDataFim)?></div>
    <?}?>

    <?if($ddd){?>
      <div class='col-xs-4'><b>DDD: </b><?=$ddd?></div>
    <?}?>

    <?if($tel_prefixo || $tel_sufixo){?>
      <div class='col-xs-4'><b>Telefone: </b><?=$tel_prefixo?> - <?=$tel_sufixo?></div>
    <?}?>
  <?}?>

  <?
  $x=0;
  if($s[$x]){
    while($s[$x]){
      $s_passa.= $s[$x]." - ".ValorClasse("URANB",$s[$x],$repre)." | ";
      $x++;
    }
  }
  if($s || $s_passa){?>
    <div class='col-xs-12'><b>Serviço(s): </b><?=str_replace("|", "<i class='i-arrow-right-6 icon14 green'></i>", substr($s_passa,0,-2))?></div>
  <?}?>

</div>

<?print $paginacao;?>

<?

if(($vez != 1 && $troca != "sim") && ($y != "0")){
  $tabela_principal = "";
  $tabela_principal .= "  <table class='table table-small' id='tab_relatorio'>";
  $tabela_principal .= "    <thead>";
  $tabela_principal .= "    <tr class='bg-primary'>";
  $tabela_principal .= "     <th  colspan ='2'> </th>";
  $tabela_principal .= "     <th  colspan ='8'> </th>";
  $tabela_principal .= "     <th class='text-center' colspan ='2'>Fila ".$desc_campo1."  </th>";
if($_SESSION["session"]["representante"]== "URANET-TVO"){
  $tabela_principal .= "     <th class='text-center' colspan ='6'>Gravação               </th>";
} else {
  $tabela_principal .= "     <th class='text-center' colspan ='4'>Gravação               </th>";
}
  $tabela_principal .= "    </tr>";
  $tabela_principal .= "    <tr >";
  $tabela_principal .= "        <th nowrap class='text-center'>Serviço         </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Grupo           </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Ramal           </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Agente          </th>";
if($_SESSION["session"]["representante"]== "URANET-TVO"){
  $tabela_principal .= "        <th nowrap class='text-center'>Maquina   </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Canal      </th>";
}
  $tabela_principal .= "        <th nowrap class='text-center'>Dt. Ligação     </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Hr. Inicio      </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Hr. Fim         </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Duração         </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Telefone        </th>";
  if($deonde != "visao_personalizada"){
  $tabela_principal .= "        <th nowrap class='text-center'>Tipo Ligação    </th>";
  }
  $tabela_principal .= "        <th nowrap class='text-center'>Duração         </th>";
  $tabela_principal .= "        <th nowrap class='text-center'>Pos             </th>";
  $tabela_principal .= "        <th nowrap class='text-center' colspan='3'>Voz </th>";
  $tabela_principal .= "        <th nowrap class='text-center' >Fax             </th>";
  $tabela_principal .= "     </tr>";
  $tabela_principal .= "     </thead>";

  require_once("/libs/ctr/Formata.php");

  $tabela_principal .=  "      <tbody>";

  for($x = 0; $x <= $tot_matriz; $x++){
    $num_seq          = $matriz[$matriz_aux["indice"][$x]]["num"];
    $data_ligacao     = $matriz[$matriz_aux["indice"][$x]]["data_ligacao"];
    $ura_navegacao    = $matriz[$matriz_aux["indice"][$x]]["ura_navegacao"];
    $id_lig           = $matriz[$matriz_aux["indice"][$x]]["id_lig"];
    $duracao_fila     = $matriz[$matriz_aux["indice"][$x]]["duracao_fila"];
    $posicao_fila     = $matriz[$matriz_aux["indice"][$x]]["posicao_fila"];
    $nb               = $matriz[$matriz_aux["indice"][$x]]["nb"];
    $grupo            = $matriz[$matriz_aux["indice"][$x]]["grupo"];
    $ramal            = $matriz[$matriz_aux["indice"][$x]]["ramal"];
    $agente           = $matriz[$matriz_aux["indice"][$x]]["agente"];
    $nome_maquina     = $matriz[$matriz_aux["indice"][$x]]["nome_maquina"];
    $ura_canal        = $matriz[$matriz_aux["indice"][$x]]["ura_canal"];
    $status_gravacao  = $matriz[$matriz_aux["indice"][$x]]["status_gravacao"];
    $midia_id         = $matriz[$matriz_aux["indice"][$x]]["midia_id"];
    $numero_gravacao  = $matriz[$matriz_aux["indice"][$x]]["numero_gravacao"];
    $hora_ligacao_fim = $matriz[$matriz_aux["indice"][$x]]["hora_ligacao_fim"];
    $hora_ligacao_ini = $matriz[$matriz_aux["indice"][$x]]["hora_ligacao_ini"];
    $duracao_ligacao  = $matriz[$matriz_aux["indice"][$x]]["duracao_ligacao"];
    $nome_gravacao    = $matriz[$matriz_aux["indice"][$x]]["nome_gravacao"];
    $ddi              = $matriz[$matriz_aux["indice"][$x]]["ddi"];
    $nome_fax         = $matriz[$matriz_aux["indice"][$x]]["nome_fax"];

    $ddd_tel          = Formata::FoneDDI($matriz[$matriz_aux["indice"][$x]]["ddi"], $matriz[$matriz_aux["indice"][$x]]["ddd"],$matriz[$matriz_aux["indice"][$x]]["prefixo_telefone"].$matriz[$matriz_aux["indice"][$x]]["sufixo_telefone"]);
    if(trim($matriz[$matriz_aux["indice"][$x]]["tipo_atendimento"]) == "A"){
      $tipo_ligacao  = "Ativo - ".ValorClasse("URALA",$matriz[$matriz_aux["indice"][$x]]["tipo_ligacao"],$repre);
    }else{
      $tipo_ligacao  = "Receptivo - ".ValorClasse("URALR",$matriz[$matriz_aux["indice"][$x]]["tipo_ligacao"],$repre);
    }

    $tabela_principal.= "<tr title='".$tipo_ligacao."'>";
    $tabela_principal.= "  <td nowrap class='text-right'>";
    if(strtoupper($session["representante"]) == "URANET" || strtoupper($session["representante"]) == "URANET-TVO" || strtoupper($session["representante"]) == "URANET-TWE"){
      $servidor_deonde  = $_SERVER["SERVER_ADDR"];
			$ip_deonde        = $_SERVER["REMOTE_ADDR"];
			$diretorio_deonde = $_SERVER["SCRIPT_FILENAME"];
			$tabela_principal .= "             <a href=\"JavaScript:VisualizarTabela('".TRIM($num_seq)."', '".$tabela_bd."', 'num', 'LogUra', '".$servidor_deonde."', '".$ip_deonde."', '".$diretorio_deonde."')\">".$nb;
    }else{
      $tabela_principal .=  $nb;
    }
    $tabela_principal .=  "           &nbsp;</td>";
    $tabela_principal .=  "         <td nowrap class='text-right' >&nbsp; ". $grupo." &nbsp;</td>";
    $tabela_principal .=  "         <td nowrap class='text-right' >&nbsp; ". $ramal." &nbsp;</td>";
    $tabela_principal .=  "         <td nowrap>&nbsp; " . NomeResumido($agente) . "(" . $agente . ")&nbsp;</td>";

    if($_SESSION["session"]["representante"]== "URANET-TVO"){
      $tabela_principal .=  "         <td nowrap  >&nbsp; ". $nome_maquina."                   &nbsp;</td>";
      $tabela_principal .=  "         <td nowrap  >&nbsp; ". $ura_canal."                        &nbsp;</td>";
    }

    $tabela_principal .=  "         <td nowrap class='text-right' >&nbsp; ". BrDate($data_ligacao)."    &nbsp;</td>";
    $tabela_principal .=  "         <td nowrap class='text-right' >&nbsp; ". $hora_ligacao_ini."        &nbsp;</td>";
    $tabela_principal .=  "         <td nowrap class='text-right' >&nbsp; ". $hora_ligacao_fim."        &nbsp;</td>";
    $tabela_principal .=  "         <td nowrap class='text-right' >&nbsp; ". VerificaTime($time,$duracao_ligacao)."&nbsp;</td>";
    $tabela_principal .=  "         <td nowrap class='text-right' >&nbsp; ";
    if($ura_navegacao){
      if ($campo_ant == 'varchar1') {
        $pesquisaVarchar = $campo_ant;
      }

      $mku = MKUEncode("tabela=".$tabela_bd."&repre=".$repre."&time=".$time."&where=Where num=".$num_seq."&desc_campo=<br> ".$desc_campo."<b> -> Telefone:</b>".$ddd_tel."&titulo_ant=".$titulo."&monta_titulo=".$monta_titulo."&s_passa=".$s_passa."&StrDataInicio=".$StrDataInicio."&StrDataFim=".$StrDataFim."&StrHoraInicio=".$StrHoraInicio."&StrHoraFim=".$StrHoraFim."&tipo_nv=".$tipo_nv."&tipo_popup=AJ2&campo_ant=".$pesquisaVarchar);

      $tabela_principal .=  "<a href=\"javascript:abrePopUpModal('Detalhes da Ligação', 'relat_ligacoes_navegacao.php?mku=".$mku."', 'janNavLig', '750', '500', '');\">";
    }

    $tabela_principal .=  $ddd_tel ."</a>             &nbsp;</td>";
    if($deonde != "visao_personalizada"){
    $tabela_principal .=  "         <td nowrap   >&nbsp; ". $tipo_ligacao ."           &nbsp;</td>";
    }
    $mensagem = "Grupo: ".$grupo." - Agente: ".$agente." - ".NomeResumido($agente)." - Telefone: ".str_replace("&nbsp;", " ", $ddd_tel);
    $tabela_principal .=  "         <td nowrap align='center' > ".VerificaTime($time,$duracao_fila)." </font></td>";
    $tabela_principal .=  "         <td nowrap align='center' > ".$posicao_fila." </font></td>";

    $tipo = trim($matriz[$matriz_aux["indice"][$x]]["tipo_atendimento"]);

    $tabela_principal .=  "         <td nowrap align='center' colspan='2'>";
    $tabela_principal .=              IAPGravacao($nome_gravacao, "", $mensagem, "");
    $tabela_principal .=  "         </td>";
    $tabela_principal .=  "         <td nowrap align='center' colspan='2'>". IAPGravacao($nome_fax)."&nbsp;</td>";
    $tabela_principal .=  "      </tr>";
    $img = 0;
    $img1 = 0;
    $hora_ligacao_fim = 0 ;
    $hora_ligacao_ini = 0 ;
    $duracao_ligacao  = 0 ;
    $ddd_tel          = 0 ;
    $tipo_ligacao     = 0 ;
    $total_reg       += 1 ;
  }
  $tabela_principal .=  "      </tbody>";


  $tabela_principal .=  "      <tfoot>";
  $tabela_principal .=  "      <tr>";
  $tabela_principal .=  "         <td colspan ='12'  >&nbsp;  <b> TOTAL </b> &nbsp;</td>";
  if($_SESSION["session"]["representante"]== "URANET-TVO"){
    $tabela_principal .=  "         <td colspan ='6' class='text-right'>&nbsp; <b>  ". $total_reg." </b> &nbsp;</td>";
  } else {
    $tabela_principal .=  "         <td colspan ='4' class='text-right'>&nbsp;  <b> ". $total_reg." </b> &nbsp;</td>";
  }
  $tabela_principal .=  "      </tr>";
  $tabela_principal .=  "      </tfoot>";
  $tabela_principal .=  "   </table>";
  print $tabela_principal;

  ?>
  <div class='row gap-top5'>
    <div class='col-xs-12 text-center'>
      <i class='icon20 i-file-excel green cursor-pointer' title='Clique para abrir no Excel' onClick="exportarParaExcel('tab_relatorio');"></i>
      <i class='icon20 i-print cursor-pointer'            title='Clique para Imprimir'       onClick="imprimir_div('tab_relatorio');"></i>
    </div>
  </div>
  <?
}else{
}
?>

</div>

<script language="javascript" type="text/javascript" src="../js/relat_ligacoes.js"></script>

</body>
</html>
