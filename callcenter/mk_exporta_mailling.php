<?
//http://linux03/callcenter/mk_exporta_mailling.php?processo=AUTO&pref_arq=zurich_movto_atd_[yyyy][mm][dd]&classe_exporta=EXYQA&seq=3586&bat_seq=3586&bat_programa=MkExportaMailing&bat_pref_arq=zurich_movto_atd_[yyyy][mm][dd]&bat_campo_extra_2=30&teste=S
//http://linux03/callcenter/mk_exporta_mailling.php?processo=AUTO&pref_arq=vendas_HX_[yyyy][mm][dd]&classe_exporta=EXKJV&bat_seq=37410&teste=S
//http://linux03/callcenter/mk_exporta_mailling.php?processo=BATCH&seq=1&teste=S&debug=S
//http://linux03/callcenter/mk_exporta_mailling.php?processo=AUTO&bat_seq=5611&teste=S&debug=S

session_start();
session_register("session");
include "cc_libcallcenter.php";

require_once($_SERVER["DOCUMENT_ROOT"]."/libs/func/pidCtr.php");

require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/NCFuncoes.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/mk_exporta_dados_func.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/libs/func/String.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/libs/func/DateTime.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/RotinasBD.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/ProdFuncoes.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/mk_funcoes.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/libs/func/FTP.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/libs/ctr/Valida.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/libs/lang/tradutor.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/libs/func/Criptografia.php");
require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/ConexaoCallCenter.php");

require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/cc_define_sistema.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/libs/conf/DefineAmbiente.php");

//IPs que a rede Usuários chega na WebProc01
$_GLOBALS["arrIPsRedeUsu"] = array (
  "10.237.105.1",
  "10.235.0.111",  //Rede Usuários (pelo link intergrall.com.br)
);

$_GLOBALS["isProducao"  ] = (DefineAmbiente::getStrAmbiente() == "uracenter");
$_GLOBALS["isIPRedeUsu" ] = in_array($_SERVER["REMOTE_ADDR"], $_GLOBALS["arrIPsRedeUsu"]);

//$_GLOBALS["isProducao"  ] = true;
//$_GLOBALS["isIPRedeUsu" ] = true;

$IsExecURL = array_key_exists("bat_seq",$_GET);
//$_SESSION["session"]["deonde_login"] == ""

//IF de segurança para quando o robô for executado da Rede Usuários, pede confirmação do usuário
if ($_GLOBALS["isProducao"] && $_GLOBALS["isIPRedeUsu"] && $IsExecURL && !$_POST["_usuario_confirmou"]) {
  require_once($_SERVER["DOCUMENT_ROOT"]."/batch/mk_exporta_conf_exec.php");
  exit;
}

$objTradutor = new Tradutor($session["idioma"]);
$exTempoIni = microtime(true);

if ($_GET["teste"] == "S") {
  $_POST = $_GET;// para testes BAT
}


// Começar Aplicar o Novo Modelo de Conexão

$conexaoCallCenter = new ConexaoCallCenter();


if ($_POST["processo"] == "BATCH" || $_POST["processo"] == "AUTO" || $_GET['processo'] == "AT") {
  header("Content-Type: text/plain;");
} else {
  if (!isset($session)) {header ("Location:".HTTPHOST.DOCROOT."cc_login.php"); exit;}
}

//$intervalo_dt          = IsmkuDecode($intervalo_dt);
//$param_limit_dia       = IsmkuDecode($param_limit_dia);
$tipo_transf           = IsmkuDecode($tipo_transf);
$tipo_proc             = IsmkuDecode($tipo_proc);
$repre                 = IsmkuDecode($repre);
$repre_passa           = IsmkuDecode($repre_passa);
$discador_modelo_passa = IsmkuDecode($discador_modelo_passa);
$exportacao_passa      = IsmkuDecode($exportacao_passa);
$busca_direta          = IsmkuDecode($busca_direta);


if($_GET['processo'] == "AT"){
  if(empty($_GET['repre']) || empty($_GET['modelo']) || empty($_GET['classe_exportacao'])){
    print "[PARÂMETROS INVLIDOS][REPRE:{$_GET['repre']}][MODELO:{$_GET['modelo']}][CLASSE_EXPORTACAO:{$_GET['classe_exportacao']}]";
    exit;
  }else{
    $discador_modelo = $_GET['modelo'];
    $exportacao = $_GET['classe_exportacao'];
    $procura = "OK";
    $visualiza = "J";
  }
}

if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO" && $_GET["processo"] != "AT ") {
  require_once("/libs/func/MobileDetect.php");
  $detect = new MobileDetect();
  if ($detect->isMobile()) {
    $usa_bootstrap = true;
  }
  if($_SESSION["ssitgl_browser"] != "IE"){
    $usa_bootstrap = true;
  }
  if($_SESSION["ssitgl_browser"] == "IE" && $_SESSION["ssitgl_browser_versao"] >=10){
    $usa_bootstrap = true;
  }
} else {
  $usa_bootstrap = false;
}

//*********** teste carlos
// $usa_bootstrap = false;
//***********************

if ($usa_bootstrap == true) {
  $bgcolor_td_destaque  = "";
  $bgcolor_td_destaque1 = "";
  $bgcolor_td_dado1     = "";
  $bgcolor_td_dado2     = "";
  $bgcolor_td_dado3     = "";

  $txt6_titulo_table    = "";
  $txt6_corpo_table     = "";

  $txt5_titulo_table    = "";
  $txt5_corpo_table     = "";
  $class_table = " class='table table-striped table-bordered'";
} else {
  $bgcolor_td_destaque  = "bgcolor='".$session["td_destaque"]."'";
  $bgcolor_td_destaque1 = "bgcolor='".$session["td_destaque1"]."'";
  $bgcolor_td_dado1     = "bgcolor='".$session["td_dado1"]."'";
  $bgcolor_td_dado2     = "bgcolor='".$session["td_dado2"]."'";
  $bgcolor_td_dado3     = "bgcolor='".$session["td_dado3"]."'";

  $txt6_titulo_table    = "txt6";
  $txt6_corpo_table     = "txt6";

  $txt5_titulo_table    = "txt5";
  $txt5_corpo_table     = "txt5";
  $class_table = "";
}

$arrVars    = array();
$dthr_agora = date("Y-m-d H:i:s");
$dt_agora   = datetime_getDate($dthr_agora);
$hr_agora   = datetime_getTime($dthr_agora);

if ($_POST["processo"] == "BATCH" || $_POST["processo"] == "AUTO" || $_GET["processo"] == "AT") {
  ini_set("memory_limit", "150M");
  set_time_limit(1200);
} else {
  ini_set("memory_limit", "100M");
  set_time_limit(60);
  require_once($_SERVER["DOCUMENT_ROOT"]."/libs/ctr/xajax/xajax.inc.php");
}

if (trim($classe_menu) != "") {
  $busca_direta = "S";
  if ($repre_passa != "[SELECIONA]") {
    if ($repre_passa != "[SESSION]") {
      $repre = $repre_passa;
    } else {
      $repre       = $session["representante"];
      $repre_passa = $session["representante"];
    }
  }
} else {
  $busca_direta = "N";
}

$qtd_param_classe = 10;
$qtd_param_campo  = 10;
$qtd_param_update = 20;

$connect = ConnectDB();

//************************* Variaveis que vou passar *****************************

if ($_POST["processo"] == "BATCH") {

  if (empty($_POST["seq"]) || !is_numeric($_POST["seq"])) {
    print "NO ERRO NA PASSAGEM DOS PARÂMETROS<br>seq=".$_POST["seq"];
    exit;
  }

  if (empty($_POST["padrao_design"]) === false) {
    require_once("design/design_sessao_".$_POST["padrao_design"].".php");
  } else {
    $session["td_destaque"] = "#D0211E";
    $session["td_dado3"] = "#FFEAEA";
    $session["td_dado1"] = "#B5B5B5";
  }

  $q = "SELECT classe_exporta, script, representante,classe_mkpro,desc_campanha, representante,classe_mkpro,end_ftp,delimitador_campo, nome_arquivo FROM tb_mk_exp_sql WHERE seq = '".addslashes($_POST["seq"])."' AND status = 'P'";
  $query = DescExecQuery($q, ConnectSISTEMA(), "N");
  if ($rec = mysql_fetch_assoc($query)) {

    if (substr($rec["classe_exporta"],0, 2) == "DX") {
      $busca_direta = "S";
      $repre_passa  = $rec["representante"];
      $repre_param  = $repre_passa;
      $classe_menu  = $rec["classe_exporta"];
    }

    $repre                = $rec["representante"];
    $discador_modelo      = $rec["classe_mkpro"];
    $exportacao           = $rec["classe_exporta"];
    $session["print_sql"] = "N";
    $deondegta            = "gerenciador";
    $visualiza            = "A";
    $query_completa       = $rec["script"];
    $procura              = "OK";
    $delimitador          = $rec["delimitador_campo"];
    if ($delimitador == "T") {
      $delimitador = chr(9);
    }
    $nome_arquivo_auto    = $rec["nome_arquivo"];

    $q = "SELECT vlr_classe FROM tb_classe WHERE cod_classe = 'ADFTP' AND representante = 'URANET' AND tipo_reg = 'I' AND desc_classe = '".addslashes($rec["end_ftp"])."'";
    $query = DescExecQuery($q, $connect, "N");

    if ($rec = mysql_fetch_assoc($query)) {
      $aux = explode("¢",$rec["vlr_classe"]);

      $dadosFTP = array (
        "ftp_host"  => $aux[0],
        "ftp_porta" => $aux[1],
        "ftp_user"  => $aux[2],
        "ftp_pass"  => $aux[3],
        "ftp_dir"   => $aux[4],
      );
    }

  } else {

    $dados_exporta  = "<br><br>";
    $dados_exporta .= "<center><font class='txtvermelho'><strong>Nenhum parâmetro para ser executado</strong></font></center>";
    $dados_exporta .= "<br><br>";
    print $dados_exporta;
    exit;
  }

} elseif ($_POST["processo"] == "AUTO") {
  $busca_direta = "S";

  if (empty($_POST["bat_seq"]) === true) {
    print "ERRO NA PASSAGEM DOS PARÂMETROS - [seq - Batch Parâmetros (".$_POST["bat_seq"].")]";
    exit;
  }

  $q = "SELECT ".
          "seq             , pref_arq    , representante    , mk_flag , cod_discador , ".
          "ftp_host        , ftp_porta   , ftp_user         , ftp_pass, ftp_dir      , ".
          "ftp_protocolo   , prox_num_seq, ftp_max_tentativa, empresa , diretorio    , ".
          "pref_arq_cliente, ftp_passive , programa         , ftp_encriptacao        , ".
          "separador_arq   , ext_arq     , campo_extra_4    , ftp_intervalo_tentativa, ".
          "ftp_replicar    , ftp_versao_ssl ".
       "FROM tb_batch_param WHERE seq = '".addslashes($_POST["bat_seq"])."'";

  $query = DescExecQuery($q, ConnectSISTEMA(), "N");
  if ($rec = mysql_fetch_assoc($query)) {

    if (empty($rec["campo_extra_4"]) === true) {
      print "Classe Exporta não econtrada [campo_extra_4 - Batch Parâmetros]";
      exit;
    }

    $endftp["sql"] = $rec;

    $repre                = $rec["representante"];
    $discador_modelo      = $rec["mk_flag"].$rec["cod_discador"];
    $exportacao           = $rec["campo_extra_4"];//$_POST["classe_exporta"];
    $session["print_sql"] = "N";
    $deondegta            = "gerenciador";//[gerenciador]
    $visualiza            = "A";
    $procura              = "OK";
    $delimitador          = $rec["separador_arq"];
    if ($delimitador == "T") {
      $delimitador = chr(9);//TAB
    }
    $pref_arq             = $rec["pref_arq"];
    $pref_arq_cliente     = $rec["pref_arq_cliente"];
    $ext_arq              = $rec["ext_arq"];
    $prox_num_seq         = $rec["prox_num_seq"];

    $nome_arquivo_auto     = $pref_arq.'.'.$ext_arq;

    if ($pref_arq_cliente != "") {
      $nome_arquivo_cli_auto = $pref_arq_cliente.'.'.$ext_arq;
    }

    // if ($discador_modelo == "") {
    //   $dados_exporta = "Parâmetro Operação/Discador no SEQ `{$_POST["bat_seq"]}` não preenchido.";
    //   print $dados_exporta;
    //   exit;
    // }

  } else {
    print "Nenhum parâmetro encontrado para o SEQ `{$_POST["bat_seq"]}`";
    exit;
  }
}

//********************************************************************************

/*
// Reomovido pelo Carlos, por não saber o motivo dele esta nessa parte do COD.
if($repre_passa) {
  $repre = $repre_passa;
}
*/

if($discador_modelo_passa) {
  $discador_modelo = $discador_modelo_passa;
}

if($exportacao_passa) {
  $exportacao = $exportacao_passa;
}

if ($usa_ajax == "SIM") {

  if ($tp_exec == "MontaOrderBy") {

    if (trim($valor) != "") {
      $valor = utf8_decode($valor);
      //$valor = "<li> ".substr($valor, 1,strlen($valor)-2);
      $valor = substr($valor, 1,strlen($valor)-2);

      $montalistaorder = explode(",",$valor);
      $valor = "";
      $title = "";
      foreach ($montalistaorder as $key => $vlr) {
        $img_order = explode("-",$vlr);

        if ($img_order[1] != "" ) {
          if ($img_order[1] == "ordena_za.gif") {
            $title = "Do Maior para o Menor";
          } else if ($img_order[1] == "ordena_az.gif") {
            $title = "Do Menor para o Maior";
          }
          $imgtag = "&nbsp;<img align='absmiddle' vspace='0' src='imagens/".$img_order[1]."' title='".$title."'\">";
        }

        $valor .= $img_order[0].$imgtag.", ";
      }
      //$valor = "<li>".str_replace(",",", ",$valor);
      $valor = "<li>".substr($valor, 0,strlen($valor)-2);
    }
    print $valor;
    exit();
  }

  if($tp_exec == "MontaComboDepende"){
    switch ($condicao) {
      case 'tema_pai':
        $retorno = MontaCombo($_REQUEST["classe"],$_REQUEST["valorComboAux"],$_REQUEST["representante"]);
        ($_REQUEST["valorComboAux"] == "TODOS") ? $select = "selected" : $select = "";
        $retorno .= "<option value='TODOS' {$select} >TODOS</option>";
      break;

      case "filtro_tema_pai":
        if($vlrEscolhido != "TODOS"){
          $where_classe = "AND filtro_classe = '{$vlrEscolhido}'";
        }

        $retorno = MontaCombo($_REQUEST["classe"],$_REQUEST["valorComboAux"],$_REQUEST["representante"],"A", $where_classe);

        // $retorno = $_REQUEST;
      break;
    }
    print $retorno;

    exit();
  }

  if ($tp_exec == "INC") {

    $arrcargaauto = explode('¬', urldecode($carga_auto));
    carregaArrParam($arrcargaauto[1]."A", "URANET");
    carregaArrParam($arrcargaauto[1]."B", "URANET");

    $arrI = array (
      "classe_exporta"    => $exportacao,
      "banco_dados"       => urldecode($bdado),
      "dthr_agenda"       => date("Y-m-d")." ".date("H:i:s"),
      "script"            => addslashes(urldecode($query)),
      "status"            => "U",
      "data_cri"          => date("Y-m-d"),
      "hora_cri"          => date("H:i:s"),
      "login_cri"         => $session['operador'],
      "delimitador_campo" => urldecode($delimitador),
      "classe_mkpro"      => $arrcargaauto[1],
      "end_ftp"           => $extracao_ftp,
      "representante"     => $repre,
      "empresa"           => $mkParam["param_empresa"],
      "campanha"          => $Camp,
      "desc_campanha"     => $DesCamp,
      'filtro'            => $filtro
    );

    if ($Visualiza == "F") {
      $arrI["tipo_script"] = "arquivo_automatico";
    } else {
      $arrI["tipo_script"] = strtolower($exportacao).$arrcargaauto[0];
    }

    unset($mkParam);

    $idFazInsert = true;
    $MsgAux = FazInsert($arrI, "tb_mk_exp_sql", ConnectSISTEMA());

    if (strpos(" ".$MsgAux, "ERRO:") > 0) {
      print "<font color=red><li>".$MsgAux.".</li></font>";
      exit();
    }

    $nome_arquivo = urldecode($param_arquivo);
    $faz_update["nome_arquivo"] = substr($nome_arquivo, 0, -4)."_".$idFazInsert.substr($nome_arquivo, -4);
    $pos2 = FazUpdate($faz_update, "tb_mk_exp_sql", "WHERE seq = '".$idFazInsert."'", ConnectSISTEMA());

    $dados_exporta.= " <script>";
    $dados_exporta.= "AgendarExtracaoAuto('".$repre."','EXI', '".$carga_auto."', '".$tot."', '".$exportacao."', '".$bdado."', '".$query."','".$Camp."','".$DesCamp."', '".$Visualiza."', '".$extracao_ftp."','".$param_arquivo."','".$delimitador."')";
    $dados_exporta.= "</script>";

  } else {
    if ($Visualiza == "F") {
      $tipo_script = " AND tipo_script = 'arquivo_automatico' ";
    } else {
      $tipo_script = " AND tipo_script <> 'arquivo_automatico' ";
    }

    $arrcargaauto = explode('¬',  urldecode($carga_auto));

     if (trim($arrcargaauto[0]) == "" && $Visualiza != "F") {

       $dados_exporta  = "<br><br>";
       $dados_exporta .= "<center><font class='txtvermelho'><strong>Parâmetro carga_auto não cadastrado (".$exportacao.")</strong></font></center>";
       $dados_exporta .= "<br><br>";

     } elseif (Trim($arrcargaauto[1]) == "" && $Visualiza != "F") {
       $dados_exporta  = "<br><br>";
       $dados_exporta .= "<center><font class='txtvermelho'><strong>Parâmetro do carga_auto¬[Destino do mailing] não cadastrado (".$exportacao.")</strong></font></center>";
       $dados_exporta .= "<br><br>";
     } else {

      $dados_exporta = "<table ".$class_table." width='40%' style='border-collapse:collapse;' bordercolor='".$session["td_destaque"]."' border='1' cellpadding='0' cellspacing='1' align='center' >";
      $dados_exporta.= "  <tr ".$bgcolor_td_destaque.">";

      if ($Visualiza != "F") {
        $dados_exporta.= "    <td colspan='2' align='center'><font class='txt6'><strong>Carga de mailing automática</strong></font>";
      } else {
        $dados_exporta.= "    <td colspan='2' align='center'><font class='txt6'><strong>Extração de Arquivo</strong></font>";
      }
      $dados_exporta.= "      &nbsp;";
      $dados_exporta.= "    </td>";
      $dados_exporta.= "  </tr>";

      $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
      $dados_exporta.= "    <td colspan='2' align='left'><font class='txt5'>";
      $dados_exporta.= "      <li><strong>(".$tot.")</strong> registros encontrados com o filtro abaixo.</font>";
      $dados_exporta.= "    </td>";
      $dados_exporta.= "  </tr>";

      if ($tot != 0) {

        if ($Visualiza != "F") {
          $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
          $dados_exporta.= "    <td colspan='2' align='left'><font class='txt5'>";
          $dados_exporta.= "      <li><strong>Destino do mailing:</strong> (".ValorClasse(substr($arrcargaauto[1],0,2)."PRO",substr($arrcargaauto[1],2,2),"URANET").")</font>";
          $dados_exporta.= "    </td>";
          $dados_exporta.= "  </tr>";
        }

      $q2 = "SELECT data_cri,hora_cri,login_cri,campanha,desc_campanha, representante,classe_mkpro, nome_arquivo,status FROM tb_mk_exp_sql WHERE classe_exporta = '".addslashes($exportacao)."' AND status IN ('U','P') ".$tipo_script;
      $query2 = DescExecQuery($q2, ConnectSISTEMA(), $session["print_sql"]);

      if (!$rec2 = mysql_fetch_assoc($query2)) {
         if ($Visualiza != "F") {
           $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
           $dados_exporta.= "    <td colspan='2' align='left'><font class='txt5'>";

           if ($Camp == "") {
             $MsgAux = " <li><strong>Selecione a Campanha: </strong>";
           } elseif ($Camp != "NOVO") {
             $MsgAux = " <li><strong>Campanha: </strong> (".ValorClasse("DK".substr($arrcargaauto[1],2,2)."C", $Camp, $repre).")";
           } else {
             $MsgAux = " <li><strong>Campanha Nova:</strong> [".$DesCamp."]";
           }
           $dados_exporta.= $MsgAux."</font> <img align='absmiddle' vspace='0' src='imagens/ico_add.gif' style='cursor:pointer;' title='Selecionar Campanha' onClick=\"chamaPopUpDiv('".$repre."', 'INC','".$carga_auto."', '".$tot."', '".$exportacao."', '".$bdado."', '".$query."');\">";
           $dados_exporta.= "    </td>";
           $dados_exporta.= "  </tr>";
         }

        $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
        $dados_exporta.= "    <td align='left'><font class='txt5'>";
        $dados_exporta.= "      <li><strong>Gerar Arquivo:</font>";
        $dados_exporta.= "    </td>";
        if ($tot != 0) {
          $dados_exporta.= "    <td align='center'>";
          $dados_exporta.= "      <input type='button' name='agendar' value='Gerar' onclick=\"AgendarExtracaoAuto('".$repre."' ,'INC'  ,'".$carga_auto."', '".$tot."', '".$exportacao."', '".$bdado."', '".$query."', document.getElementById('id_camapanha').value, document.getElementById('id_desc_camapanha').value, '".$Visualiza."','".$extracao_ftp."','".$param_arquivo."',document.getElementById('id_delimitador').value)\" class='but_proc_on'>";
          $dados_exporta.= "    </td>";
          $dados_exporta.= "  </tr>";
        }
      } else {
        if ($Visualiza != "F") {
          $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
          $dados_exporta.= "    <td colspan='2' align='left'><font class='txt5'>";

          if ($rec2["campanha"] == "") {
            $MsgAux = " <li><strong>Selecione a Campanha: </strong>";
          } elseif ($rec2["campanha"] != "NOVO") {
            $MsgAux = " <li><strong>Campanha: </strong> (".ValorClasse($rec2["classe_mkpro"]."C", $rec2["campanha"], $rec2["representante"]).")";
          } else {
            $MsgAux = " <li><strong>Campanha Nova:</strong> [".$rec2["desc_campanha"]."]";
          }
          $dados_exporta.= $MsgAux."</font>";
          $dados_exporta.= "    </td>";
          $dados_exporta.= "  </tr>";
          if ($rec2["status"] == "U") {
            $msgaux = "<strong><font class='txt5azul'><strong>Aguardando execução automática</font>";
          } else {
            $msgaux = "<strong><font class='txt5azul'><strong>Executando a carregando do mailing...</font>";
          }
        } else {
          if ($rec2["status"] == "U") {
            $msgaux = "<strong><font class='txt5azul'><strong> Aguardando execução do arquivo [".$rec2["nome_arquivo"]."]</font>";
          } else {
            $msgaux = "<strong><font class='txt5azul'><strong>Arquivo [".$rec2["nome_arquivo"]."] em execução. Aguarde!</font>";
          }
        }
        $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
        $dados_exporta.= "    <td nowrap align='left'>";
        $dados_exporta.= "      <li>".$msgaux;
        $dados_exporta.= "    </td>";

        $dados_exporta.= "    <td nowrap align='left'>";
        $dados_exporta.= "      <img align='absmiddle' vspace='0' onclick=\"AgendarExtracaoAuto('".$repre."' ,'EXI'  ,'".$carga_auto."', '".$tot."', '".$exportacao."', '".$bdado."', '".$query."', document.getElementById('id_camapanha').value, document.getElementById('id_desc_camapanha').value, '".$Visualiza."','".$extracao_ftp."','".$param_arquivo."',document.getElementById('id_delimitador').value)\" border='0' width='25' height='28' src='imagens/v2/atualizar_off.gif' onmouseover=\"javascript: this.style.cursor='pointer'; this.style.cursor='hand';\" onmouseout=\"javascript: this.style.cursor='default';\" title='Clique para atualizar'>";
        $dados_exporta.= "    </td>";

        $dados_exporta.= "  </tr>";

        // $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
        // $dados_exporta.= "    <td nowrap colspan='2' align='left'>";
        // $dados_exporta.= "      <li><strong><font class='txt5'><strong>Solicitante:</strong> ".NomeResumido($rec2["login_cri"])." (".$rec2["login_cri"].") - ".BRDATE($rec2["data_cri"])." - ".$rec2["hora_cri"]."</font>";
        // $dados_exporta.= "    </td>";
        // $dados_exporta.= "  </tr>";
      }

      $q2 = "SELECT seq,data_cri,hora_cri,login_cri, nome_arquivo FROM tb_mk_exp_sql WHERE classe_exporta = '".addslashes($exportacao)."' AND status = 'T' ".$tipo_script." ORDER BY data_cri DESC, hora_cri DESC LIMIT 1";
      $query2 = DescExecQuery($q2, ConnectSISTEMA(), $session["print_sql"]);
      if ($rec2 = mysql_fetch_assoc($query2)) {
        if ($Visualiza == "F") {
          $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
          $dados_exporta.= "    <td nowrap align='left'><font class='txt5'>";
          $dados_exporta.= "      <li><strong>Último arquivo gerado:</strong></font><font class='txt5verde'> ".$rec2["nome_arquivo"]."</font>";
          $dados_exporta.= "    </td>";

          $dados_exporta.= "    <td nowrap align='center'>";
          $dados_exporta.= "      <img align='absmiddle' vspace='0' border='0' width='19' height='20' src='imagens/download.gif' onclick=\"AbreJanela('mk_exporta_mailing_ftp.php?repre=URANET&paramftp=".$extracao_ftp."&seq=".$rec2["seq"]."&login=".$session["operador"]."','frmDownload', '0', '0')\"  onmouseover=\"javascript: this.style.cursor='pointer'; this.style.cursor='hand';\" onmouseout=\"javascript: this.style.cursor='default';\" title='Download do Arquivo'>";
          $dados_exporta.= "    </td>";
          $dados_exporta.= "  </tr>";
        }

        // $dados_exporta.= "  <tr ".$bgcolor_td_dado3.">";
        // $dados_exporta.= "    <td colspan='2' align='left'><font class='txt5'>";
        // $dados_exporta.= "      <li><strong>Última solicitação:</strong> ".NomeResumido($rec2["login_cri"])." (".$rec2["login_cri"].") - ".BRDATE($rec2["data_cri"])." - ".$rec2["hora_cri"]."</font>";
        // $dados_exporta.= "    </td>";
        // $dados_exporta.= "  </tr>";
      }

      $dados_exporta.= "</table>";
      }
     }
   }

   print $dados_exporta;
   exit();
}

// ESTRUTURA E VALIDAÇÃO FILTRO COM CAMPOS JSON


if($_GET["processo"] == "AT"){

  if(isset($_GET['data_filtro']) && empty($_GET['data_filtro']) == false){

    $action_processo_at = "";

    if(empty($_GET['data_filtro']) === true){
      print "Filtro por data Inválido";
      exit;
    }

    // if(empty($_GET['campo_filtro'])) {
    //   print "Nome do Campo Inválido";
    //   exit;
    // }

    // $campo_filtro = (string) $_GET['campo_filtro'];

    $datas_filtro = explode("|",$_GET['data_filtro']);

    $data_filtro1 = $datas_filtro[0];
    $data_filtro2 = $datas_filtro[1];


    if((is_valid_date($data_filtro1) == false && is_valid_date_time($data_filtro1) == false)){
      print "Data/Hora inválida: {$data_filtro1}";
      exit;
    }

    if(empty($data_filtro2) == true){

      $ano_mes = getAnoMesRes($data_filtro1);

      $action_processo_at = "ANO_MES";

    }else{


      if(is_valid_date($data_filtro1) && is_valid_date($data_filtro2)){

        // $campo_data = $_GET['campo_filtro'];

        $data1 = anyDateToArray($data_filtro1);
        $data2 = anyDateToArray($data_filtro2);

        // USADA NA QUERY FINAL
        $data_ini_AT = $data_filtro1;
        $data_fim_AT = $data_filtro2;

        // DADOS PARA O PROGRAMA
        $ano_mes = getAnoMesRes($data_filtro1);
        $dia_ini =  $data1['dia'];
        $mes_ini =  $data2['mes'];
        $ano_ini =  $data1['ano'];
        $dia_fim =  $data2['dia'];
        $mes_fim =  $data2['mes'];
        $ano_fim =  $data2['ano'];

        $action_processo_at = "DATE";

      }else if(is_valid_date_time($data_filtro1) && is_valid_date_time($data_filtro2)){

        // $campo_filtro2 = explode('|',$_GET['campo_filtro']);

        // if(empty($campo_filtro2[1]) === true){
        //   print "Campo Hora Não passado";
        //   exit;
        // }

        // $campo_data = $campo_filtro2[0];
        // $campo_time = $campo_filtro2[1];

        $soData1 = datetime_getDate($data_filtro1);
        $soData2 = datetime_getDate($data_filtro2);

        $soTime1 = datetime_getTime($data_filtro1);
        $soTime2 = datetime_getTime($data_filtro2);

        // USADA NA QUERY FINAL
        $data_ini_AT = $soData1;
        $data_fim_AT = $soData2;

        $time_ini_AT = $soTime1;
        $time_fim_AT = $soTime2;

        // INI - DADOS PARA O PROGRAMA
        $ano_mes_AT = getAnoMesRes($soData1);
        $AnoMesAux = getAnoMes($soData1);
        $ano_mes = getAnoMes($soData1);



        $dia_ini =  $data1['dia'];
        $mes_ini =  $data2['mes'];
        $ano_ini =  $data1['ano'];
        $dia_fim =  $data2['dia'];
        $mes_fim =  $data2['mes'];
        $ano_fim =  $data2['ano'];


        $time1 = explode(":",$soTime1);
        $time2 = explode(":",$soTime2);

        $hora_ini = "{$time1[0]}:{$time1[1]}";
        $hora_fim = "{$time2[0]}:{$time2[1]}";

        $c_hora_ini = $time1[0];
        $c_mim_ini = $time1[1];

        $c_hora_fim = $time2[0];
        $c_mim_fim = $time2[1];

        // FIM - DADOS PARA O PROGRAMA


        $action_processo_at = "DATETIME";

      }else{
        print "Data/Hora inválida";
        exit;
      }

    }

  }

  $conexaoCallCenter->query("SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = '{$exportacao}' AND representante = '{$repre_param}' AND status = 'A' AND vlr_classe LIKE ('SELECAO_CLASSE_%') AND tipo_reg = 'I' ORDER BY vlr_classe");

  if($conexaoCallCenter->status === false){
    print $conexaoCallCenter->error;
    exit;
  }

  if($conexaoCallCenter->count > 0){


    if(empty($_GET['filtro'])){
      print "Filtro inválido ou inexistente";
      exit;
    }

    $campo_nr = 0;
    do{
      $campo = explode("¬",$conexaoCallCenter->result['desc_classe']);
      $campo_nome = $campo[0];

      $campos_GET = explode("|",$_GET['filtro']);

      // if(!$campos_GET[$campo_nr]){
      //   print "FILTRO \"{$campo_nome}\" invalido";
      //   exit;
      // }

      $campo_nr_vlr = str_pad(($campo_nr + 1), 2, "0", STR_PAD_LEFT);

      $auxVar = "CL_selecao_classe_{$campo_nr_vlr}";

      $$auxVar = $campos_GET[$campo_nr];

      $campo_nr++;
    }while($conexaoCallCenter->getFetchAssoc());
  }
}

if (($discador_modelo) || ($busca_direta == "S")) {

  if ($visualiza == "F") {
    $carga_auto = '¬'.$discador_modelo;
  }

  $classe_con = $discador_modelo."A";
  $nromodelo  = substr($discador_modelo, 2, 2);

  if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO") {

    if ($busca_direta == "S") {
      $classe_k = $classe_menu;
    } else {
      $classe_k = "EX".$nromodelo."K";
    }

    $q = "SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = '".addslashes($classe_k)."' AND representante = '".addslashes($repre)."' and status = 'A' and tipo_reg = 'T'";
    $query = DescExecQuery($q, $connect, "N");
    if ($rec = mysql_fetch_assoc($query)) {
      $TemExportacao = "OK";
    } else {
      $q     = "SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = '".addslashes($classe_k)."' AND representante = 'URANET' and status = 'A' and tipo_reg = 'T'";
      $query = DescExecQuery($q, $connect, "N");
      if ($rec = mysql_fetch_assoc($query)) {
        $TemExportacao = "OK";
      } else {
        $TemExportacao = "NO";
        //$exportacao    = "EX".$nromodelo.substr($discador_modelo, 0, 1);
        $exportacao = $classe_k;
      }
    }
  } else {
    $TemExportacao = "OK";
  }

  if ($exportacao != "") {

    $q     = "SELECT '1',vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = '".addslashes($exportacao)."' AND representante = '".addslashes($repre)."' and status = 'A' and tipo_reg = 'T'";
    $query = DescExecQuery($q, $connect, "N");
    if (!$rec = mysql_fetch_assoc($query)) {
      $q     = "SELECT '2', vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = '".addslashes($exportacao)."' AND representante = 'URANET' and status = 'A' and tipo_reg = 'T'";
      $query = DescExecQuery($q, $connect, "N");
      if (!$rec = mysql_fetch_assoc($query)) {
        $possui_layout = "NO";
      } else {
        $repre_param = "URANET";
      }

    } else {
      $repre_param = $repre;
    }

    $titulo_exportacao = $rec["desc_classe"];

    $q = "SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = '".addslashes($exportacao)."' AND representante = '".addslashes($repre_param)."' and status = 'A' AND tipo_reg = 'I' AND (vlr_classe NOT LIKE 'campo_%' AND vlr_classe NOT LIKE 'header_%' AND vlr_classe NOT LIKE 'trailler_%') ORDER BY vlr_classe ";
    $tem_help = false;
    $query = DescExecQuery($q, $connect, "N");

    while ($rec = mysql_fetch_assoc($query)) {
      $nome_param  = strtolower($rec["vlr_classe"]);

      if (substr($nome_param,0,5) == "help_") {
        $tem_help = true;
        continue;
      }

      if ($nome_param == "tabela") {
        $nome_param = "param_tabela";
      }

      if (substr($nome_param,0,17) == "agrupa_coluna_tit") {
        $arr_tit[$nome_param] = $rec["desc_classe"];
        continue;
      }

      if (substr($nome_param, 0, 6) == "where_") {//se for where_ concatena no parametro where (WHERE WHERE_02 WHERE_03 ......)
        $where .= " ".$rec["desc_classe"];
        continue;
      }

      if (substr($nome_param, 0, 9) == "wherebat_") {//se for wherebat_ concatena no parametro where (WHEREBAT WHEREBAT_02 WHEREBAT_03 ......)
        $wherebat .= " ".$rec["desc_classe"];
        continue;
      }

      if (substr($nome_param, 0, 4) == "var_") {
        list($nome_var, $tipo, $expressao) = explode("¬", $rec["desc_classe"]);

        $arrVars[] = array(
          "nome_var" => $nome_var,
          "tipo" => $tipo,
          "expressao" => $expressao,
          "vlr" => "",
        );
      }

      $$nome_param = $rec["desc_classe"];//faz o que fazia antes
    }

    $relatorio = strtolower($relatorio);
    if ($relatorio == "") {
      $relatorio  = "excel¢txt¢ftp";
    }

    if ($visualiza == "") {
      $primeiraOpcao = PositionField($relatorio, "¢", 1);

      switch ($primeiraOpcao) {
      case "excel":
        $visualiza = "T";
        break;
      case "json":
        $visualiza = "J";
        break;
      case "ftp":
        $visualiza = "F";
        break;
      case "carga_auto":
        $visualiza = "E";
        break;
      case "txt":
      default:
        $visualiza = "A";
        break;
      }
    }
    $param_bd = $bd;


    $arrParamA = array (
      "host_".  $param_bd,
      "user_".  $param_bd,
      "senha_". $param_bd,
      "bd_".    $param_bd,
      "tabela_".$param_bd,
      "host",
      "user",
      "senha",
      "bd",
      "tabela",
      "tabela_ativo",
      "tabela_lista_extra",
    );

    $arrParamB = array(
      "INCLUDE_DADOS",
      "USA_NC",
      "NRO_NC",
      "PARAM_EMPRESA_PRODUTO",
    );

    carregaArrParam($discador_modelo."A", "URANET",$arrParamA);
    carregaArrParam($discador_modelo."B", "URANET",$arrParamB);

    $param_include_dados   = $mkParam["INCLUDE_DADOS"];
    $param_empresa_produto = $mkParam["PARAM_EMPRESA_PRODUTO"];

    $isPesquisa = (($param_include_dados == "pesquisa") || (substr($param_include_dados, 0, 5) == "pesq_"));

    $host   = $mkParam["host_".  $param_bd];
    $user   = $mkParam["user_".  $param_bd];
    $senha  = $mkParam["senha_". $param_bd];
    $bd     = $mkParam["bd_".    $param_bd];
    $tabela = $mkParam["tabela_".$param_bd];

    if ($param_bd == "mailing") {
      $host   = $mkParam["host"];
      $user   = $mkParam["user"];
      $senha  = $mkParam["senha"];
      $bd     = $mkParam["bd"];
      $tabela = $mkParam["tabela"];

      if (strtoupper(substr($classe_con,0,2)) == "MD") {
        $tabela  = $mkParam["tabela_ativo"];
      } else {
        $tabela  = $mkParam["tabela"];
      }
    }

    if ($parm_mk) {
      $discador_modelo_passa = $parm_mk;
      $discador_modelo       = $parm_mk;
      carregaArrParam($discador_modelo."B", "URANET");
      if ($mkParam["usa_repre_vendedor"] == "S" || $classe_menu != "") {
        $repre = $mkParam["repre_vendedor"];
      }
    }
    $sub_total_ant = "";

  }

  if ($separador_func == "") {
    $separador_func = "-";
  }

  if ($nome_arquivo_auto) {
    $nome_arquivo = $nome_arquivo_auto;
  }

  if ($nome_arquivo_cli_auto) {
    $nome_arquivo_cli = $nome_arquivo_cli_auto;
  }

  $nome_arquivo     = MontaPrefArq($nome_arquivo);
  $nome_arquivo_cli = MontaPrefArq($nome_arquivo_cli);

  if ($include_01) require_once($include_01);
  if ($include_02) require_once($include_02);
  if ($include_03) require_once($include_03);
  if ($include_04) require_once($include_04);
  if ($include_05) require_once($include_05);

  $param_arquivo     =  $nome_arquivo;
  $param_arquivo_cli =  $nome_arquivo_cli;

  $param_where   = str_replace("(A)", "'", $where);

  $param_where    = str_replace("[CBO_REPRE]"    , $repre                   , $param_where);
  $param_where    = str_replace("[cbo_repre]"    , $repre                   , $param_where);
  $param_where    = str_replace("[SESSION_REPRE]", $session["representante"], $param_where);
  $param_where    = str_replace("[session_repre]", $session["representante"], $param_where);

  $param_wherebat = str_replace("(A)", "'", $wherebat);

  $param_wherebat = str_replace("[CBO_REPRE]"    , $repre                   , $param_wherebat);
  $param_wherebat = str_replace("[cbo_repre]"    , $repre                   , $param_wherebat);
  $param_wherebat = str_replace("[SESSION_REPRE]", $session["representante"], $param_wherebat);
  $param_wherebat = str_replace("[session_repre]", $session["representante"], $param_wherebat);

  $param_group    = trim($group);
  $param_order    = trim($order);

  $param_order    = str_replace("(F)", "'", $param_order);
  $param_order    = str_replace("(A)", "'", $param_order);

  $param_group    = str_replace("(F)", "'", $param_group);
  $param_group    = str_replace("(A)", "'", $param_group);

  $param_orderby     = $orderby;

  if ($param_orderby != "") {
    $param_orderby = explode(",",$orderby);

    if ($hid_order == "") {
      foreach ($param_orderby as $key => $campo) {
        $aux = explode("¬", $campo);
        $list_order_by .= ",".$aux[0];
        $hid_order     .= ",".$aux[1];

        unset($aux);
      }
      $list_order_by .= ",";
      $hid_order     .= ",";
    }
  } else {
    $list_order_by = "";
    $hid_order     = "";
  }

  $param_cmp_dt      = $nome_campo_data;
  $param_cmp_hr      = $nome_campo_hora;
  $param_cmp_dthr    = $nome_campo_datahora;

  $param_cmp_ano_mes = trim($nome_campo_ano_mes);

  $campodata       = explode("¬",$param_cmp_dt);
  $campodatahora   = explode("¬",$param_cmp_dthr);

  $data_filtro_ini = $ano_ini."-".$mes_ini."-".$dia_ini;

  if ($intervalo_dt != "S") {
    if ($dia_fim == "") {
      $dia_fim = $dia_ini;
    }
  }
  $data_filtro_fim = $ano_fim."-".$mes_fim."-".$dia_fim;

  if(strpos($campodata[0],",") == "") {
    $param_cmp_dt    = $campodata[0];
    $intervalo_dt    = strtoupper($campodata[1]);
    $param_limit_dia = $campodata[2];
    $param_cmp_dt_desc = $campodata[3];
  } else {
    $param_cmp_dt    = explode(",",$campodata[0]);
    $intervalo_dt    = strtoupper($campodata[1]);
    $param_limit_dia = $campodata[2];
    $param_cmp_dt_desc = explode(",",$campodata[3]);
  }

  if ($campodatahora[0] != "") {

    $param_cmp_dt = $campodatahora[0];
    $intervalo_dt    = 'D';
    $intervalo_dthr  = 'S';
    $param_limit_dia = '1';
    $param_cmp_dt_desc = $campodatahora[1];

    $param_cmp_hr      = $campodatahora[0];
    $intervalo_hr      = '1';
    $param_cmp_hr_desc = $campodatahora[1];
  } else {
    $intervalo_dthr  = '';
  }

  $arrPermClasses = array('EXBI1','EXBI2','EXBI3','EXBI4','EXBI5','EXBI6','EXBI7','EXBI8','EXBI9','EXBIW','EXBT0',
  'EXBT1','EXBT2','EXBT3','EXBT4','EXBT5','EXBT6','EXBT7','EXBT8','EXBT9','EXOI0','EXOI2',
  'EXOI3','EXOI4','EXOI5','EXOI8','EXH20','EXH21','EXH22','EXH23','EXH24','EXH25','EXH28');

  if ($_GET['processo'] != 'AT' && in_array($exportacao,$arrPermClasses) && $_SESSION['session']['operador'] == "re002085") {

    $conexaoCallCenter->query("SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = '".addslashes($exportacao)."' AND representante = '".addslashes($repre_param)."' AND status = 'U' AND tipo_reg = 'I' ORDER BY vlr_classe ");

    if($conexaoCallCenter->status === false) {
      print "<br><br><center><font color='#FF0000'><strong>Consulta Inválida (".$conexaoCallCenter->error.") - Login: ".$session['operador']."[DT]</strong></font></center>";
      exit;
    }

    do{

      if($conexaoCallCenter->result['vlr_classe'] == "NOME_CAMPO_ANO_MES") {

        unset($param_cmp_dt);
        unset($param_cmp_hora);
        unset($nomeCampoData);
        unset($param_cmp_dthr);
        unset($nomeCampoHora);
        unset($nome_campo_hora);
        unset($param_campo_hora);
        unset($param_cmp_hr);


        $param_cmp_ano_mes = $conexaoCallCenter->result['desc_classe'];



      }

    }while($conexaoCallCenter->getFetchAssoc());



  }

  if ($_REQUEST["procura"] == "OK") {
    if (trim($nome_campo_data) != "") {
      if (is_array($param_cmp_dt) && (!in_array($_REQUEST["param_campo_data"], $param_cmp_dt))) {
        $travar_rel = true;
      }
      if (!is_valid_date_carlos($data_filtro_ini)) {
        $travar_rel = true;
      }
      if ($intervalo_dt == "S" && !is_valid_date_carlos($data_filtro_fim)) {
        $travar_rel = true;
      }

      if ($intervalo_dt == "S" && DiasDif($data_filtro_ini, $data_filtro_fim) > $param_limit_dia) {
        $travar_rel = true;
      }
    }
  }

  $arrPermDataWhere = array('re002085','re028776','re030028');

  if ($travar_rel && in_array($session["operador"],$arrPermDataWhere) == false) {
    //Trava para não deixar qualquer consulta sem where data quando tiver parametro

    require_once('funcoes/ScriptInteligente.php');
    require_once("/libs/ctr/AlarmeCTR.php");//.$_SERVER['QUERY_STRING']

    $url = $_SERVER['SERVER_NAME'].$_SERVER["SCRIPT_NAME"]."?".$_SERVER['QUERY_STRING'];

    $msg_alarme = "<strong>Consulta Inválida GTA (".$exportacao.") - Login: ".$session["operador"]." <br> URL: (".addslashes($url).")[DT]</strong>";

    $matriz_operadores["0"] = "re001264";
    $matriz_operadores["1"] = "re000022";
    AlarmeCTR::setAlarmeIntegrAll($matriz_operadores, $msg_alarme."- POST: <pre>".getVar_dump($_POST)." - GET:".getVar_dump($_GET),"N");

    print "<br><br><center><font color='#FF0000'><strong>Consulta Inválida (".$exportacao.") - Login: ".$session['operador']."[DT]</strong></font></center>";
    exit;
  }

  // ********************** Tentativa de tratar quando tem data no parametro e entra no WHERE

  $param_cmp_ano_mes_tb = trim($nome_campo_ano_mes_tb);

  // if (trim($usa_join) != "") {
  //   $param_usa_join = explode("¬",str_replace("(A)", "'", $usa_join));
  // }

  if (trim($param_cmp_ano_mes) != "") {
    $param_cmp_ano_mes = explode("¬", $param_cmp_ano_mes);
    if ($param_cmp_ano_mes[1] != "") {
      if(strpos($param_cmp_ano_mes[0],",") > 0) {
        $param_cmp_mes      = explode(",",$param_cmp_ano_mes[0]);
        $param_cmp_mes_desc = explode(",",$param_cmp_ano_mes[2]);
      } else {
        $nome_cpo_ano_mes = $param_cmp_ano_mes[0];
      }
      $intervalo_dt = "";
    } else {
      $nome_cpo_ano_mes = $param_cmp_ano_mes[0];
    }
  }

  $campohora       = explode("¬",$param_cmp_hr);

  if(strpos($campohora[0],",") == "") {
    $param_cmp_hr    = $campohora[0];
    $intervalo_hr    = strtoupper($campohora[1]);
    $param_cmp_hr_desc = $campohora[2];
  } else {
    $param_cmp_hr    = explode(",",$campohora[0]);
    $intervalo_hr    = strtoupper($campohora[1]);
    $param_cmp_hr_desc = explode(",",$campohora[2]);


  }

  if(!$param_cmp_dt_desc){
    $param_cmp_dt_desc = "Atendimento";
  }

  if(!$param_cmp_hr_desc) {
    $param_cmp_hr_desc = "Atendimento";
  }

  if (($intervalo_dt == "S") && ($param_limit_dia == "")) {
    $param_limit_dia = "30";
  }





  if (($host == " -- " || $host == "" || $tabela == " -- " || $tabela == "") && $exportacao != "") {
    $param_bd = $bdado;
    $tabela = $param_tabela;

    $sql_bd   = "SELECT vlr_classe FROM tb_classe WHERE cod_classe = 'BDADO' and representante = 'URANET' and desc_classe = '".addslashes($param_bd)."' and status = 'A' and tipo_reg = 'I' order by vlr_classe ";

    $query_bd = DescExecQuery($sql_bd, $connect, "N");

    if ($rec = mysql_fetch_assoc($query_bd)) {
      $arr_b_dados = explode("¢",$rec["vlr_classe"]);
    }




    $AnoAux = date("Y");
    $MesAux = date("m");
    $DiaAux = date("d");
    if ($ano_mes == "") {
      $ano_mes = $AnoAux.$MesAux;
    }

    $tabelaAux = explode("¬",$tabela);

    if (is_array($tabelaAux)) {
      $tabela = $tabelaAux[0];

      if($_GET['processo'] == "AT" && empty($AnoMesAux) == true){
        $AnoMesAux    = date("Ym" , mktime(0, 0, 0, date("m"), date("d") + $tabelaAux[1], date("Y")));
      }else{
        if($_GET['processo'] != "AT"){
          $AnoMesAux    = date("Ym" , mktime(0, 0, 0, date("m"), date("d") + $tabelaAux[1], date("Y")));
        }
      }

      $AnoMesDiaAux = date("Ymd", mktime(0, 0, 0, date("m"), date("d") + $tabelaAux[1], date("Y")));
      $AnoAux       = substr($AnoMesDiaAux, 0,4);
      $MesAux       = substr($AnoMesDiaAux, 4,2);
      $DiaAux       = substr($AnoMesDiaAux, 6,2);
    }

    unset($tabelaAux);

    if ($_POST["processo"] == "AUTO" || $_GET["processo"] == "AT")  {
      if ($AnoMesAux == "") {
        $AnoMesAux = date("Ym");
      }
    } else {
      if ($nome_campo_data != "" || $nome_campo_datahora != "") {
        $AnoMesAux = $ano_ini.$mes_ini;
        $AnoAux = $ano_ini;
        $MesAux = $mes_ini;
        $DiaAux = $dia_ini;
      } else {
        $AnoAux = substr($ano_mes, 0, 4);
        $MesAux = substr($ano_mes,   -2);
        $DiaAux = "";
        $AnoMesAux = $AnoAux.$MesAux;
      }
    }

    if (substr($tabela,-6) == "AAAAMM") {
      $ano_mes_log = $AnoMesAux;
      $tabela      = str_replace("AAAAMM",$ano_mes_log,$tabela);
    } elseif (substr($tabela,-4) == "AAMM") {
      $ano_mes_log = substr($AnoMesAux, 2, 4);
      $tabela      = str_replace("AAMM",$ano_mes_log,$tabela);
    } else {
      $tabela = str_replace("[AAAA]", $AnoAux, $tabela);
      $tabela = str_replace("[AA]"  , substr($AnoAux,-2),$tabela);
      $tabela = str_replace("[DD]"  , $DiaAux, $tabela);
      $tabela = str_replace("[MM]"  , $MesAux, $tabela);
    }

    $bd    =  $arr_b_dados[0];
    $host  =  $arr_b_dados[1];
    $user  =  $arr_b_dados[2];
    $senha =  $arr_b_dados[3];
  }

  if (($session["print_sql"] != "N" && $_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO" && $_GET['processo'] != "AT") || $_POST["debug"] == "S") {
    print

    "Classe Exporta Direto: ".$classe_menu."<br>".
    "Classe Param: "         .$classe_con."<br>".
    "Classe Exporta: "       .$exportacao."<br>".
    //"host: "                 .$host      ."<br>".
    //"user: "                 .$user      ."<br>".
    //"senha: "                .$senha     ."<br>".
    "bd: "                   .$bd        ."<br>".
    "host: "                   .$host        ."<br>".
    "tabela: "               .$tabela    ."<br>".
    "param: "                .$param_bd  ."<br>".
    "NC: "                   .$mkParam["nro_nc"]."<br>";
  }

  $bdado_aux = $bd."¢".$host."¢".$user."¢".$senha."¢".$tabela;

  // if($session['operador'] == "re028776") {
  //   echo " <pre> ";
  //   echo " <hr>";
  //   echo " <h2><strong>DEBUG VARIAVEL</strong></h2> ";
  //   echo " <hr>";
  //   var_dump($bdado_aux);
  //   echo " </pre> ";
  // }

  if ($exportacao != "") {
    if ($host == "" || $host == " -- ") {
      $connectHOST = ConnectDB();
    } else {

      if (empty($update_00) === true) {
        $host = IPMaqRelatorio($host, $bd);
      }

      $connectHOST = Conecta($host, $user, $senha, $bd);
    }

    if (($isPesquisa === true) && (empty($selecao_mailing_pesquisa) === false) && (empty($mailing_pesquisa) === false)) {
      $q     = "SELECT cod_pesquisa FROM ".$param_tabela." WHERE campanha = '".addslashes($mailing_pesquisa)."' GROUP BY cod_pesquisa";
      if (trim($param_tabela) != "") {
        $query = DescExecQuery($q, $connectHOST, "N");
        $rec   = mysql_fetch_assoc($query);
        $cod_pesquisa = substr($rec["cod_pesquisa"], -2);
      } else {
        $cod_pesquisa = substr($mailing_pesquisa, -2);
      }
    }
  }
}


$hora_filtro_ini = $hora_ini;
$hora_filtro_fim = $hora_fim;

if ($datahora_ini != ""){
  $hora_filtro_ini = $datahora_ini;
  $hora_filtro_fim = $datahora_fim;
}

if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO" && $_GET['processo'] != "AT") {
  if($usa_bootstrap == true) {
    ?>
      <!doctype html>
      <html>
      <head>
      <title><?print $session["sistema"];?></title>
      <meta http-equiv="x-ua-compatible" content="IE=edge">
      <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
      <meta http-equiv="Pragma" content="no-cache">
      <meta http-equiv="Expires" content="-1">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
      <script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>
      <!-- *************** CSS *************** -->
      <!-- bootstrap -->
      <?print IntergrAllHeader();?>
      <!-- plugins -->
      <script language="javascript"  src="consistencia.js"></script>
    <?
  } else {
?>
<html>
<head>
<title><?print $session["sistema"];?></title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="-1">
<?print $v1_style_css?>

<script language="javascript"  src="consistencia.js"></script>
<script type="text/javascript" src="/js/jquery.js"  ></script>
<?
  }
?>

<style type="text/css">
.text {
  border-color: <?print $session["td_destaque1"]?>;
  border-style: solid; border-width:1;
}

table td {
 padding-left: 5px;
}
</style>

<script type="text/javascript" src="/js/montaDivPopUp.js"></script>
<script type="text/javascript" src="/js/screenBlock.js"></script>
<script language="javascript">
function chamaPopUpDiv(repre, tp_exec1, carga_auto1, tot1, exportacao1, bdado1, query1) {

  desc_rel = 'Selecione a Campanha';
  ProgramaUrl = 'mk_exporta_mailing_carga_auto.php';
  Altura  = "40%";
  Largura = "45%";

  $.ajax({
    url: ProgramaUrl,
    type: 'POST',
    data: {repre: repre, tot: tot1, exportacao: exportacao1, bdado: bdado1, query: query1,carga_auto:carga_auto1 },
    dataType: 'text',
    timeout: 10000,
    contentType: 'application/x-www-form-urlencoded; charset=iso-8859-1',
    beforeSend: function(){
      screenBlockShow();
    },
    error: function(erro){
      alert('Erro Ajax: ' + erro);
    },
    success: function(xml){
      montaDivPopUp(1, '', 'JanelaCarga', Altura, Largura, desc_rel, 'CC', '<?print $session["td_destaque"]?>', '', '', 'S', xml);
    },
    complete: function () {
      screenBlockHide();
    }
  });
}

function obterFiltroBusca() {

  var arrCampos = $(document.frmMKExp).serializeArray()

  if (arrCampos.filter(function(e) { return e.name == 'visualiza' && e.value == 'F'  }).length == 0) {
    return;
  }

  var arrCamposExtra = []
  var camposNaoGravar = ['procura', 'intervalo_dt', 'param_limit_dia', 'tipo_transf', 'repre', 'repre_passa', 'discador_modelo_passa', 'exportacao_passa', 'titulo', 'deondegta', 'busca_direta', 'classe_menu', 'tipo_popup', 'repre', 'discador_modelo', 'exportacao', 'visualiza', 'delimitador', 'visualizax', 'tipo_proc']

  arrCampos.forEach(function(campo){
    //se não tiver no array
    if(camposNaoGravar.indexOf(campo.name) == -1 ) {
      arrCamposExtra.push(campo)
    }
  })

  return JSON.stringify(arrCamposExtra);

}

function AgendarExtracaoAuto(repre, tp_exec1, carga_auto1, tot1, exportacao1, bdado1, query1, Camp1, DesCamp1, Visualiza1, ExtracaoFtp1,ParamArquivo,Delimitador) {

  try{
    var filtro = obterFiltroBusca();
  } catch (err) {
    console.log(err)
  }

  if (tp_exec1 == "INC") {

    if (Camp1 == "" && Visualiza1 != "F") {
      alert("Selecione a Campanha.");
      return false;
    }

    if (Visualiza1 == "F") {
      Msg = "Deseja gerar o arquivo agora?";
    } else {
      Msg = "Deseja carregar o mailing agora?";
    }

    if(!confirm(Msg)) {
      return false;
    }
  }

  $.ajax({
  url: 'mk_exporta_mailling.php?usa_ajax=SIM&tp_exec='+tp_exec1,
  data: {
    repre: repre,
    tot: tot1,
    exportacao: exportacao1,
    bdado: bdado1,
    query: query1,
    carga_auto: carga_auto1,
    Camp: Camp1,
    DesCamp: DesCamp1,
    Visualiza: Visualiza1,
    extracao_ftp: ExtracaoFtp1,
    param_arquivo: ParamArquivo,
    delimitador: url_encode(Delimitador),
    filtro: filtro
  },

  type: 'POST',

  dataType: 'text',
  async: false,
  timeout: 30000,
  contentType: 'application/x-www-form-urlencoded; charset=iso-8859-1',
  beforeSend: function(){
    $("#loading").css("display","block");
  },
  error: function(){
   alert('erro ajax');
  },
  success: function(xml){
    $("#loading").css("display","none");
    $("#ExtracaoAuto").html(xml);
  }
 });
}

function MontaOrderBy(tp_exec, valor) {
  $.ajax({
  url: 'mk_exporta_mailling.php?usa_ajax=SIM&tp_exec=MontaOrderBy',
  data: {valor: valor},
  type: 'POST',
  dataType: 'text',
  async: false,
  timeout: 30000,
  contentType: 'application/x-www-form-urlencoded; charset=iso-8859-1',
  beforeSend: function(){
    $("#loading").css("display","block");
  },
  error: function(){
   alert('erro ajax');
  },
  success: function(xml){
    $("#loading").css("display","none");
    $("#id_lab_order").html(xml);
  }
 });

}

function DelOrderBy(vars,id_obj) {

  if (vars == "") {
    if (confirm('Deseja limpar a classificação?')) {
      id_obj.value = "";
      document.getElementById('id_list_order_by').value = "";
      MontaOrderBy('',document.getElementById('id_list_order_by').value);
    }
    return false;
  }

  Aux = vars.split(",");
  tamanho_array = Aux.length;

  for (i=0;i<tamanho_array;i++) {
    vars = Aux[i].split("¬");

    Aux2 = vars[1].split(" ");
    if (Aux2[1] == "DESC") {
      MsgList  = "-ordena_za.gif";
      MsgList2 = "Maior/Menor";
    } else if (Aux2[1] == "ASC") {
      MsgList  = "-ordena_az.gif";
      MsgList2 = "Menor/Maior";
    } else {
      MsgList = "";
    }

    if (id_obj.value.indexOf(","+vars[1]+",") < 0) {
      alert('Coluna ['+vars[0]+' - '+MsgList2+'] não selecionada.');
      return false;
    }

    id_obj.value = replaceString(","+vars[1]+",",",",id_obj.value);

    document.getElementById('id_list_order_by').value = replaceString(","+vars[0]+MsgList+",", ",", document.getElementById('id_list_order_by').value);

    if (id_obj.value == ",") {
      id_obj.value = "";
      document.getElementById('id_list_order_by').value = "";
    }
    MontaOrderBy('',document.getElementById('id_list_order_by').value);
  }
}

function AddOrderBy(vars,id_obj) {

  if (vars == "") {
    DelOrderBy(vars,id_obj);
    return false;
  }

  if (document.getElementById('id_list_order_by').value.indexOf(".gif") < 0) {
    document.getElementById('id_list_order_by').value = "";
    document.getElementById('id_hid_order').value = "";
  }

  Aux = vars.split(",");
  tamanho_array = Aux.length;

  if (tamanho_array > 1) {
    id_obj.value = "" ;
    document.getElementById('id_list_order_by').value = "" ;
  }

  for (i=0;i<tamanho_array;i++) {

    vars = Aux[i].split("¬");

    Aux2 = vars[1].split(" ");
    if (Aux2[1] == "DESC") {
      MsgList = "-ordena_za.gif";
    } else if (Aux2[1] == "ASC") {
      MsgList = "-ordena_az.gif";
    } else {
      MsgList = "";
    }
    if (id_obj.value == "") {

      id_obj.value = "," + vars[1] + ",";

      document.getElementById('id_list_order_by').value = "," + vars[0] + MsgList+",";

    } else {
      //if (id_obj.value.indexOf("," + vars[1] + ",") >= 0) {
      if (id_obj.value.indexOf("," + Aux2[0]) >= 0) {
        alert('Coluna ['+vars[0]+'] não pode ser classificada mais de uma vez.');
        return false;
      }
      id_obj.value = id_obj.value + vars[1] + ",";
      document.getElementById('id_list_order_by').value = document.getElementById('id_list_order_by').value + vars[0] +MsgList+",";
    }
    MontaOrderBy('',document.getElementById('id_list_order_by').value);

  }

}

function VerificaForm(botao) {

  if (checa(document.frmMKExp)) {
    mostra_dt   = document.frmMKExp.intervalo_dt.value;
    mostra_dthr = document.frmMKExp.intervalo_dthr.value;

    if (mostra_dt == "S") {

      diaini = document.frmMKExp.dia_ini.value;
      mesini = document.frmMKExp.mes_ini.value;
      anoini = document.frmMKExp.ano_ini.value;
      diafim = document.frmMKExp.dia_fim.value;
      mesfim = document.frmMKExp.mes_fim.value;
      anofim = document.frmMKExp.ano_fim.value;
      qtd_inter = document.frmMKExp.param_limit_dia.value;
      if (DataIntervalo(diaini, mesini, anoini, diafim, mesfim, anofim, qtd_inter)){
        document.frmMKExp.procura.value="OK";
        document.frmMKExp.submit();
      }
    } else {
      if(mostra_dt == "M") {
        if(confereData()){
          document.frmMKExp.procura.value="OK";
          //alert('eooooq');
          document.frmMKExp.submit();
        }
      } else if (mostra_dthr) {
        if(confereHora()){
          document.frmMKExp.procura.value="OK";
          document.frmMKExp.submit();
        }
      } else {
        document.frmMKExp.procura.value="OK";
        document.frmMKExp.submit();
      }
    }
  }
}

function MudaExp(exporta){
  document.frmMKExp.procura.value="";
  document.frmMKExp.action ='<?print $PHP_SELF?>';

  if (document.getElementById('id_list_order_by')) {
    document.getElementById('id_list_order_by').value = "";
    document.getElementById('id_hid_order'    ).value = "";
  }

  document.frmMKExp.submit();
  // window.location='<?print $PHP_SELF?>?discador_modelo=<?print $discador_modelo?>&repre=<?print $repre?>&exportacao='+exporta+'&dia_ini='+dia_ini+'&mes_ini='+mes_ini+'&ano_ini='+ano_ini;
}

function mostraLayout(tipo){
  AbreJanela('', 'janExpMailling', '700', '550');
  document.frmLayout.submit();
}

function mostraHelp(classe_exporta, repre_exporta){

  AbreJanela2('mk_exporta_mailing_help.php?classe_exporta='+classe_exporta+'&repre_exporta='+repre_exporta, 'janHelp', 650, 350,'<?print $titulo?>');
}

<?
if ($include_imprime != "") {
?>
  function imprimeEspecifico() {
    AbreJanela('blank.htm', 'JanelaImpressaoEspecifico', '95%', '95%');
    document.frm_include_imprime.submit();
  }
<?
}
?>

function imprimeRelatorio(tipo) {
  // // Método Antigo (02/2021)
  // document.getElementById("simula_tipo").value = tipo;
  // document.simula.tabelao_rel.value = url_encode(document.getElementById('dadosExporta').outerHTML);

  // AbreJanela('about:blank', 'JanelaImpressao', '1px', '1px');

  // document.simula.submit();

  // Ajax utilizado para salvar LOG do download
  $.ajax({
    url: 'dac_con_regiao_det_impressao.php',
    data: {
      titulo: $('input[name=titulo]').val(),
      repre_aux: $('input[name=repre_aux]').val(),
      aux_nome_arquivo: $('input[name=aux_nome_arquivo]').val(),
      tabelao_titulo: $('input[name=tabelao_titulo]').val(),
      tipo: tipo,
      grava_dados: true
      // arq_dados: url_encode(document.getElementById('dadosExporta').value)
    },
    type: 'POST',
    dataType: 'text',
    async: false,
    timeout: 30000,
    beforeSend: function(){
      // $("#loading").css("display","block");
    },
    error: function(){
      console.log('Erro ajax do download do Excel!');
    },
    success: function(result){
      if (!result) {
        console.log('Houve um erro ao gravar o log do download, por gentileza tente novamente');
      }
    },
    complete: function(){
      // $("#loading").css("display", "none");
    }
  });

  var element = document.createElement('a');
  var universalBOM = "\uFEFF";    // Formata o arquivo para ISO-8859-1
  var nome_arquivo = $('input[name=aux_nome_arquivo]').val();
  var table_div = document.getElementById('dadosExporta');
  var table_html = table_div.outerHTML.replace(/ /g, '%20');
  element.href = 'data:application/vnd.ms-excel;charset=ISO-8859-1, ' + universalBOM+table_html;
  element.style.display = 'none';

  // Remover ".txt" do nome do arquivo
  if (nome_arquivo != "") {
    if (nome_arquivo.indexOf(".") > 0) {
      nome_arquivo = nome_arquivo.slice(0,-4);
    }
  }

  element.download = nome_arquivo;
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}

function DownloadArq(NomeArq) {
  //Método antigo
  // document.frmDownload.arq_dados.value = url_encode(document.getElementById('dadosExporta').value);
  // AbreJanela('about:blank', 'JanelaImpressao', '1px', '1px');
  // document.frmDownload.submit();

  if (document.frmMKExp.visualiza.value != "A" && document.frmMKExp.visualiza.value != "J") {
    alert('Para baixar via excel, clique em "Pesquisar" primeiro!');
    return false;
  }

  // Ajax utilizado para salvar LOG do download
  $.ajax({
    url: 'mk_exporta_mailing_arquivo.php',
    data: {
      repre_aux: $('input[name=repre_aux]').val(),
      titulo: $('input[name=titulo]').val(),
      nome_arq: $('input[name=nome_arq]').val(),
      grava_dados: true
      // arq_dados: url_encode(document.getElementById('dadosExporta').value)
    },
    type: 'POST',
    dataType: 'text',
    async: false,
    timeout: 30000,
    beforeSend: function(){
      // $("#loading").css("display","block");
    },
    error: function(){
      console.log('Erro ajax do download do Arquivo!');
    },
    success: function(result){
      if (!result) {
        console.log('Houve um erro ao gravar o log do download, por gentileza tente novamente');
      }
    },
    complete: function(){
      // $("#loading").css("display", "none");
    }
  });

  // //Método alternativo - Gravar conteúdo na Session de outra janela e depois baixar. (NÃO UTILIZAR)
  // var url = "mk_exporta_mailing_arquivo.php?repre_aux=" + $('input[name=repre_aux]').val() + "&titulo=" + $('input[name=titulo]').val() + "&nome_arq=" + $('input[name=nome_arq]').val();
  // var hiddenIFrameId = 'hiddenDownloader';
  // var iframe = document.getElementById(hiddenIFrameId);
  // if (iframe === null) {
  //   iframe = document.createElement('iframe');
  //   iframe.id = hiddenIFrameId;
  //   iframe.style.display = 'none';
  //   document.body.appendChild(iframe);
  // }
  // iframe.src = url;

  var element = document.createElement('a');
  element.style.display = 'none';
  element.setAttribute('href', 'data:text/plain,' + escape(document.getElementById('dadosExporta').value));
  element.setAttribute('download', $('input[name=aux_nome_arquivo]').val());
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}

function EnviaArqFtp(NomeArq) {
  document.frmFtp.arq_dados.value = url_encode(document.getElementById('dadosExporta').value);

  AbreJanela('about:blank', 'JanelaImpressao', '1px', '1px');
  //mk_exporta_mailing_arquivo

  document.frmFtp.submit();
}

function montaProxCombo(condicao,prox_campo,vlrEscolhido){
  var valorComboAux = montaProxCombo.arguments[3];
  var dados = "";
  switch(condicao){
    case "tema_pai":
    dados = {
      "classe" : vlrEscolhido,
      "representante" : $("select[name='repre']").val(),
      "condicao" : condicao,
      "valorComboAux" : valorComboAux
    }

    break;

    case "filtro_tema_pai":
      dados = {
      "classe" : "FM"+$("select[name='discador_modelo']").val().substr(2,2)+"T",
      "representante" : $("select[name='repre']").val(),
      "condicao" : condicao,
      "vlrEscolhido" : vlrEscolhido,
      "valorComboAux" : valorComboAux
    }
    break;
  }

  $.ajax({
    url: 'mk_exporta_mailling.php?usa_ajax=SIM&tp_exec=MontaComboDepende',
    data: dados,
    type: 'POST',
    dataType: 'text',
    async: false,
    timeout: 30000,
    contentType: 'application/x-www-form-urlencoded; charset=iso-8859-1',
    beforeSend: function(){
      // $("#loading").css("display","block");
    },
    error: function(){
     // alert('erro ajax');
    },
    success: function(xml){
      // console.log(xml);
      // return false;
      // $("#loading").css("display","none");
      $("#"+prox_campo+"_aux").find('option').remove();
      $("#"+prox_campo+"_aux").append(xml);
    }
  });
}

$(function(){
  $("select[name^='CL_selecao_depende']").each(function(){
    if($(this).hasClass("cmb_depende") === false){
      $(this).change();
    }
  });
})

</script>
</head>
<body>
<input type="hidden" id="id_delimitador" name="delimitador2" value=<?print $delimitador?>>
 <?
}//$_POST["processo"]

if ($deondegta != "gerenciador" && $_GET['processo'] != "AT") {
  print GerarCabecalho("cc_consulta.php?nivel=P", $titulo, "", "");
}

if($usa_bootstrap == true && $_GET['processo'] != "AT") {
  ?>
  <div class="container">
  <?
}

if (($discador_modelo) || ($busca_direta == "S")) {
  //GERAR SUBTITULO
  $sub_header = "";

  for ($i = 1; $i <= $qtd_param_campo; $i++) {
    $i = str_pad($i, 2, "0", STR_PAD_LEFT);
    $aux = "selecao_campo_".$i;
    $vlrcombocampo = "param_selecao_campo_".$i;
    if ($$aux != "") {
      $selecao_campo_arr = explode("¬", $$aux);

      $aux = "CPO_selecao_campo_".$i;

      $aux2 = "CPO_FIMselecao_campo_".$i;

      $selecao_campo_desc = explode(",",$selecao_campo_arr[0]);
      $selecao_campo_cpo  = explode(",",$selecao_campo_arr[2]);

      $nro_total_loop = count((array)$selecao_campo_desc);

      $DescCbo = "param_selecao_campo_".$i;
      for($z=0; $z<$nro_total_loop; $z++) {

        if ($$DescCbo == $selecao_campo_cpo[$z]) {
          $desc = $selecao_campo_desc[$z];
          break;
        }
      }

      unset($selecao_campo_cpo);
      unset($selecao_campo_desc);

      if ($$aux !=  "") {
        if ((($repre == "CAEXPORTADOR") && ($$aux == "TD"))) {
          continue;
        }

        $aux2 = "CPO_FIMselecao_campo_".$i;

        /*if ($selecao_campo_arr[1] == "IGUAL") {
        } else if ($selecao_campo_arr[1] == "DIFERENTE") {
        } else if ($selecao_campo_arr[1] == "LIKE") {
        } else */if ($selecao_campo_arr[1] == "MAIOR") {
          $sub_header .= "<tr><td><font class=\"txt1\"><strong>".$desc." - maior:</strong> ".$$aux."</td></tr>";
        } else if ($selecao_campo_arr[1] == "MENOR") {
          $sub_header .= "<tr><td><font class=\"txt1\"><strong>".$desc." - menor:</strong> ".$$aux."</td></tr>";
        } else if ($selecao_campo_arr[1] == "MAIORIGUAL") {
          $sub_header .= "<tr><td><font class=\"txt1\"><strong>".$desc." - maior ou igual:</strong> ".$$aux."</td></tr>";
        } else if ($selecao_campo_arr[1] == "MENORIGUAL") {
          $sub_header .= "<tr><td><font class=\"txt1\"><strong>".$desc." - menor ou igual:</strong> ".$$aux."</td></tr>";
        } else if ($selecao_campo_arr[1] == "ENTRE") {
          $sub_header .= "<tr><td><font class=\"txt1\"><strong>".$desc." - intervalo:</strong> ".$$aux." até ".$$aux2."</td></tr>";
          /*} else {*/
        }
      }
    }
  }

  if (empty($sub_header) === false) {
?>
    <table  cellpadding="5" cellspacing="0" align="center">
      <?print $sub_header;?>
    </table>
<?
  }
  if ($possui_layout == "NO") {
?>
    <br><br><br>
      <center><font class='txtvermelho'><strong><?php print $objTradutor->traduzir("Parâmetro do Relatório/Lay-Out não cadastrado")?> (<?print $exportacao?>)</strong></font></center>
    <br><br>
 <?
  }

if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO" && $_GET['processo'] != "AT") {
  $layout.= "<table  ".$class_table." width='650'  style='border-collapse:collapse;'  bordercolor='".$session["td_destaque"]."' border='1' cellpadding='0' cellspacing='0' align='center' >";
  $layout.= "<thead>";
  $layout.= "  <tr ".$bgcolor_td_destaque.">";
  $layout.= "    <td align='center' colspan='4'><font class='txt6'><strong>Layout</td>";
  $layout.= "  </tr>";
  $layout.= "  <tr ".$bgcolor_td_dado1.">";
  $layout.= "    <td align='center'><font class='txt5'><strong>Nome do Campo</td>";
  $layout.= "    <td align='center'><font class='txt5'><strong>Tipo         </td>";
  $layout.= "    <td align='center'><font class='txt5'><strong>Tamanho      </td>";
  $layout.= "    <td align='center'><font class='txt5'><strong>Observação   </td>";
  $layout.= "  </tr>";
  $layout.= "</thead><tbody>";

  $layoutHD.= "<table ".$class_table." width='650'  style='border-collapse:collapse;'  bordercolor='".$session["td_destaque"]."' border='1' cellpadding='0' cellspacing='0' align='center' >";
  $layoutHD.= "<thead>";
  $layoutHD.= "  <tr ".$bgcolor_td_destaque.">";
  $layoutHD.= "    <td align='center' colspan='4'><font class='txt6'><strong>Layout Header</td>";
  $layoutHD.= "  </tr>";
  $layoutHD.= "  <tr ".$bgcolor_td_dado1.">";
  $layoutHD.= "    <td align='center'><font class='txt5'><strong>Nome do Campo</td>";
  $layoutHD.= "    <td align='center'><font class='txt5'><strong>Tipo         </td>";
  $layoutHD.= "    <td align='center'><font class='txt5'><strong>Tamanho      </td>";
  $layoutHD.= "    <td align='center'><font class='txt5'><strong>Observação   </td>";
  $layoutHD.= "  </tr>";
  $layoutHD.= "</thead><tbody>";


  $layoutTR.= "<table ".$class_table." width='650'  style='border-collapse:collapse;'  bordercolor='".$session["td_destaque"]."' border='1' cellpadding='0' cellspacing='0' align='center' >";
  $layoutTR.= "<thead>";
  $layoutTR.= "  <tr ".$bgcolor_td_destaque.">";
  $layoutTR.= "    <td align='center' colspan='4'><font class='txt6'><strong>Layout Trailler</td>";
  $layoutTR.= "  </tr>";
  $layoutTR.= "  <tr ".$bgcolor_td_dado1.">";
  $layoutTR.= "    <td align='center'><font class='txt5'><strong>Nome do Campo</td>";
  $layoutTR.= "    <td align='center'><font class='txt5'><strong>Tipo         </td>";
  $layoutTR.= "    <td align='center'><font class='txt5'><strong>Tamanho      </td>";
  $layoutTR.= "    <td align='center'><font class='txt5'><strong>Observação   </td>";
  $layoutTR.= "  </tr>";
  $layoutTR.= "</thead><tbody>";

}//BATCH


  $colspan_totalizar;
  $q     = "SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = '".addslashes($exportacao)."' AND representante = '".addslashes($repre_param)."' AND status = 'A' AND tipo_reg = 'I' AND (vlr_classe like 'campo_%' OR vlr_classe like 'header_%' OR vlr_classe like 'trailler_%') ORDER BY vlr_classe ";
  if ($_POST["debug"] == "S") {
    echo "\r\n PARAMETROS: [".$q."]";
  }

  $query = DescExecQuery($q, $connect, "N");
  $temhd = false;
  $temtr = false;

  $arrCposParam = array();
  $arrCposBonus = array();
  $arrCposIndex = array();
  $arrFieldList = explode("¬", $field_list);

  while ($rec = mysql_fetch_assoc($query)) {

    if (strtolower(substr($rec["vlr_classe"],0 , 7)) == "header_") {
      $tpreg = "header";
      $auxLay = "layoutHD";
      $temhd  = true;
    } else if (strtolower(substr($rec["vlr_classe"],0 , 9)) == "trailler_") {
      $tpreg = "trailler";
      $auxLay = "layoutTR";
      $temtr  = true;
    } else {
      $tpreg = "campo";
      $auxLay = "layout";
    }

    if ($auxLay != $auxLayAnt) {
      if ($auxLayAnt == "") {
        $auxLayAnt = $auxLay;
      } else {
        eval("$".$auxLayAnt." .= '</tbody></table>';");
        $auxLayAnt = $auxLay;
      }
    }

    //tratamento para o tamanho do campo [SIZE]
    $campos_spl = explode("¬", $rec["desc_classe"]);
    $campos_spl[4] = intval($campos_spl[4]);
    if ($campos_spl[4] == 0){
      $campos_spl[4] = 1;
    }

    $mtz_campos[$tpreg][$rec["vlr_classe"]]["TIPO"]      = $campos_spl[1];

    if ($campos_spl[1] == "PARM_PERC") {
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["ALIGN"]     = $campos_spl[3];

    } else {
      $alOk = array("center", "left", "right");
      if (!in_array(strtolower($campos_spl[7]), $alOk)) {
        if ($campos_spl[7] != "") {
          $mtz_campos[$tpreg][$rec["vlr_classe"]]["MSGS"][] = "Parâmetro ALIGN=[{$campos_spl[7]}] inválido";
        }
        $campos_spl[7] = "center";
      }

      $mtz_campos[$tpreg][$rec["vlr_classe"]]["TPCA"]      = $campos_spl[3];
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["ALIGN"]     = $campos_spl[7];
    }

    if (substr($mtz_campos[$tpreg][$rec["vlr_classe"]]["TPCA"], 0, 4) == "DATE") {
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["DATE_FMT"] = substr($mtz_campos[$tpreg][$rec["vlr_classe"]]["TPCA"], (strpos($mtz_campos[$tpreg][$rec["vlr_classe"]]["TPCA"],"(")+1), -1);
    } else {
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["DATE_FMT"] = "";
    }

    $mtz_campos[$tpreg][$rec["vlr_classe"]]["VLR" ]      = $campos_spl[2];
    //$mtz_campos[$tpreg][$rec["vlr_classe"]]["TPCA"]      = $campos_spl[3];
    $mtz_campos[$tpreg][$rec["vlr_classe"]]["SIZE"]      = $campos_spl[4];

    if (!Valida::Natural($mtz_campos[$tpreg][$rec["vlr_classe"]]["SIZE"])) {
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["MSGS"][] = "Parâmetro SIZE=[{$mtz_campos[$tpreg][$rec["vlr_classe"]]["SIZE"]}] inválido";
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["SIZE"] = 0;
    }

    $mtz_campos[$tpreg][$rec["vlr_classe"]]["DECI"]      = $campos_spl[5];
    $mtz_campos[$tpreg][$rec["vlr_classe"]]["DECICARA"]  = substr($campos_spl[6], 1, 1);
    $mtz_campos[$tpreg][$rec["vlr_classe"]]["DESC"]      = $campos_spl[0];
    $mtz_campos[$tpreg][$rec["vlr_classe"]]["TPTOT"]     = $campos_spl[8];

    // if (!$campos_spl[7]) {
    //   $campos_spl[7] = "center";
    // }

    //$mtz_campos[$tpreg][$rec["vlr_classe"]]["ALIGN"]     = $campos_spl[7];

    if (strtolower($campos_spl[8]) == "tot" || strtolower($campos_spl[8]) == "ptot") {
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["TOTALIZAR"] = "S";
    } elseif (strtolower($campos_spl[8]) == "ntot") {
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["TOTALIZAR"] = "N";
    }

    //   $mtz_campos[$tpreg][$rec["vlr_classe"]]["TOTALIZAR"] = $campos_spl[8]; // S / N / M ;
    if($mtz_campos[$tpreg][$rec["vlr_classe"]]["TOTALIZAR"] == ""){
      $mtz_campos[$tpreg][$rec["vlr_classe"]]["TOTALIZAR"] = "N";
    }

    $colspan_totalizar++;

    if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO" && $_GET['processo'] != "AT" && $campos_spl[0] != "FAKECOLUMN") {
      $$auxLay.= "<tr ".$bgcolor_td_dado3.">";
      $$auxLay.= "  <td align='left'  ><font class='txt5'>&nbsp;".$campos_spl[0]."</td>";
      $$auxLay.= "  <td align='center'><font class='txt5'>".$campos_spl[3]."</td>";

      if ($campos_spl[5] == "") {
        $$auxLay.= "  <td align='right' ><font class='txt5'>".$campos_spl[4]."&nbsp;</td>";
      } else {
        $$auxLay.= "  <td align='right' ><font class='txt5'>".$campos_spl[4].substr($campos_spl[6], 1, 1).$campos_spl[5]."&nbsp;</td>";
      }

      if ($campos_spl[1] == "FIXO") {
        if ($campos_spl[3] == "CHAR") {
          $vlr_fixo = "Vazio/Espaço(s)";
        }
        if ($campos_spl[3] == "NUM") {
          $vlr_fixo = "Zero(s)";
        }
        if ($campos_spl[2]) {
          $vlr_fixo = $campos_spl[2];
        }
        $$auxLay.= "  <td><font class='txt5'><i>&nbsp;".$campos_spl[1].":</i> ".$vlr_fixo."</td>";
      } else {
        $$auxLay.= "  <td><font class='txt5'>&nbsp;</td>";
      }
      $$auxLay.= "</tr>";
    } //BATCH

    //Fim da montagem do layout.


    if ($campos_spl[0] == "FAKECOLUMN" && $campos_spl[1] == "getDadosAtendimentoMonitorado") {
      $arrCposBonus[] = "nome_monitoria";
      $arrCposBonus[] = "tipo_monitoria";
    }



    if ($campos_spl[1] == "FUNCAO" && strpos("***".$campos_spl[2], "m.mon.") < 1) {

      $cmp_func_sel = explode($separador_func, substr($campos_spl[2], (strpos($campos_spl[2], "(")+1), -1));

      $funcexpe = substr($campos_spl[2],0,  strpos($campos_spl[2], "("));

      foreach ($cmp_func_sel as $key => $campo) {
        // echo "campo: {$campo}<br>";

        // $campo = str_replace("(F)", "'", $campo);
        // $campo = str_replace("(A)", "'", $campo);

        // $campo = str_replace("var_dt_agora"  , "'".$dt_agora."'"  , $campo);
        // $campo = str_replace("var_hr_agora"  , "'".$hr_agora."'"  , $campo);
        // $campo = str_replace("var_dthr_agora", "'".$dthr_agora."'", $campo);

        // if ($campo == "") {
        //   $campo = "NULL";
        // }

        $arrIgnore = array (
          "[REC]",
          "[CBO_REPRE]",
          "[SESSION_REPRE]",
          "[MK_FLAG]",
          "[MK_NUMERO]",
          "[CLASSE_MKPRO]",
          "var_dt_agora",
          "var_hr_agora",
          "var_dthr_agora",
        );
        if (substr($campo, 0, 3) != "(F)" && substr($campo, 0, 3) != "(A)" && !in_array($campo, $arrIgnore)) {
          $arrCposParam[] = str_replace("(F)", "'", $campo);
        }
      }
    }

    if ((substr($campos_spl[2],0,6) != "m.mon.") && ($campos_spl[1] == "TABELA" || $campos_spl[1] == "CLASSE" || $campos_spl[1] == "IF")) {

      //if ($campos_spl[1] == "CLASSE") {
       unset($cmp_sel_spl);
      if (substr_count($campos_spl[2], "¢") == 1) {
        $pos = strpos($campos_spl[2], "¢");
        if (substr($campos_spl[2],$pos-3,3) == "(A)") {
          $cmp_sel_spl[0] = $campos_spl[2];
        } else {
          $cmp_sel_spl = explode("¢", $campos_spl[2]);
        }

      } else {
        $cmp_sel_spl[0] = $campos_spl[2];
      }

      if (substr($cmp_sel_spl[1], 2, 2) == "__") {
        $cmp_sel_spl[1] = str_replace("__", $nromodelo, $cmp_sel_spl[1]);
      } else {
        if ((substr($cmp_sel_spl[1], 3, 2) == "__") && (empty($mailing_pesquisa) === false) && (empty($cod_pesquisa) === false)) {
          $cmp_sel_spl[1] = str_replace("__", $cod_pesquisa, $cmp_sel_spl[1]);
        }
      }

      if (empty($cmp_sel_spl[1]) === false) {
        $arr_tmp = explode("§", $cmp_sel_spl[1]);

        if ($arr_tmp[1] == "") {
          $arr_tmp[1] = "CC";
        }

        $arrClasses[$arr_tmp[0]] = $arr_tmp[1];
      }

      $arrCposParam[] = str_replace("(A)", "'", $cmp_sel_spl[0]);
    }

    if ($mtz_campos[$tpreg][$key]["TIPO"] == "OPERACAO") {
      $cmp_sel_spl = explode("¢", $campos_spl[2]);
      $arrCposParam[] = str_replace("(F)", "", $cmp_sel_spl[0]);
      $arrCposParam[] = str_replace("(F)", "", $cmp_sel_spl[2]);
    }
  }

  // echo "<pre>";
  // var_dump($mtz_campos);
  // echo "</pre>";

  $tpreg = "campo";
  if ($auxLay != "") {
    eval("$".$auxLay." .= '</tbody></table>';");
  }

  if ($temhd == false) {
    $layoutHD = "";
  }

  if ($temtr == false) {
    $layoutTR = "";
  }

  if (is_array($arrClasses) === true) {
    require_once("/libs/ctr/ClasseCTR.php");

    if (empty($_SESSION["session"]["idioma"])) {
      $_SESSION["session"]["idioma"] = "1";
    }
//Busca Classe
     foreach ($arrClasses as $classe_atual => $sistema) {
      if (is_array($arr_sis_cl[$sistema]) === false) {
        $arr_sis_cl[$sistema] = ClassePST::getParamSistemaClasse($sistema);
      }

      eval("\$connectCL = ".$arr_sis_cl[$sistema]["conexao"]."();");

      $repre_con = DefineRepre($repre);
      $q   = "SELECT COUNT(*) AS qtd FROM ".$arr_sis_cl[$sistema]["tabela"]." WHERE representante = '".addslashes($repre_con)."' AND cod_classe = '".addslashes($classe_atual)."' AND tipo_reg = 'T' AND idioma = '".addslashes($_SESSION["session"]["idioma"])."'";

      $con = DescExecQuery($q, $connectCL, "N");
      $rec = mysql_fetch_assoc($con);
      if ($rec["qtd"] <= 0) {
        $repre_con = "URANET";
      }

      $q   = "SELECT vlr_classe, desc_classe FROM ".$arr_sis_cl[$sistema]["tabela"]." WHERE representante = '".addslashes($repre_con)."' AND cod_classe = '".addslashes($classe_atual)."' AND tipo_reg = 'I' AND idioma = '".addslashes($_SESSION["session"]["idioma"])."'";
      $con = DescExecQuery($q, $connectCL, "N");
      while ($rec = mysql_fetch_assoc($con)) {
        $Classe[$classe_atual][$rec["vlr_classe"]] = $rec["desc_classe"];
      }
    }
  }

  // $campos_select  = trim($campos_select);
  // $campos_select2 = trim($campos_select2);
  // $campos_select  = substr($campos_select , 0, strlen($campos_select )-1);
  // $campos_select2 = substr($campos_select2, 0, strlen($campos_select2)-1);


  if ($procura == "OK") {
    $where_selecao = "";

    if ($selecao_tipo_produto) {
      $selecao_tipo_produto_arr = explode("¬", $selecao_tipo_produto);

      if (($tipo_produto) && ($tipo_produto != "TODOS"))  {
        if (strtoupper($selecao_classe_arr[2]) == "LIKE") {
          $where_selecao  .= $selecao_tipo_produto_arr[1]." LIKE '".$tipo_produto."%' AND ";
        } else {
          $where_selecao  .= $selecao_tipo_produto_arr[1]." = '".$tipo_produto."' AND ";
        }
      }
    }

    if ($selecao_produto) {
      $selecao_produto_arr = explode("¬", $selecao_produto);

      if (($cod_produto) && ($cod_produto != "TODOS")) {
        if (strtoupper($selecao_classe_arr[7]) == "LIKE") {
          $where_selecao  .= $selecao_produto_arr[1]." LIKE '".$cod_produto."%' AND ";
        } else {
          $where_selecao  .= $selecao_produto_arr[1]." = '".$cod_produto."' AND ";
        }
      }
    }


    if ($selecao_mailing_pesquisa) {
      $selecao_mailing_pesquisa_arr = explode("¬", $selecao_mailing_pesquisa);

      if (empty($mailing_pesquisa) === false) {
        if (strtoupper($selecao_classe_arr[7]) == "LIKE") {
          $where_selecao  .= $selecao_mailing_pesquisa_arr[2]." LIKE '".$mailing_pesquisa."%' AND ";
        } else {
          $where_selecao  .= $selecao_mailing_pesquisa_arr[2]." = '".$mailing_pesquisa."' AND ";
        }
      }
    }

    $subquery = "";
    for ($i = 0; $i <= 99; $i++) {
      $nome_var = "subquery_".str_pad($i, 2, "0", STR_PAD_LEFT);
      if (isset($$nome_var)) {
        $subquery .= $$nome_var." ";
      }
    }

    for ($i = 1; $i <= $qtd_param_classe; $i++) {
      $i = str_pad($i, 2, "0", STR_PAD_LEFT);
      $aux = "selecao_classe_".$i;



      if ($$aux) {

        if ((substr($repre, 0, 5) == 'HONDA') && (strpos(${$aux}, 'EKBTV') !== false)) {
          # EXBIV -TRANSFORMA o COMBO EM VARÍAVEL
          continue;
        }

        $selecao_classe_arr = explode("¬", $$aux);

         $aux = "CL_selecao_classe_".$i;


         if (($$aux != "" && !is_array($$aux)) || (is_array($$aux) && trim(${$aux}[0]) != "")) {
           if ((($repre == "CAEXPORTADOR") && ($$aux == "TD"))) {
             continue;
           }
           if (!is_array($$aux)) {
             $$aux = strtoupper($$aux);
           }

           if ($$aux != "TODOS") {

            //colocado if para quando for multiplo não explodir
            if (!is_array($$aux)) {
              $arraux = explode("-", $$aux);
            }
            $selecao_classe_arr[7] = strtoupper($selecao_classe_arr[7]);

            //quando for combo multiplo tem que fazer um IN
            if (strtoupper($selecao_classe_arr[7]) == 'MULT') {
              foreach ($$aux as $chave_mult => $valor_mult) {
                $where_mult .= "'".$valor_mult."',";
              }
              $where_mult = substr($where_mult, 0, -1);

              $where_selecao .= $selecao_classe_arr[2]." IN (".$where_mult.") AND ";

            } else if ($arraux[0] == 'GRUPO') {

              $arraux[1] = str_replace(",","','",$arraux[1]);
              $arraux[1] = "'".$arraux[1]."'";

              $where_selecao .= $selecao_classe_arr[2]." IN (".$arraux[1].") AND ";
            } elseif ($arraux[0] == 'TODOS') {//GV__3

              $arraux[1] = str_replace(",","','",$arraux[1]);
              $arraux[1] = "'".$arraux[1]."'";

              $where_selecao .= $selecao_classe_arr[2]." NOT IN (".$arraux[1].") AND ";
            } else if ($selecao_classe_arr[7] == "IGUAL") {
              $where_selecao .= $selecao_classe_arr[2]." = '".$$aux."' AND ";
            } else if ($selecao_classe_arr[7] == "DIFERENTE") {
              $where_selecao .= $selecao_classe_arr[2]." != '".$$aux."' AND ";
            } else if ($selecao_classe_arr[7] == "LIKE") {
              $where_selecao .= $selecao_classe_arr[2]." LIKE '".$$aux."%' AND ";
            } else if ($selecao_classe_arr[7] == "LIKE2") {
              $where_selecao .= $selecao_classe_arr[2]." LIKE '%".$$aux."%' AND ";
            } else if ($selecao_classe_arr[7] == "MAIOR") {
              $where_selecao .= $selecao_classe_arr[2]." > '".$$aux."' AND ";
            } else if ($selecao_classe_arr[7] == "MENOR") {
              $where_selecao .= $selecao_classe_arr[2]." < '".$$aux."' AND ";
            } else if ($selecao_classe_arr[7] == "MAIORIGUAL") {
              $where_selecao .= $selecao_classe_arr[2]." >= '".$$aux."' AND ";
            } else if ($selecao_classe_arr[7] == "MENORIGUAL") {
              $where_selecao .= "<= '".$$aux."'";
              $where_selecao .= $selecao_classe_arr[2]." <= '".$$aux."' AND ";
            } else {
              $where_selecao .= $selecao_classe_arr[2]." = '".$$aux."' AND ";
            }
          }
        }
        //Troca no nome da tabela da monitoria de acordo com a classe MOTMO, somendo quando tiver "[motmo]" no nome da tabela no parametro

        if ((strtoupper($selecao_classe_arr[1]) == "MOTMO") && (strpos(strtolower($tabela), "[motmo]") > 0)) {
          $tabela    = str_replace("[motmo]",$$aux, strtolower($tabela));
          $subquery  = str_replace("[motmo]",strtolower($$aux), $subquery);
          $tabela = strtolower($tabela);
        } else if ((strtoupper($selecao_classe_arr[1]) == "MOTMO") && (strpos(strtolower($tabela), "[motab]") > 0)) {
          $motab     = ValorClasse("MOTAB", $$aux, $repre);
          $tabela    = str_replace("[motab]",$motab, strtolower($tabela));
          $subquery  = str_replace("[motab]",strtolower($motab), $subquery);
          $tabela = strtolower($tabela);
        }
        // echo "<pre>";
        // print_r($repre."**");
        // print_r($$aux."**");
        // print_r($motab);
        // echo "</pre>";
      }
    }


    for ($i = 1; $i <= $qtd_param_campo; $i++) {
      $i = str_pad($i, 2, "0", STR_PAD_LEFT);
      $aux = "selecao_campo_".$i;
      $aux2 ="CPO_selecao_campo_".$i;
      $vlrcombocampo = "param_selecao_campo_".$i;

      if ($$aux) {
        $selecao_campo_arr = explode("¬", $$aux);

       $aux = "CPO_selecao_campo_".$i;

       if ($selecao_campo_arr[1] == "LIMIT" && $$aux) {
         $param_order .= " LIMIT ".$$aux;//Acerto para colocar limit na query quando vier dos parametros SELECAO_CAMPO
         continue;
       }

       if(strpos("**".$selecao_campo_arr[0],",") > 0) {
          $where_selecao_aux = $$vlrcombocampo." ";
        } else {
          $where_selecao_aux = $selecao_campo_arr[2]." ";
        }

        $aux2 = "CPO_FIMselecao_campo_".$i;

        if ($$aux !=  "") {

          $where_selecao .= $where_selecao_aux;

          if ((($repre == "CAEXPORTADOR") && ($$aux == "TD"))) {
            continue;
          }

          if (strtoupper($$aux) == "TODOS")  {
            continue;
          }

          if ($selecao_campo_arr[1] == "IGUAL") {
            $where_selecao .= "= '".$$aux."'";
          } else if ($selecao_campo_arr[1] == "DIFERENTE") {
            $where_selecao .= "!= '".$$aux."'";
          } else if ($selecao_campo_arr[1] == "LIKE") {
            $where_selecao .= "LIKE '".$$aux."%'";
          } else if ($selecao_campo_arr[1] == "LIKE2") {
            $where_selecao .= "LIKE '%".$$aux."%'";
          } else if ($selecao_campo_arr[1] == "MAIOR") {
            $where_selecao .= "> '".$$aux."'";
          } else if ($selecao_campo_arr[1] == "MENOR") {
            $where_selecao .= "< '".$$aux."'";
          } else if ($selecao_campo_arr[1] == "MAIORIGUAL") {
            $where_selecao .= ">= '".$$aux."'";
          } else if ($selecao_campo_arr[1] == "MENORIGUAL") {
            $where_selecao .= "<= '".$$aux."'";
          } else if ($selecao_campo_arr[1] == "ENTRE") {
            $where_selecao .= " BETWEEN '".$$aux."' AND '".$$aux2."'";
          } else {
            $where_selecao .= "= '".$$aux."'";
          }
          $where_selecao .= " AND ";
        }
      }
    }

    for ($i = 1; $i <= $qtd_param_campo; $i++) {
      $i = str_pad($i, 2, "0", STR_PAD_LEFT);
      $aux = "selecao_flw_".$i;
      $aux2 ="CL_selecao_flw_".$i;
      $vlrcombocampo = "param_selecao_flw_".$i;

      if ($$aux) {
        $selecao_flw_arr = explode("¬", $$aux);

       $aux = "CL_selecao_flw_".$i;

       if(strpos("**".$selecao_flw_arr[0],",") > 0) {
          $where_selecao_aux = $$vlrcombocampo." ";
        } else {
          $where_selecao_aux = $selecao_flw_arr[2]." ";
        }

        $aux2 = "CL_FIMselecao_flw_".$i;

        if ($$aux !=  "") {

          $where_selecao .= $where_selecao_aux;

          if ((($repre == "CAEXPORTADOR") && ($$aux == "TD"))) {
            continue;
          }

          if (strtoupper($$aux) == "TODOS")  {
            $flw_permissoes  = explode("¢", getPermissoes($session["operador"], "MD", $nromodelo, "T", $grupo_acesso, $combo_area));
            (trim($flw_permissoes[9]) == "") ? $area_trabalho = $flw_permissoes[1] : $area_trabalho = $flw_permissoes[9];
            $arr_areas = explode(",",$area_trabalho);
            if (is_array($arr_areas)) {
              $where_selecao .= "IN (";
              foreach ($arr_areas as $chave => $cod_area) {
                $where_areas .= "'".$cod_area."',";
              }
              $where_selecao .= substr($where_areas, 0, -1);
              $where_selecao .= ")";
              $where_selecao .= " AND ";
            }
            continue;
          }

          if ($selecao_flw_arr[1] == "IGUAL") {
            $where_selecao .= "= '".$$aux."'";
          } else if ($selecao_flw_arr[1] == "DIFERENTE") {
            $where_selecao .= "!= '".$$aux."'";
          } else if ($selecao_flw_arr[1] == "LIKE") {
            $where_selecao .= "LIKE '".$$aux."%'";
          } else if ($selecao_flw_arr[1] == "LIKE2") {
            $where_selecao .= "LIKE '%".$$aux."%'";
          } else if ($selecao_flw_arr[1] == "MAIOR") {
            $where_selecao .= "> '".$$aux."'";
          } else if ($selecao_flw_arr[1] == "MENOR") {
            $where_selecao .= "< '".$$aux."'";
          } else if ($selecao_flw_arr[1] == "MAIORIGUAL") {
            $where_selecao .= ">= '".$$aux."'";
          } else if ($selecao_flw_arr[1] == "MENORIGUAL") {
            $where_selecao .= "<= '".$$aux."'";
          } else if ($selecao_flw_arr[1] == "ENTRE") {
            $where_selecao .= " BETWEEN '".$$aux."' AND '".$$aux2."'";
          } else {
            $where_selecao .= "= '".$$aux."'";
          }
          $where_selecao .= " AND ";
        }
      }
    }

    for ($i = 1; $i <= $qtd_param_campo; $i++) {

      // exit();
      $i = str_pad($i, 2, "0", STR_PAD_LEFT);
      $aux = "selecao_depende_".$i;
      $aux2 ="CL_selecao_depende_".$i;
      $vlrcombocampo = "param_selecao_depende_".$i;

      if ($$aux) {
        $selecao_depende_arr = explode("¬", $$aux);

        $arr_depende_prefixo = explode(".", $selecao_depende_arr[2]);
        if(is_array($arr_depende_prefixo)){
          $prefixo_campo = $arr_depende_prefixo[0];
          $campoDepende  = $arr_depende_prefixo[1];
        }else{
          $campoDepende = $selecao_depende_arr[2];
        }


        $aux = "CL_selecao_depende_".$i;

       if(strpos("**".$selecao_depende_arr[0],",") > 0) {
          $where_selecao_aux = $$vlrcombocampo." ";
        } else {
          if($campoDepende == "filtro_tema_pai"){
            $where_selecao_aux = $prefixo_campo.".tema_pai";
          }else{
            $where_selecao_aux = $selecao_depende_arr[2]." ";
          }
        }

        $aux2 = "CL_FIMselecao_depende_".$i;

        if ($$aux !=  "") {

          $where_selecao .= $where_selecao_aux;

          if ((($repre == "CAEXPORTADOR") && ($$aux == "TD"))) {
            continue;
          }

          if (strtoupper($$aux) == "TODOS")  {
            continue;
          }
          // var_dump("<pre>",$selecao_depende_arr,"</pre>");
          switch ($campoDepende) {
            case 'tema_pai':
              if ($selecao_depende_arr[1] == "IGUAL") {
                $where_selecao .= "= '".$$aux."'";
              } else if ($selecao_depende_arr[1] == "DIFERENTE") {
                $where_selecao .= "!= '".$$aux."'";
              } else if ($selecao_depende_arr[1] == "LIKE") {
                $where_selecao .= "LIKE '".$$aux."%'";
              } else if ($selecao_depende_arr[1] == "LIKE2") {
                $where_selecao .= "LIKE '%".$$aux."%'";
              } else if ($selecao_depende_arr[1] == "MAIOR") {
                $where_selecao .= "> '".$$aux."'";
              } else if ($selecao_depende_arr[1] == "MENOR") {
                $where_selecao .= "< '".$$aux."'";
              } else if ($selecao_depende_arr[1] == "MAIORIGUAL") {
                $where_selecao .= ">= '".$$aux."'";
              } else if ($selecao_depende_arr[1] == "MENORIGUAL") {
                $where_selecao .= "<= '".$$aux."'";
              } else if ($selecao_depende_arr[1] == "ENTRE") {
                $where_selecao .= " BETWEEN '".$$aux."' AND '".$$aux2."'";
              } else {
                $where_selecao .= "= '".$$aux."'";
              }
            break;
              case 'filtro_tema_pai':
                if ($selecao_depende_arr[1] == "IGUAL") {
                  $where_selecao .= "= '${$aux.'_aux'}'";
                } else if ($selecao_depende_arr[1] == "DIFERENTE") {
                  $where_selecao .= "!= '${$aux.'_aux'}'";
                } else if ($selecao_depende_arr[1] == "LIKE") {
                  $where_selecao .= "LIKE '${$aux.'_aux'}%'";
                } else if ($selecao_depende_arr[1] == "LIKE2") {
                  $where_selecao .= "LIKE '%${$aux.'_aux'}%'";
                } else if ($selecao_depende_arr[1] == "MAIOR") {
                  $where_selecao .= "> '${$aux.'_aux'}'";
                } else if ($selecao_depende_arr[1] == "MENOR") {
                  $where_selecao .= "< '${$aux.'_aux'}'";
                } else if ($selecao_depende_arr[1] == "MAIORIGUAL") {
                  $where_selecao .= ">= '${$aux.'_aux'}'";
                } else if ($selecao_depende_arr[1] == "MENORIGUAL") {
                  $where_selecao .= "<= '${$aux.'_aux'}'";
                } else if ($selecao_depende_arr[1] == "ENTRE") {
                  $where_selecao .= " BETWEEN '${$aux.'_aux'}' AND '".$$aux2."'";
                } else {
                  $where_selecao .= "= '${$aux.'_aux'}'";
                }
              break;
          }

          $where_selecao .= " AND ";
          if($campoDepende == "tema_pai" && ${$aux.'_aux'} != "TODOS"){
            $where_selecao .= "{$prefixo_campo}.tema = '${$aux.'_aux'}' AND ";
          }
        }

      }
    }

    // exit;

    // ************************************  Monta o Where por ano_mes *********************************************************************
    // Quando usar o parametro de escolha do ano_mes não é possivel usar o controles de datas.
    // Com mais de uma campo de filtro [ano_mes_referencia,alternativa_01¬calendarioanomes¬Mês,Teste].
    // Com apnes um campo de filtro [ano_mes_referencia¬calendarioanomes¬Mês].

  if ($param_cmp_ano_mes[3] == "") {// para não usar no where, apenas para selecionar
    if ($param_cmp_ano_mes[0]) {
      if ($param_cmp_ano_mes[1] == "") {
        $cmp_ano_mes_ini = str_replace("-", "", substr($data_filtro_ini,0,7));
        $cmp_ano_mes_fim = str_replace("-", "", substr($data_filtro_fim,0,7));
      } else {
        $cmp_ano_mes_ini = $ano_mes;
      }

      if (str_replace("-", "", substr($data_filtro_ini,0,7)) != str_replace("-", "", substr($data_filtro_fim,0,7))) {
        $param_where  .= " AND ".$nome_cpo_ano_mes. " BETWEEN '".$cmp_ano_mes_ini."' AND '".$cmp_ano_mes_fim."'";
      } else {
        $param_where  .= " AND ";
        if ($param_cmp_ano_mes[4] == "IGUAL") {
          $param_where .= $nome_cpo_ano_mes. " = '".$cmp_ano_mes_ini."' ";
        } else if ($param_cmp_ano_mes[4] == "DIFERENTE") {
          $param_where .= $nome_cpo_ano_mes. " != '".$cmp_ano_mes_ini."' ";
        } else if ($param_cmp_ano_mes[4] == "LIKE") {
          $param_where .= $nome_cpo_ano_mes. " LIKE '".$cmp_ano_mes_ini."%' ";
        } else if ($param_cmp_ano_mes[4] == "MAIOR") {
          $param_where .= $nome_cpo_ano_mes. " > '".$cmp_ano_mes_ini."' ";
        } else if ($param_cmp_ano_mes[4] == "MENOR") {
          $param_where .= $nome_cpo_ano_mes. " < '".$cmp_ano_mes_ini."' ";
        } else if ($param_cmp_ano_mes[4] == "MAIORIGUAL") {
          $param_where .= $nome_cpo_ano_mes. " >= '".$cmp_ano_mes_ini."' ";
        } else if ($param_cmp_ano_mes[4] == "MENORIGUAL") {
          $param_where .= $nome_cpo_ano_mes. " <= '".$cmp_ano_mes_ini."' ";
        } else {
          $param_where .= $nome_cpo_ano_mes. " = '".$cmp_ano_mes_ini."' ";
        }

      }
    }
  }
  // ************************************ FIM Monta o Where por ano_mes ******************************************************************

    $where_consulta = $param_where;
    $where_batch    = $param_wherebat;

    if($_GET['processo'] == 'AT'){

      if (is_array($param_cmp_dt)) {
        $nomeCampoData = $param_campo_data; //Várias opções de data, pega a que foi selecionada no combo
      } else {
        $nomeCampoData = $param_cmp_dt;
      }

      if (is_array($param_cmp_hr)) {
        $nomeCampoHora = $param_campo_hora; //Várias opções de hora, pega a que foi selecionada no combo
      } else {
        $nomeCampoHora = $param_cmp_hr;
      }

      switch($action_processo_at){
        case "ANO_MES":
          $where_consulta .= "{$nomeCampoData} = '{$ano_mes_AT}'";
        break;
        case "DATE":

          if($data_ini_AT === $data_fim_AT){
            $where_consulta .=  " AND {$nomeCampoData} = '{$data_ini_AT}'";
          }else{
            $where_consulta .=  " AND {$nomeCampoData} BETWEEN '{$data_ini_AT}' AND '{$data_fim_AT}'";
          }

        break;
        case "DATETIME":

          if($data_ini_AT === $data_fim_AT){
            $where_consulta .=  " AND {$nomeCampoData} = '{$data_ini_AT}'";
          }else{
            $where_consulta .=  " AND {$nomeCampoData} BETWEEN '{$data_ini_AT}' AND '{$data_fim_AT}'";
          }

          if($time_ini_AT === $time_fim_AT){
            $where_consulta .=  " AND {$nomeCampoHora} = '{$time_ini_AT}'";
          }else{
            $where_consulta .=  " AND {$nomeCampoHora} BETWEEN '{$time_ini_AT}' AND '{$time_fim_AT}'";
          }

        break;
      }

    }else{
      if ($param_cmp_ano_mes[1] == "") {
        if (is_array($param_cmp_dt)) {
          $nomeCampoData = $param_campo_data; //Várias opções de data, pega a que foi selecionada no combo
        } else {
          $nomeCampoData = $param_cmp_dt;
        }

        if ($nomeCampoData && $nomeCampoData != "[SEM_DATA]" && $nomeCampoData != "[TRATADO_ESPECIFICO]" && $param_cmp_dthr == "") {
          if ($data_filtro_ini == $data_filtro_fim || ($intervalo_dt != "S" && $intervalo_dt != "M")) {
            $where_consulta .= " AND {$nomeCampoData} = '{$data_filtro_ini}' ";
          } else {
            $where_consulta .= " AND {$nomeCampoData} BETWEEN '{$data_filtro_ini}' AND '{$data_filtro_fim}'";
          }
        }
      }


      if ($hora_filtro_ini != "00:00" || $hora_filtro_fim != "24:00") {

        if (is_array($param_cmp_hr)) {
          $nomeCampoHora = $param_campo_hora; //Várias opções de hora, pega a que foi selecionada no combo
        } else {
          $nomeCampoHora = $param_cmp_hr;
        }

        if ($nomeCampoHora && $param_cmp_dthr == "") {
          if ($intervalo_hr != "S" && $intervalo_hr != "M") {
            $where_consulta .= " AND {$nomeCampoHora} = '{$hora_filtro_ini}:00' ";
          } else {
            $where_consulta .= " AND {$nomeCampoHora} BETWEEN '{$hora_filtro_ini}:00' AND '".CalculaDifSegundos($hora_filtro_fim.":00", 1)."' ";
          }
        }
        if ($param_cmp_dthr != "") {
          $where_consulta .= " AND {$nomeCampoHora} BETWEEN '{$data_ini} {$hora_filtro_ini}:00' AND '{$data_ini} {$hora_filtro_fim}:59' ";
        }

      }
    }




    //CAMPOS DA SELECAO
    if (empty($where_selecao) === false) {
      $where_consulta .= " AND ".substr($where_selecao, 0, -4);
    }

    //WHERE DOS NOVOS CANAIS
    if (empty($rel_where) === false && $discador_modelo != "DKK0") {
      $where_consulta .= " ".stripslashes($rel_where);
    }

    //if ((empty($update_00) === false) && ($RD_update_00 == "S" || $RD_update_00 == "B"))
    if (empty($update_00) === false) {
      if ($_POST["processo"] == "AUTO") {
        $where_consulta = $where_batch;
      }

      // $campos_select_index = "";
      $q     = "SHOW INDEX FROM ".$tabela;
      $query = DescExecQuery($q, $connectHOST);
      if ($rec = mysql_fetch_assoc($query)) {
        do {
          if ($rec["Key_name"] != "PRIMARY") {
            continue;
          }
          // $campos_select_index .= $rec["Column_name"].", ";
          $arrCposIndex[] = $rec["Column_name"];
          // $arr_column_index[$rec["Column_name"]] = $rec["Column_name"];
        } while ($rec = mysql_fetch_assoc($query));

        if (count((array)$arrCposIndex) > 0) {
          $count_index = 0;
        } else {
          $where_up = $where_consulta;
        }
      } else {
        $where_up = $where_consulta;
      }
    }

    if ($pular_registro == "S") {
      // $campos_select .= ", bmc_status_contrato";
      $arrCposBonus[] = "bmc_status_contrato";
    }

    //**************************\\
    //* A query é montada aqui *\\
    //**************************\\
    $jaUsouWhere = false;
    $where_usado = "";

    if ($_POST["processo"] == "AUTO") {
      $where_usado = $where_batch;
    } else {
      $where_usado = $where_consulta;
    }






    if (trim($subquery) != "") {
      $subquery = str_replace("(A)", "'", $subquery);
      $subquery = str_replace("[=TABELA=]" , $tabela, $subquery);

      if (strpos(" ".$subquery, "[=WHERE=]") > 0) {
        $subquery = str_replace("[=WHERE=]" , $where_usado, $subquery);
        $jaUsouWhere = true;
      }
      $tabela_usada = "(".$subquery.") AS subquery";
    } else {
      $tabela_usada = $tabela;
    }

    $arrCposTotal = array_merge($arrCposParam, $arrCposIndex, $arrCposBonus, $arrFieldList);
    $arrCposTotal = array_unique($arrCposTotal);

    // Remove do array se houver algum item em branco
    $arrCposTotal = array_diff($arrCposTotal, array(""));

    $q = "SELECT ".implode(", ", $arrCposTotal)." FROM ".$tabela_usada;
    if (!$jaUsouWhere) {
      $q .= " ".$where_usado;
    }

    if (empty($update_00) === false) {
      $arr_up = explode("¬", $update_00);
    }

    //ARQUIVO AUTOMATICO
    //if (($_POST["processo"] == "AUTO" && $arr_up[0] == "B") || ($arr_up[0] == "A" && $_POST["processo"] != "AUTO" )) {
    if (($_POST["processo"] == "AUTO") || ($arr_up[0] == "A")) {

      if (empty($RD_update_00) === true) {
        $RD_update_00 = $arr_up[0];
      }

    }
    unset($arr_up);
    //GROUP BY
    if ($param_group != "--") {
      $q .= " ".$param_group;
    }

    //ORDER BY
    if ($param_order != "--") {
      if ($hid_order == "") {
        $q .= " ".$param_order;
      } else {
        $q .= " ORDER BY ".substr($hid_order, 1, strlen($hid_order) - 2);
      }
    }

    if ($visualiza == "E" || $visualiza == "F") {
      $query_aux = $q;
    }

    // Replaces a serem feitos antes de executar a query
    $arrRpl = array (
      "(A)" => "\"",
      "[=ANO_MES=]" => $ano_mes,
      "[CLASSE_MKPRO]" => $discador_modelo,
      "[MK_FLAG]" => substr($discador_modelo, 0, 2),
      "[MK_NUMERO]" => substr($discador_modelo, 2, 2),
      "[=DATA_FILTRO_INI=]" => $data_filtro_ini,
      "[=DATA_FILTRO_FIM=]" => $data_filtro_fim,
      "[CBO_REPRE]" => $GLOBALS["repre"],
      "[=WHERE=]" => $where_usado,
      "[=BAT_SEQ=]" => $_POST["bat_seq"],
      "[=BAT_PREF_ARQ=]" => $pref_arq,
    );

    // Calculando as variáveis geradas pelos parâmetros VAR_xx
    foreach($arrVars as $id => $arr) {
      $arrVars[$id]["vlr"] = calculaValorVar($arr["tipo"], $arr["expressao"]);
      $arrRpl["[=".$arr["nome_var"]."=]"] = $arrVars[$id]["vlr"];
    }

    // echo "<pre>";
    // var_dump($arrVars);
    // var_dump($arrRpl);
    // echo "</pre>";

    $q = str_ireplace(array_keys($arrRpl), array_values($arrRpl), $q);

    // ***** Não alterar mais a query ($q) daqui para baixo (somente os tratamentos da Exportação por FTP)
    // ***** Não alterar mais a query ($q) daqui para baixo (somente os tratamentos da Exportação por FTP)
    // ***** Não alterar mais a query ($q) daqui para baixo (somente os tratamentos da Exportação por FTP)
    $queryMontada = $q;

    if ($visualiza == "F" ) {//Exportação por FTP
      $qCount = "SELECT COUNT(*) AS total FROM ({$q}) AS TabelaCont";
      $q .= " LIMIT 10";
    }

    if ($_POST["processo"] == "BATCH") {
      $q = $query_completa;
    }

    if ($_POST["debug"] == "S") {
      print "\n\n SQL:[".$q."]";
      exit;
    }


    if ($visualiza == "F") {
      $queryCount = DescExecQuery($qCount, $connectHOST);
      $recCout = mysql_fetch_assoc($queryCount);
      $QtdCount = $recCout["total"];
      unset($queryCount);
      unset($recCout);
    }

    if(($visualiza == "J" || $_GET['processo'] == "AT") && $_GET['debug'] == "debug_at"){
      var_dump($q)."\r\n";
    }


    $query = DescExecQuery($q, $connectHOST);
    if ($include_imprime != "") {
      $query_include_imprime = $q;
    }
    if (!$query) {
      if ($_REQUEST["teste"] == "S" || $_POST["processo"] == "AUTO" || $_GET['processo'] == "AT") {
        print mysql_error($connectHOST)."\n";
      }
    } else {

      if($_GET['processo'] == "AT" && mysql_num_rows($query) === 0){
        print "msg: Nenhum Registro";
        exit;
      }


      $x = mysql_num_rows($query);

      $tot_reg_rodape = $x;
      $sub_total_aux = explode(",", $sub_total);

//inicio
      if (empty($sub_total) === FALSE) {

        while ($rec = mysql_fetch_assoc($query)) {
          $sub_total_index = "";
          foreach ($sub_total_aux as $chave => $vlr) {
            $sub_total_index .= $rec[$vlr]."|";
          }
          $sub_total_index = substr($sub_total_index, 0 , -1);

          foreach ($mtz_campos[$tpreg] as $key => $campo_vlr) {
 
            if ($mtz_campos[$tpreg][$key]["TOTALIZAR"] == "S") {

              //$auxMtzCmps = explode(" as ", $mtz_campos[$tpreg][$key]["VLR"]);
         
              if ($mtz_campos[$tpreg][$key]["TIPO"] == "FUNCAO") {
                $auxF = substr($mtz_campos[$tpreg][$key]["VLR"], (strpos($mtz_campos[$tpreg][$key]["VLR"], "(")+1), -1);
                $posAS = strpos(strtoupper($auxF), " AS ");
                if ($posAS !== false) {
                  $strParam = substr($auxF, $posAS + 4);
                }
                $auxMtzCmps[1] = $strParam;

               // print_r($strParam);
                //exit;
                //$auxMtzCmps[1] = substr($mtz_campos[$tpreg][$key]["VLR"], (strpos($mtz_campos[$tpreg][$key]["VLR"], "(")+1), -1);
              } else {
                // if ($auxMtzCmps[1] == "") {
                //   $auxMtzCmps[1] = $mtz_campos[$tpreg][$key]["VLR"];
                // }
                $posAS = strpos(strtoupper($mtz_campos[$tpreg][$key]["VLR"]), " AS ");
                if ($posAS !== false) {
                  $strParam = substr($mtz_campos[$tpreg][$key]["VLR"], $posAS + 4);
                } else {
                  $strParam = $mtz_campos[$tpreg][$key]["VLR"];
                }
                $auxMtzCmps[1] = $strParam;
              }

              $mtz_totalizar[$tpreg]["tot_".$key] += $rec[$auxMtzCmps[1]];

              if ($sub_total != "") {
                $mtz_totalizar["SUB_TOTAL"]["stot_".$key][$sub_total_index] += $rec[$auxMtzCmps[1]];
              }
              unset($auxMtzCmps);
            }
          }
          if ($usa_join != "") {

            foreach ($rec as $chave => $valor) {
              if ($valor != "") {
                $temreg++;
              }
            }
            if ($temreg == 0) {
              $x--;
              continue;
            }
          }
        }
      }
      unset($sub_total_aux);

      if ($x != 0) {
        mysql_data_seek($query, 0);
      }

      if ($visualiza == "T" || $visualiza == "E" || $visualiza == "F") {

        if($usa_bootstrap == true){
          $dados_exporta.= "<table id='dadosExporta' class='table table-striped table-bordered table-responsive font-small table-small' border='1'>";
          $dados_exporta.= "<thead>";
        }else{
          $dados_exporta.= "<table id='dadosExporta' style='width: 100%; border-collapse:collapse;' bordercolor='".$session["td_destaque1"]."' border='1' cellpadding='0' cellspacing='0' align='center' >";
        }

        if($inibir_total_reg != "S") {

          $dados_exporta_tot.= " <tr ".$bgcolor_td_destaque.">";

          if ($visualiza == "E" || $visualiza == "F") {
            $dados_exporta_tot.= " <td align='center' colspan='".count((array)$mtz_campos[$tpreg])."'><font class='".$txt6_titulo_table."'><strong>Amostra dos registros que serão gerados</font></td>";
          } else {
            if (strtolower($inibir_total_reg) != "tit_classe") {
              $dados_exporta_tot.= " <td align='center' colspan='".count((array)$mtz_campos[$tpreg])."'><font class='".$txt6_titulo_table."'><strong>".$x." registros</font></td>";
            } else {
              $dados_exporta_tot.= " <td align='center' colspan='".count((array)$mtz_campos[$tpreg])."'><font class='titcol'><strong>".$titulo_exportacao."</font></td>";
            }
          }

          $dados_exporta_tot.= "  </tr>";

          $dados_exporta .= $dados_exporta_tot;
        }

        $dados_exporta.= "  <tr ".$bgcolor_td_destaque.">";

        if (is_array($arr_tit)) {
          foreach ($arr_tit as $key => $vlr) {
            $agrupa_coluna_tit .= $vlr."¬";
          }
          $agrupa_coluna_tit = substr($agrupa_coluna_tit, 0 ,-1);
          unset($arr_tit);
        }

        if ($agrupa_coluna_tit != "") {
          $arr_aux = explode('¬', $agrupa_coluna_tit);

          foreach ($arr_aux as $key => $vlr) {
            $arr_param = explode('|', $vlr);

            $titulo_agrupo  = $arr_param[1];
            $arr_campos_aux = explode(',', $arr_param[0]);

            foreach ($arr_campos_aux as $key2 => $vlr2) {
              if ($key2 == 0) {
                $arr_campo_tit[$vlr2] = $titulo_agrupo."¬".count((array)$arr_campos_aux);
              } else {
                $arr_campo_tit[$vlr2] = "++[pula]++";
              }
            }
            unset($arr_param);
            unset($arr_campos_aux);
          }
          unset($arr_aux);
        }
        foreach ($mtz_campos[$tpreg] as $key=>$campo_vlr) {
          if($mtz_campos[$tpreg][$key]["DESC"] == "FAKECOLUMN")
            continue;

          if ($agrupa_coluna_tit == "") {
            $dados_exporta.= "  <td align='center'><font id='cabec_{$key}' class='".$txt6_titulo_table."'><strong>".$mtz_campos[$tpreg][$key]["DESC"]."</strong></font></td>";
          } else {

            if ($arr_campo_tit[$key]) {
              $arr_aux = explode('¬',$arr_campo_tit[$key]);

              if ($arr_aux[0] != "++[pula]++") {
                $dados_exporta.= "  <td colspan='".$arr_aux[1]."' align='center'><font class='".$txt6_titulo_table."'><strong>".$arr_aux[0]."</strong></font></td>";
              }

              if($usa_bootstrap == true){
                $dados_exporta2.= "  <td nowrap align='center' ><strong>".$mtz_campos[$tpreg][$key]["DESC"]."</strong></td>";
              }else{
                $dados_exporta2.= "  <td nowrap align='center' style='border:1px solid ".$session['td_destaque'].";' ><font class='peq'><strong>".$mtz_campos[$tpreg][$key]["DESC"]."</strong></font></td>";
              }


              unset($arr_aux);
            } else {
              $dados_exporta.= "  <td rowspan='2' align='center'><font class='".$txt6_titulo_table."'><strong>".$mtz_campos[$tpreg][$key]["DESC"]."</strong></font></td>";
            }

          }

        }
        unset($arr_campo_tit);
        $dados_exporta.= "  </tr>";

        if ($dados_exporta2 != "") {
         $dados_exporta.= "  <tr ".$bgcolor_td_destaque1.">";
         $dados_exporta.= $dados_exporta2;
         $dados_exporta.= "  </tr>";
         unset($dados_exporta2);
        }

        $td_fim = $bold_fim."</font></td>";

      } else if ($visualiza == "A") {

        if(strtoupper($header) == "DESC_CAMPO" && $delimitador != "FIXO") {
          $dados_exporta     = "";

          if (!isset($dados_exporta_tit_ext)) {
             $dados_exporta_tit_ext = "";
          }

          // $dados_exporta_tit = "";

          foreach ($mtz_campos[$tpreg] as $key=>$campo_vlr){
             if (strtoupper($mtz_campos[$tpreg][$key]["DESC"]) == '[=LATDI=]') {
            //   if (empty($GLOBALS['repre']) === false && empty($GLOBALS['CL_selecao_classe_01']) === false ) {
            //     $dados_exporta_tit .= implode(';', $GLOBALS['arrTitulo']);
            //   }
              continue;
             } else {
               $dados_exporta_tit.= $mtz_campos[$tpreg][$key]["DESC"].$delimitador;
            }


          }
          //$dados_exporta .= "\r\n";
          $dados_exporta_tit .= $dados_exporta_tit_ext;
          $dados_exporta_tit = substr($dados_exporta_tit, 0, -1)."\r\n";

        }elseif(strtoupper($header) == "CAMPO" && $delimitador != "FIXO") {
          $dados_exporta     = "";
          $dados_exporta_tit = "";
          foreach ($mtz_campos[$tpreg] as $key=>$campo_vlr){
            $dados_exporta_tit.= $mtz_campos[$tpreg][$key]["VLR"].$delimitador;
          }
          //$dados_exporta .= "\r\n";
          $dados_exporta_tit = substr($dados_exporta_tit, 0, -1)."\r\n";
        }

        if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO") {
          $dados_exporta = $dados_exporta_tit;
        }

        if ($delimitador != "FIXO") {
          $td_fim = $delimitador;
        }
      }

      $temreg = 0;

      if ($visualiza == "E" || $visualiza == "F" && ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO" && $_GET["processo"] != "AT")) {
?>
        <div id="ExtracaoAuto" style="margin: 0 auto; width:650px"></div>
        <input type="hidden" id="id_camapanha"      name="camp"           value="<?print $Camp?>">
        <input type="hidden" id="id_desc_camapanha" name="desc_camapanha" value="<?print $DesCamp?>">
        <script>
          AgendarExtracaoAuto('<?print $repre?>','EXI','<?print urlencode($carga_auto)?>', '<?print $QtdCount?>','<?print $exportacao?>','<?print urlencode($bdado_aux)?>','<?print urlencode($queryMontada)?>',document.getElementById("id_camapanha").value,document.getElementById("id_desc_camapanha").value,'<?print $visualiza?>','<?print $extracao_ftp?>','<?print urlencode($param_arquivo)?>',document.getElementById("id_delimitador").value);
        </script>
        <br>
<?
      }

      $limit = 0;
      $ttt=0;
      $reg_ht = 0;
      $pos_atual=0;

      $td_dado3    = $session["td_dado3"];
      $td_destaque = $session["td_destaque"];
      $txt5        = $txt5_corpo_table;
      $txt6        = $txt6_corpo_table;


      if ($visualiza == "T" || $visualiza == "E" || $visualiza == "F") {
        if($usa_bootstrap == true){
          $dados_exporta.= "</thead>";
          if ($x > 0) {
             $dados_exporta.= "<tbody>";
          }
        }
      }

      if ($visualiza == "A" || $visualiza == "F") {

        if (is_array($mtz_campos["header"])) {
          foreach ($mtz_campos["header"] as $key => $campo_vlr) {

            if ($mtz_campos["header"][$key]["TPCA"] == "CHAR") {
              $completa_lado = STR_PAD_RIGHT;
              $completa_cara = " ";
            } else if ($mtz_campos["header"][$key]["TPCA"] == "NUM" || $mtz_campos["header"][$key]["TPCA"] == "DECIMAL") {
              $completa_lado = STR_PAD_LEFT;
              $completa_cara = "0";
            }
            $campo = $campo_vlr["VLR"];

            $campo = str_replace("var_dt_agora"  , $dt_agora  , $campo);
            $campo = str_replace("var_hr_agora"  , $hr_agora  , $campo);
            $campo = str_replace("var_dthr_agora", $dthr_agora, $campo);
            $campo = str_replace("var_prox_seq_arq", $prox_num_seq, $campo);


            if(substr($mtz_campos["header"][$key]["TPCA"], 0, 4) == "DATE") {
              $completa_lado = STR_PAD_RIGHT;
              $completa_cara = " ";

              $formato = substr($mtz_campos["header"][$key]["TPCA"],(strpos($mtz_campos["header"][$key]["TPCA"],"(")+1), -1);

              $campo = FormataTipoDate($campo, $formato);

              if ($mtz_campos["header"][$key]["SIZE"] == "") {
                $mtz_campos["header"][$key]["SIZE"] = strlen($campo);
              }
            }

            if ($mtz_campos["header"][$key]["TIPO"] == "FUNCAO") {
              $vlr_ret_func = execFuncao($mtz_campos["header"][$key]["VLR"], $campo);

              if (substr($mtz_campos["header"][$key]["TPCA"], 0, 4) == "DATE") {
                $vlr_ret_func = FormataTipoDate($vlr_ret_func, $mtz_campos["header"][$key]["DATE_FMT"]);
              }
              $campo = $vlr_ret_func;
            }

            if ($delimitador == "FIXO") {
              $dados_exporta_header .= str_pad($campo,$mtz_campos["header"][$key]["SIZE"],$completa_cara, $completa_lado).$td_fim;
            } else {
              $dados_exporta_header .= $campo.$td_fim;
            }

          }

        }
      }

      if ($visualiza == "J"){
        $retornoDadosJson = array();
      }

      $count_reg = 0;


      while ($rec = mysql_fetch_assoc($query)) {
      $pos_atual++;

      if ($tot_reg_rodape == $pos_atual && $ult_linha_rodape == "S") {
        $session["td_dado3"] = $td_destaque;
        $txt = $txt6;
        $bold_ini = "<strong>";
        $bold_fim = "</strong>";
      } else {
        $txt = $txt5;
        $bold_ini = "";
        $bold_fim = "";
      }

      if (($visualiza == "E" || $visualiza == "F") && ($limit == 10)) {
        break;
      }
      $limit++;

        // if ($usa_join != "") {
        //   foreach ($rec as $chave => $valor) {
        //     if ($valor != "") {
        //       $temreg++;
        //     }
        //   }
        //   if ($temreg == 0) {
        //     continue;
        //   }
        // }

        if (count((array)$arrCposIndex) > 0) {
          $count_index++;
          foreach ($arrCposIndex as $chave) {
            $arr_where_up[$count_index] .= $chave." = '".$rec[$chave]."' AND ";
          }
          $arr_where_up[$count_index] = "WHERE ".substr($arr_where_up[$count_index], 0, -4);
        }

        //*****************************************************************************
        //*****************************************************************************
        //IF PARA O SISTEMA DO BRADESCO RETENÇÃO V2 PARA EXPORTAR APENAS OS IMPRESSÕES
        //MAS É NECESSÁRIO DAR UPDATE EM TODOS OS REGISTROS DO PEDIDO *****************
        //Responsavel DAVID / MARCELO
        //*****************************************************************************
        //*****************************************************************************
        //if (($exportacao == "EXAWE" || $exportacao == "EXANE") && $rec["bmc_status_contrato"] != "I")
        if ($pular_registro == "S" && $rec["bmc_status_contrato"] != "I") {
          continue;//muda o registro Não imprime... pula linha
        }
        //*****************************************************************************
        //*****************************************************************************
        //*****************************************************************************
        //*****************************************************************************


          $temregistro = true;
          /***********************************************************************************************************/
          /***********************************************************************************************************/
          /*            ONDE MOSTRA AS TDS                                                                           */
          /***********************************************************************************************************/
          /***********************************************************************************************************/

          foreach ($mtz_campos[$tpreg] as $key => $campo_vlr) {

            if ($mtz_campos[$tpreg][$key]["TIPO"] == "getDadosAtendimentoMonitorado") {

              if($rec["nome_monitoria"]){
                $qDAM = "SELECT classe_mkpro, tabela_param, id_cliente from tb_integra_monitoria where id_unificado = '".addslashes($rec["nome_monitoria"])."' and tipo_monitoria = '".addslashes($rec["tipo_monitoria"])."' ";
                $cDAM = DescExecQuery($qDAM, ConnectMON());
                $rDAM = mysql_fetch_assoc($cDAM);
                if($rDAM["classe_mkpro"]){

                  $mkParam    = carregaArrParam($rDAM["classe_mkpro"]."A", "URANET", array ("bd", "host", "senha", "user"));
                  $conexaoDAM = new Conexao($mkParam["host"], $mkParam["bd"], $mkParam["user"], $mkParam["senha"]);
                  $where_add_dam = "";
                  $id_cliente = json_decode($rDAM["id_cliente"], true);
                  if(is_array($id_cliente)){
                    foreach($id_cliente as  $chave => $vlr){
                      $where_add_dam.= "AND ".$chave." = '".$vlr."' ";
                    }
                  }

                  if($where_add_dam){
                    $conexaoDAM->query("SELECT ".$mtz_campos[$tpreg][$key]["VLR"]." from ".$rDAM["tabela_param"]." where '1' = '1' ". $where_add_dam);
                    if($conexaoDAM->status === false) {
                      print "erro bd<br>".$conexaoDAM->getDescRetorno();
                      exit;
                    }
                    if($conexaoDAM->count > 0) {
                      foreach ($conexaoDAM->result as $chave => $vlr) {
                        $rec["m.mon.".$chave] = $vlr;
                      }
                    }
                  }
                }
              }
              continue;
            }


            $mtz_campos[$tpreg][$key]["VLR"] = str_replace("(A)", "'", $mtz_campos[$tpreg][$key]["VLR"]);
            $percentual = "";

            //*************** Aqui monta toda regra do sub total
            if ($sub_total != "") {
              $sub_total_aux = explode(",",$sub_total);


              if (trim($param_group) != "") {

                $posGROUP = strpos(strtoupper($param_group), "GROUP BY");
                if ($posGROUP !== false) {
                  $strParam = substr($param_group, $posGROUP + 8);
                  $strParam = explode(",",$strParam);
                }

                // foreach ($strParam as $chave => $vlr) {
                //   echo '<pre>';
                //   print_r($agrupa_coluna_tit);
                //   print_r($rec);
                //   exit;
                //   $sub_total_index .= $rec[$vlr]."|x";
                // }
 
              }

              $sub_total_index = "";
              foreach ($sub_total_aux as $chave => $vlr) {
                $sub_total_index .= $rec[$vlr]."|";
              }

              $sub_total_index = substr($sub_total_index,0 , -1);

              $sub_total_atual = $sub_total_index;

              if ($sub_total_atual != $sub_total_ant) {

                if ($sub_total_ant != "") {

                  if ($visualiza == "T" || $visualiza == "E" || $visualiza == "F" || $visualiza == "J") {

                    if(count((array)$mtz_totalizar["SUB_TOTAL"]) > 0) {
                      $dados_exporta.= "<tr ".$bgcolor_td_dado1.">";

                      foreach($mtz_campos[$tpreg] as $indice => $value) {

                        if ($value["TPCA"] == "NUM" || $value["TPCA"] == "DECIMAL") {
                          $completa_lado = "E";
                          $completa_cara = " ";
                        }


                        $dados_exporta.= "<td align='".$value["ALIGN"]."' nowrap>";
                        if ($usa_bootstrap == true) {
                          $dados_exporta.=   "<span class='blue'>";
                        }else{
                          $dados_exporta.=   "<font class='txt5'>";
                        }

                        if($value["TPCA"] == "DECIMAL") {
                          $decimalsize   = $value["DECI"];
                          $decimalcara   = $value["DECICARA"];
                          $numformatodo  = exibirValor($mtz_totalizar["SUB_TOTAL"]["stot_".$indice][$sub_total_ant]);//number_format($mtz_totalizar[$indice], $decimalsize, $decimalcara,'');
                          $dados_exporta.=   "<strong>".$numformatodo."</strong>";

                          if($visualiza == "J") {
                            $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = $numformatodo;
                          }

                        } else {
                          if ($value["TIPO"] == "PARM_PERC") {
                            $parm_perc = explode(",", $value["VLR"]);



                            if (substr($parm_perc[1], 0, 5) == "stot_") {
                              $percentual = "100.0";
                            } else {
                            //echo "<pre>";//.$parm_perc[1];// "**".$mtz_totalizar["SUB_TOTAL"]."**";
                            //print_r($parm_perc);
                            //print_r($mtz_totalizar["SUB_TOTAL"]);
                            //echo "**".$mtz_totalizar["SUB_TOTAL"]["stot_".$parm_perc[0]][$sub_total_ant]."**";
                              $percentual = percent_carlos($mtz_totalizar["SUB_TOTAL"]["stot_".$parm_perc[0]][$sub_total_ant], $mtz_totalizar[$tpreg]["tot_".$parm_perc[0]], $parm_perc[2]);
                            }

                            unset($parm_perc);

                            if(($visualiza == "A") && ($delimitador != "FIXO")){
                              $dados_exporta .= "<strong>".trim($percentual)."</strong>";
                            } elseif ($visualiza == "J") {
                              $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($percentual));
                            } else {
                              $dados_exporta .= "<strong>".completa($percentual, 5, $completa_cara, $completa_lado)."</strong>";
                            }

                          } else {

                            if ($value["TIPO"] == "FUNCAO" && ($value["TPCA"] == "NUM" || $value["TPCA"] == "DECIMAL")) {
                              $funcNome     = substr($value["VLR"], 0, strpos($value["VLR"], "("));
                              $vlr_ret_func = $funcNome($mtz_totalizar["SUB_TOTAL"]["stot_".$indice][$sub_total_ant]);
                            } else {
                              $vlr_ret_func = $mtz_totalizar["SUB_TOTAL"]["stot_".$indice][$sub_total_ant];
                            }

                            $dados_exporta .= "<strong>".completa($vlr_ret_func, $value["SIZE"], $completa_cara, $completa_lado)."</strong>";

                            if($visualiza == "J") {
                              $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($vlr_ret_func));
                            }


                          }
                        }

                        $dados_exporta.=   "</font>";
                        $dados_exporta.= "</td>";
                      }
                      $dados_exporta.= "</tr>";
                    }
                  }
                }
                $sub_total_ant = $sub_total_atual;//$rec[$sub_total];
              }
            }

            if ($temregistro) {
              if ($visualiza == "T" || $visualiza == "E"|| $visualiza == "F") {
                $dados_exporta.= " <tr ".$bgcolor_td_dado3.">";
              }
              $temregistro = false;
            }
            //*************** Monta o percentual na linha

            if ($mtz_campos[$tpreg][$key]["TIPO"] == "PARM_PERC") {

              $parm_perc = explode(",", $mtz_campos[$tpreg][$key]["VLR"]);
              $aling = $mtz_campos[$tpreg][$key]["ALIGN"];

              if ($aling == "") {
               $aling = "RIGHT";
              }
              if($visualiza == "T" || $visualiza == "E" || $visualiza == "F") {
               $td_ini = "<td align='".$aling."'><font class='".$txt."'>".$bold_ini;
              }

              $completa_lado = "D";
              if($visualiza == "A") {
               $completa_cara = "0";
              } else {
               $completa_cara = " ";
              }

              if ($sub_total != "") {

                if (substr($parm_perc[1], 0, 5) == "stot_") {//Subtotal - STOT
                  $tot_reg_sub_tot = $mtz_totalizar["SUB_TOTAL"][$parm_perc[1]][$sub_total_ant];
                } else {
                  $tot_reg_sub_tot = $mtz_totalizar[$tpreg][$parm_perc[1]];//TotalGeral - TOT
                }

              } else {
                $tot_reg_sub_tot = $mtz_totalizar[$tpreg][$parm_perc[1]];//Valor Total - TOT
              }

              if ($mtz_campos[$tpreg][$parm_perc[0]]["TIPO"] == "FUNCAO") {
               $vlr_aux = substr($mtz_campos[$tpreg][$parm_perc[0]]["VLR"], (strpos($mtz_campos[$tpreg][$parm_perc[0]]["VLR"], "(")+1), -1);
              } else {
               $vlr_aux = $mtz_campos[$tpreg][$parm_perc[0]]["VLR"];
              }

              if ($mtz_campos[$tpreg][$parm_perc[1]]["TIPO"] == "FUNCAO") {
               $vlr_aux2 = substr($mtz_campos[$tpreg][$parm_perc[1]]["VLR"], (strpos($mtz_campos[$tpreg][$parm_perc[1]]["VLR"], "(")+1), -1);
              } else {
               $vlr_aux2 = $mtz_campos[$tpreg][$parm_perc[1]]["VLR"];
              }

              $auxMtzCmps = explode(" as ", $vlr_aux);

              if (substr($parm_perc[1], 0, 5) == "stot_") {

                if ($auxMtzCmps[1]) {
                  $primeiro_valor = $auxMtzCmps[1];
                } else {
                  $primeiro_valor = $vlr_aux;
                }
                $primeiro_valor = $rec[$primeiro_valor];
                $segundo_valor  = $tot_reg_sub_tot;

              } else {

                unset($auxMtzCmps);

                if (substr($parm_perc[1], 0, 4) == "tot_") {

                 $auxMtzCmps  = explode(" as ", $vlr_aux );

                 if ($auxMtzCmps[1]) {
                   $segundo_valor = $auxMtzCmps[1];
                 } else {
                   $segundo_valor = $vlr_aux;
                 }

                 $primeiro_valor = $rec[$segundo_valor];
                 $segundo_valor  = $tot_reg_sub_tot;

                } else { //campo_xx,campo_yy

                 $auxMtzCmps  = explode(" as ", $vlr_aux );

                 if ($auxMtzCmps[1]) {
                   $primeiro_valor = $auxMtzCmps[1];
                 } else {
                   $primeiro_valor = $vlr_aux;
                 }

                 unset($auxMtzCmps);
                 $auxMtzCmps  = explode(" as ", $vlr_aux2 );

                 if ($auxMtzCmps[1]) {
                   $segundo_valor = $auxMtzCmps[1];
                 } else {
                   $segundo_valor = $vlr_aux2;
                 }

                  $primeiro_valor = $rec[$primeiro_valor];
                  $segundo_valor  = $rec[$segundo_valor];
                }

              // echo $primeiro_valor ."|". $segundo_valor."<br>";

              }
              unset($auxMtzCmps);

              $percentual = percent_carlos($primeiro_valor, $segundo_valor, $parm_perc[2]);

              if(($visualiza == "A") && ($delimitador != "FIXO")){
                $dados_exporta .= $td_ini.trim($percentual).$td_fim;
              } elseif($visualiza == "J") {
                $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($percentual));
              } else {
                $dados_exporta .= $td_ini.completa($percentual, 5, $completa_cara, $completa_lado).$td_fim;
              }
            } else {

              if($visualiza == "T" || $visualiza == "E" || $visualiza == "F") {
                if ($txt != "") {
                  $font_ini = "<font class='".$txt."'>";
                  $font_fim = "</font>";
                } else {
                  $font_ini = "";
                  $font_fim = "";
                }
              //*************************************************************************************************
              //*************************************************************************************************
              //IF removido dia 01/09/2020, não sei por que existia, mas não deixava o alinhamento funcionar bem.
              //Carlos BAT
              //*************************************************************************************************
              //*************************************************************************************************

               if (!$mtz_campos[$tpreg][$key]["ALIGN"] || $mtz_campos[$tpreg][$key]["ALIGN"] != "left") {
                 $align = " align='{$mtz_campos[$tpreg][$key]["ALIGN"]}'";
               } else {
                 $align = "";
               }

                $td_ini = "<td{$align}>{$font_ini}".$bold_ini;

                $td_fim = $bold_fim."{$font_fim}</td>";

              }

              if ($mtz_campos[$tpreg][$key]["TPCA"] == "CHAR") {
                $completa_lado = "D";
                if ($visualiza == "T" || $visualiza == "E") {
                  $completa_cara = "";
                } else {
                  $completa_cara = " ";
                }
              }

              if ($mtz_campos[$tpreg][$key]["TPCA"] == "NUM" || $mtz_campos[$tpreg][$key]["TPCA"] == "DECIMAL") {
                $completa_lado = "E";
                if ($visualiza == "A") {
                  $completa_cara = "0";
                } else {
                  $completa_cara = " ";
                }
              }
            }

            //TIPO CLASSE
            if ($mtz_campos[$tpreg][$key]["TIPO"] == "CLASSE") {
              $cmp_func_valorclasse = explode("¢", $mtz_campos[$tpreg][$key]["VLR"]);
              $arr_tmp = explode("§", $cmp_func_valorclasse[1]);
              if (substr($arr_tmp[0], 2, 2) == "__") {
                $arr_tmp[0] = str_replace("__", $nromodelo, $arr_tmp[0]);
              } else {
                if ((substr($arr_tmp[0], 3, 2) == "__") && (empty($mailing_pesquisa) === false) && (empty($cod_pesquisa) === false)) {
                  $arr_tmp[0] = str_replace("__", $cod_pesquisa, $arr_tmp[0]);
                }
              }

              $vlr_ret_func = $Classe[$arr_tmp[0]][$rec[$cmp_func_valorclasse[0]]];


              if (($visualiza == "A") && $delimitador != "FIXO") {
                $dados_exporta.= $td_ini.trim($vlr_ret_func).$td_fim;
              } elseif ($visualiza == "J") {
                $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($vlr_ret_func));
              } else {
                $dados_exporta.= $td_ini.completa($vlr_ret_func, $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
              }
            }

            //TIPO FUNCAO
            if ($mtz_campos[$tpreg][$key]["TIPO"] == "FUNCAO") {
              $vlr_ret_func = execFuncao($mtz_campos[$tpreg][$key]["VLR"], $rec);

              if (substr($mtz_campos[$tpreg][$key]["TPCA"], 0, 4) == "DATE") {
                $vlr_ret_func = FormataTipoDate($vlr_ret_func, $mtz_campos[$tpreg][$key]["DATE_FMT"]);
              }

              if ($visualiza == "A" && $delimitador != "FIXO") {
                $dados_exporta .= $td_ini.trim($vlr_ret_func).$td_fim;
              } elseif ($visualiza == "J") {
                $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($vlr_ret_func));
              } else {
                $dados_exporta .= $td_ini.completa($vlr_ret_func, $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
              }
            }

            //TIPO FIXO
            if ($mtz_campos[$tpreg][$key]["TIPO"] == "FIXO") {
              if(($visualiza == "A") && $delimitador != "FIXO"){
                $Auxdados_exporta = $td_ini.trim($mtz_campos[$tpreg][$key]["VLR"]).$td_fim;
              } else if ($visualiza == "J") {
                $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($mtz_campos[$tpreg][$key]["VLR"]));
              } else {
                $Auxdados_exporta = $td_ini. completa($mtz_campos[$tpreg][$key]["VLR"], $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
              }


              if($mtz_campos[$tpreg][$key]["TPCA"] == "DECIMAL"){

                $decimalsize   = $mtz_campos[$tpreg][$key]["DECI"];
                $decimalcara   = $mtz_campos[$tpreg][$key]["DECICARA"];
                $numformatodo  = number_format($rec[$mtz_campos[$tpreg][$key]["VLR"]], $decimalsize, $decimalcara,'');

                if(($visualiza == "A") && $delimitador != "FIXO"){
                  $Auxdados_exporta = $td_ini.trim($numformatodo).$td_fim;
                } elseif ($visualiza == "J") {
                  $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($numformatodo));
                } else {
                  $Auxdados_exporta = $td_ini.completa($numformatodo, $mtz_campos[$tpreg][$key]["SIZE"] + $decimalsize, $completa_cara, $completa_lado).$td_fim;
                }
              }
              $dados_exporta.= $Auxdados_exporta;
            }

            //TIPO TABELA
            if ($mtz_campos[$tpreg][$key]["TIPO"] == "TABELA") {

              if (substr_count($mtz_campos[$tpreg][$key]["VLR"], "¢") == 1) {//Gambi Carlos para Votaratim
                $pos = strpos($mtz_campos[$tpreg][$key]["VLR"], "¢");
                if (substr($mtz_campos[$tpreg][$key]["VLR"],$pos-1,3) == "'¢'") {//Procura se tem o caracter ¢ quando não é valorclasse
                  $cmp_func_valorclasse = explode("@.@", $mtz_campos[$tpreg][$key]["VLR"]);//GAmbi Carlos
                } else {
                  $cmp_func_valorclasse = explode("¢", $mtz_campos[$tpreg][$key]["VLR"]);
                }
              } else {
                $cmp_func_valorclasse = explode("@.@", $mtz_campos[$tpreg][$key]["VLR"]);//GAmbi Carlos
              }

              if ($cmp_func_valorclasse[1] != "") {
                if (substr($cmp_func_valorclasse[1], 2, 2) == "__") {
                  $cmp_func_valorclasse[1] = str_replace("__", $nromodelo, $cmp_func_valorclasse[1]);
                } else {
                  if ((substr($cmp_func_valorclasse[1], 3, 2) == "__") && (empty($mailing_pesquisa) === false) && (empty($cod_pesquisa) === false)) {
                    $cmp_func_valorclasse[1] = str_replace("__", $cod_pesquisa, $cmp_func_valorclasse[1]);
                  }
                }

                if(($visualiza == "A") && $delimitador != "FIXO"){
                  $Auxdados_exporta = $td_ini.trim($Classe[$cmp_func_valorclasse[1]][$rec[$cmp_func_valorclasse[0]]]).$td_fim;
                } elseif ($visualiza == "J") {
                  $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($Classe[$cmp_func_valorclasse[1]][$rec[$cmp_func_valorclasse[0]]]));
                } else {
                  $Auxdados_exporta = $td_ini.completa($Classe[$cmp_func_valorclasse[1]][$rec[$cmp_func_valorclasse[0]]], $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
                }

              } else {
                $auxMtzCmps = explode(" as ", $mtz_campos[$tpreg][$key]["VLR"]);


                if ($auxMtzCmps[1]) {
                  //********************* Montas query com "AS" ex. count(*) as Tot
                  if (($visualiza == "A") && $delimitador != "FIXO") {
                    $Auxdados_exporta = $td_ini.$rec[$auxMtzCmps[1]].$td_fim;
                  } elseif ($visualiza == "J") {
                    $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($rec[$auxMtzCmps[1]]));
                  } else {
                    $Auxdados_exporta = $td_ini. completa($rec[$auxMtzCmps[1]], $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
                  }
                } else {
                  if (($visualiza == "A") && $delimitador != "FIXO") {
                    $Auxdados_exporta = $td_ini.$rec[$mtz_campos[$tpreg][$key]["VLR"]].$td_fim;
                  } elseif ($visualiza == "J") {
                    $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($rec[$mtz_campos[$tpreg][$key]["VLR"]]));
                  } else {
                    if ($mtz_campos[$tpreg][$key]["VLR"] == "Xalternativa_01X") {// teste carlos
                      $hidden_text = "<input type='text' name='".$mtz_campos[$tpreg][$key]["VLR"]."' value='".$rec[$mtz_campos[$tpreg][$key]["VLR"]]."'>";
                      $Auxdados_exporta = $td_ini.$hidden_text.$td_fim;
                    } else {
                      $Auxdados_exporta = $td_ini. completa($rec[$mtz_campos[$tpreg][$key]["VLR"]], $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
                    }
                  }
                }
              }

              //TIPO DATE
              if (substr($mtz_campos[$tpreg][$key]["TPCA"], 0, 4) == "DATE") {
                $Auxdados_exporta = $td_ini.FormataTipoDate($rec[$mtz_campos[$tpreg][$key]["VLR"]], $mtz_campos[$tpreg][$key]["DATE_FMT"]).$td_fim;

                if ($visualiza == "J") {
                  $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim(FormataTipoDate($rec[$mtz_campos[$tpreg][$key]["VLR"]], $mtz_campos[$tpreg][$key]["DATE_FMT"])));
                }

              }

              if ($mtz_campos[$tpreg][$key]["TPCA"] == "DECIMAL") {
                $decimalsize   = $mtz_campos[$tpreg][$key]["DECI"];
                $decimalcara   = $mtz_campos[$tpreg][$key]["DECICARA"];

                $numformatodo  = number_format($rec[$mtz_campos[$tpreg][$key]["VLR"]], $decimalsize, $decimalcara,'');
                $Auxdados_exporta = $td_ini.completa($numformatodo, $mtz_campos[$tpreg][$key]["SIZE"] + $decimalsize, $completa_cara, $completa_lado).$td_fim;

                if ($visualiza == "J") {
                  $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($numformatodo));
                }

              }

              if ($mtz_campos[$tpreg][$key]["TPCA"] == "NUM") {
                $Auxdados_exporta = str_replace(",", "", $Auxdados_exporta);
                $Auxdados_exporta = str_replace(".", "", $Auxdados_exporta);

                if ($visualiza == "J") {
                  $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($Auxdados_exporta));
                }
              }

              $dados_exporta.= $Auxdados_exporta;
            }

            //TIPO IF
            if ($mtz_campos[$tpreg][$key]["TIPO"] == "IF" && substr($mtz_campos[$tpreg][$key]["TPCA"],0,4) != "DATE") {
              $cmp_condicao = explode("¢", $mtz_campos[$tpreg][$key]["VLR"]);
              if ($rec[$cmp_condicao[0]] == $cmp_condicao[1]){
                if(($visualiza == "A") && $delimitador != "FIXO"){
                  $Auxdados_exporta.=$td_ini.trim($cmp_condicao[2]).$td_fim;
                } elseif ($visualiza == "J") {
                  $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($cmp_condicao[2]));
                } else {
                  $Auxdados_exporta.=$td_ini. completa($cmp_condicao[2], $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
                }
              }else{
                if ($rec[$cmp_condicao[0]] == $cmp_condicao[3]){
                  if(($visualiza == "A") && $delimitador != "FIXO"){
                    $Auxdados_exporta.=$td_ini.trim($cmp_condicao[4]).$td_fim;
                  } elseif ($visualiza == "J") {
                    $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($cmp_condicao[4]));
                  } else {
                    $Auxdados_exporta.=$td_ini.completa($cmp_condicao[4], $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
                  }
                }else{
                  if(($visualiza == "A") && $delimitador != "FIXO"){
                    $Auxdados_exporta.= $td_ini."".$td_fim;
                  } elseif ($visualiza == "J") {
                    $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = "";
                  } else {
                    $Auxdados_exporta.= $td_ini. completa("", $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
                  }
                }
              }
              $dados_exporta.= $Auxdados_exporta;
            }

            //TIPO OPERACAO
            if ($mtz_campos[$tpreg][$key]["TIPO"] == "OPERACAO" && substr($mtz_campos[$tpreg][$key]["TPCA"],0,4) != "DATE") {
              $cmp_operacao = explode("¢", $mtz_campos[$tpreg][$key]["VLR"]);

              $pos = strpos($cmp_operacao[0],"(F)");
              if ($pos === false){
                $campo1 = $rec[$cmp_operacao[0]];
              }else{
                $campo1 = str_replace("(F)", "",$cmp_operacao[0]);
              }

              $pos = strpos($cmp_operacao[2],"(F)");
              if ($pos === false){
                $campo2 = $rec[$cmp_operacao[2]];
              }else{
                $campo2 = str_replace("(F)", "",$cmp_operacao[2]);
              }

              switch($cmp_operacao[1]){
                case "*":
                  $totalope = $campo1*$campo2;
                  break;
                case "/":
                  $totalope = $campo1/$campo2;
                  break;
                case "-":
                  $totalope = $campo1-$campo2;
                  break;
                case "+":
                  $totalope = $campo1+$campo2;
                  break;
              }
              if(($visualiza == "A") && $delimitador != "FIXO") {
                $Auxdados_exporta = $td_ini.trim($totalope).$td_fim;
              } elseif ($visualiza == "J") {
                $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($totalope));
              } else {
                $Auxdados_exporta = $td_ini. completa($totalope, $mtz_campos[$tpreg][$key]["SIZE"], $completa_cara, $completa_lado).$td_fim;
              }

              if($mtz_campos[$tpreg][$key]["TPCA"] == "DECIMAL"){

                $decimalsize   = $mtz_campos[$tpreg][$key]["DECI"];
                $decimalcara   = $mtz_campos[$tpreg][$key]["DECICARA"];
                $numformatodo  = number_format($totalope, $decimalsize, $decimalcara,'');
                if(($visualiza == "A") && $delimitador != "FIXO"){
                  $Auxdados_exporta = $td_ini.trim($numformatodo).$td_fim;
                } elseif ($visualiza == "J") {
                  $retornoDadosJson[$count_reg][utf8_encode($campo_vlr["DESC"])] = utf8_encode(trim($numformatodo));
                } else {
                  $Auxdados_exporta = $td_ini. completa($numformatodo, $mtz_campos[$tpreg][$key]["SIZE"] + $decimalsize, $completa_cara, $completa_lado).$td_fim;
                }
              }
              $dados_exporta .= $Auxdados_exporta;

            }

            if($mtz_campos[$tpreg][$key]["TOTALIZAR"] != "N") {

              $auxMtzCmps = explode(" as ", $mtz_campos[$tpreg][$key]["VLR"]);
   
              if ($auxMtzCmps[1] == "") {
                $auxMtzCmps[1] = $mtz_campos[$tpreg][$key]["VLR"];
              }

              $mtz_totalizar_aux = "";

              if ($mtz_campos[$tpreg][$key]["TPCA"] == "NUM" || $mtz_campos[$tpreg][$key]["TPCA"] == "DECIMAL") {

                switch($mtz_campos[$tpreg][$key]["TIPO"]){ // TRATAR OS CAMPOS VLR
                  case "FUNCAO":
                    if($mtz_campos[$tpreg][$key]["TPCA"] == "DECIMAL") {
                      $mtz_totalizar_aux    = str_replace(",", ".", str_replace(".", "", $vlr_ret_func));
                    } else {
                      if(!is_numeric($vlr_ret_func)) {
                        $strFuncao  = trim($mtz_campos[$tpreg][$key]["VLR"]);
                        $funcParams = substr($strFuncao, (strpos($strFuncao, "(") + 1), -1);
                        $arrParams  = explode($GLOBALS["separador_func"], $funcParams);
                        foreach ($arrParams as $i => $strParam) {
                          if (substr($strParam, 0, 3) == "(F)") {
                            continue;
                          }
                          $posAS = strpos(strtoupper($strParam), " AS ");
                          if ($posAS !== false) {
                            $strParam = substr($strParam, $posAS + 4);
                          }
                          $pTrat = $rec[$strParam];
                        }
                        $mtz_totalizar_aux = $pTrat;
                      } else {
                        $mtz_totalizar_aux = $vlr_ret_func;
                      }
                    }
                    break;
                  case "OPERACAO":
                    $mtz_totalizar_aux = $totalope;
                    break;
                  default: // QUALQUER UM DIFERENTE DE FUNCAO
                    $mtz_totalizar_aux = $rec[$auxMtzCmps[1]];
                  break;
                }
                if (is_numeric($mtz_totalizar_aux)) {
                  $mtz_totalizar[$key] += $mtz_totalizar_aux;//Soma o total
                }
              }
            }
            /***********************************************************************************************************/
            /***********************************************************************************************************/
            /*            ONDE MOSTRA AS TDS                                                                           */
            /***********************************************************************************************************/
            /***********************************************************************************************************/
          } // FOREACH dos Campos Ex. Nome|CPF|XXX

          if ($visualiza == "T" || $visualiza == "E"|| $visualiza == "F") {
            $dados_exporta .= "</tr>";
          }
          /***********************************************************************************************************/
          /***********************************************************************************************************/
          /*            ONDE MOSTRA AS TDS                                                                           */
          /***********************************************************************************************************/
          /***********************************************************************************************************/
          if ($visualiza == "A") {

            if ($_POST["processo"] == "BATCH" || $_POST["processo"] == "AUTO") {

              $dados_exporta = str_replace("<br>" , " ", $dados_exporta);
              $dados_exporta = str_replace(chr(13), "" , $dados_exporta);
              $dados_exporta = str_replace(chr(10), " ", $dados_exporta);

              $ttt++;
              if ($ttt == 1){
                $tmpfile = tmpfile();

                if ($dados_exporta_tit != "" || $dados_exporta_header != "") {
                  $reg_ht++;
                }
                if ($dados_exporta_header) {
                  $dados_exporta = $dados_exporta_header."\r\n".$dados_exporta;
                } else if($dados_exporta_tit){
                  $dados_exporta = $dados_exporta_tit.$dados_exporta;
                }
              }

              if ($delimitador != "FIXO") {
                $dados_exporta = substr($dados_exporta, 0, -1)."\r\n";
              } else {
                $dados_exporta .= "\r\n";
              }

              fwrite($tmpfile, $dados_exporta);
              $dados_exporta = "";
              //usleep(3);
            } else {

              if ($delimitador != "FIXO") {
                $dados_exporta = substr($dados_exporta, 0, -1)."\r\n";
              } else {
                $dados_exporta .= "\r\n";
              }

            }

          }

          $count_reg++;

      }///FIM DO LOOP DOS REGISTROS


      if ($_GET['processo'] == "AT"){
        print json_encode($retornoDadosJson, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP);
        exit;
      }

      $session["td_dado3"]    = $td_dado3;
      $session["td_destaque"] = $td_destaque;

      if (($x != 0) && ($visualiza == "A" || $visualiza == "F")) {

        if (is_array($mtz_campos["trailler"])) {
          foreach ($mtz_campos["trailler"] as $key => $campo_vlr) {
            if ($mtz_campos["trailler"][$key]["TPCA"] == "CHAR") {
              $completa_lado = STR_PAD_RIGHT;
              $completa_cara = " ";
            } else if ($mtz_campos["trailler"][$key]["TPCA"] == "NUM" || $mtz_campos["trailler"][$key]["TPCA"] == "DECIMAL") {
              $completa_lado = STR_PAD_LEFT;
              $completa_cara = "0";
            }

            $campo = $campo_vlr["VLR"];

            $campo = str_replace("var_dt_agora"    , $dt_agora  ,   $campo);
            $campo = str_replace("var_hr_agora"    , $hr_agora  ,   $campo);
            $campo = str_replace("var_dthr_agora"  , $dthr_agora,   $campo);
            $campo = str_replace("var_prox_seq_arq", $prox_num_seq, $campo);

            if ($mtz_campos["trailler"][$key]["TIPO"] == "FUNCAO") {
              $vlr_ret_func = execFuncao($mtz_campos["trailler"][$key]["VLR"], $campo);

              if (substr($mtz_campos["trailler"][$key]["TPCA"], 0, 4) == "DATE") {
                $vlr_ret_func = FormataTipoDate($vlr_ret_func, $mtz_campos["trailler"][$key]["DATE_FMT"]);
              }
              $campo = $vlr_ret_func;
            }

            if(substr($mtz_campos["trailler"][$key]["TPCA"], 0, 4) == "DATE") {
              $completa_lado = STR_PAD_RIGHT;
              $completa_cara = " ";

              $formato = substr($mtz_campos["trailler"][$key]["TPCA"],(strpos($mtz_campos["trailler"][$key]["TPCA"],"(")+1), -1);

              $campo = FormataTipoDate($campo, $formato);

              if ($mtz_campos["trailler"][$key]["SIZE"] == "") {
                $mtz_campos["trailler"][$key]["SIZE"] = strlen($campo);
              }
            }


            if (strtoupper($campo) == "TOTREG") {
              $campo_aux = $x;
            } else {
              $campo_aux = $campo;
            }

            if ($delimitador == "FIXO") {
              $dados_exporta_trailler .= str_pad($campo_aux,$mtz_campos["trailler"][$key]["SIZE"],$completa_cara, $completa_lado).$td_fim;
            } else {
              $dados_exporta_trailler .= $campo_aux.$td_fim;
            }
          }
        }
        if ($dados_exporta_trailler != "") {
          if ($tmpfile) {
            $reg_ht++;
            fwrite($tmpfile, $dados_exporta_trailler);
          }
        }
        if ($delimitador != "FIXO") {
          $dados_exporta = substr($dados_exporta_header, 0, -1)."\r\n".$dados_exporta.substr($dados_exporta_trailler, 0, -1)."\r\n";
        } else {
          $dados_exporta = $dados_exporta_header."\r\n".$dados_exporta.$dados_exporta_trailler."\r\n";
        }
      }

      if ($_POST["processo"] == "BATCH" || $_POST["processo"] == "AUTO" || $_GET['processo'] == "AT") {

        if ($ttt == 0 && $gera_arq_vazio != "N") {
          // Caso não tenha registros para enviar e deve gerar o arquivo mesmo que ele esteja vazio
          if ($dados_exporta_tit == "") {
            //Se não tem header, inclui um enter só para não gerar o arquivo com 0 bytes
            $dados_exporta_tit = "\r\n";
          } else {
            $reg_ht++;
          }

          $tmpfile = tmpfile();
          fwrite($tmpfile, $dados_exporta_tit);
        }

        if ($tmpfile) {

          $endftp["sql"]["tamanho"          ] = magicFileSize($tmpfile);
          $endftp["sql"]["param_arquivo"    ] = $param_arquivo;
          $endftp["sql"]["param_arquivo_cli"] = $param_arquivo_cli;

          if ($_POST["processo"] == "AUTO") {
            if (!$dadosFTP = getParamFTPmkExporta()) {
              print "Não foi possível ler os parâmetros do FTP temporário: ".libftp_lastError();
              exit;
            }
          }

          $envioOk = libftp_EnviaArqComRetry($dadosFTP, $tmpfile, $param_arquivo, $_POST["qtdmaxenvio"]);

          if ($envioOk && $_POST["processo"] == "AUTO") {
            EnviaFTP($endftp["sql"]);
          }

          if (!$envioOk && $_POST["processo"] == "BATCH") {
            print "Arquivo não enviado para o FTP: ".libftp_lastError();
            exit;
          }

          if (!$envioOk && $_POST["processo"] == "AUTO") {
            $endftp["sql"]["msg_erro"] = libftp_lastError();
            $endftp["sql"]["status"  ] = "X";

            $seqTbArqFtp = EnviaFTP($endftp["sql"]);

            if (!insertIntoFtpRetry($tmpfile, $seqTbArqFtp, $param_arquivo)) {
              print "Não foi possível enviar o arquivo para o FTP temporário nem gravá-lo na tb_php_retry_ftp [".libftp_lastError()."]";
              exit;
            }
          }
          @fclose($tmpfile);
        }

        $dados_exporta = "";

        $exTempoFim = microtime(true);

        if ($_REQUEST["teste"] == "S") {
          print "Tempo execução: ".round($exTempoFim - $exTempoIni, 3)." segs\n";
          print "Pico de memória: ".fmtBytes(memory_get_peak_usage(false)).PHP_EOL;
          print "Nome Arquivo: ".$nome_arquivo.PHP_EOL;
        }

        print
          "OK fim da execução ".
          "[=str_tot=]".
            "reg_lidos=".($ttt + $reg_ht)."§".
            "reg_inc=".$ttt."§".
            "reg_alt=0§".
            "reg_exc=0§".
            "reg_desp=0§".
            "reg_ht=".$reg_ht.
          "[=str_tot=]";
      }
    }


    if (($x != 0) && ($visualiza == "T" || $visualiza == "E" || $visualiza == "F")) {

      if ($sub_total != "") {

        if(count((array)$mtz_totalizar["SUB_TOTAL"]) > 0) {
          $dados_exporta .= "<tr ".$bgcolor_td_dado1.">";

          foreach($mtz_campos[$tpreg] as $indice => $value) {

            if ($value["TPCA"] == "NUM" || $value["TPCA"] == "DECIMAL") {
              $completa_lado = "E";
              $completa_cara = " ";
            }

            $dados_exporta.= "<td align='".$value["ALIGN"]."' nowrap>";
            //$dados_exporta.=   "<font class='txt5'>";
            if ($usa_bootstrap == true) {
              $dados_exporta.=   "<span class='blue'>";
            }else{
              $dados_exporta.=   "<font class='txt5'>";
            }
            if($value["TPCA"] == "DECIMAL") {
              $decimalsize   = $value["DECI"];
              $decimalcara   = $value["DECICARA"];
              $numformatodo  = exibirValor($mtz_totalizar["SUB_TOTAL"][$indice][$sub_total_ant]);//number_format($mtz_totalizar[$indice], $decimalsize, $decimalcara,'');
              $dados_exporta.=   "<strong>".$numformatodo."</strong>";
            } else {
              if ($value["TIPO"] == "PARM_PERC") {
                unset($parm_perc);
                $parm_perc = explode(",", $value["VLR"]);

                if (substr($parm_perc[1], 0, 5) == "stot_") {
                  $percentual = "100.0";
                } else {
                //$percentual = percent_carlos($mtz_totalizar["SUB_TOTAL"]["s".$parm_perc[1]][$sub_total_ant], $mtz_totalizar[$tpreg]["tot_".$parm_perc[0]], $parm_perc[2])."***";
                  $percentual = percent_carlos($mtz_totalizar["SUB_TOTAL"]["stot_".$parm_perc[0]][$sub_total_ant], $mtz_totalizar[$tpreg]["tot_".$parm_perc[0]], $parm_perc[2]);
                }

                if(($visualiza == "A") && ($delimitador != "FIXO")){
                  $dados_exporta .= "<strong>".trim($percentual)."</strong>";
                } else {
                  $dados_exporta .= "<strong>".completa($percentual, 5, $completa_cara, $completa_lado)."</strong>";
                }
              } else {
//azul
                if ($value["TIPO"] == "FUNCAO" && ($value["TPCA"] == "NUM" || $value["TPCA"] == "DECIMAL")) {
                  $funcNome     = substr($value["VLR"], 0, strpos($value["VLR"], "("));
                  $vlr_ret_func = $funcNome($mtz_totalizar["SUB_TOTAL"]["stot_".$indice][$sub_total_ant]);
                } else {
                  $vlr_ret_func = $mtz_totalizar["SUB_TOTAL"]["stot_".$indice][$sub_total_ant];
                }
                $dados_exporta.=   "<strong>".completa($vlr_ret_func, $value["SIZE"], $completa_cara, $completa_lado)."</strong>";
              }

            }
            $dados_exporta.=   "</font>";
            $dados_exporta.= "</td>";
          }
          $dados_exporta.= "</tr>";
        }
      }
      if($usa_bootstrap == true){
        $dados_exporta .= "</tbody><tfoot>";
      }

      unset($mtz_totalizar["SUB_TOTAL"]);

      // Monta a linha de totais
      if(count((array)$mtz_totalizar) > 0) {
        $dados_exporta.= "<tr ".$bgcolor_td_destaque.">";
        foreach($mtz_campos[$tpreg] as $indice => $value) {

          if ($mtz_totalizar[$indice] || $mtz_totalizar[$indice] == 0) {
            if($mtz_campos[$tpreg][$indice]["TOTALIZAR"] == "M") {
              $mtz_totalizar[$indice] = $mtz_totalizar[$indice]/$x;
            }

            if ($value["TPCA"] == "NUM" || $value["TPCA"] == "DECIMAL") {
              $completa_lado = "E";
              $completa_cara = " ";
            }

            $dados_exporta.= "<td align='".$value["ALIGN"]."' nowrap>";
            $dados_exporta.=   "<font class='".$txt5_titulo_table."'>";

            if($value["TPTOT"] != "TOT" && $value["TPTOT"] != "NTOT" && $value["TIPO"] != "PARM_PERC") {
              $dados_exporta.=   "<strong>".$value["TPTOT"]."</strong>";
            }

            if($value["TPCA"] == "DECIMAL") {
              $decimalsize   = $value["DECI"];
              $decimalcara   = $value["DECICARA"];
              $numformatodo  = exibirValor($mtz_totalizar[$tpreg]["tot_".$indice]);
              $dados_exporta.=   "<strong>".$numformatodo."</strong>";
            } else {
              if ($value["TIPO"] == "PARM_PERC") {
                $parm_perc = explode(",", $value["VLR"]);
                if ($sub_total != "") {
                  if (substr($parm_perc[1], 0, 5) == "stot_") {
                    $dados_exporta.=   "<strong>&nbsp;</strong>";
                  } else {
                    $dados_exporta.=   "<strong>100.0</strong>";
                  }

                } else {
                  if (substr($parm_perc[1], 0, 4) != "tot_") {
                    $parm_perc[1] = "tot_".$parm_perc[1];
                  }

                  $percentual = percent_carlos($mtz_totalizar[$tpreg]["tot_".$parm_perc[0]], $mtz_totalizar[$tpreg][$parm_perc[1]], $parm_perc[2]);

                  if(($visualiza == "A") && ($delimitador != "FIXO")){
                    $dados_exporta .= "<strong>".trim($percentual)."</strong>";
                  } else {
                    $dados_exporta .= "<strong>".completa($percentual, 5, $completa_cara, $completa_lado)."</strong>";
                  }
                }
              } else {
                if ($value["TIPO"] == "FUNCAO" && ($value["TPCA"] == "NUM" || $value["TPCA"] == "DECIMAL")) {
                  $funcNome     = substr($value["VLR"], 0, strpos($value["VLR"], "("));

                  if ($mtz_totalizar[$tpreg]["tot_".$indice] == "") {
                    $vlr_ret_func = $funcNome($mtz_totalizar[$indice]);
                  } else {
                    $vlr_ret_func = $funcNome($mtz_totalizar[$tpreg]["tot_".$indice]);
                  }
                } else {
                  if ($mtz_totalizar[$tpreg]["tot_".$indice] == "") {
                    $vlr_ret_func = $mtz_totalizar[$indice];
                  } else {
                    $vlr_ret_func = $mtz_totalizar[$tpreg]["tot_".$indice];
                  }
                }
                $dados_exporta.=   "<strong>".completa($vlr_ret_func, $value["SIZE"], $completa_cara, $completa_lado)."</strong>";
              }
            }
            $dados_exporta.=   "</font>";
            $dados_exporta.= "</td>";
          } else {
            $dados_exporta.= "<td>";
            $dados_exporta.=   "<font class='".$txt5_titulo_table."'>";
            $dados_exporta.=   "<strong>&nbsp;</strong>";
            $dados_exporta.=   "</font>";
            $dados_exporta.= "</td>";
          }
        }
        $dados_exporta.= "</tr>";
      }

    }
    unset($mtz_totalizar);

    if ((empty($update_00) === false) && ($RD_update_00 == "S" || $RD_update_00 == "B" || $RD_update_00 == "A")) {

      $q = "UPDATE ".$tabela." SET ";
      for ($i = 1; $i <= $qtd_param_update; $i++) {
        $i = str_pad($i, 2, "0", STR_PAD_LEFT);
        $aux = "update_".$i;

        if ($$aux) {
          $update_campo_arr = explode("¬", $$aux);
          if ($update_campo_arr[1] == "VARS_COMANDO") {//marcelo

            if (empty(${$update_campo_arr[2]}) === true) {
              $vars_comando_aux = $arrRpl[$update_campo_arr[2]];
            } else {
              $vars_comando_aux = ${$update_campo_arr[2]};
            }

            $q .= " ".$update_campo_arr[0]." = ".$vars_comando_aux.", ";
          } else {
            $q .= $update_campo_arr[0]." = '";
            if ($update_campo_arr[1] == "FIXO") {
              $q .= $update_campo_arr[2];
            } else if ($update_campo_arr[1] == "DATA") {
              $q .= date("Y-m-d");
            } else if ($update_campo_arr[1] == "HORA") {
              $q .= date("H:i:s");
            } else if ($update_campo_arr[1] == "VARS") {
              eval("\$q .= \$".$update_campo_arr[2].";");
            }
            $q .= "', ";
          }
        }
      }
      $q = substr($q, 0, -2)." ";
      $up_rows = 0;
      if (count((array)$arrCposIndex) > 0) {
        // if (is_array($arr_where_up) === true) {
          foreach ((array) $arr_where_up as $i => $where_up) {
            $query    = DescExecQuery($q.$where_up, $connectHOST);
            $up_rows += mysql_affected_rows($connectHOST);
          }
        // }
      } else {
        $query   = DescExecQuery($q.$where_up, $connectHOST);
        $up_rows = mysql_affected_rows($connectHOST);
      }
      if ($_POST["processo"] == "BATCH") {?>
        <br>
        <table  <?print $class_table?> style='border-collapse:collapse;'  bordercolor='<?print $session["td_destaque"]?>' border='1' cellpadding='0' cellspacing='0' align='center' >
          <tr bgcolor='<?print $session["td_destaque"]?>'>
            <td align="center"><font class='titcol'>
              <?print $up_rows;?> registros alterados. Ação: <?print substr($update_00, 2);?>
            </td>
          </tr>
        </table>
        <BR>
<?    }//processo

    }

    if ($visualiza == "A") {
      if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO") {?>
        <br>
        <table  <?print $class_table?> width='650'  style='border-collapse:collapse;'  bordercolor='<?print $session["td_destaque"]?>' border='1' cellpadding='0' cellspacing='0' align='center' >
          <tr bgcolor='<?print $session["td_destaque"]?>'>
            <td align="center"><font class='titcol'>
              Encontrados <?print $x?> registros - Campos delimitados por (<?print ValorClasse("EX00L", $delimitador, $repre_param)?>)
            </td>
          </tr>
          <tr bgcolor='<?print $session["td_dado1"]?>'>
            <td align="center">
              <textarea id="dadosExporta" rows="8" cols="100" style="font-family: 'Courier New', Courier, mono; font-size: 11;" readonly><?print str_replace("&nbsp;","",$dados_exporta)?></textarea>
            </td>
          </tr>
        </table>
		<?
		if(str_replace("&nbsp;","",$dados_exporta) != "") {
			require_once($_SERVER['DOCUMENT_ROOT']."/libs/cli/TelefExportacaoLOG.php");
			$objLogExport  = new ExportacaoLOG("MDIF");

			$tipo_log = "D";

			$matriz_insLog["titulo"                ] = $titulo;
			$matriz_insLog["nome_arq"              ] = $nome_arquivo;
			$matriz_insLog["arq_dados"             ] = addslashes(str_replace("&nbsp;","",$dados_exporta));
			$matriz_insLog["aux_nome_arquivo"      ] = $aux_nome_arquivo;
			$matriz_insLog["tabelao_rel"           ] = "";
			$matriz_insLog["tabelao_titulo"        ] = "";
			$matriz_insLog["tipo"                  ] = "";
			$matriz_insLog["programa"              ] = "/callcenter/mk_exporta_mailing_arquivo.php";

			$objLogExport->InsertLogExportacao($matriz_insLog,$tipo_log);
		}
		?>



<?    }
    } elseif ($visualiza == "J" && $_GET['processo'] != "AT"){
      ?>
    <br>
    <table <?=$class_table?> width='650' style='border-collapse:collapse;' bordercolor='<?=$session["td_destaque"]?>' border='1' cellpadding='0' cellspacing='0' align='center'>
      <tr bgcolor='<?=$session["td_destaque"]?>'>
        <td align="center">
          <font class='titcol'>
            Encontrados
            <?=$x?> registros - Campos delimitados por (
            <?=ValorClasse("EX00L", $delimitador, $repre_param)?>)
        </td>
      </tr>

      <tr bgcolor='<?=$session["td_dado1"]?>'>
        <td align="center">
        <textarea id="dadosExporta" rows="8" cols="100" style="font-family: 'Courier New', Courier, mono; font-size: 11;" readonly><?=  stripslashes(convertUnicodeForCaracteres(utf8_decode(json_encode($retornoDadosJson))));?></textarea>
        </td>
      </tr>
    </table>
    <?
    } elseif ($visualiza == "T" || $visualiza == "E" || $visualiza == "F") {
      if ($x != 0) {
        $dados_exporta."</tfoot>";
      }
      print $dados_exporta."</table>";
    }
  }
  if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO" && $_GET["processo"] != "AT" && $x == 0) {
    print "<br><br><br>";
  }
}
if ($_POST["processo"] != "BATCH" && $_POST["processo"] != "AUTO" && $_GET['processo'] != "AT") {
?>

  <?if ($include_imprime != "") {?>
  <form name="frm_include_imprime" target="JanelaImpressaoEspecifico" method="POST" action="<?print $include_imprime?>">
    <input type="hidden" name="query_include_imprime"   value="<?print mkuEncode($query_include_imprime);?>">
    <input type="hidden" name="bdado_aux"               value="<?print mkuEncode($bdado_aux);?>">
  </form>
  <?}?>

<form name="frmLayout" method="post" action="mk_exporta_mailing_layout.php" target="janExpMailling">
  <input type="hidden" name="layout"   value="<?print urlencode($layout)?>">
  <input type="hidden" name="layoutHD" value="<?print urlencode($layoutHD)?>">
  <input type="hidden" name="layoutTR" value="<?print urlencode($layoutTR)?>">
</form>

<form name="simula" method="POST" action="dac_con_regiao_det_impressao.php" target="JanelaImpressao">
  <input type="hidden" name="repre_aux" value="<?print $repre   ?>">
  <input type="hidden" name="titulo"    value="<?print $titulo?>">
  <input type="hidden" name="tipo" id="simula_tipo"       value="">
  <input type="hidden" name="tabelao_titulo"    value="">
  <input type="hidden" name="tabelao_rel"       value="">
  <input type="hidden" name="aux_nome_arquivo"  value="<?print $nome_arquivo?>">
</form>

<form name="frmDownload" method="post" action="mk_exporta_mailing_arquivo.php" target="JanelaImpressao">
  <input type="hidden" name="repre_aux" value="<?print $repre   ?>">
  <input type="hidden" name="titulo"    value="<?print $titulo?>">
  <input type="hidden" name="nome_arq"  value="<?print urlencode($param_arquivo)?>">
  <input type="hidden" name="arq_dados" value="">
</form>

<form name="frmFtp" method="post" action="mk_exporta_mailing_ftp.php" target="JanelaImpressao">
  <input type="hidden" name="titulo"    value="<?print $titulo?>">
  <input type="hidden" name="paramftp"  value="<?print $envia_ftp?>">
  <input type="hidden" name="repre"     value="<?print $repre   ?>">
  <input type="hidden" name="nome_arq"  value="<?print urlencode($param_arquivo)?>">
  <input type="hidden" name="arq_dados" value="">
</form>

<?

if(!isset($session["exportacao"])) {
  require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/ConexaoCallCenter.php");
  $sqlAdmin   = "SELECT * FROM tbadmin WHERE login = '".addslashes($session["operador"])."'";
  $conexao_cc = new ConexaoCallCenter();
  $conexao_cc->query($sqlAdmin);

  if($conexao_cc->result){
    if(!$conexao_cc->result["flag_impressao_exportacao"]) {
	  $conexao_cc->result["flag_impressao_exportacao"] = "S¢S";
    }
    $arrayImpressaoExpostacao = explode("¢",$conexao_cc->result["flag_impressao_exportacao"]);
    $session["impressao" ] = $arrayImpressaoExpostacao[0];
    $session["exportacao"] = $arrayImpressaoExpostacao[1];
  }
}

$conteudo_tabela_img = "";
if ($relatorio != "excel") {
  if (($TemExportacao == "OK" && $exportacao != "" && $possui_layout != "NO") || ($TemExportacao == "NO" && $discador_modelo != "" && $possui_layout != "NO")) {
    $conteudo_tabela_img .=  " <img src='imagens/layout_vermelho4_32px.gif' align='botton' style='cursor:pointer;' title='Layout do Arquivo' onClick='mostraLayout();'>";

    if($session["exportacao"] != "N") {
	  if (trim($dados_exporta) != "" && $visualiza != "T" && $visualiza != "E" && $visualiza != "F") {
        $conteudo_tabela_img .=  "<img src='imagens/download.gif' align='botton' style='cursor:pointer;' title='Download do Arquivo' onClick='DownloadArq()'>";
      }
	}
  }
}

if($x != 0 && $visualiza == "T"){
  if($session["exportacao"] != "N") {
    $conteudo_tabela_img .=  "<img src='imagens/excel_32px.gif' align='botton' style='cursor:pointer;' title='Excel' onClick=\"imprimeRelatorio('excel')\">";
  }
}

if ($x != 0 && $include_imprime) {
  $conteudo_tabela_img .= "<img src='imagens/".$include_imprime_img."' align='botton' style='cursor:pointer;' title='Impressão' onClick=\"imprimeEspecifico();\">";
}

if ($relatorio != "excel") {
  if($envia_ftp != "" && $visualiza != "T" && trim($dados_exporta) != "") {
    $conteudo_tabela_img .=  "<img src='imagens/ico_ftp.gif' align='botton' style='cursor:pointer;' title='Envia pelo FTP' onClick='EnviaArqFtp()'>";
  }
}

if ($_SESSION["session"]["representante"] == "URANET" || $_SESSION["session"]["print_sql"] != "N") {
  $conteudo_tabela_img .= htmlParamInvalidos($mtz_campos);
}

if ($conteudo_tabela_img) {
?>
  <table  <?print $class_table?> width="400" border="0" cellspacing="0" cellpadding="0" align="center">
    <tr>
      <td nowrap align="center" width="90%" >
      <?print $conteudo_tabela_img?>
      </td>
    </tr>
  </table>
<?
}
?>


<?
if ($deondegta == "gerenciador") {
  $action = "ia_gerenciador_ta.php";
} else {
  $action = $PHP_SELF;
}
//CodProdCliente('','');
?>

<form action="<?print $action;?>" method="POST" name="frmMKExp">

<table <?print $class_table?> width="400" border="4" cellspacing="0" cellpadding="1" align="center" style='border-collapse:collapse;'>

  <input type="hidden" name="procura"               value="<?print $procura?>">
  <input type="hidden" name="intervalo_dt"          value="<?print $intervalo_dt?>">
  <input type="hidden" name="param_limit_dia"       value="<?print $param_limit_dia?>">
  <input type="hidden" name="intervalo_dthr"       value="<?print $intervalo_dthr?>">
<?
/*<input type="hidden" name="intervalo_dt"          value="<?print mkuEncode($intervalo_dt)?>">
  <input type="hidden" name="param_limit_dia"       value="<?print mkuEncode($param_limit_dia)?>">
*/
?>
  <input type="hidden" name="tipo_transf"           value="<?print mkuEncode($tipo_transf)?>" >
  <input type="hidden" name="tipo_proc"             value="<?print mkuEncode($tipo_proc)?>">
  <input type="hidden" name="repre"                 value="<?print mkuEncode($repre)?>" >
  <input type="hidden" name="repre_passa"           value="<?print mkuEncode($repre_passa)?>" >
  <input type="hidden" name="discador_modelo_passa" value="<?print mkuEncode($discador_modelo_passa)?>" >
  <input type="hidden" name="exportacao_passa"      value="<?print mkuEncode($exportacao_passa)?>" >
  <input type="hidden" name="titulo"                value="<?print $titulo?>">
  <input type="hidden" name="deondegta"             value="<?print $deondegta?>">

  <input type="hidden" name="busca_direta"          value="<?print mkuEncode($busca_direta)?>">
  <input type="hidden" name="classe_menu"           value="<?print $classe_menu?>">
  <input type="hidden" name="tipo_popup"            value="<?print $tipo_popup?>">
<?
if ($deondegta != "gerenciador") {
  if ($busca_direta == "S" && $repre_passa != "[SELECIONA]") {
?>
  <input type="hidden" name="repre" value="<?print $repre;?>" >
<?
  } else {

    $comboRepre = MontaCombo("REPRE", $repre, $session['representante'],"A","ZZ");
    $titRepre = $titClasse;

?>
  <tr <? print $bgcolor_td_dado3;?>>
    <td nowrap align="left" class="txt5">
      <strong><?print $titRepre?>:</strong>
    </td>
    <td align="left" class="txt5">
      <?if($repre_passa != "[SELECIONA]" && $repre_passa) {?>
          <input type="hidden" name="repre" value="<?print $repre_passa;?>" >
          <?print ValorClasse("REPRE", $repre_passa, $session["representante"]);?>
      <?} else {?>
          <select name="repre" consistencia="sempre" class="select_digitavel" consistencia1="pre" msg=" Selecione o Representante." OnChange="MudaExp(this.value);">
            <?print $comboRepre?>
          </select>
      <?}?>
    </td>
  </tr>
<?
  }
}

/*OnChange="window.location='<?print $PHP_SELF?>?repre='+this.value+'&titulo=<?print $titulo?>'">*/
if ($repre) {

  if ($busca_direta == "S" ) {

?>
    <input type="hidden" name="discador_modelo" value="<?print mkuEncode($discador_modelo_passa);?>" >
<?

  } else {

    if(!$discador_modelo_passa) {

      if (strtoupper($vlradgta[$tipo_proc][2]) == "DK") {
        $whereMK = 'cod_classe ="DKPRO" AND ';
        $optionvlr = "DK";
      } elseif (strtoupper($vlradgta[$tipo_proc][2]) == "MD") {
        $whereMK = 'cod_classe ="MDPRO" AND ';
        $optionvlr = "MD";
      } elseif (strtoupper($vlradgta[$tipo_proc][2]) == "MK") {
        $whereMK = 'cod_classe IN ("DKPRO", "MDPRO", "MKPRO") AND ';
        $optionvlr = "";
      } else {
        $whereMK = 'cod_classe = "" AND ';
      }

      if ($deondegta != "gerenciador") {
        $whereMK = 'cod_classe IN ("DKPRO", "MDPRO", "MKPRO") AND ';
      }
      $q1 = " SELECT vlr_classe, desc_classe, tipo_reg, cod_classe, status FROM tb_classe WHERE ".
            " representante = '".addslashes($repre)."' AND ".$whereMK." tipo_reg IN ('I','T') AND idioma = '1' ORDER BY desc_classe";
      $con = DescExecQuery($q1, $connect, "N");

      while($rec = mysql_fetch_assoc($con)) {
        if ($rec["tipo_reg"] == "T"){
          $TitClasseMkpro = $rec["desc_classe"];
          continue;
        }
        $sel="";

        $optionvlr = substr($rec["cod_classe"],0,2);//DK OU MD OU MK

        $q_k     = "SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = 'EX".addslashes($rec["vlr_classe"])."K' AND representante = '".addslashes($repre)."' AND status = 'A' AND tipo_reg = 'T'";
        $query_k = DescExecQuery($q_k, $connect, "N");
        if (!$rec_k = mysql_fetch_assoc($query_k)) {
          $q_k     = "SELECT vlr_classe, desc_classe FROM tb_classe WHERE cod_classe = 'EX".addslashes($rec["vlr_classe"])."K' AND representante = 'URANET' AND status = 'A' AND tipo_reg = 'T'";
          $query_k = DescExecQuery($q_k, $connect, "N");
          if (!$rec_k = mysql_fetch_assoc($query_k)) {
            continue;
          }
        }

        if($optionvlr.$rec["vlr_classe"] == $discador_modelo)
        $sel="selected";
        //Acerto para demonstração na apresentação
        if ($_SESSION["session"]["operador"] == "re001264") {
          if ($repre == "URANET" && $optionvlr.$rec["vlr_classe"] != "DKZZ") {
            continue;
          }
        }
        if($rec["status"] == "R") {
          $background_option = " style=\"color: #ff0000;\" ";
          $descricao_situacao = " (R)";
        } else if ($rec["status"] == "S") {
          $background_option = " style=\"color: #ff0000;\" ";
          $descricao_situacao = " (S)";
        } else if ($rec["status"] == "U") {
          $background_option = " style=\"color: #FF8800;\" ";
          $descricao_situacao = " (U)";
        } else {
          $background_option = " ";
          $descricao_situacao = "";
        }
        if ($session["representante"] == "URANET") {
          $option .= "<option value='".$optionvlr.$rec["vlr_classe"]."' ".$sel.$background_option.">".$rec["desc_classe"].$descricao_situacao." - ".$optionvlr."</option>";
        } else {
          if ($rec["status"] != "U") {
            $option .= "<option value='".$optionvlr.$rec["vlr_classe"]."' ".$sel.$background_option.">".$rec["desc_classe"].$descricao_situacao." - ".$optionvlr."</option>";
          }
        }
      }
    }

  ?>
    <tr <? print $bgcolor_td_dado3;?>>
      <td align="left" class="txt5"><strong><?print $objTradutor->traduzir("Operação");?>:</strong></td>
      <td align="left" class="txt5">
        <?if ($discador_modelo_passa) {?>

            <?print ValorClasse(substr($discador_modelo_passa,0,2)."PRO",substr($discador_modelo_passa,2,2),$repre)?>
            <input type="hidden" name="discador_modelo" value="<?print $discador_modelo_passa;?>" >
        <?} else {
            if ($deondegta != "gerenciador") {?>
                <select name="discador_modelo" OnChange="window.location='<?print $PHP_SELF?>?discador_modelo='+this.value+'&repre=<?print $repre?>&repre_passa=<?print $repre_passa?>&titulo=<?print $titulo?>'" consistencia="sempre" consistencia1="pre" msg="Selecione o Operação">
            <?} else {?>
                <select name="discador_modelo" OnChange="MudaExp(this.value);" consistencia="sempre" consistencia1="pre" msg="Selecione o Operação">
            <?}?>
            <option value="">--Selecione--</option>
            <?print $option?>
          </select>
        <?}?>
     </td>
    </tr>
  <?
  }
}

if (($discador_modelo) || ($busca_direta == "S")) {
  if ($TemExportacao == "OK") {
?>
   <script language="javascript" type="text/javascript">
   function clickClasse(exportacao) {
     if(exportacao.value != ""){
       AbreJanela2('cc_classe_pesquisa_altera_inclui.php?consistencia2_inclui=simples&botao=recusa&classe='+exportacao.value+'&repre=URANET&acesso=A&desc_classe_titulo=Seleção Exporta Dados', 'janelaLupa', 650, 350,'Mostra Classe')
     }else{
       alert("Selecione a Exportação");
       exportacao.focus();
     }
   }
   </script>

<?
if ($exportacao_passa) {
  if ($discador_modelo) {
    $classe_k = substr($exportacao_passa, 0, 2).substr($discador_modelo, 2, 2)."K";
  } elseif ($classe_menu) {
    $classe_k = $classe_menu;
  } else {
    $classe_k = substr($exportacao_passa, 0, 4)."K";
  }

  $MontaCombo = ValorClasse($classe_k, $exportacao_passa, $repre);
  $titClasse = $titVlrClasse;
} else {
  if ($busca_direta == "S") {
    $monta_combo_k = $classe_menu;
  } else {
    $monta_combo_k = "EX".substr($discador_modelo,2,2)."K";
  }
  $MontaCombo = MontaCombo($monta_combo_k, $exportacao, $repre, "A", "ZZ");
}
if (!$titClasse) {
  $titClasse = "Consulta";
}

$titClasse = $objTradutor->traduzir($titClasse);

?>
   <tr <?print $bgcolor_td_dado3;?>>
      <td nowrap align="left"><font class="txt5"><strong><?print $titClasse;?>:</strong></td>
      <td align="left"  ><font class="txt5">
<?    if($exportacao_passa) {
        print $MontaCombo;
?>
        <input type="hidden" id="exportacao" name="exportacao" value="<?print $exportacao_passa;?>">
<?    } else {?>
        <select id="exportacao" name="exportacao"  consistencia="sempre" consistencia1="pre" msg=" Selecione a Exportação." OnChange="MudaExp(this.value);" >
        <?print $MontaCombo?>
        </select>
<?    }
      if ($session["representante"] == "URANET" && ($session["equipe"] == "005" || strpos("***".$session["equipe"],"005") == 3 || $session["equipe"] == "015")) {?>
        <img align="absmiddle" vspace="0" src="imagens/ico_classe.gif" width="15px" title="Manutenção da Classe" style="cursor:pointer;" onClick="clickClasse(document.getElementById('exportacao'))">
<?    }

      if ($tem_help) {?>
        <img src="imagens/info.gif" align='absmiddle' vspace='0' border='0' width='22px' style="cursor:pointer;" title="Ajuda" onClick="mostraHelp('<?print $exportacao?>','<?print $repre_param?>')">
<?    }
      unset($matriz_help);
?>
      </td>
    </tr>
<?
   }


if ($possui_layout != "NO") {
  if ($exportacao != "") {

    if (strtolower($param_cmp_ano_mes[1]) == "calendarioanomes") {
      require ($_SERVER['DOCUMENT_ROOT']."/libs/func/DatepickerCalendario.php");
?>
      <tr align="left" <? print $bgcolor_td_dado3;?>>
<?
       if ($param_cmp_ano_mes) {
         $nro_total_loop = count((array)$param_cmp_mes);
       }
       if (strpos($param_cmp_ano_mes[0],",") == "") {?>
         <td nowrap><font class="txt5"><strong><?print $param_cmp_ano_mes[2]?>:</strong></font></td>
<?     } else {?>
         <td nowrap><font class="txt5">
           <select name="nome_cpo_ano_mes">
<?           for($z=0; $z<$nro_total_loop; $z++) {
               if (strpos($param_cmp_mes[$z], "data") !== false) {
                 $param_cmp_mes[$z] = "LEFT(REPLACE(".$param_cmp_mes[$z].",'-',''),6)";
               }?>
               <option value="<?print $param_cmp_mes[$z];?>" <?if($nome_cpo_ano_mes == $param_cmp_mes[$z]){print " SELECTED ";}?>><?print $param_cmp_mes_desc[$z];?></option>;
<?           }?>
           </select>
           </font>
         </td>
<?     }?>

       <td nowrap>
       <input class="input_datepicker" date-format="yyyymm" value="<?= $ano_mes ? $ano_mes : date("Ym")?>" input="text" view-mode="anomes" name="ano_mes">
       </td>
<?
        // print DatepickerCalendarioAnoMes("ano_mes", $data_limite_ini, $data_limite_fim, "Selecione o Ano/Mês");
?>

<?

    } else {
      if ($nome_campo_data != "" || $nome_campo_datahora != "") {// campo = $param_cmp_dt & $param_cmp_dt_desc = descricao
        $nro_total_loop = count((array)$param_cmp_dt);

        //Carlos datahora
       if ($nome_campo_datahora != "") {
         $intervalo_dt = "D";
       }

?>
        <tr align="left" <? print $bgcolor_td_dado3;?>>
        <?if(strpos($campodata[0],",") == "") {?>
          <td nowrap><font class="txt5"><strong><?print $param_cmp_dt_desc?>:</strong></font></td>
        <?} else {?>
            <td nowrap>
              <font class="txt5">
                <select name="param_campo_data">
                <?for($z=0; $z<$nro_total_loop; $z++) {?>
                    <option value="<?print $param_cmp_dt[$z];?>" <?if($param_campo_data == $param_cmp_dt[$z]){print " SELECTED ";}?>><?print $param_cmp_dt_desc[$z];?></option>;
                <?}?>
                </select>
              </font>
            </td>
        <?}?>
  <td nowrap>
    <font class="txt5">
    <strong>
    <script language="javascript" type="text/javascript">
<!--
    function setData() {
      document.frmMKExp.mes_ini.value  = document.frmMKExp.mes_fim.value;
      document.frmMKExp.ano_ini.value  = document.frmMKExp.ano_fim.value;

      document.frmMKExp.data_ini.value = document.frmMKExp.ano_ini.value+'-'+document.frmMKExp.mes_ini.value+'-'+document.frmMKExp.dia_ini.value;
      document.frmMKExp.data_fim.value = document.frmMKExp.ano_fim.value+'-'+document.frmMKExp.mes_fim.value+'-'+document.frmMKExp.dia_fim.value;
      document.frmMKExp.ano_mes.value  = document.frmMKExp.ano_fim.value+document.frmMKExp.mes_fim.value;
    }
-->
    </script>
    <input type="hidden" name="data_ini" id="data_ini" value="">
    <input type="hidden" name="data_fim" id="data_fim" value="">
    <input type="hidden" name="ano_mes"  id="ano_mes"  value="">
<?
  if ($intervalo_dt != "M") {
    if ($intervalo_dt == "S") {
       $desc_data = "Dia Ini:";
    } else {
       $desc_data = "Dia:";
    }
    print $desc_data;
?>
    <select name="dia_ini" id="dia_ini" onChange="setData();">
      <?print ComboData("D", $dia_ini, date("d"));?>
    </select>
    <input type="hidden" name="mes_ini" id="mes_ini" value="">
    <input type="hidden" name="ano_ini" id="ano_ini" value="">
  <?
    if ($intervalo_dt == "S") {?>
      Dia Fim:
      <select name="dia_fim" id="dia_fim" onChange="setData();">
        <?print ComboData("D", $dia_fim, date("d"));?>
      </select>
  <?} else {?>
      <input type="hidden" name="dia_fim" id="dia_fim" value="">
  <?}?>
      Mês:
      <select name="mes_fim" id="mes_fim" onChange="setData();">
        <?print ComboData("M", $mes_fim, date("m"));?>
      </select>
      Ano:
      <select name="ano_fim" id="ano_fim" onChange="setData();">
        <?print ComboData("A", $ano_fim, date("Y"));?>
      </select>

      <script language="javascript" type="text/javascript">
      <!--
      setData();
      -->
      </script>
  <?
  } else {
  ?>
     <script language="javascript" type="text/javascript">
       function confereData(){
         data_ini = new Date(document.frmMKExp.ano_ini.value, (document.frmMKExp.mes_ini.value - 1), document.frmMKExp.dia_ini.value);
         data_fim = new Date(document.frmMKExp.ano_fim.value, (document.frmMKExp.mes_fim.value - 1), document.frmMKExp.dia_fim.value);
         data_ini_fmt = document.frmMKExp.ano_ini.value+"-"+document.frmMKExp.mes_ini.value+"-"+document.frmMKExp.dia_ini.value;
         data_fim_fmt = document.frmMKExp.ano_fim.value+"-"+document.frmMKExp.mes_fim.value+"-"+document.frmMKExp.dia_fim.value;

        //  if((data_ini_fmt > '<?print date("Y-m-d")?>') || (data_fim_fmt > '<?print date("Y-m-d")?>')){
        //    document.frmMKExp.dia_fim.focus();
        //    alert('Não é permitido a pesquisa maior que o dia atual.');
        //    return false;
        //  }

         if(data_fim < data_ini){
           document.frmMKExp.dia_ini.focus();
           alert('Data inicial da pesquisa deve ser menor do que a data final.');
           return false
         }

         if((Math.floor((data_fim - data_ini)/86400000)) <= <?print $param_limit_dia;?>){
           return true;
         }else{
           alert('O intervalo máximo para consulta é de <?print $param_limit_dia;?> dias.');
           document.frmMKExp.dia_ini.focus();
         }
       }
     </script>
  <?
    print dataCalendarioNovo("dia_ini","mes_ini","ano_ini","dia_fim","mes_fim","ano_fim","","","","frmMKExp");
  }
}

if ($nome_campo_datahora != "") {

?>
  <script language="javascript" type="text/javascript">
  function confereHora(){
    if(document.frmMKExp.datahora_fim.value < document.frmMKExp.datahora_ini.value){
      document.frmMKExp.c_min_ini.focus();
      alert('Minuto inicial da pesquisa deve ser menor do que o minuto final.');
      return false
    } else {
      return true
    }
  }
</script>
<?
  print "<br><br>Hora: ";
?>

  <select name="c_hora_ini" id="c_hora_ini" onChange="setHora();">
    <?for ($i=0; $i<24; $i++){ ?><option value="<?if ($i < 10){$xi = $i; $xi="0".$xi;print $xi;} else {print $i;}?>"<?print ImprimeSelected($c_hora_ini, $i, "00");?>><?if ($i < 10){$xi = $i; $xi="0".$xi;print $xi;} else{print $i;}?></option><?}?>
  </select> &nbsp;Minuto ( Inicial:

  <select name="c_min_ini" id="c_min_ini" onChange="setHora();">
    <option value="00" <?if($c_min_ini == "00" || $c_min_fim == ""){ print "selected";}?>>00</option>
    <option value="15" <?if($c_min_ini == "15"){ print "selected";}?>>15</option>
    <option value="30" <?if($c_min_ini == "30"){ print "selected";}?>>30</option>
    <option value="45" <?if($c_min_ini == "45"){ print "selected";}?>>45</option>
    <option value="59" <?if($c_min_ini == "59"){ print "selected";}?>>59</option>
  </select>
  &nbsp;&nbsp;Final:
  <select name="c_min_fim" id="c_min_fim" onChange="setHora();">
    <option value="00" <?if($c_min_fim == "00" || $c_min_fim == ""){ print "selected";}?>>00</option>
    <option value="15" <?if($c_min_fim == "15"){ print "selected";}?>>15</option>
    <option value="30" <?if($c_min_fim == "30"){ print "selected";}?>>30</option>
    <option value="45" <?if($c_min_fim == "45"){ print "selected";}?>>45</option>
    <option value="59" <?if($c_min_fim == "59"){ print "selected";}?>>59</option>
  </select>
  )
  <script language="javascript" type="text/javascript">
  <!--
    function setHora() {
      document.frmMKExp.datahora_ini.value = document.frmMKExp.c_hora_ini.value+':'+document.frmMKExp.c_min_ini.value;
      document.frmMKExp.datahora_fim.value = document.frmMKExp.c_hora_ini.value+':'+document.frmMKExp.c_min_fim.value;
      document.frmMKExp.intervalo_dthr.value = 'S';
    }
  -->
  </script>
  <input type="hidden" name="datahora_ini" id="datahora_ini" value="<?print $datahora_ini?>">
  <input type="hidden" name="datahora_fim" id="datahora_fim" value="<?print $datahora_fim?>">
  <script language="javascript" type="text/javascript">
    setHora();
  </script>
<?
}
?>
     </strong>
    </font>
  </td>
  </tr>
<?
      }
      if ($nome_campo_hora) {// campo = $param_cmp_hr & $param_cmp_hr_desc = descricao
        $nro_total_loop = count((array)$param_cmp_hr);
?>
        <tr align="left" <? print $bgcolor_td_dado3;?>>
        <?if(strpos($campohora[0],",") == "") {?>
        <td nowrap><font class="txt5"><strong><?print $param_cmp_hr_desc?>:</strong></font></td>
        <?} else {?>
        <td nowrap>
          <font class="txt5">
            <select name="param_campo_hora">
            <?for($z=0; $z<$nro_total_loop; $z++) {?>
              <option value="<?print $param_cmp_hr[$z];?>" <?if($param_campo_hora == $param_cmp_hr[$z]){print " SELECTED ";}?>><?print $param_cmp_hr_desc[$z];?></option>;
            <?}?>
            </select>
          </font>
        </td>
        <?}?>
       <td nowrap><font class="txt5"><strong>
       <script language="javascript" type="text/javascript">
        <!--
          function setHora() {
            document.frmMKExp.hora_ini.value = document.frmMKExp.c_hora_ini.value+':'+document.frmMKExp.c_min_ini.value;
            document.frmMKExp.hora_fim.value = document.frmMKExp.c_hora_fim.value+':'+document.frmMKExp.c_min_fim.value;
          }
        -->
        </script>
        <input type="hidden" name="hora_ini" id="hora_ini" value="<?print $hora_ini?>">
        <input type="hidden" name="hora_fim" id="hora_fim" value="<?print $hora_fim?>">
<?
  if ($intervalo_hr == "S") {
    $desc_hora = "Hora Inicial:";
  } else {
    $desc_hora = "Hora:";
  }
  print $desc_hora;
?>
      <select name="c_hora_ini" id="c_hora_ini" onChange="setHora();">
        <?for ($i=0; $i<24; $i++){ ?><option value="<?if ($i < 10){$xi = $i; $xi="0".$xi;print $xi;} else {print $i;}?>"<?print ImprimeSelected($c_hora_ini, $i, "00");?>><?if ($i < 10){$xi = $i; $xi="0".$xi;print $xi;} else{print $i;}?></option><?}?>
      </select>:
      <select name="c_min_ini" id="c_min_ini" onChange="setHora();">
        <option value="00" <?if($c_min_ini == "00" || $c_min_fim == ""){ print "selected";}?>>00</option>
        <option value="15" <?if($c_min_ini == "15"){ print "selected";}?>>15</option>
        <option value="30" <?if($c_min_ini == "30"){ print "selected";}?>>30</option>
        <option value="45" <?if($c_min_ini == "45"){ print "selected";}?>>45</option>
      </select>
    <?
    if ($intervalo_hr == "S") {
    ?>
       Hora Final:
       <select name="c_hora_fim" id="c_hora_fim" onChange="setHora();">
         <?for ($i=0; $i<=24; $i++){ ?><option value="<?if ($i < 10){$xi = $i; $xi="0".$xi;print $xi;} else {print $i;}?>"<?print ImprimeSelected($c_hora_fim, $i, "24");?>><?if ($i < 10){$xi = $i; $xi="0".$xi;print $xi;} else{print $i;}?></option><?}?>
       </select>:
       <select name="c_min_fim" id="c_min_fim" onChange="setHora();">
          <option value="00" <?if($c_min_fim == "00" || $c_min_fim == ""){ print "selected";}?>>00</option>
          <option value="15" <?if($c_min_fim == "15"){ print "selected";}?>>15</option>
          <option value="30" <?if($c_min_fim == "30"){ print "selected";}?>>30</option>
          <option value="45" <?if($c_min_fim == "45"){ print "selected";}?>>45</option>
       </select>
    <?
    } else {
    ?>
       <input type="hidden" name="c_hora_fim" id="c_hora_fim" value="">
    <?
    }
    ?>

     <script language="javascript" type="text/javascript">
       setHora();
     </script>
  </td>
  </tr>

<?
      }
    }

    //FILTRO NOVOS CANAIS

    if (strtoupper($tratar_nc) == "N") {
      $mkParam["usa_nc"] = "XXXXXXXXXX";// Para não usar a Rotina de NC
    }


    //if ((strtoupper($tratar_nc) == "S" || strtoupper($tratar_nc) == "") && $exportacao != "") {
    //if ( (strtoupper($tratar_nc) == "S" || $tratar_nc == "") && isset($tratar_nc) && $exportacao != "") {

    if ($mkParam["usa_nc"] == "S" && $exportacao != "" && ($session["equipe"] != 'vend_login' || substr($session["operador"], 0, 5) != 'pvt04'))  {

      $filtro_array = montaCombosFiltro($session["tp_user"], $session["equipe"], $session["login_sistema_cliente"], "frmMKExp",$repre, substr($discador_modelo, 0, 4), "array");


      if ($filtro_array) {

        if (substr($discador_modelo, 0, 4) == "MDYP" || substr($discador_modelo, 0, 4) == "MDGU" || substr($discador_modelo, 0, 4) == "MDII" || substr($discador_modelo, 0, 4) == "MDVR") {
          if ($filtro_array["vend_regional"]["desc"]) {
?>
            <tr <? print $bgcolor_td_dado3;?>>
              <td nowrap><font class="txt5"><strong><?print $filtro_array["vend_regional"]["desc"];?>:</strong></font></td>
              <td nowrap colspan="3"><font class="txt5"><?print $filtro_array["vend_regional"]["vlr"];?></font>
              </td>
            </tr>
<?
          } else {
            print $filtro_array["vend_regional"]["vlr"];
          }

          if ($filtro_array["vend_eps"]["desc"]) {
?>
            <tr <? print $bgcolor_td_dado3;?>>
              <td nowrap><font class="txt5"><strong><?print $filtro_array["vend_eps"]["desc"];?>:</strong></font></td>
              <td nowrap colspan="3"><font class="txt5"><?print $filtro_array["vend_eps"]["vlr"];?></font>
              </td>
            </tr>
<?
          } else {
            print $filtro_array["vend_eps"]["vlr"];
          }

          if ($filtro_array["vend_depto"]["desc"]) {
?>
            <tr <? print $bgcolor_td_dado3;?>>
              <td nowrap><font class="txt5"><strong><?print $filtro_array["vend_depto"]["desc"];?>:</strong></font></td>
              <td nowrap colspan="3"><font class="txt5"><?print $filtro_array["vend_depto"]["vlr"];?></font>
              </td>
            </tr>
<?
          } else {
            print $filtro_array["vend_depto"]["vlr"];
          }

          if ($filtro_array["vend_n1"]["desc"]) {
?>
            <tr <? print $bgcolor_td_dado3;?>>
              <td nowrap><font class="txt5"><strong><?print $filtro_array["vend_n1"]["desc"];?>:</strong></font></td>
              <td nowrap colspan="3"><font class="txt5"><?print $filtro_array["vend_n1"]["vlr"];?></font>
              </td>
            </tr>
<?
          } else {
            print $filtro_array["vend_n1"]["vlr"];
          }

          if ($filtro_array["vend_login"]["desc"]) {
?>
            <tr <? print $bgcolor_td_dado3;?>>
              <td nowrap><font class="txt5"><strong><?print $filtro_array["vend_login"]["desc"];?>:</strong></font></td>
              <td nowrap colspan="3"><font class="txt5"><?print $filtro_array["vend_login"]["vlr"];?></font>
              </td>
            </tr>
<?
          } else {
            print $filtro_array["vend_login"]["vlr"];
          }

        }else{
          if ($filtro_array[0]["desc"]) {
  ?>
          <tr <? print $bgcolor_td_dado3;?>>
            <td nowrap><font class="txt5"><strong><?print $filtro_array[0]["desc"];?>:</strong></font></td>
            <td nowrap colspan="3"><font class="txt5"><?print $filtro_array[0]["vlr"];?></font>
            </td>
          </tr>
  <?
          } else {
            print $filtro_array[0]["vlr"];
          }
          if ($filtro_array[1]["desc"]) {
  ?>
          <tr <? print $bgcolor_td_dado3;?>>
            <td nowrap><font class="txt5"><strong><?print $filtro_array[1]["desc"];?>:</strong></font></td>
            <td nowrap colspan="3"><font class="txt5"><?print $filtro_array[1]["vlr"];?></font>
            </td>
          </tr>
  <?
          } else {
            print $filtro_array[1]["vlr"];
          }
          if ($filtro_array[2]["desc"]) {
  ?>
          <tr <? print $bgcolor_td_dado3;?>>
            <td nowrap><font class="txt5"><strong><?print $filtro_array[2]["desc"];?>:</strong></font></td>
            <td nowrap colspan="3"><font class="txt5"><?print $filtro_array[2]["vlr"];?></font>
            </td>
          </tr>
  <?
          } else {
            print $filtro_array[2]["vlr"];
          }
          if ($filtro_array[3]["desc"]) {
  ?>
          <input type="hidden" name="vendedor" value="ok">
          <tr <? print $bgcolor_td_dado3;?>>
            <td nowrap><font class="txt5"><strong><?print $filtro_array[3]["desc"];?>:</strong></font></td>
            <td nowrap colspan="3"><font class="txt5"><?print $filtro_array[3]["vlr"];?></font>
            </td>
          </tr>
  <?
          } else {
            print $filtro_array[3]["vlr"];
          }

        }

      }
    }

    if (empty($_REQUEST["exportacao"]) === false) {
      if ($selecao_tipo_produto) {
        $selecao_tipo_produto_arr = explode("¬", $selecao_tipo_produto);
?>
  <tr <? print $bgcolor_td_dado3;?>>
    <td><font class="txt5"><strong><?print $selecao_tipo_produto_arr[0];?>:</strong></font></td>
    <td>
      <select name="tipo_produto">
        <?
        $q_p = " SELECT DISTINCT(tipo_produto) AS tipo_produto FROM tbproduto WHERE empresa = '".addslashes($param_empresa_produto)."' AND tipo_produto <> 'MODEN'";
        $con_p = DescExecQuery($q_p, $connect, "N");
        while ($rec_p = mysql_fetch_assoc($con_p)) {
?>
          <option value="<?print $rec_p["tipo_produto"];?>"<?
          if ($rec_p["tipo_produto"] == $tipo_produto) {?>
            selected
  <?      }?>><?print ValorClasse("TPCON", $rec_p["tipo_produto"], DefineRepre($repre));?></option>
<?      }?>
        <option value="TODOS"<?
        if ($tipo_produto == "TODOS") {
          ?> selected<?
        }
?>>TODOS</option>
      </select>
    </td>
  </tr>
<?
      }

      if ($selecao_produto) {
        $selecao_produto_arr = explode("¬", $selecao_produto);
?>
  <tr <? print $bgcolor_td_dado3;?>>
    <td><font class="txt5"><strong><?print $selecao_produto_arr[0];?>:</strong></font></td>
    <td>
      <select name="cod_produto">
        <?
        $q_p = "SELECT codproduto, nomeproduto FROM tbproduto WHERE empresa = '".addslashes($param_empresa_produto)."'";
        if (($tipo_produto) && ($tipo_produto != "TODOS"))  {
          $q_p .= " AND tipo_produto = '".addslashes($tipo_produto)."'";
        }
        $q_p .= " AND tipo_produto <> 'MODEN'";

        $con_p = DescExecQuery($q_p, $connect, "N");
        while ($rec_p = mysql_fetch_assoc($con_p)) {
?>
        <option value="<?print $rec_p["codproduto"];?>"<?if ($rec_p["codproduto"] == $cod_produto) {?> selected<?}?>><?print $rec_p["nomeproduto"];?></option>
<?
        }
?>
        <option value="TODOS"<?
        if ($cod_produto == "TODOS") {
          ?> selected<?
        }
?>> TODOS </option>

      </select>
    </td>
  </tr>
<?
      }

      if ($selecao_mailing_pesquisa) {
        $selecao_mailing_pesquisa_arr = explode("¬", $selecao_mailing_pesquisa);
?>
  <tr <? print $bgcolor_td_dado3;?>>
    <td><font class="txt5"><strong><?print $selecao_mailing_pesquisa_arr[0];?>:</strong></font></td>
    <td>

     <?if(!$selecao_classe_arr[6]){
       $selecao_classe_arr[6] = "sopreenchido";
     }
     ?>
      <select name="mailing_pesquisa" consistir="<?print $selecao_classe_arr[6]?>" tipodado='todos' msg='Selecione o(a) <?print $selecao_classe_arr[0];?>' onchange="javascript: document.frmMKExp.submit();">
        <?
        if (substr($selecao_mailing_pesquisa_arr[1], 2, 2) == "__") {
          $selecao_mailing_pesquisa_arr[1] = str_replace("__", $nromodelo, $selecao_mailing_pesquisa_arr[1]);
        }

        if(!$selecao_mailing_pesquisa_arr[4]){
          $selecao_mailing_pesquisa_arr[4] = "A";
        }

        if(!$selecao_mailing_pesquisa_arr[5]) {
          $selecao_mailing_pesquisa_arr[5] = "ZZ"  ;
        }

        if ($selecao_mailing_pesquisa_arr[3] == "CC") {//callcenter
          print MontaCombo($selecao_mailing_pesquisa_arr[1], $mailing_pesquisa, DefineRepre($repre), $selecao_mailing_pesquisa_arr[4], $selecao_mailing_pesquisa_arr[5]);
        } elseif ($selecao_mailing_pesquisa_arr[3] == "PQ") {//pesquisa
          print MontaComboPesq($selecao_mailing_pesquisa_arr[1], $mailing_pesquisa, DefineRepre($repre), $selecao_mailing_pesquisa_arr[4], $selecao_mailing_pesquisa_arr[5]);
        } elseif ($selecao_mailing_pesquisa_arr[3] == "CT") {//conhecimento
          print MontaComboConhec($selecao_mailing_pesquisa_arr[1], $mailing_pesquisa, DefineRepre($repre), $selecao_mailing_pesquisa_arr[4], $selecao_mailing_pesquisa_arr[5]);
        } elseif ($selecao_mailing_pesquisa_arr[3] == "PV") {//prova
          print MontaComboProva($selecao_mailing_pesquisa_arr[1], $mailing_pesquisa, DefineRepre($repre), $selecao_mailing_pesquisa_arr[4], $selecao_mailing_pesquisa_arr[5]);
        }
?>
      </select>
    </td>
  </tr>
<?
      }

    //CAMPOS DE SELECAO DE CLASSE
    for ($i = 1; $i <= $qtd_param_classe; $i++) {
      $i = str_pad($i, 2, "0", STR_PAD_LEFT);
      $aux = "selecao_classe_".$i;

      if ($$aux) {
        $selecao_classe_arr = explode("¬", $$aux);

//        $aux = "CL_".$selecao_classe_arr[2];
        $aux = "CL_selecao_classe_".$i;

        if (substr($selecao_classe_arr[1], 2, 2) == "__") {
          $selecao_classe_arr[1] = str_replace("__", $nromodelo, $selecao_classe_arr[1]);
        } else {
          if ((substr($selecao_classe_arr[1], 3, 2) == "__") && (empty($mailing_pesquisa) === false) && (empty($cod_pesquisa) === false)) {
            $selecao_classe_arr[1] = str_replace("__", $cod_pesquisa, $selecao_classe_arr[1]);
          }
        }
?>
  <tr <? print $bgcolor_td_dado3;?>>
    <td><font class="txt5"><strong><?print $selecao_classe_arr[0];?>:</strong></font></td>
    <td>
<?
      if(!$selecao_classe_arr[6]){
        $selecao_classe_arr[6] = "sopreenchido";
      }

      if(!$selecao_classe_arr[8]) {
        $selecao_classe_arr[8] = "descricao";
      }

      //if para funcionar o combo multipli "MULT"
      if($selecao_classe_arr[7] == "MULT") {
        $combo_mult = "multiple='multiple'  size='8' ";
        $combo_mult_sufixo = "[]";
      } else {
        $combo_mult = "";
        $combo_mult_sufixo = "";
      }

?>
      <select <?print $combo_mult;?> name="<?print $aux.$combo_mult_sufixo;?>" consistir='<?print $selecao_classe_arr[6]?>' tipodado='todos' msg='Selecione o campo <?print $selecao_classe_arr[0];?>'>
        <?
        if(!$selecao_classe_arr[4]){
          $selecao_classe_arr[4] = "A";
        }
        if(!$selecao_classe_arr[5]){
          $selecao_classe_arr[5] = "ZZ";
        }
        if(trim($selecao_classe_arr[9]) == ""){
          $selecao_classe_arr[9] = "valor";//Para montar o combo com o valor = (valor e descrição) ou descricao = (descrição e valor igual)
        }
        // MOTMO |  | UNIMED | S | and filtro_classe = 71 | descricao | valor
        // echo $selecao_classe_arr[1].' | '. $$aux.' | '. DefineRepre($repre).' | '.$selecao_classe_arr[4].' | '. $selecao_classe_arr[5].' | '. $selecao_classe_arr[8].' | '.$selecao_classe_arr[9];
        if ($selecao_classe_arr[3] == "CC") {//callcenter
          print MontaCombo($selecao_classe_arr[1], $$aux, DefineRepre($repre),$selecao_classe_arr[4], $selecao_classe_arr[5], $selecao_classe_arr[8],$selecao_classe_arr[9]);
        } else if ($selecao_classe_arr[3] == "PQ") {//pesquisa
          print MontaComboPesq($selecao_classe_arr[1], $$aux, DefineRepre($repre),$selecao_classe_arr[4], $selecao_classe_arr[5], $selecao_classe_arr[8]);
        } else if ($selecao_classe_arr[3] == "CT") {//conhecimento
          print MontaComboConhec($selecao_classe_arr[1], $$aux, DefineRepre($repre), $selecao_classe_arr[4], $selecao_classe_arr[5], $selecao_classe_arr[8]);
        } else if ($selecao_classe_arr[3] == "PV") {//prova
          print MontaComboProva($selecao_classe_arr[1], $$aux, DefineRepre($repre), $selecao_classe_arr[4], $selecao_classe_arr[5], $selecao_classe_arr[8]);
        } else if ($selecao_classe_arr[3] == "FI") {//enriquecimento
          print MontaComboForm($selecao_classe_arr[1], $$aux, DefineRepre($repre), $selecao_classe_arr[4], $selecao_classe_arr[5], $selecao_classe_arr[8]);
        } elseif ($selecao_classe_arr[3] == "FUNCAO") {
          $arrItens = execFuncao($selecao_classe_arr[1]);
          print arrayToOptions($arrItens, $$aux);
        }
?>
      </select>
    </td>
  </tr>
<?
        }
      }

      //CAMPO DE SELECAO DEPENDE
      for ($i = 1; $i <= $qtd_param_classe; $i++) {
        $i = str_pad($i, 2, "0", STR_PAD_LEFT);
        $aux = "selecao_depende_".$i;
        if ($$aux) {
          $selecao_depende_arr = explode("¬", $$aux);
          $aux = "CL_selecao_depende_".$i;
          if (substr($selecao_depende_arr[1], 2, 2) == "__") {
            $selecao_depende_arr[1] = str_replace("__", $nromodelo, $selecao_depende_arr[1]);
          } else {
            if ((substr($selecao_depende_arr[1], 3, 2) == "__") && (empty($mailing_pesquisa) === false) && (empty($cod_pesquisa) === false)) {
              $selecao_depende_arr[1] = str_replace("__", $cod_pesquisa, $selecao_depende_arr[1]);
            }
          }

          $arrComboPrefixo = explode(".", $selecao_depende_arr[2]);
          if(is_array($arrComboPrefixo)){
            if($arrComboPrefixo[1] != ""){
              $campoDepende = $arrComboPrefixo[1];
            }else{
              $campoDepende = $arrComboPrefixo[0];
            }
          }

          if($campoDepende == "tema_pai"){
            $desc_combo_depende = "Sub-Motivo";
          }elseif($campoDepende == "filtro_tema_pai"){
            $desc_combo_depende = "Motivo";
            $getCondClasse   = "SELECT desc_classe FROM tb_classe WHERE cod_classe = 'FM".substr($discador_modelo, 2)."T' AND tipo_reg = 'C' AND vlr_classe = 'CONDI' AND status = 'A' AND representante = '".addslashes($repre)."'";
            $queryCondClasse = DescExecQuery($getCondClasse, $connect,"N");
            $recCondClasse = mysql_fetch_assoc($queryCondClasse);
            if($recCondClasse["desc_classe"] != ""){
              $arr_dados_classe = explode("|",$recCondClasse["desc_classe"]);
              $arrVlrComboDepende = explode(",", substr($arr_dados_classe[0], 0,-1));
              if(is_array($arrVlrComboDepende)){
                foreach ($arrVlrComboDepende as $chave_depende => $valorComboDepende) {
                  $arrComboDepende[$valorComboDepende] = ValorClasse("CLACD",$valorComboDepende, "URANET");
                }
              }
              $arrComboDepende["ZZ"] = $arr_dados_classe[2];
              $arrComboDepende["TODOS"] = "TODOS";
            }
          }
          ?>
            <tr <? print $bgcolor_td_dado3;?>>
              <td><font class="txt5"><strong><?print $selecao_depende_arr[0];?>:</strong></font></td>
            <td>
              <?
              if(!$selecao_depende_arr[6]){
                $selecao_depende_arr[6] = "sopreenchido";
              }

              if(!$selecao_depende_arr[8]) {
                $selecao_depende_arr[8] = "descricao";
              }

              if($selecao_depende_arr[7] == "MULT") {
                $combo_mult = "multiple='multiple'  size='8' ";
                $combo_mult_sufixo = "[]";
              } else {
                $combo_mult = "";
                $combo_mult_sufixo = "";
              }
              ?>
                <select <?print $combo_mult;?> name="<?print $aux.$combo_mult_sufixo;?>" id="<?print $aux.$combo_mult_sufixo;?>" consistir='<?print $selecao_depende_arr[6]?>' tipodado='todos' msg='Selecione o(a) <?print $selecao_depende_arr[0];?>' onchange="montaProxCombo('<?=$campoDepende;?>','<?=$aux?>', this.value, '<?print ${$aux.$combo_mult_sufixo."_aux"};?>');">
              <?

                  if($campoDepende == "tema_pai"){

                    if(!$selecao_depende_arr[4]){
                      $selecao_depende_arr[4] = "A";
                    }
                    if(!$selecao_depende_arr[5]){
                      $selecao_depende_arr[5] = "ZZ";
                    }

                    if ($selecao_depende_arr[3] == "CC") {//callcenter
                      print MontaCombo($selecao_depende_arr[1], $$aux, DefineRepre($repre),$selecao_depende_arr[4], $selecao_depende_arr[5], $selecao_depende_arr[8]);
                    } else if ($selecao_depende_arr[3] == "PQ") {//pesquisa
                      print MontaComboPesq($selecao_depende_arr[1], $$aux, DefineRepre($repre),$selecao_depende_arr[4], $selecao_depende_arr[5], $selecao_depende_arr[8]);
                    } else if ($selecao_depende_arr[3] == "CT") {//conhecimento
                      print MontaComboConhec($selecao_depende_arr[1], $$aux, DefineRepre($repre), $selecao_depende_arr[4], $selecao_depende_arr[5], $selecao_depende_arr[8]);
                    } else if ($selecao_depende_arr[3] == "PV") {//prova
                      print MontaComboProva($selecao_depende_arr[1], $$aux, DefineRepre($repre), $selecao_depende_arr[4], $selecao_depende_arr[5], $selecao_depende_arr[8]);
                    } else if ($selecao_depende_arr[3] == "FI") {//enriquecimento
                      print MontaComboForm($selecao_depende_arr[1], $$aux, DefineRepre($repre), $selecao_depende_arr[4], $selecao_depende_arr[5], $selecao_depende_arr[8]);
                    }
                  }elseif($campoDepende == "filtro_tema_pai"){
                    ?>
                     <option value="">-- Selecione -- </option>
                    <?
                      if(is_array($arrComboDepende)){
                        foreach ($arrComboDepende as $vlrComboDepende => $descComboDepende) {
                          ($vlrComboDepende == ${$aux.$combo_mult_sufixo}) ? $select = "selected" : $select = "";
                          ?>
                            <option value="<?=$vlrComboDepende?>" <?=$select;?>><?=$descComboDepende?></option>
                          <?
                        }
                      }
                  }
              ?>
                </select>
              </td>
            </tr>
            <tr>
              <td>
                <font class="txt5"><strong><?=$desc_combo_depende;?>:</strong></font>
              </td>
              <td>
                <select class="cmb_depende" name="<?print $aux.$combo_mult_sufixo;?>_aux" id="<?print $aux.$combo_mult_sufixo;?>_aux" consistir='<?print $selecao_depende_arr[6]?>' tipodado='todos' msg='Selecione o(a) <?print $desc_combo_depende;?>'>
                  <option value="">-- Selecione -- </option>
                </select>
            </td>


          </tr>
         <?
        }
      }


      //CAMPO DE SELECAO DEPENDE

      //CAMPO SELEÇÃO FLW
      for ($i = 1; $i <= $qtd_param_classe; $i++) {
        $i = str_pad($i, 2, "0", STR_PAD_LEFT);
        $aux = "selecao_flw_".$i;

        if ($$aux) {
          $selecao_flw_arr = explode("¬", $$aux);
          $aux = "CL_selecao_flw_".$i;

          if (substr($selecao_flw_arr[1], 2, 2) == "__") {
            $selecao_flw_arr[1] = str_replace("__", $nromodelo, $selecao_flw_arr[1]);
          } else {
            if ((substr($selecao_flw_arr[1], 3, 2) == "__") && (empty($mailing_pesquisa) === false) && (empty($cod_pesquisa) === false)) {
              $selecao_flw_arr[1] = str_replace("__", $cod_pesquisa, $selecao_flw_arr[1]);
            }
          }
          ?>
          <tr <?=$bgcolor_td_dado3;?>>
            <td><font class="txt5"><strong><?print $selecao_flw_arr[0];?>:</strong></font></td>
            <td>
          <?
            if(!$selecao_flw_arr[6]){
              $selecao_flw_arr[6] = "sopreenchido";
            }

            if(!$selecao_flw_arr[8]) {
              $selecao_flw_arr[8] = "descricao";
            }

            //if para funcionar o combo multipli "MULT"
            if($selecao_flw_arr[7] == "MULT") {
              $combo_mult = "multiple='multiple' size='8' ";
              $combo_mult_sufixo = "[]";
            } else {
              $combo_mult = "";
              $combo_mult_sufixo = "";
            }

            ?>
              <select <?print $combo_mult;?> name="<?print $aux.$combo_mult_sufixo;?>" consistir='<?print $selecao_flw_arr[6]?>' tipodado='todos' msg='Selecione o(a) <?print $selecao_flw_arr[0];?>'>
            <?
                if(!$selecao_flw_arr[4]){
                  $selecao_flw_arr[4] = "A";
                }
                if(!$selecao_flw_arr[5]){
                  $selecao_flw_arr[5] = "ZZ";
                }

                if ($selecao_flw_arr[3] == "CC") {//callcenter
                  print MontaCombo($selecao_flw_arr[1], $$aux, DefineRepre($repre),$selecao_flw_arr[4], $selecao_flw_arr[5], $selecao_flw_arr[8]);
                } else if ($selecao_flw_arr[3] == "PQ") {//pesquisa
                  print MontaComboPesq($selecao_flw_arr[1], $$aux, DefineRepre($repre),$selecao_flw_arr[4], $selecao_flw_arr[5], $selecao_flw_arr[8]);
                } else if ($selecao_flw_arr[3] == "CT") {//conhecimento
                  print MontaComboConhec($selecao_flw_arr[1], $$aux, DefineRepre($repre), $selecao_flw_arr[4], $selecao_flw_arr[5], $selecao_flw_arr[8]);
                } else if ($selecao_flw_arr[3] == "PV") {//prova
                  print MontaComboProva($selecao_flw_arr[1], $$aux, DefineRepre($repre), $selecao_flw_arr[4], $selecao_flw_arr[5], $selecao_flw_arr[8]);
                } else if ($selecao_flw_arr[3] == "FI") {//enriquecimento
                  print MontaComboForm($selecao_flw_arr[1], $$aux, DefineRepre($repre), $selecao_flw_arr[4], $selecao_flw_arr[5], $selecao_flw_arr[8]);
                } else if ($selecao_flw_arr[3] == "AREA") {//workflow
                  require_once($_SERVER['DOCUMENT_ROOT']."/callcenter/flw_funcoes.php");
                  // print montaComboArea($selecao_flw_arr[1], , DefineRepre($repre), $selecao_flw_arr[4], $selecao_flw_arr[5], $selecao_flw_arr[8]);
                  print montaComboAreaFLW($nromodelo,$$aux);
                }

              ?>
              </select>
            </td>
          </tr>
          <?
        }
      }

      //CAMPOS DE SELECAO DE CAMPO
      for ($i = 1; $i <= $qtd_param_campo; $i++) {
        $i = str_pad($i, 2, "0", STR_PAD_LEFT);
        $aux = "selecao_campo_".$i;

        if ($$aux) {
?>
          <tr align="left" <? print $bgcolor_td_dado3 ?>>
<?
          $selecao_campo_arr = explode("¬", $$aux);

          if(strpos($selecao_campo_arr[0],",") == "") {
?>
            <td nowrap><font class="txt5"><strong><?print $selecao_campo_arr[0]?>:</strong></font></td>
<?        } else {

            $selecao_campo_desc = explode(",",$selecao_campo_arr[0]);
            $selecao_campo_cpo  = explode(",",$selecao_campo_arr[2]);
            $nome_combo = "param_selecao_campo_".$i;
?>
              <td nowrap>
                <font class="txt5">
                  <select name="<?print $nome_combo?>">
<?
                    $nro_total_loop = count((array)$selecao_campo_desc);
                    for($z=0; $z<$nro_total_loop; $z++) {
?>
                      <option value="<?print $selecao_campo_cpo[$z];?>" <?if($$nome_combo == $selecao_campo_cpo[$z]){print " SELECTED ";}?>><?print $selecao_campo_desc[$z];?></option>;
<?
                    }
?>
                  </select>
                </font>
              </td>
<?
            }
            //$selecao_campo_arr = explode("¬", $$aux);

            if(!$selecao_campo_arr[3]){
              $selecao_campo_arr[3] = "sopreenchido";
            }


            if(strpos($selecao_campo_arr[0],",") == "") {
              $aux = "CPO_".$selecao_campo_arr[2];
            } else {
              $aux = "CPO_selecao_campo_".$i;
            }

            $aux = "CPO_selecao_campo_".$i;

            if($selecao_campo_arr[1] == "ENTRE") {

              if(strpos($selecao_campo_arr[0],",") == "") {
                $aux2 = "CPO_FIM".$selecao_campo_arr[2];
              } else {
                $aux2 = "CPO_FIMselecao_campo_".$i;
              }

              $aux2 = "CPO_FIMselecao_campo_".$i;

?>
            <td>
              De:&nbsp;<input type="text" name="<?print $aux;?>" value="<?print $$aux;?>" consistir="<?print $selecao_campo_arr[3]?>" tipodado='todos' msg='Preencha o filtro.'>
              Até&nbsp;<input type="text" name="<?print $aux2;?>" value="<?print $$aux2;?>" consistir="<?print $selecao_campo_arr[3]?>" tipodado='todos' msg='Preencha o filtro.'>
            </td>
          </tr>
<?
            } else {
              if ($selecao_campo_arr[3] == "numeros_0" || $selecao_campo_arr[3] == "numeros"){
                $tipodado = $selecao_campo_arr[3];
                $selecao_campo_arr[3] = "sopreenchido";
              } else {
                $tipodado = "todos";
              }
?>
              <td>
                <input type="text" name="<?print $aux;?>" value="<?print $$aux;?>" consistir="<?print $selecao_campo_arr[3]?>" tipodado="<?print $tipodado?>" msg='Preencha o filtro.'>
            </td>
          </tr>
<?
          }
        }
      }
    }

  if ($relatorio != "excel" && $exportacao != "") {
?>
  <tr <?print $bgcolor_td_dado3?>>
    <td align="left"><font class="txt5"><strong><?print $objTradutor->traduzir("Tipo Arquivo");?>:</strong></td>
    <td align="left"  ><font class="txt5">

      <?
      if (strpos("**".$relatorio, "ftp") > 0 && $session["exportacao"] != "N") {
        if ($extracao_ftp != "") {
          ?>
          <label style="cursor:pointer;">
            <input type="radio" name="visualizax" value="F" <?if($visualiza == "F"){print "checked";}?> OnClick="document.frmMKExp.visualiza.value=this.value;">
            <img name="img_file_ftp" align="absmiddle" vspace="0" src="imagens/file_ftp_18px.png" style="cursor:pointer;" title="FTP" OnClick="document.frmMKExp.visualiza.value=document.frmMKExp.visualizax[0].value;document.frmMKExp.visualizax[0].checked=true;">&nbsp;<?print $objTradutor->traduzir("Arquivo FTP");?> (<?print $nome_arquivo?>)
          </label>
          <br>
          <?
        }
      }
      if (strpos("**".$relatorio, "txt") > 0 && $session["exportacao"] != "N") {
        ?>
        <label style="cursor:pointer;">
          <input type="radio" name="visualizax" value="A" <?if($visualiza == "A"){print "checked";}?> OnClick="document.frmMKExp.visualiza.value=this.value;">
          <img name="img_file" align="absmiddle" vspace="0" src="imagens/file_txt_18px.png" style="cursor:pointer;" title="Arquivo" OnClick="document.frmMKExp.visualiza.value=document.frmMKExp.visualizax[0].value;document.frmMKExp.visualizax[0].checked=true;">&nbsp;<?print $objTradutor->traduzir("Arquivo");?> (<?print $nome_arquivo?>)
        </label>
        <br>
        <?
      }
      if (strpos("**".$relatorio, "excel") > 0) {
?>
        <label style="cursor:pointer;">
          <input type="radio" name="visualizax" value="T" <?if($visualiza == "T"){print "checked";}?> OnClick="document.frmMKExp.visualiza.value=this.value;">
		<?if($session["exportacao"] != "N") {?>
          <img name="img_excel" align="absmiddle" vspace="0" src="imagens/excel_18px.gif" style="cursor:pointer;" title="Excel" OnClick="document.frmMKExp.visualiza.value=document.frmMKExp.visualizax[1].value;document.frmMKExp.visualizax[1].checked=true;">&nbsp;<?print $objTradutor->traduzir("Tabela");?> (Excel)
		<?} else {?>
			    &nbsp;<?print $objTradutor->traduzir("Relatório");?>
		<?}?>
        </label>
<?
      }
      if (strpos("**".$relatorio, "carga_auto") > 0) {
        if ($carga_auto != "") {
          $aux = explode('¬',  $carga_auto);
          if ($aux[0] != "") {
            ?>
            <br>
            <input type="radio" name="visualizax" value="E" <?if($visualiza == "E"){print "checked";}?> OnClick="document.frmMKExp.visualiza.value=this.value;">Carga Automática (<?print $aux[0];?>)
            <?
          }
        }
      }

      if (strpos("**".$relatorio, "json") > 0){
        ?>
            <br>
              <input type="radio" name="visualizax" value="J" <?if($visualiza == "J"){print "checked" ;}?>
              OnClick="document.frmMKExp.visualiza.value=this.value;">
              <img name="img_file" align="absmiddle" vspace="0" src="imagens/file_txt_18px.png" style="cursor:pointer;" title="JSON" OnClick="document.frmMKExp.visualiza.value=document.frmMKExp.visualizax[0].value;document.frmMKExp.visualizax[0].checked=true;">
              Formato <span style="font-weight:bold; color:#06F;">(JSON)</span>
            <br>
            <?

    }
?>
      <input type="hidden" name="visualiza" value="" consistir="sempre" tipodado="todos" msg="Selecione corretamente a opção `Tipo Arquivo`.">
      <script>$('input[name=visualiza]').val($('input[name=visualizax]:checked').val());</script>
    </td>
  </tr>

<?
  } else {
    $visualiza = "T";
  }

  if (is_array($param_orderby)) {?>
    <tr>
      <td colspan="2">
        <table <?print $class_table?> width="100%" border="0" cellspacing="0">
          <tr <?print $bgcolor_td_dado3?>>
            <td style='border: 2px dotted <?print $session['td_destaque'];?>;border-bottom:none;border-right:none;padding-left: 5px;' align="left" width="113px"><font class="txt5"><strong>Classificar por:</strong></td>
            <td style='border: 2px dotted <?print $session['td_destaque'];?>;border-bottom:none;border-left:none;' align="left"  ><font class="txt5">
              <select name="cbo_orderby" id="id_cbo_orderby" >
              <option value="" <?if ($cbo_orderby == ""){print " selected";}?>>-- Limpar --</option>;
              <option value="<?print $orderby?>" <?if ($list_order_by == $orderby){print " selected";}?>>Todos</option>;
      <?
              foreach ($param_orderby as $key => $campo) {
                $option_order = explode("¬", $campo);
      ?>
                <option value="<?print $option_order[0]."¬".$option_order[1]." ASC" ?>"><? print $option_order[0]." - Menor/Maior"?></option>;
                <option value="<?print $option_order[0]."¬".$option_order[1]." DESC"?>"><? print $option_order[0]." - Maior/Menor"?></option>;
      <?
              }
      ?>
              </select>
              <img name="img_add" align="absmiddle" vspace="0" src="imagens/ico_add.gif" style="cursor:pointer;" title="Adicionar Classificação" onClick="AddOrderBy(document.getElementById('id_cbo_orderby').value,document.getElementById('id_hid_order'))">
              <img name="img_del" align="absmiddle" vspace="0" src="imagens/ico_del.gif" style="cursor:pointer;" title="Retirar Classificação"   onClick="DelOrderBy(document.getElementById('id_cbo_orderby').value,document.getElementById('id_hid_order'))">
            </td>
          </tr>
          <tr <?print $bgcolor_td_dado3?> >
            <td style='border: 2px dotted <?print $session['td_destaque'];?>;border-top:none;padding-left: 5px;' colspan="2" align="left"><font class="txt5"><font color='blue'><span id="id_lab_order"><?print $lab_order?></span></font></font></td>
          </tr>
          <input type="hidden" name="hid_order"     id="id_hid_order"     value="<?print $hid_order?>">
          <input type="hidden" name="list_order_by" id="id_list_order_by" value="<?print $list_order_by?>">

          <script language="javascript">
            MontaOrderBy('', document.getElementById('id_list_order_by').value);
          </script>
        </table>
      </td>
    </td>
<?}
  if ($relatorio != "excel" && $exportacao != "" &&  strtolower($delimitador_fixo) != "sim" ) {
?>
  <tr <?print $bgcolor_td_dado3?>>
    <td align="left"><font class="txt5"><strong><?print $objTradutor->traduzir("Delimitador");?>:</strong></td>
    <td align="left"  ><font class="txt5">
      <select name="delimitador" OnChange="document.getElementById('id_delimitador').value=this.value;" >
      <?print MontaCombo("EX00L", $delimitador, $session["representante"],"A","ZZ")?>
      </select>
    </td>
  </tr>
<?
  }
if (empty($update_00) === false) {
  $arr_up = explode("¬", $update_00);
  if (empty($RD_update_00) === true) {
    $RD_update_00 = $arr_up[0];
  }
}

if ((empty($update_00) === false) && ($RD_update_00 != "B" && $RD_update_00 != "A")) {
?>
  <tr <?print $bgcolor_td_dado3?>>
    <td align="center" colspan="2">
      <font class="txt5">
        <strong>
          <?print $arr_up[1];?>?
          <br>
          <input type="radio" name="RD_update_00" id="RD_update_00_S" value="S"<?
          if ($RD_update_00 == "S") {
            ?> checked<?
          }
          ?>>
          <label for="RD_update_00_S">Sim</label>
          <input type="radio" name="RD_update_00" id="RD_update_00_N" value="N"<?
          if ($RD_update_00 == "N") {
            ?> checked<?
          }
          ?>>
          <label for="RD_update_00_N">Não</label>
        </strong>
      </font>
    </td>
  </tr>
<?
}
  }
}
?>
</form>
</table>
<?

if ($exportacao != "") {
?>
<br>
<div align="center"><input type="button" name="enviar" value="<?print $objTradutor->traduzir("Pesquisar");?>" onclick="javascript: VerificaForm(this);" class="but_proc_on"></div>
<?
}

print "<span><br><br><br></span>";

if($usa_bootstrap == true){
  ?>
  </div></div>
  <?
}

if ($deondegta != "gerenciador") {
  print GerarRodape("cc_consulta.php?nivel=P");
  if($usa_bootstrap == true){
    ?>
    </div>
    <?
  }
}
?>
</body>
<script language="javascript"  src="/js/mk_exporta_mailling.js"></script>
</html>
<?
}//BATCH

function MontaPrefArq($PrefArq, $dthrRef = "1111-11-11 00:00:00") {
  global $prox_num_seq;

  if (is_valid_date($dthrRef)) {
    $dthrRef = $dthrRef." 00:00:00";
  } elseif (is_valid_time($dthrRef)) {
    $dthrRef = date("Y-m-d")." ".$dthrRef;
  } elseif (is_valid_date_time($dthrRef)) {
    // Não precisa fazer nada
  } else {
    $dthrRef = "1111-11-11 00:00:00";
  }

  if ($dthrRef == "1111-11-11 00:00:00") {
    $objDate = new DateTime();
  } else {
    $objDate = DateTime::createFromFormat("Y-m-d H:i:s", $dthrRef);
  }

  if (preg_match("/\[-([0-9]+[DMY])\]/", $PrefArq, $arr_qtd_dia) == 1) {
    //RETIRA A QUANTIDADE DE DIAS DETERMINADA DO PARÂMETRO TIMESTAMP
    $objDate->sub(new DateInterval("P{$arr_qtd_dia[1]}"));
    $PrefArq = preg_replace("/\[-([0-9]+[DMY])\]/", "", $PrefArq);
  }

  if (preg_match("/\[C([0-9]+D)\]/", $PrefArq, $arr_qtd_dia) == 1) {
    //RETIRA A QUANTIDADE DE DIAS DETERMINADA DO PARÂMETRO TIMESTAMP
    if (intval($objDate->format('d'), 10) > intval($arr_qtd_dia[1], 10)) {
      $objDate->add(new DateInterval("P1M"));
    }
    $PrefArq = preg_replace("/\[C([0-9]+D)\]/", "", $PrefArq);
  }

  $a = array (
    "[dt]"      => $objDate->format("ymd"    ),
    "[DT]"      => $objDate->format("Ymd"    ),

    "[br]"      => $objDate->format("dmy"    ),
    "[BR]"      => $objDate->format("dmY"    ),

    "[hr]"      => $objDate->format("Hi"     ),
    "[HR]"      => $objDate->format("His"    ),

    "[DTHR]"    => $objDate->format("YmdHis" ),
    "[DT_HR]"   => $objDate->format("Ymd_His"),

    "[BRHR]"    => $objDate->format("dmYHis" ),
    "[BR_HR]"   => $objDate->format("dmY_His"),

    "[dthr]"    => $objDate->format("ymdHi"  ),
    "[dt_hr]"   => $objDate->format("ymd_Hi" ),

    "[brhr]"    => $objDate->format("dmyHi"  ),
    "[br_hr]"   => $objDate->format("dmy_Hi" ),

    "[DThr]"    => $objDate->format("YmdHi"  ),
    "[DT_hr]"   => $objDate->format("Ymd_Hi" ),

    "[BRhr]"    => $objDate->format("dmYHi"  ),
    "[BR_hr]"   => $objDate->format("dmY_Hi" ),

    "[dtHR]"    => $objDate->format("ymdHis" ),
    "[dt_HR]"   => $objDate->format("ymd_His"),

    "[brHR]"    => $objDate->format("dmyHis" ),
    "[br_HR]"   => $objDate->format("dmy_His"),

    "[dd]"      => $objDate->format("d"),
    "[mm]"      => $objDate->format("m"),
    "[y]"       => substr($objDate->format("y"), -1),
    "[yy]"      => $objDate->format("y"),
    "[yyyy]"    => $objDate->format("Y"),

    "[hh]"      => $objDate->format("H"),
    "[nn]"      => $objDate->format("i"),
    "[ss]"      => $objDate->format("s"),
    "[z]"       => substr(getMili(), 0, 1),
    "[zz]"      => substr(getMili(), 0, 2),
    "[zzz]"     => substr(getMili(), 0, 3),

    "[x]"       => $prox_num_seq,
    "[xx]"      => str_pad($prox_num_seq, 2, "0", STR_PAD_LEFT),
    "[xxx]"     => str_pad($prox_num_seq, 3, "0", STR_PAD_LEFT),
    "[xxxx]"    => str_pad($prox_num_seq, 4, "0", STR_PAD_LEFT),
    "[xxxxx]"   => str_pad($prox_num_seq, 5, "0", STR_PAD_LEFT),

    "[DTHR15]"  => formatRoundMinutes($objDate, 15, "YmdHis" ),
    "[DTHR30]"  => formatRoundMinutes($objDate, 30, "YmdHis" ),
    "[DTHR60]"  => formatRoundMinutes($objDate, 60, "YmdHis" ),
    "[DT_HR15]" => formatRoundMinutes($objDate, 15, "Ymd_His"),
    "[DT_HR30]" => formatRoundMinutes($objDate, 30, "Ymd_His"),
    "[DT_HR60]" => formatRoundMinutes($objDate, 60, "Ymd_His"),

    "[dthr15]"  => formatRoundMinutes($objDate, 15, "ymdHi" ),
    "[dthr30]"  => formatRoundMinutes($objDate, 30, "ymdHi" ),
    "[dthr60]"  => formatRoundMinutes($objDate, 60, "ymdHi" ),
    "[dt_hr15]" => formatRoundMinutes($objDate, 15, "ymd_Hi"),
    "[dt_hr30]" => formatRoundMinutes($objDate, 30, "ymd_Hi"),
    "[dt_hr60]" => formatRoundMinutes($objDate, 60, "ymd_Hi"),

    "[DThr15]"  => formatRoundMinutes($objDate, 15, "YmdHi" ),
    "[DThr30]"  => formatRoundMinutes($objDate, 30, "YmdHi" ),
    "[DThr60]"  => formatRoundMinutes($objDate, 60, "YmdHi" ),
    "[DT_hr15]" => formatRoundMinutes($objDate, 15, "Ymd_Hi"),
    "[DT_hr30]" => formatRoundMinutes($objDate, 30, "Ymd_Hi"),
    "[DT_hr60]" => formatRoundMinutes($objDate, 60, "Ymd_Hi"),

    "[dtHR15]"  => formatRoundMinutes($objDate, 15, "ymdHis" ),
    "[dtHR30]"  => formatRoundMinutes($objDate, 30, "ymdHis" ),
    "[dtHR60]"  => formatRoundMinutes($objDate, 60, "ymdHis" ),
    "[dt_HR15]" => formatRoundMinutes($objDate, 15, "ymd_His"),
    "[dt_HR30]" => formatRoundMinutes($objDate, 30, "ymd_His"),
    "[dt_HR60]" => formatRoundMinutes($objDate, 60, "ymd_His"),

    "[BRHR15]"  => formatRoundMinutes($objDate, 15, "dmYHis" ),
    "[BRHR30]"  => formatRoundMinutes($objDate, 30, "dmYHis" ),
    "[BRHR60]"  => formatRoundMinutes($objDate, 60, "dmYHis" ),
    "[BR_HR15]" => formatRoundMinutes($objDate, 15, "dmY_His"),
    "[BR_HR30]" => formatRoundMinutes($objDate, 30, "dmY_His"),
    "[BR_HR60]" => formatRoundMinutes($objDate, 60, "dmY_His"),

    "[brhr15]"  => formatRoundMinutes($objDate, 15, "dmyHi" ),
    "[brhr30]"  => formatRoundMinutes($objDate, 30, "dmyHi" ),
    "[brhr60]"  => formatRoundMinutes($objDate, 60, "dmyHi" ),
    "[br_hr15]" => formatRoundMinutes($objDate, 15, "dmy_Hi"),
    "[br_hr30]" => formatRoundMinutes($objDate, 30, "dmy_Hi"),
    "[br_hr60]" => formatRoundMinutes($objDate, 60, "dmy_Hi"),

    "[BRhr15]"  => formatRoundMinutes($objDate, 15, "dmYHi" ),
    "[BRhr30]"  => formatRoundMinutes($objDate, 30, "dmYHi" ),
    "[BRhr60]"  => formatRoundMinutes($objDate, 60, "dmYHi" ),
    "[BR_hr15]" => formatRoundMinutes($objDate, 15, "dmY_Hi"),
    "[BR_hr30]" => formatRoundMinutes($objDate, 30, "dmY_Hi"),
    "[BR_hr60]" => formatRoundMinutes($objDate, 60, "dmY_Hi"),

    "[brHR15]"  => formatRoundMinutes($objDate, 15, "dmyHis" ),
    "[brHR30]"  => formatRoundMinutes($objDate, 30, "dmyHis" ),
    "[brHR60]"  => formatRoundMinutes($objDate, 60, "dmyHis" ),
    "[br_HR15]" => formatRoundMinutes($objDate, 15, "dmy_His"),
    "[br_HR30]" => formatRoundMinutes($objDate, 30, "dmy_His"),
    "[br_HR60]" => formatRoundMinutes($objDate, 60, "dmy_His"),

    "[hr15]"    => formatRoundMinutes($objDate, 15, "Hi"),
    "[hr30]"    => formatRoundMinutes($objDate, 30, "Hi"),
    "[hr60]"    => formatRoundMinutes($objDate, 60, "Hi"),

    "[HR15]"    => formatRoundMinutes($objDate, 15, "His"),
    "[HR30]"    => formatRoundMinutes($objDate, 30, "His"),
    "[HR60]"    => formatRoundMinutes($objDate, 60, "His"),
  );

  $PrefArq = str_replace(array_keys($a), array_values($a), $PrefArq);

  return $PrefArq;
}

function formatRoundMinutes($objDtHr, $minutos, $fmt) {
  return date_format(DateTime::createFromFormat("Y-m-d H:i:s", RoundMinutes($objDtHr->format("Y-m-d H:i:s"), $minutos)), $fmt);
}

function percent_carlos($parcial, $total, $sub){

  if ($parcial == 0) {return 0;}
  if ($total   == 0) {return 0;}
  $sub = str_replace("-","",$sub);
  if ($sub     == "") {$sub = 0;}

  $div = ($parcial / $total)-$sub;

  $aux = $div * 100;
  $percent = round ($aux, 1);
  $ix = strpos ($percent, ".");
  $result = substr ($percent, 0, $ix + 2);
  if ((int) $ix == 0) {$result = $percent . '.0';}
  return $result;
}

function is_valid_date_carlos($date){
  if(substr_count($date, "-") != 2){
    return false;
  }

  $m_date = explode("-", $date);
  if(strlen($m_date[0]) != 4 || strlen($m_date[1]) != 2 || strlen($m_date[2]) != 2){
    return false;
  }

  if(!Valida::SoNumeros($m_date[0]) || !Valida::SoNumeros($m_date[1]) || !Valida::SoNumeros($m_date[2])) {
    return false;
  }

  return true;
}

function EnviaFTP($arrdadosftp) {
  $data_agora = date("Y-m-d");
  $hora_agora = date("H:i:s");

  $arrins['mk_flag'                ] = $arrdadosftp['mk_flag'                ];
  $arrins['mk_numero'              ] = $arrdadosftp['cod_discador'           ];

  $arrins['tamanho'                ] = $arrdadosftp['tamanho'                ];
  $arrins['programa'               ] = $arrdadosftp['programa'               ];
  $arrins['pref_arq'               ] = $arrdadosftp['pref_arq'               ];

  $arrins['empresa'                ] = $arrdadosftp['empresa'                ];
  $arrins['representante'          ] = $arrdadosftp['representante'          ];
  $arrins['data_cri'               ] = $data_agora;
  $arrins['hora_cri'               ] = $hora_agora;
  $arrins['data_agenda'            ] = $data_agora;
  $arrins['hora_agenda'            ] = $hora_agora;
  $arrins['tipo_processo'          ] = "MOV";

  $arrins['nome_arq'               ] = $arrdadosftp['param_arquivo'];

  if (trim($arrdadosftp['param_arquivo_cli']) != "") {
    $arrins['nome_arq_env'] = $arrdadosftp['param_arquivo_cli'];
  } else {
    $arrins['nome_arq_env'] = $arrdadosftp['param_arquivo'];
  }

  if ($arrdadosftp["status"] == null) {
    $arrins["status"] = "M";
    $arrins["data_prox_tentativa"] = $arrins["data_agenda"]." ".$arrins["hora_agenda"];
  } else {
    $arrins["status"] = $arrdadosftp["status"];
    //Agenda para mais tarde para o robo de retry tentar novamente
    $arrins["data_prox_tentativa"] = datetime_addSecs($arrins["data_agenda"]." ".$arrins["hora_agenda"], $arrdadosftp["ftp_intervalo_tentativa"] * 60);

    $MsgErro = " - Falha no envio ao FTP (".$arrdadosftp["msg_erro"].").";
  }

  $arrins["ocorrencia"] = "[".brDate($data_agora)." ".$hora_agora."] -> MkExportaMailing St: (".$arrins['status'].") e TpProc: (MOV)".$MsgErro."\r\n";

  $arrins["ftp_host"           ] = $arrdadosftp["ftp_host"               ];
  $arrins["ftp_porta"          ] = $arrdadosftp["ftp_porta"              ];
  $arrins["ftp_user"           ] = $arrdadosftp["ftp_user"               ];
  $arrins["ftp_pass"           ] = $arrdadosftp["ftp_pass"               ];
  $arrins["ftp_dir"            ] = $arrdadosftp["ftp_dir"                ];
  $arrins["ftp_passive"        ] = $arrdadosftp["ftp_passive"            ];
  $arrins["max_tentativa"      ] = $arrdadosftp["ftp_max_tentativa"      ];
  $arrins["intervalo_tentativa"] = $arrdadosftp["ftp_intervalo_tentativa"];
  $arrins["ftp_protocolo"      ] = $arrdadosftp["ftp_protocolo"          ];
  $arrins["ftp_encriptacao"    ] = $arrdadosftp["ftp_encriptacao"        ];
  $arrins["ftp_versao_ssl"     ] = $arrdadosftp["ftp_versao_ssl"         ];

  require_once($_SERVER["DOCUMENT_ROOT"]."/libs/bd/ConexaoSistema.php");
  $conSis = new ConexaoSistema();
  $conSis->ExecInsert($arrins, "tb_arq_ftp");

  if ($conSis->status === false) {
    print "Erro ao inserir a tb_arq_ftp. Msg: [".$conSis->getDescRetorno()."]\n";
    exit;
  }

  $lastId = $conSis->last_id();

  if ($arrdadosftp["ftp_replicar"] > "") {

    $ret = getParamCadFTP($arrdadosftp["ftp_replicar"]);

    $arrins["seq_principal"] = $lastId;
    $arrins["status"       ] = "N";
    $arrins["tipo_processo"] = "ENV";
    $arrins["ocorrencia"   ] = "[".brDate($data_agora)." ".$hora_agora."] -> MkExportaMailing St: (".$arrins['status'].")\r\n";

    foreach ((array) $ret as $itemFTP) {
      $arrins["ftp_host"           ] = $itemFTP["ftp_host"               ];
      $arrins["ftp_porta"          ] = $itemFTP["ftp_porta"              ];
      $arrins["ftp_user"           ] = $itemFTP["ftp_user"               ];
      $arrins["ftp_pass"           ] = $itemFTP["ftp_pass"               ];
      $arrins["ftp_dir"            ] = $itemFTP["ftp_dir"                ];
      $arrins["ftp_passive"        ] = $itemFTP["ftp_passive"            ];
      $arrins["max_tentativa"      ] = $itemFTP["ftp_max_tentativa"      ];
      $arrins["intervalo_tentativa"] = $itemFTP["ftp_intervalo_tentativa"];
      $arrins["ftp_protocolo"      ] = $itemFTP["ftp_protocolo"          ];
      $arrins["ftp_encriptacao"    ] = $itemFTP["ftp_encriptacao"        ];
      $arrins["ftp_versao_ssl"     ] = $itemFTP["ftp_versao_ssl"         ];
      $arrins["seq_cad_ftp"        ] = $itemFTP["seq"                    ];

      $conSis->execInsert($arrins, "tb_arq_ftp");
    }
  }

  return $lastId;
}

function FormataTipoDate($data, $formato) {
  if (!is_valid_date($data)) {
    return $data;
  }

  if ($formato == "dd/mm/YYYY") {
    $ret = BRDate($data);
  } elseif ($formato == "ddmmYYYY") {
    $ret = str_replace("/", "", BRDate($data));
  } elseif ($formato == "dd/mm/YY") {
    $data = BRDate($data);
    $ret  = substr($data, 0, 6).substr($data, 8, 2);
  } elseif ($formato == "ddmmYY") {
    $data = BRDate($data);
    $ret  = substr($data, 0, 6).substr($data, 8, 2);
    $ret  = str_replace("/", "", $ret);
  } elseif ($formato == "YYYYmmdd") {
    $ret = str_replace("-", "", $data);
  } elseif ($formato == "dd.mm.YYYY") {
    $ret = str_replace("/", ".", BRDate($data));
  } else {
    $ret = $data;
  }

  return $ret;
}

function ValorClassePosicional($st_vda, $cod_rec, $repre, $classes) {
  $clas_arr = explode(";", $classes);
  if ($cod_rec && $clas_arr[$st_vda]) {
    return ValorClasse($clas_arr[$st_vda], $cod_rec, $repre);
  } else {
    return "-";
  }
}

function calculaValorVar($tipo, $expressao) {
  global $arrRpl;

  foreach($arrRpl as $var => $valor) {
    $expressao = str_ireplace($var, $valor, $expressao);
  }

  if (strtoupper($tipo) == "FIXO") {
    return $expressao;
  } elseif (strtoupper($tipo) == "FUNCAO") {
    return eval("return ".$expressao.";");
  } else {
    return "erro";
  }
}

function execFuncao($strFuncao, $rec = null) {
  $strFuncao = trim($strFuncao);

  $funcNome   = substr($strFuncao, 0, strpos($strFuncao, "("));
  $funcParams = substr($strFuncao, (strpos($strFuncao, "(") + 1), -1);

  $arrParams  = explode($GLOBALS["separador_func"], $funcParams);
  $arrParTrat = array();

  $rpl = array(
    "var_dt_agora"    => $GLOBALS["dt_agora"],
    "var_hr_agora"    => $GLOBALS["hr_agora"],
    "var_dthr_agora"  => $GLOBALS["dthr_agora"],
    "[MK_FLAG]"       => substr($GLOBALS["discador_modelo"], 0, 2),
    "[MK_NUMERO]"     => $GLOBALS["nromodelo"],
    "[CLASSE_MKPRO]"  => $GLOBALS["discador_modelo"],
    "[CBO_REPRE]"     => $GLOBALS["repre"],
    "[SESSION_REPRE]" => $_SESSION["session"]["representante"],
  );

  $rpl = array_merge($rpl, (array) $GLOBALS["arrRpl"]);


  foreach ($arrParams as $i => $strParam) {

    if (!$pTrat = $rpl[$strParam]) {
      $strParam = str_ireplace(array_keys($rpl), array_values($rpl), $strParam);

      $posAS = strpos(strtoupper($strParam), " AS ");
      if ($posAS !== false) {
        $strParam = substr($strParam, $posAS + 4);
      }

      if (substr($strParam, 0, 3) == "(F)") {
        $aux_traco = str_replace("(T)", "-", $strParam);
        $pTrat     = str_replace("(F)", "", $aux_traco);
        $pTrat     = str_replace("(F", "", $pTrat);
      } elseif ($rec === NULL) {
        $pTrat = $strParam;
      } else {
        $tmp_pos = strpos(strtoupper($strParam), ") AS ");

        $strParam = str_replace("(F)", "'", $strParam);
        $strParam = str_replace("(A)", "'", $strParam);
        if ($strParam == "[REC]") {
          $pTrat = $rec;
        } elseif ($tmp_pos === false) {
          $pTrat = $rec[$strParam];
        } else {
          $pTrat = $rec[substr($strParam, ($tmp_pos + 6))];
        }
        unset($tmp_pos);
      }

      if (is_string($pTrat)) {
        if (substr($pTrat, 2, 2) == "__") {
          $pTrat = str_replace("__", $GLOBALS["nromodelo"], $pTrat);
        } elseif (substr($pTrat, 3, 2) == "__" && $GLOBALS["mailing_pesquisa"] && $GLOBALS["cod_pesquisa"]) {
          $pTrat = str_replace("__", $GLOBALS["cod_pesquisa"], $pTrat);
        }
      }

    }

    $arrParTrat[$i] = $pTrat;
  }

  if(function_exists($funcNome)){
    return call_user_func_array($funcNome, $arrParTrat);
  }else{
    return "FNE(".$funcNome.")";
  }
}

// Remover esta função daqui
function arrayToOptions($arr, $selected) {
  if (!is_array($arr)) {
    $arr = array($arr);
  }

  if (!is_array($selected)) {
    $selected = array($selected);
  }

  if (count((array)$arr) == 0) {
    return "<option value=''> -- Sem itens -- </option>";
  }

  $ret = "<option value=''> -- Selecione -- </option>";
  foreach ($arr as $i => $val) {
    $v = $val["v"];
    $d = $val["d"];
    $s = (in_array(strtoupper($v), $selected))? " selected " : "";

    $ret .= "<option value='{$v}'{$s}>{$d}</option>";
  }

  return $ret;
}

?>