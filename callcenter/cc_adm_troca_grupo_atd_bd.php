<?
if(!$_GET["ramal"]) {
  session_start();
  session_register("session");
  include "cc_libcallcenter.php";
  if (!isset($session)) {header ("Location:cc_login.php"); exit;}

} else {
  include "cc_libcallcenter.php";
  $connectRamal = ConnectRAMAL();

  $q = "SELECT ramal, tipo_ramal, sala, posicao, andar, login_operador, equipe, atende_admin, empresa, nome_resumido, status_pa_ramal, hora_atu, tp_user, status_dac,".
       "servico_dac, atende, qtd_lig, tempo_tot_lig, hora_trabalho, grupo_atende, representante, status_pausa, hora_ini_mute, hora_fim_mute, dac_ip, dac_porta,ip_remoto ".
       "FROM tb_ramal WHERE ramal = '".$_GET["ramal"]."' ";

	$query = DescExecQuery($q,$connectRamal,"N");
  if($rec = mysql_fetch_assoc($query)) {
    $dados_ramal[$_GET["ramal"]] = $rec;
  }
  $grupo_enviar = $_GET["grupo_urafi"];
  $ramal_atd[0] = $_GET["ramal"];
}
$connect = ConnectDB();

if(!$tipo_aloca) {
  $tipo_aloca = "B";
}

if(is_array($ramal_atd)) {
  require_once($_SERVER['DOCUMENT_ROOT']."/callcenter/funcoes/RotinasBD.php");
  require_once($_SERVER['DOCUMENT_ROOT']."/callcenter/funcoes/Login.php");
  $connectRamal = ConnectRAMAL();
  $connCall     = new ConexaoCallCenter();

  foreach ($ramal_atd as $chave => $valor) {
    $arrayGrupos = $grupo_enviar;
    if(is_array($arrayGrupos)) {
      foreach($arrayGrupos as $keys => $grupos_new){




        if(strpos($dados_ramal[$valor]["atende"], $grupos_new) === false) {

          $gr = $grupos_new;
          if(substr($gr,-1) == "P"){
		        $gr = substr($gr, 0, -1);
		      }

          $repre_admin_repre = $dados_ramal[$valor]["representante"];
          
          $arr_ins = array(
            "login" => $dados_ramal[$valor]["login_operador"],
            "grupo" => $gr,
            "representante" => $repre_admin_repre,
            "grupo_atende" => "REC",
            "equipe" => $dados_ramal[$valor]["equipe"],
            "data_atualiza" => date("Y-m-d"),
            "hora_atualiza" => date("H:i:s"),
          );

          $arr_upd = array(
            "representante" => $repre_admin_repre,
            "grupo_atende" => "REC",
            "equipe" => $dados_ramal[$valor]["equipe"],
            "data_atualiza" => date("Y-m-d"),
            "hora_atualiza" => date("H:i:s"),
          );
          
          if($repre_admin_repre){
            $connCall->execInsDupUp($arr_ins, "tbadmin_repre", $arr_upd);
            if ($connCall->status === false) {
              print "Rotina Ponto Break Pausa<br>[".__FUNCTION__."] ".$connCall->getDescRetorno();
              unset($connCall);
              exit;
            }
          }

          $usa_dac                       = "S";
          $tipo_msg_dac                  = "Change_Grupo";
          $ip_dac                        = $dados_ramal[$valor]["dac_ip"        ];
          $porta_dac                     = $dados_ramal[$valor]["dac_porta"     ];
          $ramal_dac                     = $dados_ramal[$valor]["ramal"         ];
          $msg_dac_ss_usuario            = NomeResumido($dados_ramal[$valor]["login_operador"]);
          $msg_dac_ss_representante      = $dados_ramal[$valor]["empresa"       ];
          $msg_dac_ss_origem             = $dados_ramal[$valor]["representante" ];
          $msg_dac_ss_operador           = $dados_ramal[$valor]["login_operador"];
          $msg_dac_ss_usa_predictive     = false;
          $dados_ramal[$valor]["atende"] = $dados_ramal[$valor]["atende"].$grupos_new."|";
          $msg_dac_ss_discador_atende    = $dados_ramal[$valor]["atende"];

          //print "<li>***usa_dac = ".$usa_dac;
          //print "<li>***tipo_msg_dac = ".$tipo_msg_dac;
          //print "<li>***ip_dac = ".$ip_dac;
          //print "<li>***porta_dac                  = ".$porta_dac;
          //print "<li>***ramal_dac                  = ".$ramal_dac;
          //print "<li>***msg_dac_ss_usuario         = ".$msg_dac_ss_usuario;
          //print "<li>***msg_dac_ss_representante   = ".$msg_dac_ss_representante;
          //print "<li>***msg_dac_ss_origem          = ".$msg_dac_ss_origem;
          //print "<li>***msg_dac_ss_operador        = ".$msg_dac_ss_operador;
          //print "<li>***msg_dac_ss_usa_predictive  = ".$msg_dac_ss_usa_predictive;
          //print "<li>***dados_ramal[valor][atende] = ".$dados_ramal[$valor]["atende"];
          //print "<li>***msg_dac_ss_discador_atende = ".$msg_dac_ss_discador_atende;

          //UPDATE TB_RAMAL
          $matriz_up_ramal["atende"]  = $dados_ramal[$valor]["atende"];
          $where  = " WHERE ramal = '".addslashes($dados_ramal[$valor]["ramal"])."' ";
          $msg_ok = FazUpdate($matriz_up_ramal,"tb_ramal",$where,$connectRamal);

          //UPDATE TB_RAMAL_DAC
          $matriz_up_ramal_dac["grupos"]  = "(INT)concat(grupos,' ','".$grupos_new."') (INT)";
          $where  = " WHERE dac_ip = '".addslashes($dados_ramal[$valor]["dac_ip"])."' AND dac_porta = '".addslashes($dados_ramal[$valor]["dac_porta"])."' AND ramal = '".addslashes($dados_ramal[$valor]["ramal"])."' ";
          $msg_ok = FazUpdate($matriz_up_ramal_dac,"tb_ramal_dac",$where,$connectRamal);

          $deonde = "ATUALIZA_GRUPO_ATD";

          if ($_SESSION["ambiente"] != "teste") {
            require($_SERVER["DOCUMENT_ROOT"]."/callcenter/cc_message_dac.php");
          } else {
            $retorno = "|XXXXXXX|Ok|";
          }

          $dados_retorno = explode("|",$retorno);

          if($dados_retorno[2] == "Ok") {
            //UPDATE TB_PONTO_LOG
            $where_ponto = "WHERE representante = '".addslashes($dados_ramal[$valor]["representante"])."' AND data = '".date("Y-m-d")."' AND login = '".addslashes($dados_ramal[$valor]["login_operador"])."' ";
            $sql_ponto   = "SELECT count(*) as total FROM tb_ponto_log_".date("ym")." ".$where_ponto." AND tipo = 'P2'";
            $query_ponto = DescExecQuery($sql_ponto,$connect,"N");
            $rec_ponto   = mysql_fetch_assoc($query_ponto);

            $matriz_pronto["atende_escolheu"]  = "(INT)concat(atende_escolheu,'','".$grupos_new."|') (INT)";

            if($rec_ponto["total"] > 0) {
              $where_ponto .= " AND tipo = 'P2' ";
            } else {
              $where_ponto .= " AND tipo = 'P1' ";
            }
            $msg_ponto = FazUpdate($matriz_pronto,"tb_ponto_log_".date("ym"),$where_ponto,$connect);

            require_once($_SERVER['DOCUMENT_ROOT']."/libs/pst/PontoPST.php");
            PontoPST::setEventoPontoLog(date("Y-m-d"), $dados_ramal[$valor]["representante"], $dados_ramal[$valor]["login_operador"], $dados_ramal[$valor]["nome_resumido"], "CG", $dados_ramal[$valor]["ramal"], "Mudança Grupo ( Incluir Grupo " . $grupos_new . ")", $matriz_up_ramal["atende"], $dados_ramal[$valor]["atende_admin"], date("H:i:s"), date("H:i:s"), "0", $dados_ramal[$valor]["equipe"]);

            //UPDATE ADMIN
            //$matrizOpeAtualizadosAdmin.= $dados_ramal[$valor]["login_operador"];
            $where_admin = "WHERE login = '".$dados_ramal[$valor]["login_operador"]."'";

            $matriz_atu_admin["leu_headline_grupos_liberados"  ]  = "S";
            $matriz_atu_admin["headline_grupos_liberados"      ]  = "(INT)concat(headline_grupos_liberados,'','¢".$grupos_new."¢') (INT)";
            $matriz_atu_admin["headline_grupos_liberados_dia"  ]  = "";
            if($tipo_aloca == "D") {
              $matriz_atu_admin["headline_grupos_liberados_dia"]  = "(INT)concat(headline_grupos_liberados_dia,'','¢".$grupos_new."¢') (INT)";
              $matriz_atu_admin["data_valid_grupo_liberado"    ]  = date("Y-m-d");
            } elseif($tipo_aloca == "T") {
              $matriz_atu_admin["headline_grupos_liberados_dia"]  = "(INT)concat(headline_grupos_liberados_dia,'','¢".$grupos_new."¢') (INT)";
              $matriz_atu_admin["data_valid_grupo_liberado"    ]  = date("Y-m-d");
              $matriz_atu_admin["atende"                       ]  = "(INT)concat(atende,'','".str_replace("¢¢",",",str_replace("P","",$grupos_new)).",') (INT)";
            }
            $msg_admin = FazUpdate($matriz_atu_admin,"tbadmin",$where_admin,$connect);
            setLogAtualizacaoLogin($dados_ramal[$valor]["login_operador"], "LGA");
            require_once("/libs/ctr/AlarmeCTR.php");
            AlarmeCTR::setAlarmeIntegrAll($dados_ramal[$valor]["login_operador"]," <font color='red'><strong>ATENÇÃO GRUPO:</strong></font> (".$grupos_new.") ".ValorClasse("GRATE",substr($grupos_new,0,-1),$dados_ramal[$valor]["representante"])." disponibilizado para atendimento!","N");
            //print "<li>MSGADMIN:".$msg_admin;

          } else {
            //VOLTAR UPDATE TB_RAMAL
            $matriz_up_ramal["atende"]  = "(INT)REPLACE(atende,'".$grupos_new."|','')(INT)";
            $where  = " WHERE ramal = '".addslashes($dados_ramal[$valor]["ramal"])."' ";
            $msg_ok = FazUpdate($matriz_up_ramal,"tb_ramal",$where,$connectRamal);

            //VOLTAR UPDATE TB_RAMAL_DAC
            $matriz_up_ramal_dac["grupos"]  = "(INT)REPLACE(grupos,' ".$grupos_new."','')(INT)";
            $where  = " WHERE dac_ip = '".addslashes($dados_ramal[$valor]["dac_ip"])."' AND dac_porta = '".addslashes($dados_ramal[$valor]["dac_porta"])."' AND ramal = '".addslashes($dados_ramal[$valor]["ramal"])."' ";
            $msg_ok = FazUpdate($matriz_up_ramal_dac,"tb_ramal_dac",$where,$connectRamal);

            $msg_ok = $dados_retorno[3];
          }
        } else {
          if($_GET["ramal"]) {
            print "<br>Ramal já esta no Grupo => ".$grupos_new."<br>";
          }
          $msg_ok = "OK";
        }
      }
    }

  }
} else {
  $msg_ok = "Nenhum Usuário Selecionado!";
}

if($msg_ok == "OK"){
	$msg = "Alteração Realizada com Sucesso!";
} else {
  $msg = $msg_ok;
}

if($_GET["ramal"] || strtoupper($session["operador"]) == "RE002806") {
  print "<br>SQL RAMAL => ".$q;
  print "<br>DADOS RAMAL:<pre>";
  print_r($dados_ramal);
  print "</pre>";

  print "<br>usa_dac=".$usa_dac;
  print "<br>tipo_msg_dac=".$tipo_msg_dac;
  print "<br>ip_dac=".$ip_dac;
  print "<br>porta_dac=".$porta_dac;
  print "<br>ramal_dac=".$ramal_dac;
  print "<br>msg_dac_ss_usuario=".$msg_dac_ss_usuario;
  print "<br>msg_dac_ss_representante=".$msg_dac_ss_representante;
  print "<br>msg_dac_ss_origem=".$msg_dac_ss_origem;
  print "<br>msg_dac_ss_operador=".$msg_dac_ss_operador;
  print "<br>msg_dac_ss_usa_predictive=".$msg_dac_ss_usa_predictive;
  print "<br>msg_dac_ss_discador_atende=".$msg_dac_ss_discador_atende;
  print "<br>";
  var_dump($retorno);
  exit();
}



?>
<form name="form_volta" id="form_volta" action="cc_adm_troca_grupo_atd.php" method="POST">
  <input type="hidden" name="msg"    value="<?print $msg   ?>" />
  <input type="hidden" name="msg_ok" value="<?print $msg_ok?>" />
  <input type="hidden" name="repre"  value="<?print $_POST["repre"]?>"/>

  <?
  if ($painel_operacional_novo == "S") {
  ?>
  <input type="hidden" name="painel_operacional_novo" value="<?print $painel_operacional_novo?>" />
  <input type="hidden" name="tipo_popup" value="<?print $tipo_popup?>" />
  <input type="hidden" name="operador" value="<?print $operador?>" />

  <?
  }
  ?>



</form>
<script type="text/javascript">document.form_volta.submit();</script>