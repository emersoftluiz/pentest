<?php
if($gambi_ajax_md !== true){
session_start();
session_register("session");
}
include "cc_libcallcenter.php";
if($gambi_ajax_md !== true){
if (!isset($session)) {header ("Location:".HTTPHOST.DOCROOT."cc_login.php"); exit;}
}

unset($_SESSION["ssitgl_voltou_mk_".$nro_sistema]);
// print "<pre>";
// var_dump($_REQUEST);

$GLOBALS["ramal_atend"] = $_REQUEST["ramal_atend"];

if (empty($GLOBALS["ramal_atend"]) === true) {
	$GLOBALS["ramal_atend"] = $session["ramal"];
}

require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/func/ValidaVersao.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/cli/HondaErrorHandler.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/func/LogPassoaPasso.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/bd/Conexao.php");
require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/func/ValidaVersao.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/md_funcoes.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/mk_funcoes.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/RotinasBD.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/ScriptInteligente.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/libs/ctr/RamalWeb.php");

$campo_mk_origem = "";
$vlr_mk_origem = "";



$ctrl_duplicidade = true;
//**************************************************************************
//**************************************************************************
//ROTINA QUE DECODA OS DADOS VINDOS PELO AJAX,APENAS QUANDO O BD FOR AJAX***
//**************************************************************************
//**************************************************************************

if ($mk_form_veio_ajax == "SIM") {
	foreach ($_REQUEST as $nome_campo_aux=>$value_campo_aux){
		if(is_array($value_campo_aux)){
			$_REQUEST[$nome_campo_aux]  = array_map("utf8_decode",$value_campo_aux);
			$$nome_campo_aux  = array_map("utf8_decode",$value_campo_aux);
		}else{
			$_REQUEST[$nome_campo_aux]  = utf8_decode($value_campo_aux);
			$$nome_campo_aux  = utf8_decode($value_campo_aux);

		}
	}
	foreach ($_POST as $nome_campo_aux=>$value_campo_aux){
		if(is_array($value_campo_aux)){
			$_POST[$nome_campo_aux]  =  array_map("utf8_decode",$value_campo_aux);
		}else{
			$_POST[$nome_campo_aux]  = utf8_decode($value_campo_aux);
		}

	}
	foreach ($_GET as $nome_campo_aux=>$value_campo_aux){
		if(is_array($value_campo_aux)){
			$_GET[$nome_campo_aux]  =  array_map("utf8_decode",$value_campo_aux);
		}else{
			$_GET[$nome_campo_aux]  = utf8_decode($value_campo_aux);
		}
	}
}
//**************************************************************************
//**************************************************************************
//**************************************************************************
//**************************************************************************
if (is_array($_SESSION["ssitgl_grupo_atende"]) === true) {
	foreach ($_SESSION["ssitgl_grupo_atende"] as $key => $value) {
		if(substr($value,0,1) == "H") {
		  $_SESSION["ssitgl_voltou_mk_".$nro_modelo] = false;
		}
	}
}

if(substr($session["representante"],0,6) == "ZURICH") {
  $_SESSION["ssitgl_voltou_mk_".$nro_modelo] = false;
}

if(substr($session["representante"],0,6) == "QSAUDE-128") {
  $_SESSION["ssitgl_voltou_mk_".$nro_modelo] = false;
}

if ($formulario_externo == 'S' ) {
	$_SESSION["ssitgl_voltou_mk_".$nro_modelo] = false;
}
if ($nro_modelo == 'DD') {
	$_SESSION["ssitgl_voltou_mk_".$nro_modelo] = false;
}

if (($sistema_identificacao == "teste" && (substr($session["representante"],0,3) == 'BMC' ||  $nro_modelo == "C0" ||  $nro_modelo == "TU")) || strtoupper($session["operador"]) == "OPETECACI") {
	$_SESSION["ssitgl_voltou_mk_".$nro_modelo] = false;
}

if($_SESSION["ssitgl_voltou_mk_".$nro_modelo] === true && $dk_campo_chave == ""){
  if($nro_modelo == "7W" && substr($session["representante"], 0, 12) == "ES-VITALDENT"){
    $_SESSION["ssitgl_voltou_mk_" . $nro_modelo] = false;
    print "<script language='JavaScript'>parent.location.reload();</script>";
    exit;
  }else{
	  if($sistema_identificacao != "teste" && strtoupper($session["operador"]) != "TFARTHUR"){
		print "<font class='txtvermelho2'>NÃO UTILIZE O BOTÃO VOLTAR DO BROWSER</font>";
		exit;
	  }
  }
}

//**************************************************
//carrega parametros como BD,TABELA etc...
//**************************************************
carregaParametros1($repre_param);

//INI-FACILITAR A VERIFICAÇÃO DOS PARÂMETROS DE IDENTIFICAÇÃO DO ATENDIMENTO

//VERIFICA SE O NÚMERO DO PEDIDO DEVE SER GERADO NO INÍCIO DO ATENDIMENTO
$isGeraPedido = (strpos("¢{$selecao_receptivo}¢", "¢gera_pedido¢") !== false);
//VERIFICA SE O MODELO UTILIZA REGISTRO DE ATENDIMENTO
$isRegAtd = ((empty($botao_finaliza_cliente) === false) && (substr($botao_finaliza_cliente, 0, 1) == "A"));
//IDENTIFICA A LIGAÇÃO POR SINCRONISMO COM O DAC
$isLigSinc = (strpos("¢{$selecao_receptivo}¢", "¢r_lig_sinc¢") !== false);
//PEDIDO PODE SER GERADO NO INÍCIO DA LIGAÇÃO
$isGeraPreAtd = (strpos("¢{$selecao_receptivo}¢", "¢pre_atd¢") !== false);
//VERIFICA SE O NÚMERO DO PEDIDO PODE SER GERADO NA URA
$isUraGeraProtocolo = (strpos("¢{$selecao_receptivo}¢", "¢ura_gera_protocolo¢") !== false);

//FIM-FACILITAR A VERIFICAÇÃO DOS PARÂMETROS DE IDENTIFICAÇÃO DO ATENDIMENTO

//VERIFICA SE O REGISTRO É SOMENTE DA LIGAÇÃO
$isRegAtdLig = (($isRegAtd === true) && ($atv_st_venda_cartao == "3"));

//**************************************************
$mkParam = carregaArrParam('MD'.$nro_modelo, $repre_param);


if ($observacao_rec_especial == "S") {
	$GLOBALS['prp_observacao']  = addslashes($GLOBALS['prp_observacao']);
}


$param_usa_tabulador_lista_extra = $mkParam['usa_tabulador_lista_extra'];


//**************************************************
//** Conecta ao BD do Paramertro *******************
//**************************************************

//**********************************************************
//*************tratamento de variaveis ********************
$classe_mkpro = "MD".$nro_modelo;
$mk_tipo_atendimento = "R";
//**********************************************************
//**********************************************************

$string_codigo = "##MD".$nro_modelo.$mesmo_cliente_n_pedido."##";

//**************************************************************************
//**************************************************************************
//ROTINA QUE BUSCA DADOS DA CAIXA DE EMAIL PESSOAL PARA ENVIO ESPECIFICO****
//**************************************************************************
//**************************************************************************
if ($rotina_envia_email == "S") {
  if($lead_mkpro != "") {
    $grupo_email_env = ValidaGrupoEnvEmail($lead_mkpro,$dk_campanha);
  }
  if($grupo_email_env) {
    $dadosGrupoCaixa = DadosEmailCaixa($grupo_email_env,$repre_vendedor);
  }
  if($dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"]) {
    $grupo_email  = $dadosGrupoCaixa["EMAIL_GRUPO"];
    $origem_email = $dadosGrupoCaixa["EMAIL_ORIGEM_1"];
    $nome_email   = $dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"];
  }
}

if ($nro_modelo == "TU" && $repre_vendedor == "BMC" && $mk_origem_atd == "04") {
	//Bradesco - CACI - forçando usar o grupo de disparo de e-mail do discador AJ de tratativa de e-mail.
	$dadosGrupoCaixa["EMAIL_GRUPO"]         = "E126";
	$dadosGrupoCaixa["EMAIL_ORIGEM_1"]      = "gestaodecanais@bradescofinanciamentos.com.br";
	$dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"] = "Bradesco Gestão de Canais";
	$grupo_email                            = $dadosGrupoCaixa["EMAIL_GRUPO"];
	$origem_email                           = $dadosGrupoCaixa["EMAIL_ORIGEM_1"];
	$nome_email                             = $dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"];
}
//**************************************************************************
//**************************************************************************
//ROTINA QUE BUSCA DADOS DA CAIXA DE EMAIL PESSOAL PARA ENVIO ESPECIFICO****
//**************************************************************************
//**************************************************************************





//* INI - DEFININDO VARIÁVEIS PARA GRAVAR PASSO A PASSO DO OPERADOR QUANDO ELE TIVER FINALIZANDO O ATENDIMENTO *//
if (substr($repre_vendedor,0,5) == 'HONDA') {
	try {
		$estagio  = "BD_GERAL";

		$errorHandler = new HondaErrorHandler($classe_mkpro, $_POST["mesmo_cliente_n_pedido"], $estagio, $_SESSION['session']['operador']);
	  //* Gravação do LOG PASSO A PASSO no BD *//
	  $objLogPAP = new LogPassoaPasso($mkParam, $estagio, $errorHandler, $classe_mkpro, $_POST["mesmo_cliente_n_pedido"], $grupo);

	  $objLogPAP->gravarLogPassoaPasso();

	} catch (Exception $e) {
	  $errorHandler->gravarLogErro($e);
	}
}
//* FIM - DEFININDO VARIÁVEIS PARA GRAVAR PASSO A PASSO DO OPERADOR QUANDO ELE TIVER FINALIZANDO O ATENDIMENTO *//

if ($usa_repre_vendedor == "S") {
	$repre_sistema = $repre_vendedor;
} else {
	$repre_sistema =  $session["representante"];
}

$arr_param_atu_logura  = explode("¢",$atu_logura);

$param_classe_recusa  = $classe_recusa;
$param_classe_c_imp   = $classe_c_imp;
$param_classe_agenda  = $classe_agenda;

if ($host == "") {
	$connectHOST = ConnectDB();
  require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/bd/ConexaoCallCenter.php");
	$connHOST = new ConexaoCallCenter();//CRIANDO CONEXÃO COM O BD NO PADRÃO NOVO
} else {
	$connectHOST = Conecta($host, $user, $senha, $bd);
	$connHOST = new Conexao($host, $bd, $user, $senha);//CRIANDO CONEXÃO COM O BD NO PADRÃO NOVO
}
//**************************************************
//print "Banco: ".$bd."<br>";

$connect = ConnectDB();
$connect_ramal = ConnectRAMAL();

// ************************************************************* //
// *************** TRATAMENTO DOS CAMPOS EXTRAS **************** //
// ****************** ROTINA NOVA        *********************** //
// ************************************************************* //
require_once("rotinas/CamposExtrasBD.php");
// ************************************************************* //
// ************************************************************* //
// ************************************************************* //

// ************************************************************* //
// ************************************************************* //

//showvars();

//for ($x=1; $x<=9; $x++) {
	if(${"possui_campo_extra_stvenda_".$atv_st_venda_cartao} == "S") {
		unset($matriz_cextra);
		$mk_cextra_sigla      = "STVENDA_EXTRA_".$atv_st_venda_cartao;
		$mk_cextra_classe     = "MD".$nro_modelo."B";
		$mk_cextra_sistema_bd = "MK";

		require("rotinas/CamposExtrasBD.php");

		if (is_array($matriz_ins) && is_array($matriz_cextra)) {
			$matriz_ins = array_merge($matriz_ins,$matriz_cextra);
		} else {
			if (is_array($matriz_cextra)) {
				$matriz_ins = $matriz_cextra;
			}
		}
	}
//}


// ************************************************************* //
// ************************************************************* //
// ************************************************************* //
// ************************************************************* //

//if($qtd_campos_extras > 13){
//  print "<pre>";
//  print_r($qtd_campos_extras);
//  exit;
//}
// ************************************************************* //
// *************** TRATAMENTO DOS CAMPOS EXTRAS **************** //
// ****************** ROTINA ANTIGA      *********************** //
// ************************************************************* //

for ($x=1; $x<=13; $x++) {
	$aux_parm_cmp_extra = "campo_extra_".$x;
	$parm_campo_extra = explode("¢", $$aux_parm_cmp_extra);
	$parm_cmp_extra_func = explode("-",$parm_campo_extra[5]);

	if ($parm_cmp_extra_func[0] == "valor") { // ** TRATANDO O VALOR
		$aux_cmp_extra = "cmp_extra_".$x;
		$$aux_cmp_extra = getValorDecimal($$aux_cmp_extra,"");
	}
}
// ************************************************************* //
// **************************** FIM **************************** //
// ************************************************************* //

// ************************************************************* //
// ******************** ROTINA MIDIA GRUPO ********************* //
// ************************************************************* //
if($rotina_midia == "S") {

	$matriz_ins["midia_filtro_1"] = $midia_filtro_1;
	$matriz_ins["midia_filtro_2"] = $midia_filtro_2;
	$matriz_ins["midia_filtro_3"] = $midia_filtro_3;
}
// ************************************************************* //
// **************************** FIM **************************** //
// ************************************************************* //


// ************************************************************* //
// ******************** ROTINA INDICAÇÃO TELA ATD ************** // 26/02/2018 (ADRIANO) A PRINCIPIO PARA CLIENTE SEM PARAR
// ************************************************************* //
if ($mostra_indica_tela_atd == "S" && $rdIndicaAtd == "S") {
  include("md_cad_prop_bd_dados_indica_atendimento.php");
}

//amarração do protocolo novo dentro do IM

if (${'im_chave_'.strtolower(substr($mk_ramal["grupo"], 0, 2)).'1'} != "") {
	$matriz_ins['im_chave_'.strtolower(substr($mk_ramal["grupo"], 0, 2)).'1'] = ${'im_chave_'.strtolower(substr($mk_ramal["grupo"], 0, 2)).'1'};
	$campo_flw_mk_coleta_campos .= " im_chave_".strtolower(substr($mk_ramal["grupo"], 0, 2))."1, ";
	$vlr_flw_mk_coleta_campos   .= " '".${'im_chave_'.strtolower(substr($mk_ramal["grupo"], 0, 2)).'1'}."', ";
}
// ********************************************************************************** //
//  ROTINA CAMPOS UPDATE TANTO PARA FOLLOWUP QUANTO PARA TEMA_PAI********************* //
// ******************************************************************************** //

if ($mk_campos_update) {
	$arrMKCamposUpdate = explode("§",$mk_campos_update);
	if (is_array($arrMKCamposUpdate)) {
		foreach ($arrMKCamposUpdate as $key => $value) {
			if ($value) {
				$arrMKCamposUpdateAtributos = explode("¢",$value);

				switch ($arrMKCamposUpdateAtributos[3]) {
					case "V":
						${$arrMKCamposUpdateAtributos[1]} = str_replace(".","",${$arrMKCamposUpdateAtributos[1]});
						${$arrMKCamposUpdateAtributos[1]} = str_replace(",",".",${$arrMKCamposUpdateAtributos[1]});
						$matriz_ins[$arrMKCamposUpdateAtributos[1]] = ${$arrMKCamposUpdateAtributos[1]};
						if($matriz_ins[$arrMKCamposUpdateAtributos[1]]){
							$campo_flw_mk_coleta_campos .= " ".$arrMKCamposUpdateAtributos[1].", ";
							$vlr_flw_mk_coleta_campos   .= " '".$matriz_ins[$arrMKCamposUpdateAtributos[1]]."', ";
						}

						break;
					case "D":
						$cup_dia_aux = $arrMKCamposUpdateAtributos[1]."_dia";
						$cup_mes_aux = $arrMKCamposUpdateAtributos[1]."_mes";
						$cup_ano_aux = $arrMKCamposUpdateAtributos[1]."_ano";
						if(!$$cup_dia_aux){$$cup_dia_aux = 11;};
						if(!$$cup_mes_aux){$$cup_mes_aux = 11;}
						if(!$$cup_ano_aux){$$cup_ano_aux = 1111;};
						$matriz_ins[$arrMKCamposUpdateAtributos[1]] = $$cup_ano_aux."-".$$cup_mes_aux."-".$$cup_dia_aux;
						if($matriz_ins[$arrMKCamposUpdateAtributos[1]]){
							$campo_flw_mk_coleta_campos .= " ".$arrMKCamposUpdateAtributos[1].", ";
							$vlr_flw_mk_coleta_campos   .= " '".$matriz_ins[$arrMKCamposUpdateAtributos[1]]."', ";
						}

						break;
					case "T":
						$matriz_ins[$arrMKCamposUpdateAtributos[1]] = ${$arrMKCamposUpdateAtributos[1]};
						if($matriz_ins[$arrMKCamposUpdateAtributos[1]]){
							$campo_flw_mk_coleta_campos .= " ".$arrMKCamposUpdateAtributos[1].", ";
							$vlr_flw_mk_coleta_campos   .= " '".$matriz_ins[$arrMKCamposUpdateAtributos[1]]."', ";
						}

						break;
					case "C":
						$matriz_ins[$arrMKCamposUpdateAtributos[1]] = ${$arrMKCamposUpdateAtributos[1]};
						if($matriz_ins[$arrMKCamposUpdateAtributos[1]]){
							$campo_flw_mk_coleta_campos .= " ".$arrMKCamposUpdateAtributos[1].", ";
							$vlr_flw_mk_coleta_campos   .= " '".$matriz_ins[$arrMKCamposUpdateAtributos[1]]."', ";
						}

						break;
					case "A":
						$matriz_ins[$arrMKCamposUpdateAtributos[1]] = ${$arrMKCamposUpdateAtributos[1]."_ano"}.${$arrMKCamposUpdateAtributos[1]."_mes"};
						if($matriz_ins[$arrMKCamposUpdateAtributos[1]]){
							$campo_flw_mk_coleta_campos .= " ".$arrMKCamposUpdateAtributos[1].", ";
							$vlr_flw_mk_coleta_campos   .= " '".$matriz_ins[$arrMKCamposUpdateAtributos[1]]."', ";
						}

						break;
				}
			}
		}
	}
}
// ************************************************************* //
// **************************** FIM **************************** //
// ************************************************************* //

// ************************************************************* //
// ************** ROTINA LIMPAR PAUSA CALLBACK RACO ************ //
// ************************************************************* //
if($utiliza_callback_raco == "S" || $param_utiliza_callback_raco == "S"){
	mkPausaTela("saiPausa");
}
// ************************************************************* //
// **************************** FIM **************************** //
// ************************************************************* //

// ************************************************************* //
// ******************** ROTINA MK ORIGEM   ********************* //
// ************************************************************* //

if ($mk_origem_atd != "") {
	$matriz_ins["mk_origem_atd"]    = $mk_origem_atd;
	$campo_mk_origem .= " mk_origem_atd, ";
	$vlr_mk_origem .= " '".$mk_origem_atd."', ";

	if ($_POST["mk_ramal_serialize"] == "SEM_LIGACAO" || $_POST["mk_ramal_serialize"] == "DIRETO" ||  $session["apaga_consulta_mk_ramal"] == "S") {
		$mk_ramal["equipe"]         = "";
		$mk_ramal["nb"]             = "";
		$mk_ramal["grupo"]          = "Sem Dac";
		$mk_ramal["nro_gravacao"]   = "";
		$mk_ramal["nome_gravacao"]  = "";
		$mk_ramal["bina_gravacao"]  = "";
		$mk_ramal["id_cli"]         = "";
		$mk_ramal["id_lig"]         = "";
		$mk_ramal["hora_ini"]       = "00:00:00";
		$mk_ramal["hora_fim"]       = "00:00:00";
		$mk_ramal["duracao"]        = "";
		$mk_ramal["retorno_sistema"]  = "";

		unset($bina_cliente);
		unset($tempo_tot_lig);
		unset($id_lig);
		unset($nome_gravacao);
		unset($servico_dac);

	} else {
	  $mk_ramal_ant = $mk_ramal;
		$mk_ramal = unserialize(urldecode($_POST["mk_ramal_serialize"]));
		if(!$mk_ramal){
		  $mk_ramal = $mk_ramal_ant;
		}
		if ($mk_ramal["grupo"] == "" && $mk_ramal["servico_dac"] != "Sem Dac") {
    /*
		  require_once("/libs/ctr/AlarmeCTR.php");
			ob_start();
			echo "<pre>ERRO GRAVACAO MK RAMAL VAZIA";
			var_dump($_GET);
			var_dump($_POST);
			var_dump($_SESSION);
			var_dump($mk_ramal);
			echo "</pre>";
			$msg_alarme .= ob_get_contents();
			ob_end_clean();

			$matrizOperadoresQG["1"] = "re000161";
			$matrizOperadoresQG["2"] = "re003811";
			AlarmeCTR::setAlarmeIntegrAll($matrizOperadoresQG,addslashes($msg_alarme),"N");
			*/
		} else {
      $mk_ramal['hora_fim'] = date("H:i:s");
      $mk_ramal['duracao'] = (date_timestamp_get(date_create($mk_ramal['hora_fim'])) - date_timestamp_get(date_create($mk_ramal['hora_ini'])));
		}
	}

	if ($nro_modelo == "T9" || $nro_modelo == "T5" || $nro_modelo == "9T" || $nro_modelo == "GD" || $nro_modelo == "9X" || $nro_modelo == "9I") {
		if(ValorClasse("MD".$nro_modelo."L","PAUSA_AUTOMATICA",$repre_vendedor) == "S") {
			//AUTO_DIRECT_ATD
			if (ValorClasse("MD".$nro_modelo."L","AUTO_DIRECT_ATD",$repre_vendedor) != "S") {
				mkPausaTela("saiPausa");

				require_once($_SERVER['DOCUMENT_ROOT']."/libs/ctr/RamalDac.php");
				$objRamalDac = new RamalDac($session["ip_dac"], $session["porta_dac"], $ramal_atend);
				$objRamalDac->setCampo("obs_tela", "");
				$objRamalDac->execUpdate();
			} else {
				require_once($_SERVER['DOCUMENT_ROOT']."/libs/ctr/RamalDac.php");
				$objRamalDac = new RamalDac($session["ip_dac"], $session["porta_dac"], $ramal_atend);
				$objRamalDac->setCampo("obs_tela", "FINALIZANDO TABULAÇÃO");
				$objRamalDac->execUpdate();
			}

		}
	} else {


		if($mk_origem_atd== "R" && (ValorClasse("MD".$nro_modelo."L","PAUSA_AUTOMATICA",$repre_vendedor) == "S") || (ValorClasse("MD".$nro_modelo."L","PAUSA_TABULACAO",$repre_vendedor) == "S")) {
			if ($session["operador"] == "xx015412" && $nro_modelo == "GD") {
				mkPausaTela("saiPausa");
			}
			if ($nro_modelo != "GD") {
				mkPausaTela("saiPausa");
			}
		}
	}

} else {
	// ************************************************************* //
	// ******************** ROTINA DADOS DA GRAVACAO   ********************* //
	// ************************************************************* //
	if ((is_array($mk_ramal) === false) || (isset($mk_ramal) === false)) {
		//Setando os dados da ligacao na tb ramal
		$objRamal = new RamalWeb($session["ip_dac"], $session["porta_dac"], $ramal_atend);
		$mk_ramal = $objRamal->DadosAtendimento();
	}
	// ************************************************************* //
	// ******************** ROTINA DADOS DA GRAVACAO   ********************* //
	// ************************************************************* //
}

// ************************************************************* //
// **************************** FIM **************************** //
// ************************************************************* //

// ************************************************************* //
// ******************** ROTINA MK MSG ALERTA ******************* //
// ************************************************************* //
if (empty($mk_msg_alerta) === false) {
	$matriz_ins["mk_msg_alerta"] = addslashes($mk_msg_alerta);
	$campo_mk_origem .= " mk_msg_alerta, ";
	$vlr_mk_origem .= " '".addslashes($mk_msg_alerta)."', ";
}
// ************************************************************* //
// **************************** FIM **************************** //
// ************************************************************* //

//***********************************************************************
//***********************ROTINA DE STATUS INTELIGENTE********************
//***********************************************************************
if ($status_grava_proposta == "MKSTI") {
	//  print "<li>Marcelo bd principal";
	//$GLOBALS["aiDebugPrint"] = true;

	mostraRegraScript("URANET", $status_grava_proposta."¢MD".$nro_modelo,"ARR");
	$aux_status_grava_proposta = $arrayAIaux[0];
	$aux_sistema_aux_status    = $arrayAIaux1[0];

	if (!$aux_status_grava_proposta) {
		print "<div align=\"center\"><font color=\"#FF0000\" size=\"7\">REGRA DO STATUS NÃO CADASTRADO NO AÇÃO INTELIGENTE.<br>
     REPRESENTANTE: URANET REGRA: MKSTI OPERAÇÃO: MD".$nro_modelo."<br><br>CONTATE UM ANALISTA DA URANET</font></div>";
		exit;

	} else {
		$status_grava_proposta_ant = $status_grava_proposta;
		$status_grava_proposta     = $aux_status_grava_proposta;
		//adequando as variaveis do md ao dk
		$param_status_grava_proposta_ant = $status_grava_proposta;
		$param_status_grava_proposta     = $aux_status_grava_proposta;

		$aux_sistema_aux_status    = $arrayAIaux1[0];
	}
}

if (!$param_status_grava_proposta) {
	$param_status_grava_proposta     = $status_grava_proposta;
}
//***************************************************************************
//***************************************************************************
//***************************************************************************

//**********************************************************************************************
//**********************************************************************************************
//**********************************************************************************************
//---------inicio  da logica de update nas listas extras....
//**********************************************************************************************
//**********************************************************************************************
//**********************************************************************************************

if ($usa_lista_extra == "S") {
	$connectMK     = ConnectMKPARAM();
	$q_le = "SELECT vlr_classe, desc_classe FROM tb_mk_classe WHERE cod_classe = 'LE".$nro_modelo."B' AND representante = 'URANET' AND tipo_reg = 'I' AND status = 'A' ";
	if ($query_le = DescExecQuery($q_le, $connectMK)) {

		if (($rec_le = mysql_fetch_assoc($query_le))) {
			do {
				$arrLE[$rec_le["vlr_classe"]] =$rec_le["desc_classe"];
			} while ($rec_le = mysql_fetch_assoc($query_le));
		} else {
			print "<br><font class='txtvermelho3'>Parametros da Lista Extra não encontrado,CLASSE = LE".$nro_sistema_le."B </font>";

		}
	} else {
		print "<br><font class='txtvermelho3'>Parametros da Lista Extra não encontrado,CLASSE = LE".$nro_sistema_le."B </font>";
		print mysql_error($connectMK);
	}

	if (!$arrLE["LE_TIPO"]) {
		$arrLE["LE_TIPO"]          = "SELEC_ATENDIMENTO";
	}


	//********************************************************************
	//faz um update em todos os combos selecionados na lista extra anterior
	//********************************************************************
	if (is_array($LE_hidden_escolha)) {
		$connect_le = Conecta($host_lista_extra,$user_lista_extra,$senha_lista_extra,$bd_lista_extra);
		foreach ($LE_hidden_escolha as $chaves_le=>$valor_le) {
			if ($valor_le != "") {
				$matriz_up_le[$arrLE["LE_BAIXA_CAMPO"]] = $valor_le;
				$matriz_up_le["data_atualiza"] = date("Y-m-d");
				$matriz_up_le["hora_atualiza"] = date("H:i:s");
				$matriz_up_le["login_atualiza"] = $session["operador"];

				$arrLEChaves = explode(",",$arrLE["LE_CHAVES"]);
				$arrLEChavesVlr = explode("¢",$chaves_le);


				$result_le = FazUpdate($matriz_up_le,$tabela_lista_extra,"Where ".$arrLEChaves[0]."=".$arrLEChavesVlr[0]." and ".$arrLEChaves[1]."=".$arrLEChavesVlr[1]." and ".$arrLEChaves[2]."=".$arrLEChavesVlr[2],$connect_le);
				if ($result_le != "OK") {
					print "<font class='txtvermelho'>ERRO AO BAIXAR A LISTA EXTRA";
					print $result_le;
				}
				unset($matriz_up_le);
			}
		}
	}
	if (is_array($LE_grava)) {
		foreach ($LE_grava as $campo_grava_le=>$valor_grava_le) {
			$matriz_ins[$campo_grava_le] = $valor_grava_le;
			$matriz_vda_padrao[$campo_grava_le] = $valor_grava_le;
		}
	}

}
if ( $param_usa_tabulador_lista_extra == 'S' ) {

  require_once("{$_SERVER['DOCUMENT_ROOT']}/callcenter/funcoes/TabuladorListaExtra.php");
  require_once("{$_SERVER['DOCUMENT_ROOT']}/libs/ctr/MKParam.php");

  $le_repre = $param_repre_vendedor       ? $param_repre_vendedor       : $repre_vendedor;
  $le_siste = $nro_modelo;

	MKParam::carregaArrParam('MD' . $le_siste, $le_repre);
  if (is_array($lepadrao)) {
    $matriz_merge = array();
    foreach ($lepadrao as $indice_item => $lista_extra) {
			if($lepadrao[$indice_item]['met_atd_nivel1'] == "z"){
				continue;
			}
      $tabulador_lista_extra = new TabuladorListaExtra($le_repre, $le_siste, $lista_extra['indice_le']);

      $matriz_le = $tabulador_lista_extra->gravaPropostas(array($lista_extra), $indice_item, 'N');

			if (is_array($matriz_le)) {
        $matriz_merge = array_merge($matriz_merge, $matriz_le);
      }

      if ($lista_extra['indice_le'] > "0") {
        $lista_extra_multipla = true;
      }

    }
    $matriz_ins_loop = $matriz_merge;
	}

  if (!$lista_extra_multipla) {
    if (is_array($matriz_ins_loop)) {
      foreach ($matriz_ins_loop as $ind => $item) {
        $aux_le = explode('-', $ind);
        $nova_matriz_ins_loop[$aux_le[1]] = $item;
      }
    }
    $matriz_ins_loop = $nova_matriz_ins_loop;
	}

  if ($tabulador_lista_extra && $tabulador_lista_extra->statusexec !== true) {
    print $tabulador_lista_extra->msgexec;
    exit;
  } else {
    if (count((array)$matriz_ins_loop) > 0) {

      $set_grava_proposta_include = "sim";
      $grava_proposta             = "sim";
      $faz_insert_atd_padrao      = "sim";

    } else {
			$set_grava_proposta_include = "sim";
      $grava_proposta             = "sim";
      $faz_insert_atd_padrao      = "sim";
    }
  }

}
//**********************************************************************************************
//**********************************************************************************************
//**********************************************************************************************
//**********************************************************************************************
//**********************************************************************************************
//**********************************************************************************************

//*****************************************************************************
//*****************************SCRITP ARGUMENTOS GRAVAÇÃO**********************
//*****************************************************************************
if (empty($script_argumento) === false) {
	$mtr_script_argumento = explode("¢", $script_argumento);
	if ($mtr_script_argumento[0] == "S" && empty($forms_args) === false) {
		$arg_formularios = $forms_args;
		$aux_forms_args = explode("§§", $forms_args);
		$arg_abordagem = "";
		foreach ($aux_forms_args as $chave => $valor) {
			if (empty($valor) === false) {
				$aux_valor = str_replace("§", "", $valor);
				$arg_abordagem .= ${"forms_args_".$aux_valor}."¢";
			}
		}
		$arg_abordagem = substr($arg_abordagem, 0, -1);
		$matriz_ins["arg_formularios"]        = $arg_formularios;
		$matriz_ins["arg_abordagem"]          = $arg_abordagem;
		$matriz_vda_padrao["arg_formularios"] = $arg_formularios;
		$matriz_vda_padrao["arg_abordagem"]   = $arg_abordagem;
		$matriz_prop["arg_formularios"]       = $arg_formularios;
		$matriz_prop["arg_abordagem"]         = $arg_abordagem;
	}
} else {
	unset($mtr_script_argumento);
	unset($arg_abordagem);
	unset($arg_formularios);
}
//*****************************************************************************
//*****************************************************************************
//*****************************************************************************

/*
classe_c_imp_status_bk
cod_recusa_3


classe_recusa_status_bk
cod_recusa_2
*/

$idFazInsert = true;

if ($conclusao_receptivo == "S" && $classe_recusa_status_bk == "S" && $cod_recusa_2) {
	$arr_aux_cr = explode("¢", $cod_recusa_2);
	$cod_recusa_2  = $arr_aux_cr[0];
	$st_bk_status  = $arr_aux_cr[1];
	$st_bk_dias_ag = $arr_aux_cr[2];
	$st_bk_data_ag = $arr_aux_cr[3];
}
if ($conclusao_receptivo == "S" && $classe_c_imp_status_bk == "S" && $cod_recusa_3) {
	$arr_aux_cr = explode("¢", $cod_recusa_3);
	$cod_recusa_3  = $arr_aux_cr[0];
	$st_bk_status  = $arr_aux_cr[1];
	$st_bk_dias_ag = $arr_aux_cr[2];
	$st_bk_data_ag = $arr_aux_cr[3];
}


if (!$ddd_1  ) {$ddd_1    = $atv_ddd_tel        ;}
if (!$fone_1 ) {$fone_1   = $atv_num_tel        ;}
if (!$ramal_1) {$ramal_1  = $atv_ramal_tel      ;}
if (!$ddd_2  ) {$ddd_2    = $atv_ddd_comercial  ;}
if (!$fone_2 ) {$fone_2   = $atv_fone_comercial ;}
if (!$ramal_2) {$ramal_2  = $atv_ramal_comercial;}
if (!$ddd_3  ) {$ddd_3    = $atv_ddd_cont       ;}
if (!$fone_3 ) {$fone_3   = $atv_num_cont       ;}
if (!$ramal_3) {$ramal_3  = $atv_ramal_cont     ;}


$arr_conclusao = explode("¢",$conclusao);

if ((!$ddd_1) && (!$atv_ddd_tel)) {
	if (!$id_lig) {
		$id_lig       = $mk_ramal["id"];
	}
	if (!$bina_cliente) {
		$bina_cliente = $mk_ramal["bina_gravacao"];
	}
	if (!$hora_ini_dac) {
		$hora_ini_dac = $mk_ramal["hora_ini_dac"];
	}
	if (!$ddd_1) {
		$ddd_1         = substr($mk_ramal["bina_gravacao"], 0, 2);
	}
	if (!$fone_1) {
		$fone_1        = substr($mk_ramal["bina_gravacao"], 2);
	}
}


//******************************************************************************************************************************************************
//**ESPECIFICO PARA OUVIDORIA PARA ENTRADAS DIFERENTE DE 0800(TELEFONIA) OU ESPECIFICO PARA CAMPANHAS DE SITE NÃO GRAVAR OS DADOS DA MK_RAMAL(LIGAÇÃO)**
//******************************************************************************************************************************************************
if ((isset($ouv_origem) === true && empty($ouv_origem) === false && $ouv_origem != "01") || ((substr($lead_grupo, 0, 1) == "W" || substr($lead_grupo, 0, 1) == "E") && $ligou_na_ficha != "S")) {
	unset($mk_ramal);
	unset($id_lig);
	unset($bina_cliente);
	unset($hora_ini_dac);
	unset($servico_dac);
	unset($nome_gravacao);
}
//*****************************************************************************************************************
//*****************************************************************************************************************
//*****************************************************************************************************************






//***************************
//*******************VARS****
//***************************
$hoje_dia = Date("d"); If (strlen($hoje_dia) < 2) {$hoje_dia = "0".$hoje_dia;}
$hoje_mes = Date("m"); If (strlen($hoje_mes) < 2) {$hoje_mes = "0".$hoje_mes;}
$hoje_ano = Date("Y");
//$empresa =  $session["representante"];
$data     = date ('Y-m-d');
$hora     = date ('H:i:s');
$Operador = $session["operador"];
//*************************

function get_id_lig()
{
	global $mk_ramal;
	return $mk_ramal["id_lig"];
}

if ($id_lig) {
	$atv_id_lig = $id_lig;
}
if (!$atv_id_lig) {
	$atv_id_lig = get_id_lig();
}


if ($cmp_extra_1)  {$up_cp_extra .= " ,campo_extra_1  = '".$cmp_extra_1."'";}
if ($cmp_extra_2)  {$up_cp_extra .= " ,campo_extra_2  = '".$cmp_extra_2."'";}
if ($cmp_extra_3)  {$up_cp_extra .= " ,campo_extra_3  = '".$cmp_extra_3."'";}
if ($cmp_extra_4)  {$up_cp_extra .= " ,campo_extra_4  = '".$cmp_extra_4."'";}
if ($cmp_extra_5)  {$up_cp_extra .= " ,campo_extra_5  = '".$cmp_extra_5."'";}
if ($cmp_extra_6)  {$up_cp_extra .= " ,campo_extra_6  = '".$cmp_extra_6."'";}
if ($cmp_extra_7)  {$up_cp_extra .= " ,campo_extra_7  = '".$cmp_extra_7."'";}
if ($cmp_extra_8)  {$up_cp_extra .= " ,campo_extra_8  = '".$cmp_extra_8."'";}
if ($cmp_extra_9)  {$up_cp_extra .= " ,campo_extra_9  = '".$cmp_extra_9."'";}
if ($cmp_extra_ano) {$up_cp_extra .= " ,campo_extra_10 = '".$cmp_extra_ano_10."-".$cmp_extra_mes_10."-".$cmp_extra_dia_10."'";}
if ($cmp_extra_ano) {$up_cp_extra .= " ,campo_extra_11 = '".$cmp_extra_ano_11."-".$cmp_extra_mes_11."-".$cmp_extra_dia_11."'";}
if ($cmp_extra_12) {$up_cp_extra .= " ,campo_extra_12 = '".$cmp_extra_12."'";}
if ($cmp_extra_13) {$up_cp_extra .= " ,campo_extra_13 = '".$cmp_extra_13."'";}

if ($cmp_script_1) {
	require_once("/libs/ctr/RichText.php");
	$cmp_script_1 = RichText::slashCode($cmp_script_1);
}


$ins_cp_extra   ="";
$ins_vl_cp_extra="";
if ($cmp_extra_1)  {
	$ins_cp_extra     .= " campo_extra_1,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_1."',";
}
if ($cmp_extra_2)  {
	$ins_cp_extra     .= " campo_extra_2,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_2."'";
}
if ($cmp_extra_3)  {
	$ins_cp_extra     .= " campo_extra_3,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_3."'";
}
if ($cmp_extra_4)  {
	$ins_cp_extra     .= " campo_extra_4,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_4."'";
}
if ($cmp_extra_5)  {
	$ins_cp_extra     .= " campo_extra_5,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_5."'";
}
if ($cmp_extra_6)  {
	$ins_cp_extra     .= " campo_extra_6,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_6."'";
}
if ($cmp_extra_7)  {
	$ins_cp_extra     .= " campo_extra_7,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_7."'";
}
if ($cmp_extra_8)  {
	$ins_cp_extra     .= " campo_extra_8,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_8."'";
}
if ($cmp_extra_9)  {
	$ins_cp_extra     .= " campo_extra_9,";
	$ins_vl_cp_extra  .= "'".$cmp_extra_9."'";
}
if ($cmp_extra_ano) {
	$ins_cp_extra    .= " campo_extra_10,";
	$ins_vl_cp_extra .= "'".$cmp_extra_ano_10."-".$cmp_extra_mes_10."-".$cmp_extra_dia_10."'";
}
if ($cmp_extra_ano) {
	$ins_cp_extra    .= " campo_extra_11,";
	$ins_vl_cp_extra .= "'".$cmp_extra_ano_11."-".$cmp_extra_mes_11."-".$cmp_extra_dia_11."'";
}
if ($cmp_extra_12) {
	$ins_cp_extra    .= " campo_extra_12,";
	$ins_vl_cp_extra .= "'".$cmp_extra_12."'";
}
if ($cmp_extra_13) {
	$ins_cp_extra    .= " campo_extra_13,";
	$ins_vl_cp_extra .= "'".$cmp_extra_13."'";
}

if ($_SESSION["ambiente"] == "treinamento") {
	if ($atv_st_venda_cartao == "0") {
		$msg_ok = "AGENDAMENTO UNIVERSAL registrado com sucesso!!!";
	} else if ($atv_st_venda_cartao == "1") {
		$proposta = "ok";
		$msg_ok = "CADASTRO EFETUADO COM SUCESSO";
	} else if ($atv_st_venda_cartao == "2") {
		$msg_erro = "ok";
		$msg_ok = "RECUSA registrada com sucesso!!!";
	} else if ($atv_st_venda_cartao == "3") {
		$msg_erro = "ok";
		$msg_ok = "CONTATO IMPOSSÍVEL registrado com sucesso!!!";
	} else if ($atv_st_venda_cartao == "4") {
		$msg_ok = "AGENDAMENTO DEDICADO registrado com sucesso!!!";
	}
} else {
	/* *******************************************************************************************
	********** Detecta o que foi escolhido no atendimento e faz o update nescessário: *********
	******************************************************************************************* */
	if ($classe_followup != "") {
		require_once("mk_funcoes.php");
		$date_time = getDataFinalFolow($classe_followup, $cod_recusa_1, $repre_vendedor, $param_empresa_produto, $arrTipoProd, mkConecta_TB_PROPOSTA());
		$matriz_ins["flw_data_previsao"]  = $date_time[0];
		$matriz_ins["flw_hora_previsao"]  = $date_time[1];
		$matriz_ins["flw_tempo_previsao"] = $date_time[2];
		$matriz_ins["flw_status"]         = "A";
	}


	if ($abriu_formulario == "S") {
		require_once("funcoes/getNPedido.php");

		if($formularios_preenchido) {
			$formularios_preenchido = str_replace("'","\"",$formularios_preenchido);
			$array_form             = explode("=|PERG_FORM|=",$formularios_preenchido);
			$cont = 0;
			foreach ($array_form as $valor_form) {
				if($valor_form) {
					$array_form_resp      = explode("=|RESP_FORM|=",$valor_form);
					$numero_formulario    = $array_form_resp[0];
					$respostas_formulario = $array_form_resp[1];
					$n_enriquecimento     = getNPedido($param_empresa."_ENRIQ");
					$campo_chave          = $n_enriquecimento;

					$var_rec_post = json_decode($respostas_formulario,true);
					foreach ($var_rec_post as $chave => $valor) {
						$pula_form_var = "N";
						switch ($chave) {
							case "repre_form":
							case "numero_formulario":
							case "deonde_prog":
							case "busca":
							case "atualizou_tela":
								$pula_form_var = "S";
								break;
						}
						if($pula_form_var != "S") {
							$$chave = utf8_decode($valor);
						}
					}

					if (file_exists("md_cad_prop_bd_dados_form_inteligente.php")) {
						require("md_cad_prop_bd_dados_form_inteligente.php");
					}
					$matriz_ins_loop[$cont]["n_enriquecimento"	   ] = $n_enriquecimento;
					$matriz_ins_loop[$cont]["cod_enriquecimento"	 ] = $numero_formulario;
					$matriz_ins_loop[$cont]["campo_chave"	         ] = $n_enriquecimento;

					foreach ($var_rec_post as $chave => $valor) {
						$pula_form_var = "N";
						switch ($chave) {
							case "repre_form":
							case "numero_formulario":
							case "deonde_prog":
							case "busca":
							case "atualizou_tela":
								$pula_form_var = "S";
								break;
						}
						if($pula_form_var != "S") {
							unset($$chave);
						}
					}
				}
				$cont++;
			}
		} else {
			$n_enriquecimento = getNPedido($param_empresa."_ENRIQ");
			if (!$campo_chave) {
				$campo_chave = $n_enriquecimento;
			}
			$matriz_ins["n_enriquecimento"    ] = $n_enriquecimento;
			$matriz_ins["cod_enriquecimento"  ] = $numero_formulario;

			//$cmp_extra_1 = str_replace($busca_like,"",$cmp_extra_1);
			//****************************************************************
			//INCLUDE DO PROGRAMA Q INCLUI PERGUNTAS DO FORMULARIO INTELIGENTE
			//****************************************************************
			if (file_exists("md_cad_prop_bd_dados_form_inteligente.php")) {
				require_once("md_cad_prop_bd_dados_form_inteligente.php");
			}
			//****************************************************************
			//****************************************************************
			//****************************************************************
		}
	}

	//print "<li>".$tipo_modelo."->".$atv_st_venda_cartao;

	if ($nro_modelo == "1V"){
		$tipo_modelo = "RECEPTIVO";
	}

  if(achaNroModelo($nro_modelo,$tipo_abertura) == "YB") {
    ini_set("memory_limit","44M");
  } elseif (achaNroModelo($nro_modelo,$tipo_abertura) == "WJ") {
    ini_set("memory_limit", "128M");
  }

	switch($tipo_modelo) {
		case "AGENDA_RETORNO":
		case "ATIVO":
		case "INDICACAO":
		case "ATIVO_LEADS":
		case "ATIVO_DISCAR":
		case "RECEPTIVO":
		case "INDICACAO_MK":
			switch($atv_st_venda_cartao) {
				case "1":
					if($prefixo_classe_tema_pai) {
						require_once("md_cad_prop_bd_tema_pai.php");
					}

					//**************************************************************
					//atendimento padrao é antes do update do discador *******************************
					if($atendimento_padrao == "S") {
						$im_prim_nome 		 = strtok($nome_razao, " ");
						$im_prim_nome_agente = strtok($session['usuario'], " ");

				    $file = mkFileInclude($include_dados_pasta, $include_dados, "md_cad_prop_bd_dados_".$include_dados.".php", "N");

						if(file_exists($file)){
							require_once($file);
						}
						require_once("md_cad_prop_bd_dados_atendimento_padrao.php");
					}else {
						//***********************************************************
						//INCLUDE DOS INSERTS DO BD NA TABELA DO PROGRAMA QUE DA O INCLUDE
						//***********************************************************

						if($include_dados && $atv_st_venda_cartao != "4"){
  				    $file = mkFileInclude($include_dados_pasta, $include_dados, "md_cad_prop_bd_dados_".$include_dados.".php", "N");
							include $file;
						}
						//******************************************************************************
					}

					if ($nro_modelo == "ZC" || $nro_modelo == "ZN") {
						if (is_array($_FILES) === true && (count($_FILES) > 0)) {
							if($host_documentos){
								$connect_docs = Conecta($host_documentos, $user_documentos, $senha_documentos, $bd_documentos);
							}else{
								print " PARÂMETRO USA_ANEXO == S E DE BANCO DE DADOS (DOCUMENTOS) NÃO PARAMETRIZADO";
								exit;
							}

							/**************************************************************************************************************************************************/
							/******************* ANEXO RECEPTIVO                                           ********************************************************************/
							/**************************************************************************************************************************************************/
							if (count($_FILES) > 0) {
								foreach ($_FILES as $arquivo => $param) {

									if ($param["error"] == 0) {
										//NÃO HOUVE ERRO, O UPLOAD FOI BEM SUCEDIDO
                    $tmp = addslashes(file_get_contents($param["tmp_name"]));

										$q = "INSERT INTO ".$tabela_documentos." (classe_mkpro,tipo, nome, dados, representante,ano_mes,data_cri,hora_cri,login_cri,arq_size,n_pedido) VALUES ('MD".$nro_modelo."','".$param["type"]."', '".$param["name"]."', '".addslashes(file_get_contents($param["tmp_name"]))."', '".$repre_vendedor."','".Date("Ym")."','".Date("Y-m-d")."','".Date("H:i:s")."','".$session["operador"]."','".$param["size"]."','".$flw_id_ativ."')";
										if (mysql_query($q, $connect_docs)) {
											$msg_docs .= "Arquivo <b>".$param["name"]."</b> cadastrado com sucesso!<br>";
											$q_id    = mysql_query("SELECT LAST_INSERT_ID() as protocolo", $connect_docs);
											$rec_id  = mysql_fetch_array($q_id);

											$arr_ext = explode(".",$param["name"]);
											$x_arq   = 0;
											$extesao = "";
											while($arr_ext[$x_arq]) {
												$extesao = $arr_ext[$x_arq];
												$x_arq++;
											}

											if (!$id_arquivos) {
												$id_arquivos .= "DocMK*".str_replace(".".$extesao,"",$param["name"])."|".$extesao."|".$param["size"]."|MD|".$nro_modelo."|".$rec_id["protocolo"]."|".$session["operador"]."|".Date("Y-m-d")."|".Date("H-i-s").":";
											} else {
												$id_arquivos .= str_replace(".".$extesao,"",$param["name"])."|".$extesao."|".$param["size"]."|MD|".$nro_modelo."|".$rec_id["protocolo"]."|".$session["operador"]."|".Date("Y-m-d")."|".Date("H-i-s").":";
											}

											$anexos_associado_atd .= "¢".${"tipo_docto".substr($arquivo,-1)}."=DocMK*".str_replace(".".$extesao,"",$param["name"])."|".$extesao."|".$param["size"]."|MD|".$nro_modelo."|".$rec_id["protocolo"]."|".$session["operador"]."|".Date("Y-m-d")."|".Date("H-i-s");
										} else {
											print mysql_error();
											$msg_docs .= "Não foi possível gravar arquivo <b>".$param["name"]."</b>. (".mysql_error($connect_docs).")<br>";
										}
										unset($tmp);
									} else if ($param["error"] == 1) {
										//O ARQUIVO NO UPLOAD É MAIOR DO QUE O LIMITE DEFINIDO EM UPLOAD_MAX_FILESIZE NO PHP.INI
										$msg_docs .= "O tamanho do arquivo <b>".$param["name"]."</b> é maior que permitido (Tamanho Máximo 2Mb).<br>";
									} else if ($param["error"] == 2) {
										//O ARQUIVO ULTRAPASSA O LIMITE DE TAMANHO EM MAX_FILE_SIZE QUE FOI ESPECIFICADO NO FORMULÁRIO HTML
										$msg_docs .= "O tamanho do arquivo <b>".$param["name"]."</b> é maior que permitido (Tamanho Máximo 2Mb).<br>";
									} else if ($param["error"] == 3) {
										//O UPLOAD DO ARQUIVO FOI FEITO PARCIALMENTE
										$msg_docs .= "Não foi possível completar o upload do arquivo  <b>".$param["name"]."</b>. Tente novamente (3).<br>";
									} else if ($param["error"] == 4) {
										//NÃO FOI FEITO O UPLOAD DO ARQUIVO
									}
								}
								if ($id_arquivos) {
									$id_arquivos = substr($id_arquivos,0,-1);
								}
							}

							if ($flw_arquivo_anexo) {
								if ($id_arquivos) {
									$id_arquivos .= ":".$flw_arquivo_anexo;
								} else {
									$id_arquivos .= $flw_arquivo_anexo;
								}
							}

							if ($id_arquivos) {
								$mtz_up_anexo["anexos"] = trim($id_arquivos);
								FazUpdate($mtz_up_anexo, $tabela_proposta, " WHERE num_prop = '".$matriz_ins["num_prop"]."'", $connectHOST);
							}
						}
					}
					/**************************************************************************************************************************************************/
					/******************* ANEXO RECEPTIVO                                           ********************************************************************/
					/**************************************************************************************************************************************************/

					//********************* Include POS (Douglas) ***********************
					require_once("md_cad_prop_bd_pos.php");
					//*******************************************************************

					break;
				case "2":
				case "3":
				case "4":
				case "6":
				case "7":
				case "8":
				case "9":
					if($prefixo_classe_tema_pai) {
						require_once("md_cad_prop_bd_tema_pai.php");
					}

					//**************************************************************
					//atendimento padrao é antes do update do discador *******************************
					if($atendimento_padrao == "S") {
						$im_prim_nome 		 = strtok($nome_razao, " ");
						$im_prim_nome_agente = strtok($session['usuario'], " ");
				    $file = mkFileInclude($include_dados_pasta, $include_dados, "md_cad_prop_bd_dados_".$include_dados."_".$atv_st_venda_cartao.".php", "N");
						if(file_exists($file)){
							require_once($file);
						}
						require_once("md_cad_prop_bd_dados_atendimento_padrao.php");
					}else{
						//***********************************************************
						//INCLUDE DOS INSERTS DO BD NA TABELA DO PROGRAMA QUE DA O INCLUDE
						//***********************************************************

						if($include_dados && $atv_st_venda_cartao != "4"){
  				    $file = mkFileInclude($include_dados_pasta, $include_dados, "md_cad_prop_bd_dados_".$include_dados."_".$atv_st_venda_cartao.".php", "N");

							include $file;
						}
						//******************************************************************************
					}


					$fez_insert_na_ativo = false;
					if ($agenda_gravacao_normal == "S" && $tipo_atend_co=="4") {//insere na tb_ativo


						//**************************************************************************************
						//**************************************************************************************
						//dados da tabela ativo  que será inserido  ********************************************
						//**************************************************************************************
						//**************************************************************************************

						$matriz_atv["seq"]      = "";

						if ($nro_modelo != "SX" && $nro_modelo != "SD") {
							$matriz_atv["campanha"] = "9999";
						}

						if ($rel_vend_regional) {
							$matriz_atv["vend_login"]         = $rel_vend_login;
							$matriz_atv["vend_regional"]      = $rel_vend_regional;
							$matriz_atv["vend_eps"]           = $rel_vend_eps;
							$matriz_atv["vend_depto"]         = $rel_vend_depto;
						}
						$matriz_atv["flag_ligar"]         = "S";
						$matriz_atv["nb_origem"]          = $matriz_ins["nb_origem"];
						$matriz_atv["grupo_origem"]       = $matriz_ins["grupo_origem"];
						$matriz_atv["campo_chave"]        = $campo_chave;
						$matriz_atv["cpf_cnpj"]           = $cpf_cnpj;
						$matriz_atv["nome_razao"]         = $nome_razao;
						$matriz_atv["data_cri"]           = Date("Y-m-d");
						$matriz_atv["hora_cri"]           = Date("H:i:s");

						$matriz_atv["operador_incompl"]   = "";


						if ($classe_agenda != "") {
							$matriz_atv["classe_recusa"]       = $classe_agenda;
							$matriz_atv["cod_recusa"]          = $cod_recusa_4;
							$matriz_atv["classe_recusa_indic"] = $classe_agenda;
							$matriz_atv["cod_recusa_indic"]    = $cod_recusa_4;
						}

						//tipo escolhido da agenda
						switch($tipo_agenda_dsp) {
							case "dedicado":
								$matriz_atv["st_venda_cartao"]    = "4";
								$matriz_atv["login_operador"]     = $session["operador"];
								$matriz_atv["status"]             = "41";
								break;
							case "finalmailing":
								$matriz_atv["st_venda_cartao"]    = "0";
								$matriz_atv["login_operador"]     = "0";
								$matriz_atv["status"]           = "04";
								$matriz_atv["cod_recusa"]       = "FIM";
								break;
							case "universal":
							case "universal_redireciona":
								$matriz_atv["st_venda_cartao"]    = "0";
								$matriz_atv["login_operador"]     = "0";
								$matriz_atv["status"]             = "02";
								break;
							default:
								$matriz_atv["st_venda_cartao"]    = "4";
								$matriz_atv["login_operador"]     = $session["operador"];
								$matriz_atv["status"]             = "41";
								break;
						}


						$matriz_atv["data_atualiza"]      = Date("Y-m-d");
						$matriz_atv["hora_atualiza"]      = Date("H:i:s");



						$matriz_atv["status_periodo"]     = "A";
						$matriz_atv["status_retorno"]     = "N";
						//$matriz_atv["representante"]      = $repre; comentado por marceo para pegar o repre do param_repre_vendedor do discador selecionado para indicação
						$matriz_atv["representante"]      = $repre_vendedor;
						$matriz_atv["hora_periodo"]       = "";
						$matriz_atv["id_lig"]             = "";
						$matriz_atv["cod_pesquisa"]       = "";
						$matriz_atv["ddd_1"]              = $ddd_1;
						$matriz_atv["fone_1"]             = $fone_1;
						$matriz_atv["ramal_1"]            = $ramal_1;
						$matriz_atv["st_fone_1"]          = "A";
						$matriz_atv["ddd_1_antigo"]       = $ddd_1;
						$matriz_atv["fone_1_antigo"]      = $fone_1;
						$matriz_atv["tiplig_1"]           = "";
						$matriz_atv["try_1"]              = 0;
						$matriz_atv["ddd_2"]              = $ddd_2;
						$matriz_atv["fone_2"]             = $fone_2;
						$matriz_atv["ramal_2"]            = $ramal_2;
						$matriz_atv["st_fone_2"]          = "A";
						$matriz_atv["ddd_2_antigo"]       = $ddd_2;
						$matriz_atv["fone_2_antigo"]      = $fone_2;
						$matriz_atv["tiplig_2"]           = "";
						$matriz_atv["try_2"]              = 0;
						$matriz_atv["ddd_3"]              = $ddd_3;
						$matriz_atv["fone_3"]             = $fone_3;
						$matriz_atv["ramal_3"]            = $ramal_3;
						$matriz_atv["st_fone_3"]          = "A";
						$matriz_atv["ddd_3_antigo"]       = $ddd_3;
						$matriz_atv["fone_3_antigo"]      = $fone_3;
						$matriz_atv["tiplig_3"]           = "";
						$matriz_atv["try_3"]              = "0";
						$matriz_atv["fone_atual"]         = "0";
						$matriz_atv["login_operador_cri"] = $login_cri;
						$matriz_atv["ano_mes"]            = $ano_mes;


						if($usa_bootstrap == "S"){
							$matriz_atv["data_agenda"]        =BDDATE($data_agenda);
						}else{
							$matriz_atv["data_agenda"]        =$ano_agenda."-".$mes_agenda."-".$dia_agenda;
						}
						$matriz_atv["hora_agenda"]        = $hora_agenda.":".$minu_agenda.":00";
						$matriz_atv["observacao"]         = $observacao;

						foreach ($matriz_atv as $key => $valor) {
							if (!$valor) {
								unset($matriz_atv[$key]);
							}
						}
						$msg_insert = FazInsert($matriz_atv, $tabela_ativo, $connectHOST);
						if(substr($msg_insert,0,2) != "OK"){
							print $msg_insert ;
							exit;
						}
						if(!$matriz_atv["campo_chave"]){
							$q       = "SELECT LAST_INSERT_ID() AS id";
							$query   = mysql_query($q, $connectHOST);
							$rec     = mysql_fetch_array($query);
							$AtivNum = $rec["id"];
							$matriz_upag["campo_chave"] = $AtivNum;
							$msg_update = FazUpdate($matriz_upag,$tabela_ativo, "WHERE seq='".$matriz_upag["campo_chave"]."'", $connectHOST);
						}else{
							$msg_update = "OK";
						}
						$fez_insert_na_ativo = true;

						//**************************************************************************************
						//**************************************************************************************
						//**************************************************************************************
						//**************************************************************************************
						//**************************************************************************************
						//**************************************************************************************





					}

					//********************* Include POS (Douglas) ***********************
					require_once("md_cad_prop_bd_pos.php");
					//*******************************************************************

					break;
			}
			break;
		case "FOLLOWUP":
		case "FLW_ATV_S_MAIL":
			include "flw_funcoes.php";

			require_once($_SERVER["DOCUMENT_ROOT"]."/libs/func/FollowUp.php");
			/* Pós Atividade */

			if($isRechamado == "S" && !$flw_tema_pai && $isRechamadoTemaPai) {
			  $flw_tema_pai = $isRechamadoTemaPai;
			}

			$pos_ativ_qtd_dia = ValorClasse("FMPAT", achaNroModelo($nro_modelo,$tipo_abertura), "URANET");
			if (trim($pos_ativ_qtd_dia) == "--") {
				$pos_ativ_qtd_dia = ValorClasse("FMPAT", "DEFAULT", "URANET");
			}
			$pos_ativ_data    = strftime("%Y-%m-%d",mktime(date("H"),date("i"),date("s"),date("m"),(date("d")+$pos_ativ_qtd_dia),date("Y") ));
			$pos_ativ_hora    = date("H:i:s");
			/*                */
			if ($flw_nivel_acesso) {
				$flw_nivel_acesso_atd = $flw_nivel_acesso;
			}

			$mkParamFLW = carregaArrParamFLW(achaNroModelo($nro_modelo,$tipo_abertura), $repre_vendedor);

			if($mkParamFLW["usa_projeto"] == "S") {
				$flwArrCtr = getArrContratoFLW("MD", achaNroModelo($nro_modelo,$tipo_abertura), $repre);
			}

			//*********************************************************************************
			//Colocado a rotina de pedido aqui para poder gravar nos logs do SLA MARCELO
			//*********************************************************************************
			if (empty($_POST["mesmo_cliente_n_pedido"]) === true) {
				if (empty($_POST["lead_n_pedido"]) === true) {
          require_once($_SERVER['DOCUMENT_ROOT']."/libs/func/NPedido.php");
					require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/Conexao.php");
					$ObjConPedido =  new Conexao($host_pedido, $bd_pedido, $user_pedido, $senha_pedido);
					//$n_pedido = getNPedido($param_empresa, "", $ObjConPedido, $tabela_pedido);
					//comentado pois caso nao tenha o pedido parametrizado daria pau..
					// desse jeito nao da pau... vai gravar vazio...
					//$n_pedido = get_numero_pedido($param_empresa);
					$n_pedido = get_numero_pedido($param_empresa, "", $ObjConPedido, $tabela_pedido);
					if($n_pedido === false){
						$n_pedido = "";
					}
				}else{
					$n_pedido = $_POST["lead_n_pedido"];
				}
			} else {
				$n_pedido = $_POST["mesmo_cliente_n_pedido"];
			}
			//*********************************************************************************
			//*********************************************************************************
			//*********************************************************************************

			/**************************************************************************************
			** Pega o ID_LIG das ligações coloca num HIDDEM para manda para prox pagina que grava no bd ***
			*************************************************************************************/
			if ($mk_origem_atd != "") {
			  $servico_dac = $mk_ramal["grupo"];
			  $id_lig = $mk_ramal["id_lig"];
			  $bina_cliente = $mk_ramal["bina_gravacao"];
			  $nome_gravacao = $mk_ramal["nome_gravacao"];
			  $tempo_tot_lig = $mk_ramal["duracao"];
			}else{
  			if (!$servico_dac) {
  				$servico_dac = $mk_ramal["grupo"];
  			}
  			if (!$id_lig) {
  				$id_lig = $mk_ramal["id_lig"];
  			}
  			if (!$bina_cliente) {
  				$bina_cliente = $mk_ramal["bina_gravacao"];
  			}
  			if (!$nome_gravacao) {
  				$nome_gravacao = $mk_ramal["nome_gravacao"];
  			}
  			$tempo_tot_lig = $mk_ramal["duracao"];
			}

			/*************************************************************************************/
			if (empty($info_script_motivo) === false) {
				$info_script_motivo = urldecode(base64_decode($info_script_motivo));
			}
			if (empty($info_script_motivo_cliente) === false) {
				$info_script_motivo_cliente = urldecode(base64_decode($info_script_motivo_cliente));
			}

			$flw_status = "P";
			if ($flw_nivel_acesso == "FA" || $flw_nivel_acesso == "999") { // Finalizando no atendente
				$flw_status          = "F";
				$flw_nivel_acesso    = $flw_user_nivel_acesso; //"999";
				$flw_login_operador  = $session["operador"];   //"SOLICITANTE";
				$campo_ativ_tempo_ok = "ativ_tempo_ok, ";
				$valor_ativ_tempo_ok = "'S',";
				$hora_vecto_ativ     = date("H");
				$min_vecto_ativ      = date("i");
			}

			//     $mkFlwParam = carregaArrParamFLW($nro_modelo,$repre_vendedor,array("FLW_SLA_TIPO","SUB_TEMA"));
			//     $flw_sla_evento_tipo = $mkFlwParam["flw_sla_tipo"];
			//            if ($flw_sla_evento_tipo == "ATIVIDADE") {
			//              $pend_tempo_max_exec = $param_ativ_dt_vecto;
			//            } elseif ($flw_sla_evento_tipo == "AREA") {
			//      $pend_tempo_max_exec = getPermissoes($flw_grupo_acesso."¢".$flw_nivel_acesso, "MD", achaNroModelo($nro_modelo,$tipo_abertura), "TAN");
			//      if ($mkFlwParam["sub_tema"] && $mkFlwParam["sub_tema"] == "S") {
			//          $pend_tempo_max_exec = formataTempoMaxExec($pend_tempo_max_exec, $flw_tema_pai.$flw_tema, $flw_grupo_acesso);
			//      } else {
			//          $pend_tempo_max_exec = formataTempoMaxExec($pend_tempo_max_exec, $flw_tema, $flw_grupo_acesso);
			//      }
			//            } else {
			//              $pend_tempo_max_exec = getPermissoes($flw_grupo_acesso."¢".$flw_nivel_acesso, "MD", achaNroModelo($nro_modelo,$tipo_abertura), "TAN");
			//              $pend_tempo_max_exec = formataTempoMaxExec($pend_tempo_max_exec, $flw_tema, $flw_grupo_acesso);
			//            }
			//
			//$tipo_sla_tema = "T";

			//**************************************************//
			//  CARREGANDO DADOS EVENTO
			//**************************************************//
			$arrParamFLW['SLA_PARAM'             ] = 'SLA_PARAM';
			$arrParamFLW['GRAVA_SOLICITANTE'     ] = 'GRAVA_SOLICITANTE';
			$arrParamFLW['GRAVA_SOLICITANTE_TIPO'] = 'GRAVA_SOLICITANTE_TIPO';
			$arrParamFLW['USA_ATIV_PLATAFORMA'   ] = 'USA_ATIV_PLATAFORMA';
			$arrParamFLW['GRAVA_ANEXO_ATD'       ] = 'GRAVA_ANEXO_ATD';
			$arrParamFLW['SLA_TIME'              ] = 'SLA_TIME';

			$mkFlwParam = carregaArrParamFLW(achaNroModelo($nro_modelo, $tipo_abertura), $repre_vendedor, $arrParamFLW);
			$tipo_sla_tema =str_replace("¢","",$mkFlwParam["sla_param"] );
			if ($tipo_sla_tema) {
				$array_data_hora_ativ_vecto = explode("|", getDataHoraVecto(achaNroModelo($nro_modelo,$tipo_abertura),$flw_grupo_acesso,$flw_tema_pai,$flw_tema,$repre_vendedor,$repre_vendedor,$tipo_sla_tema,$param_ativ_dt_vecto,$flw_nivel_acesso,"EVENTO"));
			} else {
				print "<font class='txtvermelho'><strong>ERRO: FALTA PARAMETRO SLA_PARAM</strong></font><br>";
			}

			//**************************************************//
			//  DADOS EVENTO
			//**************************************************//
			//veio da rotina getDataHoraVecto logo acima
			if($bmg_processo) {
			  $pend_data_vecto = $array_data_hora_ativ_vecto_processo_data;
  			$pend_hora_vecto = $array_data_hora_ativ_vecto_processo_hora;
  			$pend_tempo_max_exec = $array_data_hora_ativ_vecto_processo_timestamp;

  			$str_campos_matriz_ins_flw  .= " , bmg_processo_etapa_data";
				$str_valores_matriz_ins_flw .= " , '".$pend_data_vecto."'";

  			$str_campos_matriz_ins_flw  .= " , bmg_processo_etapa_hora";
				$str_valores_matriz_ins_flw .= " , '".$pend_hora_vecto."'";

  			$str_campos_matriz_ins_flw  .= " , bmg_processo_etapa_tempo";
				$str_valores_matriz_ins_flw .= " , '".$pend_tempo_max_exec."'";

			} else {
			  $pend_data_vecto = $array_data_hora_ativ_vecto[0];
  			$pend_hora_vecto = $array_data_hora_ativ_vecto[1];
  			$pend_tempo_max_exec = $array_data_hora_ativ_vecto[2];
			}

			//**************************************************//
			//  DADOS ATIVIDADE
			//**************************************************//
			//ja esta vindo da rotina getDataHoraVecto montados no md_cad_prop_2.php
			$ativ_data_vecto = $ano_vecto_ativ."-".$mes_vecto_ativ."-".$dia_vecto_ativ;
			$ativ_hora_vecto = $hora_vecto_ativ.":".$min_vecto_ativ.":00";

			$hora_ini  = mktime (date("H"),date("i"), date("s"), date("m"), date("d"), date("Y"));
			$hora_fim  = mktime ($hora_vecto_ativ, $min_vecto_ativ, date("s"), date("m"), date("d"), date("Y"));
			$data_ini  = mktime (date("H"), date("i"), date("s"), date("m"), date("d"),date("Y"));
			$data_fim  = mktime (date("H"), date("i"), date("s"), $mes_vecto_ativ, $dia_vecto_ativ, $ano_vecto_ativ);
			$ativ_tempo_max_exec = ($data_fim - $data_ini) + ($hora_fim - $hora_ini);

			if ($flw_tema_pai) {
				$campo_tema_pai     = " tema_pai, ";
				$valor_tema_pai     = "'".$flw_tema_pai."',";
				$campo_tema_pai_atd = " tema_pai_atd, ";
				$valor_tema_pai_atd = "'".$flw_tema_pai."',";
			}

			$utilizaFiltroTemaPai = trim(ValorClasse("FM".achaNroModelo($nro_modelo,$tipo_abertura)."K", "FILTRA_TEMA_PAI", $repre_flw));
			$descTemaPai     = ValorClassePrint("FM".achaNroModelo($nro_modelo,$tipo_abertura)."T", $flw_tema_pai, $repre_vendedor);
			$filtro_tema_pai = $condicaoVlrClasse;

			if (empty($utilizaFiltroTemaPai) === false && $utilizaFiltroTemaPai != "--" && $utilizaFiltroTemaPai != "N") {
				switch ($filtro_tema_pai) {
					case "ZZ"://produtivo
	          $atv_st_venda_cartao = "1";
						break;

					case "ST"://improdutivo
	          $atv_st_venda_cartao = "2";
						break;

					case "AI"://informativo
	          $atv_st_venda_cartao = "3";
						break;
					default:
					  $atv_st_venda_cartao = "0";
						break;
				}

				$campo_filtro_tema_pai .= " filtro_tema_pai, ";
				$valor_filtro_tema_pai .= "'".$filtro_tema_pai."',";
			}

			// ***********************************************************************************
			// ****** QUANDO UTILIZA A ROTINA NOVA DE ANEXO ATRAVÉS DO flw_retorno_ajax.php ******
			// ***********************************************************************************
			if($usa_rotina_nova_anexo == "S") {
  			foreach ($_POST as $var => $value) {
  			  if($value) {
    				if (substr($var,0,7) == "arquivo") {
        			if (!$id_arquivos) {
        				$id_arquivos .= str_replace(":","-",$value).":";
        			} else {
        				$id_arquivos .= str_replace("DocMK*","",str_replace(":","-",$value)).":";
        			}
      			}
  				}
  			}
  			if ($id_arquivos) {
  			  $id_arquivos = substr($id_arquivos,0,-1);
  			}
			}

      // ***********************************************************************************
			// ****** QUANDO UTILIZA A ROTINA NOVA DE ANEXO ATRAVÉS DO flw_retorno_ajax.php ******
			// ***********************************************************************************

			if ($usa_anexo == "S") {
				$campo_anexos .= " anexos, ";
				$valor_anexos .= "'".$id_arquivos."',";

				$valor_anexos_site .= "'".$id_arquivos;

				if (empty($anexos_site) === false) {
					if (empty($id_arquivos) === false) {
						$valor_anexos_site .= ":".$anexos_site;
					} else {
						$valor_anexos_site .= $anexos_site;
					}
				}

				$valor_anexos_site .= "',";

				if (empty($anexo_solicitado) === false) {
					$campo_tema_pai_ativ = " anexo_solicitado, ";
					$valor_tema_pai_ativ = "'".$anexo_solicitado."',";
				}
			}

			if ($anexo_obrigatorio == "S" || $anexo_obrigatorio == "A") {
				$campo_anexo_ob = " anexo_obrig, ";
				$valor_anexo_ob = "'".$anexo_obrigatorio."',";
			}


			if (empty($tabela_proposta) === true) {
				print "<div align='center'><font class='txtvermelho'><strong>Erro, Tabela Proposta não parâmetrizada. Favor contatar SAC.</strong></font></div>";
				exit;
			}


			/*
			  NOVA FUNÇÃO QUE PEGA A CLASSE FM__A
			*/
			$retParamMotivo = getParamMotivo("MD", achaNroModelo($nro_modelo,$tipo_abertura), "", $flw_tema_pai, $flw_tema, $repre_vendedor, $tipo_busca);

			// colocado a rotina de pegar o pedido antes dos cálculos do SLA para poder logar com o pedido MARCELO
			//      if (empty($_POST["mesmo_cliente_n_pedido"]) === true) {
			//
			//        if(empty($_POST["lead_n_pedido"])==true) {
			//          require_once("funcoes/getNPedido.php");
			//          //$n_pedido = getNPedido($param_empresa);
			//          //comentado pois caso nao tenha o pedido parametrizado daria pau..
			//          // desse jeito nao da pau... vai gravar vazio...
			//          $n_pedido = get_numero_pedido($param_empresa);
			//          if($n_pedido === false){
			//            $n_pedido = "";
			//          }
			//        }else{
			//          $n_pedido = $_POST["lead_n_pedido"];
			//        }
			//      } else {
			//        $n_pedido = $_POST["mesmo_cliente_n_pedido"];
			//      }

			if (empty($_POST["lead_id"]) === false) {
				$campos_lead        = ", lead_id, lead_grupo, lead_mkpro ";
				$campos_lead_insert = ", '".$_POST["lead_id"]."', '".$_POST["lead_grupo"]."', '".$_POST["lead_mkpro"]."'";

				if ($nro_modelo == "BI") {
					$matriz_up_reg_atd["lead_id"   ] = $_POST["lead_id"];
					$matriz_up_reg_atd["lead_grupo"] = $_POST["lead_grupo"];
					$matriz_up_reg_atd["lead_mkpro"] = $_POST["lead_mkpro"];
				}
			}

			if ($anexo_solicitado) {
				$arr_anexo_solicitado = explode("-",$anexo_solicitado);
				$classe_anexo_solicitado = $arr_anexo_solicitado[0];
				$arr_tipo_anexo_solicitado = explode("¢",$arr_anexo_solicitado[1]);

				foreach ($arr_tipo_anexo_solicitado as $key => $value) {
					$arr_tratamento_tipo_anexo_solicitado = explode("=",$value);
					$arr_tipo_result[$arr_tratamento_tipo_anexo_solicitado[0]] = $arr_tratamento_tipo_anexo_solicitado[1];
				}
				$conta_pendentes = 0;
				$conta_opcionais = 0;
				foreach ($arr_tipo_result as $key => $value) {
					if ($value == "O") {
						$conta_opcionais++;
					} elseif ($value == "P") {
						$conta_pendentes++;
					}
				}

				if ($conta_opcionais > 0 && $conta_pendentes == 0) {
					$str_status_anexo = ",status_anexo";
					$str_status_anexo_valor = ",'N'";
				} else {
					$str_status_anexo = ",status_anexo";
					$str_status_anexo_valor = ",'P'";

					//AÇÃO - EXPIRAR OCORRÊNCIA SEM ANEXOS
					if ((is_numeric($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["anexo_qtd_dia_canc"]) === true) && ($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["anexo_qtd_dia_canc"] > 0)) {
						$arr_dthr_exp_ocorrencia = explode("|", getDataHoraVecto(achaNroModelo($nro_modelo, $tipo_abertura), $flw_grupo_acesso, $flw_tema_pai, $flw_tema, $repre_vendedor, $repre_vendedor, $tipo_sla_tema, $param_ativ_dt_vecto, $flw_nivel_acesso, "EXPIRA_ANEXO"));

						$str_status_anexo .= ", anexo_dthr_exp ";
						$str_status_anexo_valor .= ", '".$arr_dthr_exp_ocorrencia[0]." ".$arr_dthr_exp_ocorrencia[1]."' ";
					}
				}
			}

			if ($usa_anexo == "S" && empty($anexos_site) === false) {
				$str_status_anexo = ",status_anexo";
				$str_status_anexo_valor = ",'N'";
			}

			if (empty($status_ouvidoria) === false) {
				$str_status_ouvidoria       = ",status_ouvidoria";
				$str_status_ouvidoria_valor = ",'".$status_ouvidoria."'";
			}

			//INICIALIZA COM HORA ATUAL
			$data_ini_ativ = date("Y-m-d");
			$hora_ini_ativ = date("H:i:s");

			if(!$tema_observacao){
				if($flw_tema_pai){
					$tema_observacao = ValorClasse($flw_tema_pai,$flw_tema,$repre_vendedor);
				}else{
					$tema_observacao = ValorClasse("FM".achaNroModelo($nro_modelo,$tipo_abertura)."T",$flw_tema,$repre_vendedor);
				}
			}

			if (!$flw_login_operador) {
				$flw_login_operador = $flw_login_operador_aux;
			}

			$flw_nivel_acesso = trim($flw_nivel_acesso);
			if (empty($flw_nivel_acesso) === true) {
				require_once("/libs/ctr/AlarmeCTR.php");


				if (empty($flw_nivel_acesso) === true) {
					$msg_alarme .= "******FLW_NIVEL_ACESSO VAZIO******<br><br><br>";
				}
				if (empty($flw_login_operador) === true) {
					$msg_alarme .= "******FLW_LOGIN_OPERADOR VAZIO******<br><br><br>";
				}
				ob_start();
				echo "<pre>";
				var_dump($_GET);
				var_dump($_POST);
				var_dump($_SESSION);
				echo "</pre>";
				$msg_alarme .= ob_get_contents();
				ob_end_clean();

				$matrizOperadoresQG["1"] = "re006200";
				//        $matrizOperadoresQG["2"] = "re002085";
				//$matrizOperadoresQG["3"] = "re003811";
				AlarmeCTR::setAlarmeIntegrAll($matrizOperadoresQG,addslashes($msg_alarme),"N");
			}

			if ($mk_numero == "A8" || $mk_numero == "A9") {
				if (($ativ_tempo_max_exec < "2000000") || (empty($anexo_solicitado) === true && $mk_numero == "A8"))  {
					require_once("/libs/ctr/AlarmeCTR.php");
					foreach ($_GLOBALS as $key => $value) {
						$msg_alarme .= $key." = ".$value."<br>";
					}
					if ($ativ_tempo_max_exec < "2000000") {
						$msg_alarme = "Tempo menos que 2000000 <br><br>".$msg_alarme;
					} else {
						$msg_alarme = "anexo_solicitado (VAZIO) <br><br>".$msg_alarme;
					}
					$matrizOperadoresQG["1"] = "re005215";
					$matrizOperadoresQG["2"] = "fsa";
					$matrizOperadoresQG["3"] = "re002085";
					AlarmeCTR::setAlarmeIntegrAll($matrizOperadoresQG,addslashes($msg_alarme),"N");
				}
			}

			//QG-(EDUARDO 04/12/2009)-PEND_LOGIN_OPERADOR VAZIO
			$flw_login_operador = trim($flw_login_operador);
			if (empty($flw_login_operador) === true) {
				$flw_login_operador = "TODOS";
			}

			if (((empty($botao_finaliza_cliente) === false) && (substr($botao_finaliza_cliente, 0, 1) == "A")) && ($reg_atd_param == 'S')) {//HOJE SOMENTE HONDA
				if (empty($_POST["arr_campos_volta"]["atendimento"]) === true) {
					if (empty($hidden_servico_dac) === false) {
						$servico_dac_update = $hidden_servico_dac;
					} else {
						$servico_dac_update = $mk_ramal["grupo"];
					}
				} else {
					$servico_dac_update = $_POST["arr_campos_volta"]["atendimento"];
				}
				$_POST["arr_campos_volta"]["servico_dac"] = $servico_dac_update;

				$matriz_up_reg_atd["atendimento"] = $arr_campos_volta["atendimento"];
			} else {
				$servico_dac_update = $servico_dac;
			}

			//			print "<pre>";
			//			var_dump($mk_ramal,$servico_dac_update);
			//			exit;

			if (strlen(trim($lead_grupo)) > 0 && $servico_dac_update == "" && substr($lead_grupo, 0, 1) == "E") {
				$aux_lead_grupo = trim(ValorClasse("URAFI", $lead_grupo."M", "URANET"));
				if ($aux_lead_grupo != "--") {
					$servico_dac_update = $lead_grupo."M";
				} else {
					$servico_dac_update = $lead_grupo."E";
				}
				unset($aux_lead_grupo);
			}


			// *******************************************************************************************************************
			// ****************************** ROTINA QUE GRAVA OS CAMPOS EXTRAS DO MOTIVO/SUBMOTIVO ******************************
			// *******************************************************************************************************************
			$mk_cextra_sigla      = "FLWEXTRAPAI".$flw_tema_pai;
			$mk_cextra_classe     = "FM".achaNroModelo($nro_modelo,$tipo_abertura)."C";
			$mk_cextra_sistema_bd = "CC";
			require("rotinas/CamposExtrasBD.php");

			if(is_array($matriz_cextra)){
				foreach ($matriz_cextra as $key_cextra => $value_cextra){
					$str_campos_matriz_ins_flw  .= " , ".$key_cextra;
					$str_valores_matriz_ins_flw .= " , '".$value_cextra."'";
				}
			}
			unset($matriz_cextra);
			$mk_cextra_sigla      = "FLWEXTRA".$flw_tema_pai.$flw_tema;
			$mk_cextra_classe     = "FM".achaNroModelo($nro_modelo,$tipo_abertura)."C";
			$mk_cextra_sistema_bd = "CC";
			require("rotinas/CamposExtrasBD.php");

			if(is_array($matriz_cextra)){
				foreach ($matriz_cextra as $key_cextra => $value_cextra){
					$str_campos_matriz_ins_flw  .= " , ".$key_cextra;
					$str_valores_matriz_ins_flw .= " , '".$value_cextra."'";
				}
			}

			// *******************************************************************************************************************
			// ****************************** ROTINA QUE GRAVA OS CAMPOS EXTRAS DO MOTIVO/SUBMOTIVO ******************************
			// *******************************************************************************************************************

			if(is_array($matriz_ins_flw)){
				foreach ($matriz_ins_flw as $campo_ins_flw=>$value_ins_flw){
					$str_campos_matriz_ins_flw  .= " , ".$campo_ins_flw;
					$str_valores_matriz_ins_flw .= " , '".$matriz_ins_flw[$campo_ins_flw]."'";
				}
			}

			if ($mkFlwParam['grava_solicitante'] == 'S') {
			  if ($mkFlwParam['grava_solicitante_tipo'] == 'DK') {
          $solicitante_ddd = ((empty($_POST['ddd_1']) === false)? $_POST['ddd_1']: ((empty($_POST['ddd_2']) === false)? $_POST['ddd_2']: $_POST['ddd_3']));
          $solicitante_num_tel = ((empty($_POST['fone_1']) === false)? $_POST['fone_1']: ((empty($_POST['fone_2']) === false)? $_POST['fone_2']: $_POST['fone_3']));

			    $str_campos_matriz_ins_flw .= ", ddd_1, fone_1, ddd_2, fone_2, ddd_3, fone_3, agenda_melhor_horario";
				  $str_valores_matriz_ins_flw .= ", '".addslashes($_POST['ddd_1'])."', '".addslashes($_POST['fone_1'])."', '".addslashes($_POST['ddd_2'])."', '".addslashes($_POST['fone_2'])."', '".addslashes($_POST['ddd_3'])."', '".addslashes($_POST['fone_3'])."', '".addslashes("{$_POST['hora_melhor_horario']}:{$_POST['min_melhor_horario']}:00")."'";

			  	//VERIFICANDO SE AS INFORMAÇÕES DE MELHOR HORARIO PARA CONTATO PRECISAM SER ALTERADAS DURANTE A SOLICITAÇÃO
			  	$tmpDataAtual = new DateTime('now');

			  	$tmpAgendaMelhorHorario =  addslashes("{$_POST['hora_melhor_horario']}:{$_POST['min_melhor_horario']}:00");

			  	$dataMelhorHorario = new DateTime($tmpDataAtual->format("Y-m-d {$tmpAgendaMelhorHorario}"));

			  	$tmpProximaData = new DateTime('tomorrow');

			    $str_campos_matriz_ins_flw .= ", agenda_melhor_horario_dthr";

			  	if ($tmpDataAtual > $dataMelhorHorario ) {
				    $str_valores_matriz_ins_flw .= ", '{$tmpProximaData->format('Y-m-d')} {$tmpAgendaMelhorHorario}' ";
			  	} else {
				    $str_valores_matriz_ins_flw .= ", '{$tmpDataAtual->format('Y-m-d')} {$tmpAgendaMelhorHorario}' ";
			  	}
			  }

				$str_campos_matriz_ins_flw .= ", solicitante_nome, solicitante_ddd, solicitante_num_tel, solicitante_email";
				$str_valores_matriz_ins_flw .= ", '".addslashes($solicitante_nome)."', '".addslashes($solicitante_ddd)."', '".addslashes($solicitante_num_tel)."', '".addslashes($solicitante_email)."'";
			}

			$utilizaClassificacaoFinal = trim(ValorClasse("FM".achaNroModelo($nro_modelo,$tipo_abertura)."K", "UTILIZA_CLASSIFICACAO_FINAL", $repre_vendedor));

			if ($utilizaClassificacaoFinal != "--" && $flw_nivel_acesso != "999") {
				$str_campos_matriz_ins_flw .= ", classificacao_final";
				$str_valores_matriz_ins_flw .= ", '".$classificacao_final."'";
			}

			if ($mkFlwParam["usa_ativ_plataforma"] && substr($mkFlwParam["usa_ativ_plataforma"],"0","3") == "ATD") {
				$campo_plataforma = ",plataforma";
				$campo_valor_plataforma = ",'".$ativ_plataforma."'";
			}

			if ((empty($botao_finaliza_cliente) === false) && (substr($botao_finaliza_cliente, 0, 1) == "A")) {
				$campo_reg_atd = ", reg_atd_canal, reg_atd_grupo";
				$campo_valor_reg_atd = ", '".$reg_atd_canal."', '".$reg_atd_grupo."'";
			}

			//AVALIAÇÃO DE  OCORRENCIA
			if ($retParamMotivo["T,".$flw_tema_pai.$flw_tema]['avalia_tema'] != 'N') {
				$campo_avalia_ocorrencia = ", avalia_flag ";
				$campo_valor_avalia_ocorrencia = ", '".$retParamMotivo["T,".$flw_tema_pai.$flw_tema]["avalia_tema"]."' ";
			}

			//PERMISSÃO DE VISUALIZACAO DE OCORRÊNCIA
			if (empty($retParamMotivo['T,'.$flw_tema_pai.$flw_tema]['visualizacao_tema']) === false ) {
				$campo_visualizacao_tema = ', visualizacao_tema ';
				$campo_valor_visualizacao_tema = ", '{$retParamMotivo['T,'.$flw_tema_pai.$flw_tema]['visualizacao_tema']}' ";
			}

			//PERMISSÃO DE VISUALIZACAO DE EVENTO
			if (empty($retParamMotivo['T,'.$flw_tema_pai.$flw_tema]['visualizacao_evento']) === false ) {
				$campo_visualizacao_evento = ', visualizacao_evento ';
				$campo_valor_visualizacao_evento = ", '{$retParamMotivo['T,'.$flw_tema_pai.$flw_tema]['visualizacao_evento']}' ";
			}

      //CLASSIFICAÇÃO DE OCORRÊNCIA

      /*******************************************************/
      /* SU90431 - PARA CASO COMEÇE A EXISTIR O PARAMETRO NA TABELA CLASSIFICAÇÃO */
      /* NÃO DEIXAR CLASSIFICAR OPERAÇÕES QUE ANTES NÃO FAZIA ESTA FUNÇÃO */
      /*******************************************************/
      ValorClasse(
        ValorClasse("FM".achaNroModelo($nro_modelo,$tipo_abertura)."K", "CLASSIFICA_CLASSE_PAI", $repre_vendedor),
        $retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica"],
        $repre
      );

      global $condicaoVlrClasse;
      $isClassificacaoComDetalhe = ($condicaoVlrClasse == "CM");

      /*******************************************************/
      /* SU90431**/
      /*******************************************************/


      //classifica_classe_pai

			if ( (empty($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica"]) === false && (strlen($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica"]) == 5)) && ( !verificaValidaVersao("SU90431") && $isClassificacaoComDetalhe ) == false ) {
				$campo_classifica_classe = ", classifica_classe, classifica_codigo, classifica_data, classifica_hora, classifica_login, classifica_data_fim, classifica_hora_fim ";
				$classifica_codigo = "000";
				$classifica_data_fim = "1111-11-11";
				$classifica_hora_fim = "00:00:00";
				if(((ValorClasse("FM".achaNroModelo($nro_modelo,$tipo_abertura)."K", "CLASSIFICA_VERSAO", $repre_vendedor) == "V2") && $retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica_versao"])) {
					$classifica_codigo = $retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica_versao"];
					$arr_data_vecto = explode("|", getDataHoraVecto(achaNroModelo($nro_modelo, $tipo_abertura), $flw_grupo_acesso, $flw_tema_pai, $flw_tema, $repre_vendedor, $repre_vendedor, $tipo_sla_tema, $param_ativ_dt_vecto, $flw_nivel_acesso, "EXPIRA_FUP"));
					$classifica_data_fim = $arr_data_vecto[0];
					$classifica_hora_fim = $arr_data_vecto[1];
				}
				$campo_valor_classifica_classe = ", '".$retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica"]."', '".$classifica_codigo."', '".date("Y-m-d")."', '".date("H:i:s")."', '".$_SESSION["session"]["operador"]."', '".$classifica_data_fim."', '".$classifica_hora_fim."' ";
			}

			$flw_nivel_acesso_ant   = $flw_nivel_acesso;
			$flw_login_operador_ant = $flw_login_operador;

			if($flw_nivel_acesso == "SOL") {
				$flw_nivel_acesso_ant   = $flw_nivel_acesso;
				$flw_login_operador_ant = $flw_login_operador;

				$flw_permissoes         = explode("¢", getPermissoes($session["operador"], "MD", achaNroModelo($nro_modelo,$tipo_abertura), "T", $flw_grupo_acesso));
				$flw_nivel_acesso       = $flw_permissoes[1];

				if($flw_login_operador == "SOLICITANTE") {
					$flw_login_operador     = $session["operador"];
				}

			}

			if (empty($flw_tema_pai) === true) {
				print "<div align='center'><font class='txtvermelho'><strong>Erro: Não foi possível carregar o Motivo. Favor Refazer a Transação.</strong></font></div><pre>";
				exit;
			}

			if(substr($session["representante"],0,7) == "TRACKER" || substr($session["representante"],0,6) == "ZURICH") {
				if(empty($flw_tema) === true) {
					require_once("/libs/ctr/AlarmeCTR.php");
					ob_start();
					echo "<pre>";
					var_dump($_GET);
					var_dump($_POST);
					var_dump($_SESSION);
					echo "</pre>";
					$msg_alarme .= ob_get_contents();
					ob_end_clean();

					unset($matrizOperadoresQG);
					$matrizOperadoresQG["1"] = "re006200";
					AlarmeCTR::setAlarmeIntegrAll($matrizOperadoresQG,addslashes($msg_alarme),"N");
					//          print "<div align='center'><font class='txtvermelho'><strong>Erro: Não foi possível carregar o Sub-Motivo. Favor Refazer a Transação(".$flw_tema_pai."|".$flw_nivel_acesso."|".achaNroModelo($nro_modelo,$tipo_abertura).").</strong></font></div>";
					//          exit;
				}
			}

			if($tema_pai == "F6I02" && $tema != "001" && $tema != "002" && $tema != "003" && $ativ_data_vecto == date("Y-m-d")) {
				require_once("/libs/ctr/AlarmeCTR.php");
				ob_start();
				echo "<pre>";
				var_dump($_GET);
				var_dump($_POST);
				var_dump($_SESSION);
				echo "</pre>";
				$msg_alarme .= ob_get_contents();
				ob_end_clean();

				unset($matrizOperadoresQG);
				$matrizOperadoresQG["1"] = "re006200";
				AlarmeCTR::setAlarmeIntegrAll($matrizOperadoresQG,addslashes($msg_alarme),"N");
			}

			if(empty($flw_nivel_acesso) === true) {
				print "<div align='center'><font class='txtvermelho'><strong>Erro: Não foi possível carregar o Setor. Favor Refazer a Transação.</strong></font></div>";
				exit;
			}

			if(empty($flw_login_operador) === true) {
				print "<div align='center'><font class='txtvermelho'><strong>Erro: Não foi possível carregar o Usuário. Favor Refazer a Transação.</strong></font></div>";
				exit;
			}

			if($usa_repre_vendedor == "S") {
				$repre_grava = $repre_vendedor;
			} else {
				$repre_grava = $session["representante"];
			}

			try {
				if (((substr($repre_vendedor, 0, 5) == 'HONDA') || (substr($repre_vendedor, 0, 7) == 'BMC-QUA')) && (!verificaValidaVersao("SU90431"))) {
					$mk_num_dupli = achaNroModelo($nro_modelo,$tipo_abertura);

					$q_dupli = "SELECT ATV.ativ_num AS ativ_num, ATV.mk_flag AS mk_flag, ATV.mk_numero AS mk_numero, ATV.grupo_acesso AS grupo_acesso, ATV.ativ_num AS ativ_num, ATV.tema AS tema, ATV.tema_pai AS tema_pai, EVE.even_num AS even_num, EVE.descricao AS descricao FROM {$tabela_proposta} AS ATV LEFT JOIN {$tabela_historico} AS EVE ON ATV.mk_flag = EVE.mk_flag AND ATV.mk_numero = EVE.mk_numero AND ATV.grupo_acesso = EVE.grupo_acesso AND ATV.ativ_num = EVE.ativ_num AND ATV.tema_pai = EVE.tema_pai AND ATV.tema = EVE.tema AND  EVE.even_num = '1' WHERE ATV.mk_flag = 'MD' AND ATV.mk_numero = '{$mk_num_dupli}' AND ATV.grupo_acesso = '{$flw_grupo_acesso}' AND ATV.tema_pai = '{$flw_tema_pai}' AND ATV.tema = '{$flw_tema}' AND ATV.n_pedido = '{$n_pedido}'";
					if ($rec_dupli = DescExecQuery($q_dupli, $connectHOST, "N")) {
            $count = mysql_num_rows($rec_dupli);
						if  ($count > 0) {
							if (is_null($rec['even_num'])) {
								//DELETAR REGISTRO
								//PROGRAMA SEGUE NORMALMENTE E PERMITE INCLUSÃO DE NOVA OCORRÊNCIA
								$connHOST->query(
									"DELETE FROM {$tabela_proposta}
									WHERE mk_flag = '{$rec['mk_flag']}' AND  mk_numero = '{$rec['mk_numero']}' AND grupo_acesso = '{$rec['grupo_acesso']}' AND ativ_num = '{$rec['ativ_num']}'"
								);
								throw new Exception("|Ocorrência incompleta foi deletada.|{$q_dupli}", 1);

							} else {
								$ctrl_duplicidade = false;
								$rec = mysql_fetch_array($rec_dupli);
								$flw_id_ativ  = $rec['ativ_num'];
								$campo_passa1 = $rec['ativ_num'];
								throw new Exception("{$count}|Ocorrência duplicada|{$q_dupli}", 1);
							}

						}
					}
				}

			} catch (Exception $e) {
				if (substr($repre_vendedor,0,5) == 'HONDA') {
					$errorHandler->gravarLogErro($e);
				}
      }


			//SEMPRE DEVEMOS GRAVAR ESTA INFORMAÇÃO SOBRE A EXPIRAÇÃO AUTOMÁTICA DO ANEXO
			if (substr($repre_vendedor, 0, 5) == 'HONDA') {
  			$flagCancAutoOco = ((($retParamMotivo["T,{$flw_tema_pai}{$flw_tema}"]['possui_anexo_obrigatorio'] == 'S') && ($retParamMotivo["T,{$flw_tema_pai}{$flw_tema}"]['anexo_qtd_dia_canc'] > 0))? 'S':'N');
  			$str_status_anexo .= ', anexo_auto_exp';
  			$str_status_anexo_valor .= ", '{$flagCancAutoOco}'";
			}

      if(!$data_cri_oco) {
        $data_cri_oco = date("Y-m-d");
      } else {

        $arr_aux1 = explode("-",$ativ_data_vecto);
        $arr_aux3 = explode(":",$ativ_hora_vecto);

        $arr_aux2 = explode("-",$data_cri_oco);
        $arr_aux4 = explode(":",$hora_cri_oco);

        $data_ini  = mktime ($arr_aux4[0], $arr_aux4[1], $arr_aux4[2], $arr_aux2[1], $arr_aux2[2], $arr_aux2[0]);
        $data_fim  = mktime ($arr_aux3[0], $arr_aux3[1], $arr_aux3[2], $arr_aux1[1], $arr_aux1[2], $arr_aux1[0]);

        $ativ_tempo_max_exec = ($data_fim - $data_ini);

      }

      if(!$hora_cri_oco) {
        $hora_cri_oco = date("H:i:s");
      }

      if($ativ_tempo_max_exec < 0) {
        $data_ini  = mktime (date("H"), date("i"), date("s"), date("m"), date("d"),date("Y"));
        $data_fim  = mktime (substr($ativ_hora_vecto,0,2), substr($ativ_hora_vecto,3,2), substr($ativ_hora_vecto,6,2), substr($ativ_data_vecto,5,2), substr($ativ_data_vecto,8,2), substr($ativ_data_vecto,0,4));
        $ativ_tempo_max_exec = ($data_fim - $data_ini);
      }

      if(achaNroModelo($nro_modelo,$tipo_abertura) == "YB") {

        if(!$cod_nivel_ci_1 || !$cpf_cnpj) {
          print "<font class='txtvermelho2'>NÃO FOI POSSÍVEL CARREGAR O CPF/CANAL DE ATENDIMENTO, REALIZE NOVAMENTE ESTÁ OPERAÇÃO</font>";
	        exit;
        }

      }

        $str_campos_matriz_ins_flw .= ", data_receb_area";
  			$str_valores_matriz_ins_flw .= ", '".date("Y-m-d")."'";
        $str_campos_matriz_ins_flw .= ", hora_receb_area";
  			$str_valores_matriz_ins_flw .= ", '".date("H:i:s")."'";

  		if(achaNroModelo($nro_modelo,$tipo_abertura) == "YB") {
  			$campo_ins_even .= "n_pedido,";
				$valor_ins_even .= "'".$n_pedido."',";

				if ($flw_status == "F") { // Insere as tabelas histórico FCR no BMG Atendimento
					$tabela_proposta  = $tabela_proposta."_fcr_".date("ym");
					$tabela_historico = $tabela_historico."_fcr_".date("ym");
				}

  		}

      if ($flw_status == "F") { // Finalizando no atendente
        $str_campos_matriz_ins_flw .= ", data_conclusao_ativ";
  			$str_valores_matriz_ins_flw .= ", '".date("Y-m-d")."'";
        $str_campos_matriz_ins_flw .= ", hora_conclusao_ativ";
  			$str_valores_matriz_ins_flw .= ", '".date("H:i:s")."'";
      }
      //

			if(!$bmg_processo) {// DEPOIS ADICIONADO O 1==1 PARA TODOS OS CLIENTES ENTRAREM NA CONDIÇÃO E LEVAR O SLA DO ENVENTO IGUAL AO DA ATIVIDADE
				$pend_tempo_max_exec = $ativ_tempo_max_exec;
				$pend_data_vecto     = $ativ_data_vecto;
				$pend_hora_vecto     = $ativ_hora_vecto;
			}

      if ($flw_status == "F") {
        //AJUSTE DA GRAVAÇÃO DO TEMPO DE EXECUÇÃO (SOMENTE QUANDO FINALIZA NO ATENDENTE)
        $data_ini_ativ = $ativ_data_vecto;
        $hora_ini_ativ = $ativ_hora_vecto;

        $ativ_tempo_max_exec = 0;
        $pend_tempo_max_exec = $ativ_tempo_max_exec;

        if ($cmbMotivoEncerramento) {// Finalizando no atendente
          $str_campos_matriz_ins_flw .= ", motivo_encerramento";
          $str_valores_matriz_ins_flw .= ", '".$cmbMotivoEncerramento."'";
        }

      } else {
        if ($mkParamFLW["sla_time"] != " -- ") {
          $array_param_sla_time = explode("¢",$mkParamFLW["sla_time"]);
          if (is_array($array_param_sla_time) === true) {
            if ($nro_modelo != "XN" && ($array_param_sla_time[0] == "FIM_EXPEDIENTE" || $array_param_sla_time[0] == "HORA_UTIL")) {
              //QUANDO O PARAMETRO E O DE FIM DO EXPEDIENTE NÃO PRECISAMOS TROCAR O SLA PORQUE ESTE SEMPRE SERÁ O DO FIM DO EXPEDIENTE
//              $ativ_hora_vecto = $array_param_sla_time[1];
//              $pend_hora_vecto = $array_param_sla_time[1];
//              $ativ_tempo_max_exec = mktime (substr($ativ_hora_vecto,0,2), substr($ativ_hora_vecto,3,2), substr($ativ_hora_vecto,6,2), substr($ativ_data_vecto,5,2), substr($ativ_data_vecto,8,2), substr($ativ_data_vecto,0,4))-mktime (date("H"), date("i"), date("i"), date("m"), date("d"),date("Y"));
            } else {
              $vecto_correto   = mktime (date("H"), date("i"), date("s")+$ativ_tempo_max_exec, date("m"), date("d"),date("Y"));
              $ativ_data_vecto = date("Y-m-d", $vecto_correto);
              $ativ_hora_vecto = date("H:i:s", $vecto_correto);
              $pend_data_vecto = $ativ_data_vecto;
              $pend_hora_vecto = $ativ_hora_vecto;
              $data_cri_oco    = date("Y-m-d");
              $hora_cri_oco    = date("H:i:s");
            }
          }
        }
			}

			//Vinícius Cunha -  rotina para realizar INSERT com os campos específicos
      $file = mkFileInclude($include_dados_pasta, $include_dados, "md_cad_prop_bd_dados_".$include_dados."_pre_inclusao.php", "N");

			if(file_exists($file)){
			  require_once($file);
			}
			//Vinícius Cunha -  rotina para realizar INSERT com os campos específicos

			if ($ctrl_duplicidade === true) {
				$Dados = "INSERT INTO $tabela_proposta (".
				"mk_flag, ".
				"mk_numero, ".
				"grupo_acesso, ".
				"atd_nivel_acesso, ".
				"pend_nivel_acesso, ".
				"pend_login_operador, ".
				"pend_data_vecto, ".
				"pend_hora_vecto, ".
				"origem_nivel_acesso, ".
				"origem_login_operador, ".
				"login_operador, ".
				"ano_mes_cri, ".
				"data_cri, ".
				"hora_cri, ".
				"ano_mes_atu, ".
				"data_atualiza, ".
				"hora_atualiza, ".
				"login_atualiza, ".
				"ativ_data_vecto, ".
				"ativ_hora_vecto, ".
				"ativ_tempo_max_exec, ".
				"representante, ".
				"equipe, ".
				"bina_cliente, ".
				"tempo_tot_lig, ".
				"id_lig, ".
				"nome_gravacao, ".
				"servico_dac, ".
				"status, ".
				"pos_ativ_data_agenda, ".
				"pos_ativ_hora_agenda, ".
				"pos_ativ_status, ".
				"tema, ".
				"tema_atd, ".
				"dk_campanha, ".
				"dk_mkpro, ".
				"dk_campo_chave, ".
				$campo_tema_pai.
				$campo_tema_pai_atd.
				$campo_filtro_tema_pai.
				$campo_anexos.
				$campo_anexo_ob.
				$campo_ativ_tempo_ok.
				$campo_mk_origem.
				$campo_flw_mk_coleta_campos.
				$campo_tema_pai_ativ.
				"prioridade, ".
				"codigo_contrato, ".
				"tema_observacao, ".
				"n_pedido".
				$campos_lead.
				", email_id, data_ini_ativ, hora_ini_ativ".
				$str_status_anexo.
				$str_status_ouvidoria.
				$str_campos_matriz_ins_flw.
				$campo_plataforma.
				", ".
				"qtd_evento".
				$campo_reg_atd.
				$campo_classifica_classe.
				$campo_avalia_ocorrencia.
				$campo_visualizacao_tema.
				$campo_visualizacao_evento.
				") VALUES (".
				"'MD', ".
				"'".achaNroModelo($nro_modelo,$tipo_abertura)."', ".
				"'".$flw_grupo_acesso        ."', ".
				"'".$flw_user_nivel_acesso   ."', ".
				"'".$flw_nivel_acesso        ."', ".
				"'".$flw_login_operador      ."', ".
				"'".$pend_data_vecto         ."', ".
				"'".$pend_hora_vecto         ."', ".
				"'".$flw_user_nivel_acesso   ."', ".
				"'".$session["operador"]     ."', ".
				"'".$session["operador"]     ."', ".
				"'".date("Ym")               ."', ".
				"'".$data_cri_oco            ."', ".
				"'".$hora_cri_oco            ."', ".
				"'".date("Ym")               ."', ".
				"'".$data_cri_oco            ."', ".
				"'".$hora_cri_oco            ."', ".
				"'".$session["operador"]     ."', ".
				"'".$ativ_data_vecto         ."', ".
				"'".$ativ_hora_vecto         ."', ".
				"'".$ativ_tempo_max_exec     ."', ".
				"'".$repre_grava			       ."', ".
				"'".$session["equipe"]       ."', ".
				"'".$bina_cliente            ."', ".
				"'".$tempo_tot_lig           ."', ".
				"'".$id_lig                  ."', ".
				"'".$nome_gravacao           ."', ".
				"'".$servico_dac_update      ."', ".
				"'".$flw_status              ."', ".
				"'".$pos_ativ_data           ."', ".
				"'".$pos_ativ_hora           ."', ".
				"'P"                         ."', ".
				"'".$flw_tema                ."', ".
				"'".$flw_tema                ."', ".
				"'".$dk_campanha             ."', ".
				"'".$lead_mkpro              ."', ".
				"'".$dk_campo_chave          ."', ".
				$valor_tema_pai.
				$valor_tema_pai_atd.
				$valor_filtro_tema_pai.
				$valor_anexos_site.
				$valor_anexo_ob.
				$valor_ativ_tempo_ok.
				$vlr_mk_origem.
				$vlr_flw_mk_coleta_campos.
				$valor_tema_pai_ativ.
				"'".$flw_prioridade         ."', ".
				"'".$flwArrCtr["codigo"]    ."', ".
				"'".$tema_observacao        ."', ".
				"'".$n_pedido           ."'".
				$campos_lead_insert.", '".$mk_email_id."', '".$data_ini_ativ."', '".$hora_ini_ativ."'".
				$str_status_anexo_valor.
				$str_status_ouvidoria_valor.
				$str_valores_matriz_ins_flw.
				$campo_valor_plataforma.
				",";
				if (empty($anexos_site) === false && $usa_anexo == "S" && empty($anexo_solicitado) === false) {
					$Dados .= "'2'";
				} else {
					$Dados .= "'1'";
				}
				$Dados .=
				$campo_valor_reg_atd.
				$campo_valor_classifica_classe.
				$campo_valor_avalia_ocorrencia.
				$campo_valor_visualizacao_tema.
				$campo_valor_visualizacao_evento.
				")";

				DescExecQuery($Dados, $connectHOST, "N");
				if (mysql_error($connectHOST)) {
					print "Você tem um erro de SQL<br><br>";
					print mysql_error($connectHOST);
					print "<br><br>".$Dados;
					exit;
				}

				$flw_id_ativ  = mysql_insert_id($connectHOST);
				$campo_passa1 = mysql_insert_id($connectHOST);

				if (empty($tabela_historico) === true) {
					print "<div align='center'><font class='txtvermelho'><strong>Erro, tabela histórico não parâmetrizada. Favor contatar SAC.</strong></font></div>";
					exit;
				}


  $string_codigo = "##MD".$nro_modelo.$n_pedido."|".$flw_id_ativ."##";

  /* ------------------------------------------ */
  /* ROTINA PARA PASSAR CAMPOS PARA A LOG_URA T */
  /* ------------------------------------------ */

    require_once($_SERVER["DOCUMENT_ROOT"]."/libs/ctr/LUTbCompl.php");

    $objLU = new luTbCompl($id_lig);

    $matrizLU["bina"]             = $bina_cliente;
    $matrizLU["cod_motivo"]       = $flw_status;
    $matrizLU["classe_motivo"]    = "GW".$nro_modelo."3";
    $matrizLU["cod_submotivo"]    = $flw_tema_pai;
    $matrizLU["classe_submotivo"] = "FM".$nro_modelo."T";
    $matrizLU["representante"]    = $repre_grava;
    $matrizLU["classe_mkpro"]     = "MD".$nro_modelo;
    $matrizLU["numero_chave"]     = $flw_id_ativ;
    $matrizLU["nome_razao"]       = $tema_observacao;
    $matrizLU["cpf_cnpj"]         = "";
    $matrizLU["campanha"]         = "FLW";
    $matrizLU["cmp_extra_1"]      = $flw_grupo_acesso;
    $matrizLU["cmp_extra_2"]      = $LU_cmp_extra_2;
    $matrizLU["cmp_extra_3"]      = $LU_cmp_extra_3;
    $loguraT = $objLU->insere($id_lig, $nome_gravacao, $matrizLU);

    if($loguraT === false){
      print $objLU->descRetorno;
      exit;
    }
    unset($matrizLU);

  /* ----------------------------------------   */
  /* ROTINA PARA PASSAR CAMPOS PARA A LOG_URA T */
  /* ----------------------------------------   */







				//      if ((achaNroModelo($nro_modelo,$tipo_abertura) == "H8" || achaNroModelo($nro_modelo,$tipo_abertura) == "BT" || achaNroModelo($nro_modelo,$tipo_abertura) == "BH" || achaNroModelo($nro_modelo,$tipo_abertura) == "HC" || achaNroModelo($nro_modelo,$tipo_abertura) == "BI" || achaNroModelo($nro_modelo,$tipo_abertura) == "BF" || achaNroModelo($nro_modelo,$tipo_abertura) == "GH" || achaNroModelo($nro_modelo,$tipo_abertura) == "OI") && ($ativ_data_vecto == date("Y-m-d"))) {
				//        require_once("/libs/ctr/AlarmeCTR.php");
				//        $msg_alarme  = "Erro na Gravação do SLA da Honda<br> mk_numero:".achaNroModelo($nro_modelo,$tipo_abertura)." ativ_num(Ocorrencia): ".$flw_id_ativ;
				//        $msg_alarme .= " ativ_tempo_max_exec: ".$ativ_tempo_max_exec." <br> ";
				//        $msg_alarme .= " ativ_tempo_max_exec do if: ".$ativ_tempo_max_exec." <br> ";
				//        $msg_alarme .= " ativ_tempo_max_exec do if Novo: ".$ativ_tempo_max_exec_novo." <br> ";
				//        $msg_alarme .= " ativ_data_vecto: ".$ativ_data_vecto." <br> ";
				//        $msg_alarme .= " ativ_hora_vecto: ".$ativ_hora_vecto." <br> ";
				//
				//        $matrizOperadoresQG["1"] = "re006200";
				//        AlarmeCTR::setAlarmeIntegrAll($matrizOperadoresQG,addslashes($msg_alarme),"N");
				//      }

				//HONDA-U
				//VERIFICANDO SE FOI ENVIADO UM E-MAIL ESPECIFICO DURANTE A ABERTURA DA OCORRÊNCIA
				//EM CASO POSITIVO IREMOS GRAVAR O ID DO E-MAIL NO EVENTO DA OCORRÊNCIA
				$Dados = "INSERT INTO $tabela_historico (".
				"mk_flag,".
				"mk_numero,".
				"grupo_acesso,".
				"ativ_num,".
				"pend_nivel_acesso,".
				"pend_login_operador,".
				"pend_data_vecto,".
				"pend_hora_vecto,".
				"pend_tempo_max_exec,".
				"origem_nivel_acesso,".
				"origem_login_operador,".
				"ano_mes_cri,".
				"data_cri,".
				"hora_cri,".
				"ano_mes_atu,".
				"data_atualiza,".
				"hora_atualiza,".
				"login_atualiza,".
				"representante,".
				"status,".
				"tema,".
				$campo_tema_pai.
				$campo_anexos.
				$campo_tema_pai_ativ.
				$campo_ins_even.
				"descricao,email_id".
				") VALUES (".
				"'MD"                          ."',".
				"'".achaNroModelo($nro_modelo, $tipo_abertura)  ."',".
				"'".$flw_grupo_acesso          ."',".
				"'".$flw_id_ativ               ."',".
				"'".$flw_nivel_acesso          ."',".
				"'".$flw_login_operador        ."',".
				"'".$pend_data_vecto           ."',".
				"'".$pend_hora_vecto           ."',".
				"'".$pend_tempo_max_exec       ."',".
				"'".$flw_user_nivel_acesso     ."',".
				"'".$session["operador"]       ."',".
				"'".date("Ym")                 ."',".
				"'".date("Y-m-d")              ."',".
				"'".date("H:i:s")              ."',".
				"'".date("Ym")                 ."',".
				"'".date("Y-m-d")              ."',".
				"'".date("H:i:s")              ."',".
				"'".$session["operador"]       ."',".
				"'".$repre_grava  			       ."',".
				"'".$flw_status                ."',".
				"'".$flw_tema                  ."',".
				$valor_tema_pai.$valor_anexos.
				$valor_tema_pai_ativ.
				$valor_ins_even.
				"'".addslashes($flw_descricao) ."',".
				"'".$mk_email_id."')";

				DescExecQuery($Dados, $connectHOST, "N");
				if(mysql_error($connectHOST)){
					print "Você tem um erro de SQL<br><br>";
					print mysql_error($connectHOST);
					print "<br><br>".$Dados;
					$qDelFlw = "DELETE FROM ".$tabela_proposta." WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'";
					mysql_query($qDelFlw, $connectHOST);
					exit;
				}

				$flw_id_even = mysql_insert_id($connectHOST);

				//*************************************************
				//*******TRATAMENTO DO CLASSIFICA VERSÃO VINI******
				//*************************************************
				if (empty($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica"]) === false && (strlen($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica"]) == 5)) {
					if((ValorClasse("FM".achaNroModelo($nro_modelo,$tipo_abertura)."K", "CLASSIFICA_VERSAO", $repre_vendedor) == "V2") && $retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica_versao"]) {
						if(DescExecQuery($Dados, $connectHOST, "N")) {
							$flw_id_even_versao = mysql_insert_id($connectHOST);
							global $titVlrClasse;
							ValorClasse($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica"], $classifica_codigo, $repre, true);
							$texto = "<font class='txt5azul'><strong>".$titVlrClasse."</strong></font>\n".
							"<strong>DE.....: </strong>...\n".
							"<strong>PARA: </strong>".ValorClasse($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["cod_classe_classifica"], $classifica_codigo, $session["representante"], true)."\n";
							$arrUpVersaoEven["pend_data_vecto"    ] = $classifica_data_fim;
							$arrUpVersaoEven["pend_hora_vecto"    ] = $classifica_hora_fim;
							$arrUpVersaoEven["pend_tempo_max_exec"] = $arr_data_vecto[2];
							$arrUpVersaoEven["descricao"          ] = addslashes($texto);
							$arrUpVersaoEven["tarefa_projeto"     ] = "S";
							$arrUpVersaoEven["anexo_associado"    ] = "S";
							if(achaNroModelo($nro_modelo,$tipo_abertura) == "ZL") {
								$arrUpVersaoProp["pend_logins_tarefa"  ] = "|".$session["operador"]."¢S|";
								$arrUpVersaoEven["pend_login_operador"] = $session["operador"];
							} else {
								$arrUpVersaoProp["pend_logins_tarefa"  ] = "|SETOR=".$flw_nivel_acesso."¢S|";
								$arrUpVersaoEven["pend_login_operador"] = "TODOS";
							}
							FazUpdate($arrUpVersaoProp, $tabela_proposta,  " WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'", $connectHOST);
							FazUpdate($arrUpVersaoEven, $tabela_historico, " WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."' AND even_num = '".$flw_id_even_versao."'", $connectHOST);
						}
					}
				}
			//*************************************************
			//*******TRATAMENTO DO CLASSIFICA VERSÃO VINI******
			//*************************************************

			//*************************************************
			//**********TRATAMENTO DO RECHAMADO VINI***********
			//*************************************************
				//$utilizaRechamado = trim(ValorClasse("FM".achaNroModelo($nro_modelo,$tipo_abertura)."K", "UTILIZA_RECHAMADO", $repre_vendedor));
				if(($pesqRechamado == "S" || $pesqRechamado == "J") && $ativNumRechamado) {
					// *** RECHAMADO ORIGEM *** //

					$campo_tabela = $pesqRechamado == "S" ? "rechamado" : "reincidencia";
					$status_acao  = $pesqRechamado == "S" ? "RH" : "RX";

					// UPDATE OCORRENCIA ORIGEM
					$UpdRechamado = "UPDATE ".$tabela_proposta." SET data_atualiza = '".date("Y-m-d")."', hora_atualiza = '".date("H:i:s")."', login_atualiza = '".$session["operador"]."', ".$campo_tabela."_origem = 'S', ".$campo_tabela."_origem_qtd = ".$campo_tabela."_origem_qtd+1, ".$campo_tabela."_origem_ativ_num = CONCAT(".$campo_tabela."_origem_ativ_num,'".$flw_id_ativ."§') WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$ativNumRechamado."'";
					if(DescExecQuery($UpdRechamado, $connectHOST, "N")) {
						// INSERT EVENTO OCORRENCIA ORIGEM
						$Dados = "INSERT INTO ".$tabela_historico."(".
						"mk_flag,".
						"mk_numero,".
						"grupo_acesso,".
						"ativ_num,".
						"nome_gravacao,".
						"email_id,".
						"pend_nivel_acesso,".
						"pend_login_operador,".
						"pend_data_vecto,".
						"pend_hora_vecto,".
						"pend_tempo_max_exec,".
						"origem_nivel_acesso,".
						"origem_login_operador,".
						"ano_mes_cri,".
						"data_cri,".
						"hora_cri,".
						"ano_mes_atu,".
						"data_atualiza,".
						"hora_atualiza,".
						"login_atualiza,".
						"representante,".
						"status,".
						"tema,".
						$campo_tema_pai.
						$campo_tema_pai_ativ.
						"descricao,status_acao".
						") VALUES (".
						"'MD'                             ,".//ok
						"'".achaNroModelo($nro_modelo,$tipo_abertura)  ."',".//ok
						"'".$flw_grupo_acesso          ."',".//ok
						"'".$ativNumRechamado          ."',".//ok
						"'".$nome_gravacao          ."',".//ok
						"'".$dk_campo_chave          ."',".//ok
						"'998',".//ok
						"'".$status_acao."',".//ok
						"'".$pend_data_vecto           ."',".
						"'".$pend_hora_vecto           ."',".
						"'".$pend_tempo_max_exec       ."',".
						"'".$flw_nivel_acesso          ."',".//ok
						"'".$flw_login_operador        ."',".//ok
						"'".date("Ym")                 ."',".//ok
						"'".date("Y-m-d")              ."',".//ok
						"'".date("H:i:s")              ."',".//ok
						"'".date("Ym")                 ."',".//ok
						"'".date("Y-m-d")              ."',".//ok
						"'".date("H:i:s")              ."',".//ok
						"'".$flw_login_operador        ."',".//ok
						"'".$repre_grava               ."',".//ok
						"'F',".//ok
						"'".$flw_tema                  ."',".//ok
						$valor_tema_pai.//ok
						$valor_tema_pai_ativ.//ok
						"'".addslashes($flw_descricao) ."','".$status_acao."')";

						if(!DescExecQuery($Dados, $connectHOST, "N")) {
							print mysql_error($connectHOST);
							print "<br><br>".$Dados;
							exit;
						}

						$rechamado_status   = $mtzRechamado[$ativNumRechamado]["status"];
						$rechamado_ativ_num = $mtzRechamado[$ativNumRechamado]["ativ_num"];
						$rechamado_n_pedido = $mtzRechamado[$ativNumRechamado]["n_pedido"];
						$rechamado_email    = $mtzRechamado[$ativNumRechamado]["email"];

						// ***************************************************************************************** //
						// REGRA DE STATUS CASO O PROTOCOLO DE ORIGEM ESTEJA FECHADO O NOVO SERÁ ABERTO E VICE-VERSA //
						// ***************************************************************************************** //

						if($pesqRechamado == "S") {

							// VERIFICA SE JÁ POSSUI ALGUM RECHAMADO PENDENTE COM ESTE NÚMERO DE OCORRÊNCIA COMO ORIGEM
							$qRechamado = "SELECT ativ_num FROM ".$tabela_proposta." WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND status IN ('A', 'P') AND ".$campo_tabela."_origem_ativ_num REGEXP '[[:<:]]".$ativNumRechamado."§'";
							if($queryRechamado = DescExecQuery($qRechamado, $connectHOST, "N")) {
								if($recRechamado = mysql_fetch_assoc($queryRechamado)) {
									$mtzRechamado[$ativNumRechamado]["status"] = "P";
								}
							}

							switch ($mtzRechamado[$ativNumRechamado]["status"]) {//STATUS DO RECHAMADO DE ORIGEM
								case "P":
								case "A":
									$campoUpdRechamadoProp = " status = 'F', ativ_data_vecto = '".date("Y-m-d")."', ativ_hora_vecto = '".date("H:i:s")."', pend_data_vecto = '".date("Y-m-d")."', pend_hora_vecto = '".date("H:i:s")."', ativ_tempo_ok = 'S' , ";
									$campoUpdRechamadoHist = " status = 'F' ";
									$statusRechamado       = "F";
									break;
								default:
									if ($_POST["flw_nivel_acesso"] == "FA" || $_POST["flw_nivel_acesso"] == "999") { // Finalizando no atendente
										$campoUpdRechamadoProp = " status = 'F', ativ_data_vecto = '".date("Y-m-d")."', ativ_hora_vecto = '".date("H:i:s")."', pend_data_vecto = '".date("Y-m-d")."', pend_hora_vecto = '".date("H:i:s")."', ativ_tempo_ok = 'S' , ";
										$campoUpdRechamadoHist = " status = 'F' ";
										$statusRechamado       = "F";
									} else {
										$campoUpdRechamadoProp = " status = 'P', ";
										$campoUpdRechamadoHist = " status = 'P'  ";
										$statusRechamado       = "P";
									}
									break;
							}

							$UpdRechamado = "UPDATE ".$tabela_historico." SET ".$campoUpdRechamadoHist." WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'";
							if(!DescExecQuery($UpdRechamado, $connectHOST, "N")) {
								print mysql_error($connectHOST);
								print "<br><br>".$UpdRechamado;
								exit;
							}
							// *** RECHAMADO DESTINO *** //

							$flw_nivel_acesso == "999";
							$flw_nivel_acesso_atd == "999";

						}

							// *** RECHAMADO DESTINO *** //
							$UpdRechamado = "UPDATE ".$tabela_proposta." SET ".$campoUpdRechamadoProp." ".$campo_tabela."_destino = 'S', ".$campo_tabela."_destino_qtd = ".$campo_tabela."_destino_qtd+1, ".$campo_tabela."_origem_ativ_num = CONCAT(".$campo_tabela."_origem_ativ_num,'".$ativNumRechamado."§') WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'";
							if(!DescExecQuery($UpdRechamado, $connectHOST, "N")) {
								print mysql_error($connectHOST);
								print "<br><br>".$UpdRechamado;
								exit;
							}

						// ***************************************************************************************** //
						// REGRA DE STATUS CASO O PROTOCOLO DE ORIGEM ESTEJA FECHADO O NOVO SERÁ ABERTO E VICE-VERSA //
						// ***************************************************************************************** //

					}
				}
			//*************************************************
			//**********TRATAMENTO DO RECHAMADO VINI***********
			//*************************************************

			//*************************************************
			//********TRATAMENTO DO ANEXO DO SITE MARCELO******
			//*************************************************
				if ((empty($anexos_site) === false) && ($usa_anexo == "S") && (empty($anexo_solicitado) === false)) {
					$Dados = "INSERT INTO ".$tabela_historico."(".
					"mk_flag,".
					"mk_numero,".
					"grupo_acesso,".
					"ativ_num,".
					"pend_nivel_acesso,".
					"pend_login_operador,".
					"pend_data_vecto,".
					"pend_hora_vecto,".
					"pend_tempo_max_exec,".
					"origem_nivel_acesso,".
					"origem_login_operador,".
					"ano_mes_cri,".
					"data_cri,".
					"hora_cri,".
					"ano_mes_atu,".
					"data_atualiza,".
					"hora_atualiza,".
					"login_atualiza,".
					"representante,".
					"status,".
					"tema,".
					$campo_tema_pai.
					$campo_anexos.
					$campo_tema_pai_ativ.
					"descricao,email_id".
					") VALUES (".
					"'MD'                             ,".//ok
					"'".achaNroModelo($nro_modelo,$tipo_abertura)  ."',".//ok
					"'".$flw_grupo_acesso          ."',".//ok
					"'".$flw_id_ativ               ."',".//ok
					"'".$flw_nivel_acesso          ."',".//ok
					"'".$flw_login_operador        ."',".//ok
					"'".$pend_data_vecto           ."',".
					"'".$pend_hora_vecto           ."',".
					"'".$pend_tempo_max_exec       ."',".
					"'".$flw_user_nivel_acesso     ."',".//ok
					"'auto',".//ok
					"'".date("Ym")                 ."',".//ok
					"'".date("Y-m-d")              ."',".//ok
					"'".date("H:i:s")              ."',".//ok
					"'".date("Ym")                 ."',".//ok
					"'".date("Y-m-d")              ."',".//ok
					"'".date("H:i:s")              ."',".//ok
					"'auto',".//ok
					"'".$repre_grava               ."',".//ok
					"'P',".//ok
					"'".$flw_tema                  ."',".//ok
					$valor_tema_pai.//ok
					$valor_anexos_site.//ok
					$valor_tema_pai_ativ.//ok
					"'Arquivo anexado com sucesso. Origem: Site','".$mk_email_id."')";

					if(!DescExecQuery($Dados, $connectHOST, "N")) {
						print "Você tem um erro de SQL<br><br>";
						print mysql_error($connectHOST);
						print "<br><br>".$Dados;
						$qDelFlw = "DELETE FROM ".$tabela_proposta." WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'";
						DescExecQuery($qDelFlw, $connectHOST);
						$qDelFlw = "DELETE FROM ".$tabela_historico." WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'";
						DescExecQuery($qDelFlw, $connectHOST);
						exit;
					}
				}
			}
			//*************************************************************

			//ANEXO DO CHAT (TRIBANCO)
			if ($nro_modelo == "F9") {
				if (empty($chat_anexo_id) === false && intval($chat_anexo_id, 10) > 0) {
					require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/Conexao.php");
					$connDocumentos = new Conexao($host_documentos, $bd_documentos, $user_documentos, $senha_documentos);
					$connDocumentos->query("SELECT nome, data_cri, hora_cri, login_cri, arq_size FROM ".$tabela_documentos." WHERE num = '".$chat_anexo_id."'");
					$connDocumentos->close();

					$tmp_pos = stripos($connDocumentos->result["nome"], ".");
					if ($tmp_pos !== false) {
						$chat_anexo_nome = substr($connDocumentos->result["nome"], 0, $tmp_pos);
						$chat_anexo_ext = substr($connDocumentos->result["nome"], $tmp_pos + 1);
					} else {
						$chat_anexo_nome = $connDocumentos->result["nome"];
						$chat_anexo_ext = "";
					}
					$chat_anexo_associado = "DocMK*".$chat_anexo_nome."|".$chat_anexo_ext."|".$connDocumentos->result["arq_size"]."|MD|".achaNroModelo($nro_modelo, $tipo_abertura)."|".$chat_anexo_id."|".$connDocumentos->result["login"]."|".$connDocumentos->result["data_cri"]."|".str_replace(":", "-", $connDocumentos->result["hora_cri"]);

					//GRAVAR EVENTO OK
					$arr_ins_even["mk_flag"] = "MD";
					$arr_ins_even["mk_numero"] = achaNroModelo($nro_modelo, $tipo_abertura);
					$arr_ins_even["grupo_acesso"] = $flw_grupo_acesso;
					$arr_ins_even["ativ_num"] = $flw_id_ativ;
					$arr_ins_even["representante"] = $repre_vendedor;
					$arr_ins_even["origem_nivel_acesso"] = $flw_user_nivel_acesso;
					$arr_ins_even["origem_login_operador"] = "auto";
					$arr_ins_even["pend_nivel_acesso"] = $flw_nivel_acesso;
					$arr_ins_even["pend_login_operador"] = $flw_login_operador;
					$arr_ins_even["tema_pai"] = $flw_tema_pai;
					$arr_ins_even["tema"] = $flw_tema;
					$arr_ins_even["anexo_solicitado"] = $anexo_solicitado;
					$arr_ins_even["anexos"] = $chat_anexo_associado;
					$arr_ins_even["pend_data_vecto"] = $pend_data_vecto;
					$arr_ins_even["pend_hora_vecto"] = $pend_hora_vecto;
					$arr_ins_even["pend_tempo_max_exec"] = $pend_tempo_max_exec;
					$arr_ins_even["ano_mes_cri"] = date("Ym");
					$arr_ins_even["data_cri"] = date("Y-m-d");
					$arr_ins_even["hora_cri"] = date("H:i:s");
					$arr_ins_even["ano_mes_atu"] = date("Ym");
					$arr_ins_even["data_atualiza"] = date("Y-m-d");
					$arr_ins_even["hora_atualiza"] = date("H:i:s");
					$arr_ins_even["login_atualiza"] = "auto";
					$arr_ins_even["status"] = "P";
					$arr_ins_even["status_finalizador"] = "";
					$arr_ins_even["risco"] = "N";
					$arr_ins_even["descricao"] = "Documento recebido: ´".$chat_anexo_nome.((empty($chat_anexo_ext) === false) ? ".".$chat_anexo_ext : "")."´.";
					$arr_ins_even["bina_cliente"] = $bina_cliente;
					$arr_ins_even["risco_contato"] = "N";
					$arr_ins_even["risco_imagem"] = "";
					$arr_ins_even["status_acao"] = "";
					$arr_ins_even["servico_dac"] = $servico_dac_update;
					$arr_ins_even["nome_gravacao"] = $nome_gravacao;
					$arr_ins_even["id_lig"] = $id_lig;
					$arr_ins_even["hora_ini_dac"] = $hora_ini_dac;
					$arr_ins_even["hora_fim_dac" ] = $hora_fim_dac;
					$arr_ins_even["tempo_tot_lig"] = $tempo_tot_lig;

					$connHistorico = new Conexao($host_historico, $bd_historico, $user_historico, $senha_historico);
					$connHistorico->execInsert($arr_ins_even, $tabela_historico);
					$connHistorico->close();

					$arr_upd_ativ_chat["anexos"] = "(INT)IF(anexos = '', '".$chat_anexo_associado."', CONCAT(anexos, '?".$chat_anexo_associado."'))(INT)";
					$arr_upd_ativ_chat["status_anexo"] = "(INT)IF(status_anexo = 'P', 'L', status_anexo)(INT)";
					$arr_upd_ativ_chat["qtd_evento"] = "(INT)(qtd_evento + 1)(INT)";

					$connProposta = new Conexao($host_proposta, $bd_proposta, $user_proposta, $senha_proposta);
					$connProposta->execUpdate($arr_upd_ativ_chat, $tabela_proposta, "mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo, $tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'");
					$connProposta->close();
				}
			}

			if  ($ctrl_duplicidade == true) {
				if (((is_array($_FILES) === true) || ($flw_arquivo_anexo != "")) && ($usa_anexo == "S")) {
					if ($host_documentos) {
						$connect_docs = Conecta($host_documentos, $user_documentos, $senha_documentos, $bd_documentos);
					} else {
						print " PARÂMETRO USA_ANEXO == S E DE BANCO DE DADOS (DOCUMENTOS) NÃO PARAMETRIZADO";
						exit;
					}
					if (count($_FILES) > 0) {
						foreach ($_FILES as $arquivo => $param) {

							if ($param["error"] == 0) {
								//NÃO HOUVE ERRO, O UPLOAD FOI BEM SUCEDIDO
								//print "<li>antes do tmp---".((((memory_get_usage(true))/1024)/1024))." PICO DE ".((((memory_get_peak_usage(true))/1024)/1024)) ;
								//$tmp = addslashes(file_get_contents($param["tmp_name"]));
								// print "<li>antes do tmp---".((((memory_get_usage(true))/1024)/1024))." PICO DE ".((((memory_get_peak_usage(true))/1024)/1024)) ;
				                if ($nro_modelo == "YB") {
				                  $campo_up_bmg = ",campo,ativ_num";
				                  $valor_up_bmg = "'".$mesmo_cliente_n_pedido."','anexos_oco',";
				                }

								$q = "INSERT INTO ".$tabela_documentos." (classe_mkpro,tipo, nome, dados, representante,ano_mes,data_cri,hora_cri,login_cri,arq_size,n_pedido".$campo_up_bmg.") VALUES ('MD".$nro_modelo."','".$param["type"]."', '".$param["name"]."', '".addslashes(file_get_contents($param["tmp_name"]))."', '".$repre_vendedor."','".Date("Ym")."','".Date("Y-m-d")."','".Date("H:i:s")."','".$session["operador"]."','".$param["size"]."',".$valor_up_bmg."'".$flw_id_ativ."')";
								if (mysql_query($q, $connect_docs)) {
									$msg_docs .= "Arquivo <b>".$param["name"]."</b> cadastrado com sucesso!<br>";
									$q_id    = mysql_query("SELECT LAST_INSERT_ID() as protocolo", $connect_docs);
									$rec_id  = mysql_fetch_array($q_id);

									$arr_ext = explode(".",$param["name"]);
									$x_arq   = 0;
									$extesao = "";
									while($arr_ext[$x_arq]) {
										$extesao = $arr_ext[$x_arq];
										$x_arq++;
									}

									if (!$id_arquivos) {
										$id_arquivos .= "DocMK*".str_replace(".".$extesao,"",$param["name"])."|".$extesao."|".$param["size"]."|MD|".$nro_modelo."|".$rec_id["protocolo"]."|".$session["operador"]."|".Date("Y-m-d")."|".Date("H-i-s").":";
										$id_arquivos_bmg = "DocMK*".str_replace(".".$extesao,"",$param["name"])."|".$extesao."|".$param["size"]."|MD|".$nro_modelo."|".$rec_id["protocolo"]."|".$session["operador"]."|".Date("Y-m-d")."|".Date("H-i-s").":";
									} else {
										$id_arquivos .= str_replace(".".$extesao,"",$param["name"])."|".$extesao."|".$param["size"]."|MD|".$nro_modelo."|".$rec_id["protocolo"]."|".$session["operador"]."|".Date("Y-m-d")."|".Date("H-i-s").":";
										$id_arquivos_bmg = str_replace(".".$extesao,"",$param["name"])."|".$extesao."|".$param["size"]."|MD|".$nro_modelo."|".$rec_id["protocolo"]."|".$session["operador"]."|".Date("Y-m-d")."|".Date("H-i-s").":";
									}

  								if ($nro_modelo == "YB") {
  								  require_once($_SERVER['DOCUMENT_ROOT']."/libs/cli/BmgProtocolo.php");
  								  $BmgProtocolo = new BmgProtocolo($session["operador"], $GLOBALS["sistema_identificacao"]);
                    // ******************************************************************************************** //
                    // ***************** GRAVANDO LOG DE ALTERAÇÃO DOS ANEXOS/RESPOSTA INSERIDA ******************* //
                    // ******************************************************************************************** //

                    $acao_bd = "I";

                    if(!$ativ_num) {
                      $ativ_num = $rec_id["protocolo"];
                    }

                    $query = "INSERT INTO tb_atd_hist_alt_dados_protocolo (n_pedido, ativ_num, acao, motivo, campo, observacao, login_cri, data_cri, hora_cri, login_atualiza, data_atualiza, hora_atualiza, anexos) VALUES ('".$mesmo_cliente_n_pedido."', '".$flw_id_ativ."', '".$acao_bd."', '', 'anexos_oco', '".$observacao."', '".$session["operador"]."', '".date("Y-m-d")."', '".date("H:i:s")."', '".$session["operador"]."', '".date("Y-m-d")."', '".date("H:i:s")."', '".$id_arquivos_bmg."') ";
                    $BmgProtocolo->connect->query($query);

                    // ******************************************************************************************** //
                    // ***************** GRAVANDO LOG DE ALTERAÇÃO DOS ANEXOS/RESPOSTA INSERIDA ******************* //
                    // ******************************************************************************************** //
  								}

									$anexos_associado_atd .= "¢".${"tipo_docto".substr($arquivo,-1)}."=DocMK*".str_replace(".".$extesao,"",$param["name"])."|".$extesao."|".$param["size"]."|MD|".$nro_modelo."|".$rec_id["protocolo"]."|".$session["operador"]."|".Date("Y-m-d")."|".Date("H-i-s");
								} else {
									print mysql_error();
									$msg_docs .= "Não foi possível gravar arquivo <b>".$param["name"]."</b>. (".mysql_error($connect_docs).")<br>";
								}
								unset($tmp);
							} else if ($param["error"] == 1) {
								//O ARQUIVO NO UPLOAD É MAIOR DO QUE O LIMITE DEFINIDO EM UPLOAD_MAX_FILESIZE NO PHP.INI
								$msg_docs .= "O tamanho do arquivo <b>".$param["name"]."</b> é maior que permitido (Tamanho Máximo 2Mb).<br>";
							} else if ($param["error"] == 2) {
								//O ARQUIVO ULTRAPASSA O LIMITE DE TAMANHO EM MAX_FILE_SIZE QUE FOI ESPECIFICADO NO FORMULÁRIO HTML
								switch ($session["representante"]) {
									case "SUHAI-S":
									case "CAOA-E":
										$msg_docs .= "O tamanho do arquivo <b>".$param["name"]."</b> é maior que permitido (Tamanho Máximo 10Mb).<br>";
									break;

									case "ALELO-O":
										$msg_docs .= "O tamanho do arquivo <b>".$param["name"]."</b> é maior que permitido (Tamanho Máximo 5Mb).<br>";
									break;

									default:
										$msg_docs .= "O tamanho do arquivo <b>".$param["name"]."</b> é maior que permitido (Tamanho Máximo 2Mb).<br>";
									break;
								}
							} else if ($param["error"] == 3) {
								//O UPLOAD DO ARQUIVO FOI FEITO PARCIALMENTE
								$msg_docs .= "Não foi possível completar o upload do arquivo  <b>".$param["name"]."</b>. Tente novamente (3).<br>";
							} else if ($param["error"] == 4) {
								//NÃO FOI FEITO O UPLOAD DO ARQUIVO(NENHUM ARQUIVO SELECIONADO)
							}
							//***************************TRATATIVA FALHA DO UPLOAD DO ANEXO***********************************
							if ($param["error"] == "1" || $param["error"] == "2" || $param["error"] == "3") {
								if ($session["print_sql"] == "S") {
									print "<pre>";
									print_r($param);
									print "</pre>";
								}
								//DELETANDO A TB_FOLLOW_ATIVIDADE E TB_FLE_EVENTO POIS NÃO FOI POSSÍVEL INSERIR O ANEXO E NESTE CASO NÃO PODE TER O PROTOCOLO SEM O ANEXO.
								$qDelFlw = "DELETE FROM ".$tabela_proposta." WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'";
								DescExecQuery($qDelFlw, $connectHOST);
								$qDelFlw = "DELETE FROM ".$tabela_historico." WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'";
								DescExecQuery($qDelFlw, $connectHOST);
	              ?>
	              <html>
	                <body>
	                <form name="proximo" action="md_cad_prop.php" METHOD="POST">
										<input type="hidden" name="abriuMkFrameWork" value="<?=$abriuMkFrameWork;?>">
        						<input type="hidden" name="im_classe_mkpro" value="<?=$im_classe_mkpro;?>">
	                  <input type="hidden" name="nro_modelo"        value="<?print base64_encode(base64_encode($nro_modelo));?>">
	                  <input type="hidden" name="repre_param"       value="<?print $repre_param;?>"     >
	                  <input type="hidden" name="nivel"       value="<?print $nivel_atual;?>"     >
	                  <input type="hidden" name="titulo"       value="<?print $titulo;?>"     >
	                  <input type="hidden" name="msg_erro"       value="****ATENÇÃO****<br>Protocolo não registrado.<br>Motivo: <?print $msg_docs;?>">
	                </form>
	                <?
	                if ($session["operador"] == "opepmo" || ($session["operador"] != "tfdavid" && $nro_modelo != "BF" && ($sistema_identificacao == "teste" || $session["operador"] == "tfarthur" || strtoupper($session["operador"])=="tfarthur" || $session["print_sql"] == "S"))) {
	                	print "<input type='button' value='Esse botão só aparece no teste ou com print_sql = S clique para continuar' onclick=\" document.proximo.submit();\" >";
	                	if ($session["print_sql"] == "S") {
	                		print "<li>APARECE SOMENTE COM PRINT_SQL";
	                		print "<li>**************GLOBALS****************<br><pre>";
	                		print_r($GLOBALS);
	                	}
	                	$_SESSION["ssitgl_voltou_mk_".$nro_modelo] = true;
	                } else {
	                	$_SESSION["ssitgl_voltou_mk_".$nro_modelo] = true;
	                	print "<script language='javascript'>document.proximo.submit();</script>";
	                }
	                exit();
	                ?>
	                </body>
	              </html>
	              <?
							}

							//************************************FIM TRATATIVA FALHA DO UPLOAD DO ANEXO*********************************************
						}
						if ($id_arquivos) {
							$id_arquivos = substr($id_arquivos,0,-1);
						}
					}

					if($flw_arquivo_anexo) {
						if($id_arquivos){
							$id_arquivos .= ":".$flw_arquivo_anexo;
						}else{
							$id_arquivos .= $flw_arquivo_anexo;
						}
					}

					if ($id_arquivos) {
						$mtz_up_anexo["anexos"] = trim($id_arquivos);
						if($mkParamFLW["grava_anexo_atd"] == "S") {
							$mtz_up_anexo["anexo_associado"] = substr($anexos_associado_atd,1);
						}
						FazUpdate($mtz_up_anexo, $tabela_proposta, " WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'", $connectHOST);
					}
				}
			}

      $file = mkFileInclude($include_dados_pasta, $include_dados, "md_cad_prop_bd_dados_".$include_dados.".php", "N");

			include $file;

			//*******************************************/
			if  ($ctrl_duplicidade == true) {
				if ($isRegAtd) {
					$connect_reg_atd = Conecta($host_reg_atd, $user_reg_atd, $senha_reg_atd, $bd_reg_atd);
					$classe_mkpro    = "MD".$nro_modelo;

					if ($isGeraPedido === true) {
						$atd_ativ_num       = $flw_id_ativ;

						$matriz_up_reg_atd["atd_ativ_num"]      = $atd_ativ_num;
						$matriz_up_reg_atd["cpf_cnpj"]          = $atv_cpf_cnpj;
						$matriz_up_reg_atd["campo_chave"]       = $atv_campo_chave;
						$matriz_up_reg_atd["nome_razao"]        = stripslashes($atv_nome_razao);
						$matriz_up_reg_atd["email"]             = $atv_email;
						$matriz_up_reg_atd["observacao"]        = $flw_descricao;

						$matriz_up_reg_atd["reg_atd_canal"]     = $reg_atd_canal;
						$matriz_up_reg_atd["reg_atd_grupo"]     = $reg_atd_grupo;

						if ($arr_campos_volta["cliente"] && $arr_campos_volta["cliente"] == "N") {
							$matriz_up_reg_atd["st_venda_cartao"] = "0";
						}

						if (empty($mk_msg_alerta) === false) {
							$matriz_up_reg_atd["mk_msg_alerta"] = $mk_msg_alerta;
						}

						$where_update_reg_atd = "WHERE classe_mkpro = '".$classe_mkpro."' AND n_pedido = '".$n_pedido."'";

					  //***************************************************************************************************************\\
            //* INI - VERIFICANDO SE O CÓDIGO QUE FOI PASSADO JÁ NÃO CONSTA COMO SUSPENSO NA TABELA DE CONTROLE DOS MOTIVOS *\\
            //***************************************************************************************************************\\
            if ($reg_atd_param == 'S') {
              if (empty($mkParam['tabela_reg_atd_param'])) {
                print 'Não foi possível encontrar a tabela responsável pelo gerencimento dos registros de atendimento. (tabela_reg_atd_param)';
                exit;
              }

              $connHOST->query("SELECT status FROM {$mkParam['tabela_reg_atd_param']} WHERE classe_mkpro = '$classe_mkpro' AND tipo_codigo = 'M' AND atd_codigo = '{$retParamMotivo['T,'.$flw_tema_pai.$flw_tema]['reg_atd']}'");
              if ($connHOST->status === false) {
                print $connHOST->getDescRetorno();
                exit;
              }

              if ($connHOST->result['status'] != 'A') {
                unset($retParamMotivo['T,'.$flw_tema_pai.$flw_tema]['reg_atd']);
              }
            }

            //***************************************************************************************************************\\
            //* FIM - VERIFICANDO SE O CÓDIGO QUE FOI PASSADO JÁ NÃO CONSTA COMO SUSPENSO NA TABELA DE CONTROLE DOS MOTIVOS *\\
            //***************************************************************************************************************\\

						require_once($_SERVER['DOCUMENT_ROOT']."/libs/func/RegAtd.php");
						alteraRegistroAtendimentoDados($retParamMotivo["T,".$flw_tema_pai.$flw_tema]["reg_atd"], $matriz_up_reg_atd, $where_update_reg_atd,"2", $retParamMotivo["T,".$flw_tema_pai.$flw_tema]["reg_atd_pri"], $flw_tema_pai, $flw_tema);
					}
				}
			}
			//*******************************************/
			break;
		default:
			$msg_erro = "TIPO MODELO NÃO ENCONTRADO";
			break;
	}
  //***********************************************************************************************************************
  //***A VALIAÇÃO OUVIDORIA BACEN MARCELO VARIAVEIS NECESSÁRIAS PARA O ENVIO DA PESQUISA POR EMAIL NÃO APAGAR (MARCELO)****
	//***********************************************************************************************************************
	require_once($_SERVER['DOCUMENT_ROOT']."/callcenter/flw_funcoes.php");
	$arrParamFLW['OUVE_AVA_BACEM_USA'] = 'OUVE_AVA_BACEM_USA';
	$mkFlwParam = carregaArrParamFLW(achaNroModelo($nro_modelo, $tipo_abertura), $repre_vendedor, $arrParamFLW);

	if ($mkFlwParam['ouve_ava_bacem_usa'] == "S") {
    require_once($_SERVER['DOCUMENT_ROOT']."/callcenter/lib_criptografa.php");
    $classe_mkpro_pesq_crip = base64_encode(base64_encode("MD".$nro_modelo));
    $ativ_num_pesq_crip     = Criptografa($flw_id_ativ);
	}
  //***********************************************************************************************************************
  //***A VALIAÇÃO OUVIDORIA BACEN MARCELO VARIAVEIS NECESSÁRIAS PARA O ENVIO DA PESQUISA POR EMAIL NÃO APAGAR (MARCELO)****
	//***********************************************************************************************************************
	// if (strtoupper($session["operador"]) == "OPETECACI") {
	// 	print "<pre>";
  //   $GLOBALS["aiDebugPrint"] = true;
	// 	//var_dump($dadosGrupoCaixa);
	// }

	if ($ctrl_duplicidade == true) {
		if ($rotina_envia_email == "S") {
        	$enviar_historico_de_email = "";
    		if($lead_mkpro != "") {
        		require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/mk_funcoes.php");
        		$dk_param = carregaArrParam($lead_mkpro, $repre_param);
        		if ($dk_param["env_hist_email"] == "S" && $dk_param["usa_email_rec"] == "S" && strpos($dk_param["email_rec_campanha"], $dk_campanha) !== false) {
          			$enviar_historico_de_email = "S";
        		}
    		}

			if ($nro_modelo == '2N' && $repre_vendedor == 'VELOE-131') {
				unset($string_codigo);//veloe pediu para remover o identificador de rechamado.
				if ($CPOEXTRA_campo_extra_4 == "N") {//forcando o não envio do historico pois foi escolhido na tela para não enviar.
					$enviar_historico_de_email = "N";
				}
			}

			if($enviar_historico_de_email == "S") {
				$monta_assinatura_email = "S";
				$enflw_array = mostraRegraScript($repre_vendedor, 'ENVEM', 'ARR');
				$monta_assinatura_email = "N";

				if($enflw_array) {
					require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/ConexaoEmail.php");
					function DiaSemana2MD($data) {
						$dia       = substr($data, 8, 2);
						$mes       = substr($data, 5, 2);
						$ano       = substr($data, 0, 4);
						$timestamp = mktime(0, 0, 0, $mes, $dia, $ano);
						$date      = getdate($timestamp);
						$dayofweek = $date['wday'];

						switch($dayofweek) {
							case "0";
							$semana = 'Domingo';
							break;
							case "1";
							$semana = 'Segunda-Feira';
							break;
							case "2";
							$semana = 'Terça-Feira';
							break;
							case "3";
							$semana = 'Quarta-Feira';
							break;
							case "4";
							$semana = 'Quinta-Feira';
							break;
							case "5";
							$semana = 'Sexta-Feira';
							break;
							case "6";
							$semana = 'Sábado';
							break;
						}
						Return $semana;
          			}

          require_once($_SERVER['DOCUMENT_ROOT']."/libs/bd/Conexao.php");
          $ccEmail   = new Conexao($dk_param["host_email_rec"],$dk_param["bd_email_rec"],$dk_param["user_email_rec"],$dk_param["senha_email_rec"]);
          $sql_email = "SELECT data_cri,hora_cri,email_origem, origem_nome, email_resposta,assunto, email_resposta_nome , email_recebido, email_destino, destino_nome, email_cc, email_cc_nome, assunto, email_qtd_anexo FROM ".$dk_param["tabela_email_rec"]."_detalhe WHERE campo_chave ='".$dk_campo_chave."' ";

          $ccEmail->query($sql_email);
          if ($ccEmail->status === false) {
            print "Erro no SELECT: [".$ccEmail->error."] SQL: [".$ccEmail->query_str."]";
            exit();
          }

          $email_contato_cliente   = $ccEmail->result["email_resposta"];
          $email_data_cri          = $ccEmail->result["data_cri"];
          $email_hora_cri          = $ccEmail->result["hora_cri"];
          $email_contato_copia_aux = $ccEmail->result["email_cc"].";".$ccEmail->result["email_destino"].";";
          $email_assunto           = $ccEmail->result["assunto" ];

          $matriz_limpa_email[$ccEmail->result["email_recebido"]] = $ccEmail->result["email_recebido"];
          $matriz_limpa_email[$param_email_origem_1          ] = $param_email_origem_1;
          $matriz_limpa_email["sac@uranet.com.br"            ] = "sac@uranet.com.br";
          $matriz_limpa_email["cac@uranet.com.br"            ] = "cac@uranet.com.br";
          $matriz_limpa_email["caci@uranet.com.br"           ] = "caci@uranet.com.br";
          $matriz_limpa_email["caci@intergrall.com.br"       ] = "caci@intergrall.com.br";
          $matriz_limpa_email["cac_uranet@intergrall.com.br" ] = "cac_uranet@intergrall.com.br";

          $email_contato_copia_aux = explode(";",$email_contato_copia_aux);
          $email_contato_copia     = "";
          foreach ($email_contato_copia_aux as $chave => $valor_resp_email) {
            if($valor_resp_email && !$matriz_limpa_email[$valor_resp_email]) {
              $email_contato_copia .= $valor_resp_email.";";
            }
          }

          $conteudo_email = $enflw_array[0];
          $conteudo_email = $conteudo_email."<hr>
        										<strong>De:</strong> ".$email_contato_cliente."<br>
        										<strong>Enviada em:</strong> ".DiaSemana2MD($email_data_cri).", ".substr($email_data_cri, -2)." de ".NomeMes(substr($email_data_cri, 5, 2))." de ".substr($email_data_cri, 0, 4)."&nbsp;&nbsp; ".substr($email_hora_cri,0,-3)."<br>
           									<strong>Assunto:</strong> ".$email_assunto."<br><br>";

          $email_assunto = str_replace("RES: ","",$email_assunto);
          $email_assunto = trim(str_replace($string_codigo,"",$email_assunto));
          $email_assunto = $email_assunto." ".$string_codigo;

					if ($nro_modelo == '2N' && $repre_vendedor == 'VELOE-131') {
						if ($arraySIassunto[0] != "") {//concatena o assunto da regra do ação inteligente
							$email_assunto .= $arraySIassunto[0];
						}
					}

        //   if(strtoupper($sistema_identificacao) == "TESTE") {
        //     $destino_email 							= "asouza@uranet.com.br";
        //     $destino_email_copia		 		= $email_contato_cliente.";fpontilho@uranet.com.br";
        //     $destino_email_copia_oculta = "alan.santos@uranet.com.br";
        //   } else {
          	$destino_email 						= $email_contato_cliente;
       	    $destino_email_copia 				= $email_contato_cliente.";".$email_contato_copia;
           	$destino_email_copia_oculta = "";
        //   }
			if ($nro_modelo == '2N' && $repre_vendedor == 'VELOE-131') {
				if($email_envia_txt != "") {
					$destino_email = $email_envia_txt;
				}
				if($email_copia_txt != ""){
					$destino_email_copia = $email_copia_txt;
				}
			}

			$assunto_email    = "RES: ".$email_assunto;
			$email_assunto    = "RES: ".$email_assunto;
			$array_data_email = explode("-",$email_data_cri);
			$ano_mes_email    = substr($array_data_email[0],2).$array_data_email[1];


		//   var_dump($destino_email_copia);

       	  $conEmail = new ConexaoEmail();
          $qEmail   = "SELECT num FROM tb_email_rec_".$ano_mes_email." WHERE nome_gravacao = '".$dk_campo_chave."'";

      	  $conEmail->query($qEmail);
       	  if ($conEmail->status === true) {
            if($conEmail->result["num"]) {
              $num_email = $conEmail->result["num"];
              $qEmail_2  = "SELECT tipo, charset, dados FROM tb_email_rec_anexo_".$ano_mes_email." WHERE num = '".$num_email."' AND nome = '' AND extensao = '' AND tamanho > 0 AND content_id = ''";

              $conEmail->query($qEmail_2);
          	  if ($conEmail->status === true) {
          	    if ($conEmail->count > 0) {
          	      do {
          	        if ($tipo_conteudo != "text/html") {
          	          //$hist_email    = mb_convert_encoding($conEmail->result["dados"], $conEmail->result["charset"],"auto");
          	          $hist_email    = mb_convert_encoding($conEmail->result["dados"], "ISO-8859-1", $conEmail->result["charset"]);
          	          $tipo_conteudo = $conEmail->result["tipo"];
          	        }
          	      } while ($conEmail->getFetchAssoc());

          	      //CRIA LISTA DE ANEXOS QUE FAZEM PARTE DO CORPO DO E-MAIL (POSSUEM CONTENT-ID)
          	      $qEmail_3  = "SELECT seq, nome, extensao, content_id,tamanho,tipo,dados FROM tb_email_rec_anexo_".$ano_mes_email." WHERE num = '".$num_email."' AND nome <> '' AND extensao <> ''";
          	      $conEmail->query($qEmail_3);
          	      if ($conEmail->status === true) {
          	        if ($conEmail->count > 0) {
          	          $x_arq = 0;
          	          unset($IAM_fixo_anexo_array);
          	          do {
          	            $conEmail->result["nome"] = trim($conEmail->result["nome"]);
          	            $IAM_fixo_anexo_array[$x_arq]["nome"    ] = $conEmail->result["nome"   ].".".$conEmail->result["extensao"];
                			  $IAM_fixo_anexo_array[$x_arq]["conteudo"] = $conEmail->result["dados"  ];
                			  $IAM_fixo_anexo_array[$x_arq]["tamanho" ] = $conEmail->result["tamanho"];
                			  $IAM_fixo_anexo_array[$x_arq]["tipo"    ] = $conEmail->result["tipo"   ];

          	            $arr_cid[$conEmail->result["seq"]]["cid" ] = $conEmail->result["content_id"];
          	            $arr_cid[$conEmail->result["seq"]]["link"] = "/comp/download.php"."?tipo=MAIL"."&origem=REC"."&anomes=".$ano_mes_email."&num=".$num_email."&seq=".$conEmail->result["seq"]."&arquivo=".urlencode($conEmail->result["nome"].".".$conEmail->result["extensao"]);

          	            $x_arq++;
          	          } while ($conEmail->getFetchAssoc());
          	        }
          	      }

          	      //SUBSTITUI AS PARTES DO CORPO DO E-MAIL QUE CONTÉM CID PELO RESPECTIVO LINK PARA O ANEXO
					if (is_array($arr_cid) === true) {
						foreach ($arr_cid as $arr_tmp) {
							if(strpos("**".$arr_tmp["link"],"undefined")|| strpos("**".$arr_tmp["link"],"UNDEFINED") || !$arr_tmp["link"]) {
								return "NO|FAVOR ENVIAR PRINT CONTENDO ESTA MENSAGEM AO SAC URANET - /comp/download.php"."?tipo=MAIL"."&origem=REC"."&anomes=".$ano_mes_email."&num=".$num_email."&seq=".$conEmail->result["seq"]."&arquivo=".urlencode($conEmail->result["nome"].".".$conEmail->result["extensao"]);
							}
							$hist_email = str_replace("cid:".$arr_tmp["cid"], $arr_tmp["link"], $hist_email);
						}
						unset($arr_tmp);
          	      	}
          	      	$conteudo_flw_email  = $conteudo_email.$hist_email;
          	      	$conteudo_email      = $conteudo_email.$hist_email;
					if($dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"]) {
                    	$grupo_email  = $dadosGrupoCaixa["EMAIL_GRUPO"];
                   		$origem_email = $dadosGrupoCaixa["EMAIL_ORIGEM_1"];
                    	$nome_email   = $dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"];
					} else {
						$nome_origem  = $email_origem_nome_1;
						$nome_email   = $nome_origem;
						$grupo_email  = $grupo_email;
					}
                  	$empresa_email 	     = $param_empresa;
                  	$gerar_email_flw     = "S";
                  	$finalizar_com_email = "T";

                  	$mk_numero_old       = $mk_numero;
                  	$mk_numero           = "MD".achaNroModelo($nro_modelo,$tipo_abertura);
					$retorno             = mostraRegraScript($repre_vendedor, "ENVEM" , "EXEC_ACAO");

					if($AI_email_id) {
						$email_id .= $AI_email_id."¢";
					}

                  //if($AI_email_id) {
                    //$matriz_up_tbativo["login_resposta"    ] = $session["operador"];
                		//$matriz_up_tbativo["data_resposta"     ] = date("Y-m-d");
                		//$matriz_up_tbativo["hora_resposta"     ] = date("H:i:s");
                		//$matriz_up_tbativo["email_resposta"    ] = $AI_email_id;
                		//$matriz_up_tbativo["flw_nivel_resposta"] = $flw_user_nivel_acesso;

                		//$connect_ativo = Conecta($dk_param["host_email_rec"], $dk_param["user_email_rec"], $dk_param["senha_email_rec"], $dk_param["bd_email_rec"]);
                    //$up_proposta   = FazUpdate($matriz_up_tbativo,$tabela_proposta,"WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo,$tipo_abertura)."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."'",$connectHOST);
                		//$up_ativo      = FazUpdate($matriz_up_tbativo,$dk_param["tabela_email_rec"],"WHERE campo_chave = '".$dk_campo_chave."'",$connect_ativo);

                    //if($up_proposta != "OK" || $up_ativo != "OK") {
                      //print $up_proposta.$up_ativo;
                      //exit();
                    //}
                    //SETAR VARIAVEL rotina_envia_email PARA ENVIAR O EMAIL SOMENTE UMA VEZ
                    //$rotina_envia_email = "N";
                  //}
                  	$mk_numero = $mk_numero_old;
				}
			} else {
				print "<center><font class='txtvermelho'>ERRO NA CONSULTA EMAIL - 2 (".$dk_campo_chave.") => ".$conEmail->error."</font></center>";
				exit();
			}
		} else {
			print "<center><font class='txtvermelho'>EMAIL ORIGEM NÃO ENCONTRADO (".$dk_campo_chave.") => ".$conEmail->query_str."</font></center>";
			exit();
		}
        	} else {
        	  print "<center><font class='txtvermelho'>ERRO NA CONSULTA EMAIL (".$dk_campo_chave.") => ".$conEmail->error."</font></center>";
        	  exit();
          }
        }
      } else {
				//$GLOBALS["aiDebugPrint"] = true;
    		$mk_numero  = "MD" . $nro_modelo;
    	  if ( substr($repre_vendedor, 0,5) == 'HONDA') {
  	   		$campo_chave_ant = $campo_chave;
  			  $campo_chave = $n_pedido;
				}

				if($dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"]) {
					if ($nro_modelo != "TU") {
						$nome_origem   = $dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"];
						$nome_email = $dadosGrupoCaixa["EMAIL_ORIGEM_1"];
						$grupo_email  = $dadosGrupoCaixa["EMAIL_GRUPO"];
					} else {
						//os parametros estavam invertidos ajustado para o bradesco, como está setando fixo no programa o email de origem.
						$grupo_email  = $dadosGrupoCaixa["EMAIL_GRUPO"];
						$origem_email = $dadosGrupoCaixa["EMAIL_ORIGEM_1"];
						$nome_email   = $dadosGrupoCaixa["EMAIL_ORIGEM_NOME_1"];
					}
				} else {
					$nome_origem       = $email_origem_nome_1;
					$nome_email    	   = $nome_origem;
					$grupo_email       = $grupo_email;
				}

			// 	var_dump($nro_modelo,$repre_vendedor);
			// exit();
			if ($nro_modelo == '2N' && $repre_vendedor == 'VELOE-131') {
				if($email_envia_txt != "") {
					$destino_email = $email_envia_txt;
				}
				if($email_copia_txt != ""){
					$destino_email_copia = $email_copia_txt;
				}
			}

				//$GLOBALS["aiDebugPrint"] = 'TRUE';

  			if ($nro_modelo == "YZ") {
  			  mostraRegraScript(defineRepre($repre_vendedor), $email_sigla_script, "EXEC_ACAO");
  			} else {
  			  mostraRegraScript($repre_vendedor,$email_sigla_script,"EXEC_ACAO");
				}

  			if($AI_email_id) {
  				$email_id .= $AI_email_id."¢";
  				if ($nro_sistema == "KT") {
  					$arrUpdEmail["email_id"] = trim($AI_email_id);
  				  $retorno = FazUpdate($arrUpdEmail, $tabela_proposta, " WHERE n_pedido = '".$matriz_ins["n_pedido"]."'", $connectHOST);
  			  }
  			}

  			if (substr($repre_vendedor, 0,5) == 'HONDA') {
  				$campo_chave = $campo_chave_ant;
  				unset($campo_chave_ant);

  				//CASO O PROCESSO DE ENVIO DE LINKS PARA UPLOAD DE DOCUMENTOS TENHA SIDO ACIONADO NA ABERTURA DA OCORRÊNCIA
  				//DEVEMOS ATUALIZAR O EVENTO DE ABERTURA COM O ID DO E-MAIL QUE FOI ENVIADO
  				if ($solicitacao_upload_doc == 'OK') {
  				  $arrUpdEmail["email_id"] = trim($AI_email_id);
  				  $retorno = FazUpdate($arrUpdEmail, $tabela_historico, " WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo, $tipo_abertura)."' AND grupo_acesso = '$flw_grupo_acesso' AND ativ_num = '$flw_id_ativ' AND even_num = '$flw_id_even'", $connectHOST);
  			  }
  		  }
			}

			if ($nro_modelo == "TU" && substr($repre_vendedor, 0,3) == 'BMC') {
				// if (strtoupper($session["operador"]) == "OPETECACI") {
				// 	print "<li>aquiiiiii";
				// }
				$arrUpdEmail["email_id"] = trim($AI_email_id);
				$retorno = FazUpdate($arrUpdEmail, $tabela_historico, " WHERE mk_flag = 'MD' AND mk_numero = '".achaNroModelo($nro_modelo, $tipo_abertura)."' AND grupo_acesso = '$flw_grupo_acesso' AND ativ_num = '$flw_id_ativ' AND even_num = '$flw_id_even'", $connectHOST);
				// if (strtoupper($session["operador"]) == "OPETECACI") {
				// 	print "<li>aaaaaaaa<pre>";
				// 	var_dump($retorno, $AI_email_id);
				// 	print "</pre>";
				// }
			}

			if(empty($AI_email_id) === false && $utiliza_historico_atendimento == "S") {
				if ($repre_vendedor == "CONAREC-U" && $classe_mkpro == "MDKA") {
					$jornada_campo_chave = $CPOEXTRA_ddi_1.$CPOEXTRA_fone_1;
				} else {
					$jornada_campo_chave = $cpf_cnpj;
					if ( !$jornada_campo_chave ) {
						$jornada_campo_chave = ValorClasse("JOR" . $nro_modelo, "CAMPO_CHAVE", $repre_vendedor);
						$jornada_campo_chave = $GLOBALS["CPOEXTRA_" . $jornada_campo_chave];
					}
				}
				require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/HistAtendPadrao.php");
				$objhist = new HistAtendPadrao($repre_vendedor);
				$objhist->gravaAtendimento('EMAIL', array('campo_chave' => $jornada_campo_chave, 'nome_gravacao' => $AI_email_id, 'grupo' => $grupo_email, 'nome_gravacao' => $AI_email_id, 'n_pedido' => $n_pedido, 'classe_mkpro' => $classe_mkpro, 'login_operador' => $session['operador']));
				if ($objhist->statusexec !== true) {
					print "ERRO AO INSERIR A JORNADA EMAIL [".$objhist->msgexec."]";
					exit();
				}
			}
		}

		if ($rotina_envia_fax == "S") {
			$mk_numero  = "MD".$nro_modelo;
			mostraRegraScript($repre_vendedor,$fax_sigla_script,"EXEC_ACAO");
		}

		if($nro_modelo == "7P" && $repre_vendedor == "CONAREC-U"){
			$rotina_envia_im = "S";
			$rotina_envia_im_sigla = "ENVIM";
			$rotina_envia_im_sigla_eventual = "ENVIM";
		}

		if($rotina_envia_im == "S") {

			$mk_numero    = "MD".$nro_modelo;

			if (Valida::Celular($atv_ddd_tel, $atv_num_tel) == true) {
				$id_contato_im      = "55".$atv_ddd_tel.$atv_num_tel;
			}elseif (Valida::Celular($atv_ddd_comercial, $atv_fone_comercial) == true) {
				$id_contato_im      = "55".$atv_ddd_comercial.$atv_fone_comercial;
			}elseif (Valida::Celular($atv_ddd_cont, $atv_num_cont) == true) {
				$id_contato_im      = "55".$atv_ddd_cont.$atv_num_cont;
			}
			$nome_im             = $nome_razao;
			$empresa_im          = $param_empresa;
			$repre_im            = $repre_vendedor;
      $GLOBALS["aiDebugPrint"] =false;
			$deonde_disparo = "MD";

			mostraRegraScript($repre_im, $rotina_envia_im_sigla, "EXEC_ACAO");


			if ($session["print_sql"] != "N") {
				print "<pre>";
				print_r($AI_retorno);
				print "</pre>";
			}
			if(is_array($AI_retorno[$rotina_envia_im_sigla])) {
				foreach($AI_retorno[$rotina_envia_im_sigla] as $key_sigla=>$arrRetAI){
					if($arrRetAI["msg"] == "OK"){
						$email_id .= $arrRetAI["id"]."¢";
					}else{
						// print "WHATSAPP NÃO ENVIADO";
						// print "<li>id".$id_contato_im;
						// print "<li>nome".$nome_im;
						// print "<li>erro:".$arrRetAI["msg"].$arrRetAI["error"];
						// print "<li>repre:".$repre_im;
						// print "<li>empresa:".$empresa_im;
						// exit;;
					}
				}
			}
		}




		if($rotina_envia_sms == "S") {
		  if ($matriz_ins["nome_razao"] != "") {
		    $aux_primeiro_nome = explode(" ", $matriz_ins["nome_razao"]);
		  } else {
		    $aux_primeiro_nome = explode(" ", $nome_razao);
		  }
		  $primeiro_nome_razao = $aux_primeiro_nome[0];

			$mk_numero    = "MD".$nro_modelo;
			$nro_operacao = $nro_modelo;
			$grupo_sms    = $grupo_sms;
			$empresa_sms  = $param_empresa;

	    if ($nro_modelo == "8A" || $nro_modelo == "VA" || $nro_modelo == "M4" || $nro_modelo == "3K" || $nro_modelo == "4J" || $nro_modelo == "MD" || $nro_modelo == "Y1" || $nro_modelo == "HS"  || $nro_modelo == "TT") {//faz a regra para pegar uns dos 3 telefones que for celular
				$achou_sms    = "N";
				if (Valida::Celular($atv_ddd_comercial, $atv_fone_comercial) == true) {
					$sms_ddd      = $atv_ddd_comercial;
					$sms_fone     = $atv_fone_comercial;
					$achou_sms    = "S";
				}
				if ($achou_sms == "N" && Valida::Celular($atv_ddd_tel, $atv_num_tel) == true) {
					$sms_ddd      = $atv_ddd_tel;
					$sms_fone     = $atv_num_tel;
					$achou_sms    = "S";
				}
				if ($achou_sms == "N" && Valida::Celular($atv_ddd_cont, $atv_num_cont) == true) {
					$sms_ddd      = $atv_ddd_cont;
					$sms_fone     = $atv_num_cont;
					$achou_sms    = "S";
				}
			}//caso contrário irá utilizar as variáveis que estão cadastradas na regra do acao inteligente.

			if($CPOEXTRA_sms_ddd_fone){
 			   $sms_ddd  = substr($CPOEXTRA_sms_ddd_fone,0,2);
			   $sms_fone = substr($CPOEXTRA_sms_ddd_fone,2);
			}

			if ($nro_modelo == "HS") {
				$ret_sms = mostraRegraScript($repre_vendedor, $sms_sigla_script, "EXEC_ACAO");
			} else {

//			  $aiDebugPrint = true;

				$ret_sms = mostraRegraScript($repre_vendedor, $sms_sigla_eventual, "EXEC_ACAO");
//				if ($nro_modelo == "3K") {
//
//			    var_dump($ret_sms);
//			    exit;
//			  }
			}

			if($AI_sms_id) {
				$email_id .= $AI_sms_id."¢";
			}


			if ($session["print_sql"] != "N" || strtoupper($session["operador"]) == "CHICO0002") {
				print "<li>rotina_envia_sms: [".$rotina_envia_sms."]";
				print "<li>matriz_ins[st_venda_cartao] = [".$matriz_ins["st_venda_cartao"]."]";
				print "<li>STVENDA_EXTRA_1_mov_ddd_sms = [".$STVENDA_EXTRA_1_mov_ddd_sms."]";
				print "<li>STVENDA_EXTRA_1_mov_tel_sms = [".$STVENDA_EXTRA_1_mov_tel_sms."]";
				print "<li>sms_ddd = [".$sms_ddd."]";
				print "<li>sms_fone = [".$sms_fone."]";
				print "<li>matriz_ins[bmc_fluxo] = [".$matriz_ins["bmc_fluxo"]."]";
				print "<li>classe_mkpro = [".$classe_mkpro."]";
				print "<li>mk_numero = [".$mk_numero."]";
				print "<li>nro_operacao = [".$nro_operacao."]";
				print "<li>grupo_sms = [".$grupo_sms."]";
				print "<li>empresa_sms = [".$empresa_sms."]";
				print "<li>repre_vendedor = [".$repre_vendedor."]";
				print "<li>sms_sigla_eventual = [".$sms_sigla_eventual."]";
				print "<li>sms_sigla_script: [".$sms_sigla_script."]";
				print "<li>RETORNO DA REGRA SMS: [".var_export($ret_sms, true)."]";
				print "<li>SMS SIGLA AGRUPAMENTO: [".$sms_sigla_agrupamento."]";
				print "<li>rechamado_status:   [".$rechamado_status."]";
				print "<li>rechamado_ativ_num: [".$rechamado_ativ_num."]";
				print "<li>rechamado_n_pedido: [".$rechamado_n_pedido."]";
				print "<li>rechamado_email:    [".$rechamado_email."]";
				print "<pre>";
				print_r($GLOBALS);
			}

			//ENVIA SMS PARA UM AGRUPAMENTO DE CONTATOS
			if (empty($sms_sigla_agrupamento) === false) {
				$ret_sms = mostraRegraScript($repre_vendedor, $sms_sigla_agrupamento, "EXEC_ACAO");
			}

			if($AI_sms_id) {
				$email_id .= $AI_sms_id."¢";
			}
			if(empty($AI_sms_id) === false && $utiliza_historico_atendimento == "S") {
				if ($repre_vendedor == "CONAREC-U" && $classe_mkpro == "MDKA") {
					$jornada_campo_chave = $CPOEXTRA_ddi_1.$CPOEXTRA_fone_1;
				} else {
					$jornada_campo_chave = $cpf_cnpj;
					if ( !$jornada_campo_chave ) {
						$jornada_campo_chave = ValorClasse("JOR" . $nro_modelo, "CAMPO_CHAVE", $repre_vendedor);
						$jornada_campo_chave = $GLOBALS["CPOEXTRA_" . $jornada_campo_chave];
					}
				}
				require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/HistAtendPadrao.php");
				$objhist = new HistAtendPadrao($repre_vendedor);
				$objhist->gravaAtendimento('SMS', array('campo_chave' => $jornada_campo_chave, 'nome_gravacao' => $AI_sms_id, 'grupo' => $grupo_sms, 'nome_gravacao' => $AI_sms_id, 'n_pedido' => $n_pedido, 'classe_mkpro' => $classe_mkpro, 'login_operador' => $session['operador']));
				if ($objhist->statusexec !== true) {
					print "ERRO AO INSERIR A JORNADA SMS [".$objhist->msgexec."]";
					exit();
				}
			}
		}
	}

	if($repre_vendedor == "CONAREC-U" && $classe_mkpro == "MDKA") {
		//dispara a ligação
    require_once($_SERVER['DOCUMENT_ROOT']."/libs/func/RegClienteMailing.php");
		$ret = RegClienteMailing::insereClienteMetraladora("CONAREC", "1474", $CPOEXTRA_fone_1, "", "", "8042¢".$CPOEXTRA_nome_cliente);

		if ($ret["status"] === false) {
			print $ret["msg"];
			exit();
		}

		$tipo_sms = "W";
		$array_msg_whatsapp = mostraRegraScript($repre_vendedor, "ENSMS¢W1", "ARR_TXT");
		require_once($_SERVER['DOCUMENT_ROOT']."/libs/cli/BotConarec2018.php");
		if (strlen($array_msg_whatsapp[0]) <= 0) {
			$msg_whats = "Olá! Seja bem vindo ao IntergrALL Experience CONAREC 2018. A partir de agora você vivenciará a melhor experiência Omnichannel!";
		} else {
			$msg_whats = $array_msg_whatsapp[0];
		}
    $ret = enviaWhatsApp($CPOEXTRA_fone_1, $msg_whats);

		if ($ret["status"] === false) {
			print $ret["msg"];
			// exit();
		}
	}

	if (strtoupper($session["operador"]) == "CHICO0002") {
		print "<li>RETORNO DA REGRA AGRUPADO SMS : [".var_export($ret_sms, true)."]";

		print "<pre>";
		print_r($_POST);
		print "</pre>";

		print "<li>ATIV_NUM => ".$flw_id_ativ;
		//exit;
	}

	if ($flw_grupo_acesso == "") {
		$flw_grupo_acesso = "1";//como estava fixo nos updates abaixo, caso esteja vazio a variavel coloca 1 fixo. Nosa casos de ouvidoria vem O e não estava funcionando Marcelo
	}
	if(($nro_modelo == "M4" || $nro_modelo == "4J") && ($AI_email_id || $AI_sms_id)) {
		$Dados = "UPDATE ".$tabela_historico." SET email_id = '".$email_id."' WHERE mk_flag = 'MD' AND mk_numero = '".$nro_modelo."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."' ";
		DescExecQuery($Dados, $connectHOST, "N");
	} else {
		//DAR UPDATE SE GERAR UM EVENTO FINALIZADO COLOCADO OR email_id = '0' POIS EXISTEM TABELAS QUE ESTÃO COM 0 E NÃO ESTAVA ATUALIZANDO MARCELO
		$Dados = "UPDATE ".$tabela_historico." SET email_id = '".$email_id."' WHERE mk_flag = 'MD' AND mk_numero = '".$nro_modelo."' AND grupo_acesso = '".$flw_grupo_acesso."' AND ativ_num = '".$flw_id_ativ."' AND status = 'F' AND (email_id = '' OR email_id = '0')";
		DescExecQuery($Dados, $connectHOST, "N");
	}

	if (strtoupper($session["operador"]) == "CAOAOPE1XXXX") {
		print "<li>".$Dados;
	  print "<pre>";
		print_r($_POST);
		print "</pre>";

		print "<li>ATIV_NUM => ".$flw_id_ativ;
		print "<li>".$Dados;
		exit;
	}

	//showvars();

	/*******************************************************
	*****************A VALIAÇÃO OUVIDORIA BACEN MARCELO******
	**********************************************************/
	require_once($_SERVER['DOCUMENT_ROOT']."/callcenter/flw_funcoes.php");
	$arrParamFLW['OUVE_AVA_BACEM_USA'] = 'OUVE_AVA_BACEM_USA';
	$mkFlwParam = carregaArrParamFLW(achaNroModelo($nro_modelo, $tipo_abertura), $repre_vendedor, $arrParamFLW);

	if ($mkFlwParam["ouve_ava_bacem_usa"] == "S" && ($atv_st_venda_cartao == "1" || $filtro_tema_pai == "ZZ")) {//somente para registro de protocolos produtivos
		$array_pesq_lig["id_lig"]        = $id_lig;
		$array_pesq_lig["nome_gravacao"] = $nome_gravacao;
		$retorno_pesq_ouve = gravaPesquisaOuvidoria(substr($classe_mkpro, 0, 2), substr($classe_mkpro, 2, 2), $flw_grupo_acesso, $flw_id_ativ, $repre_vendedor, $ouve_ava_bacem_tipo_solucao, $ouve_ava_bacem_tipo_pesquisa, $AI_email_id, $array_pesq_lig, $_POST);
		if ($retorno_pesq_ouve["status"] === false) {
			var_dump($retorno_pesq_ouve);
			exit();
		}
	}
	/*******************************************************
	*****************A VALIAÇÃO OUVIDORIA BACEN MARCELO******
	**********************************************************/

	if($nro_modelo == "3K") {
		$where_grava_cliente_gss = " WHERE cpf_cnpj = '".$cpf_cnpj."' ";
	}

	// SU 99008 - Temporário Leveros
	if($nro_modelo == 'L4' && $campo_clique_cliente == 'BOTAO_NOVO') {
		$where_grava_cliente_gss = " WHERE cpf_cnpj = '".$cpf_cnpj."' ";
	}

	if ($grava_cliente_gss == "S") {
		if ($cmp_extra_1) {$matriz_gss["campo_extra_1"]  = $cmp_extra_1;};
		if ($cmp_extra_2) {$matriz_gss["campo_extra_2"]  = $cmp_extra_2;};
		if ($cmp_extra_3) {$matriz_gss["campo_extra_3"]  = $cmp_extra_3;};
		if ($cmp_extra_4) {$matriz_gss["campo_extra_4"]  = $cmp_extra_4;};
		if ($cmp_extra_5) {$matriz_gss["campo_extra_5"]  = $cmp_extra_5;};
		if ($cmp_extra_6) {$matriz_gss["campo_extra_6"]  = $cmp_extra_6;};
		if ($cmp_extra_7) {$matriz_gss["campo_extra_7"]  = $cmp_extra_7;};
		if ($cmp_extra_8) {$matriz_gss["campo_extra_8"]  = $cmp_extra_8;};
		if ($cmp_extra_9) {$matriz_gss["campo_extra_9"]  = $cmp_extra_9;};
		if ($cmp_extra_ano_10) {$matriz_gss["campo_extra_10"] = $cmp_extra_ano_10."-".$cmp_extra_mes_10."-".$cmp_extra_dia_10;};
		if ($cmp_extra_ano_11) {$matriz_gss["campo_extra_11"] = $cmp_extra_ano_11."-".$cmp_extra_mes_11."-".$cmp_extra_dia_11;};

		if ($cmp_extra_12) {$matriz_gss["campo_extra_12"] = $cmp_extra_12;};
		if ($cmp_extra_13) {$matriz_gss["campo_extra_13"] = $cmp_extra_13;};
		if ($nro_modelo != "A8") {
			if ($cmp_script_1) {$matriz_gss["campo_script_1"] = stripslashes($cmp_script_1);};
		}

		$matriz_gss["representante"] = $repre_vendedor;
		$matriz_gss["empresa"]       = $param_empresa;
		$matriz_gss["classe_mkpro"]  = "MD".$nro_modelo;
		$matriz_gss["data_atualiza"] = date("Y-m-d");
		$matriz_gss["hora_atualiza"] = date("H:i:s");

		if($nro_modelo == "M4") {
			$matriz_gss["login_operador"]   = $session["operador"];
		}

		$matriz_gss["renda"]              = $matriz_ins["renda"];
		$matriz_gss["sexo"]               = $matriz_ins["sexo"];
		$matriz_gss["estadocivil"]        = $matriz_ins["estadocivil"];
		$matriz_gss["nacionalidade"]      = $matriz_ins["nacionalidade"];
		$matriz_gss["email"]              = $matriz_ins["email"];
		$matriz_gss["data_nasc"]          = $matriz_ins["data_nasc"];
		$matriz_gss["cargo"]              = $matriz_ins["cargo"];
		$matriz_gss["nome_empresa"]       = $matriz_ins["nome_empresa"];
		$matriz_gss["data_nasc"]          = $matriz_ins["data_nasc"];
		$matriz_gss["rg"]                 = $matriz_ins["rg"];
		$matriz_gss["rg_orgao"]           = $matriz_ins["rg_orgao"];
		$matriz_gss["rg_uf"]              = $matriz_ins["rg_uf"];
		$matriz_gss["dt_emissao_rg"]      = $matriz_ins["dt_emissao_rg"];

		//*****************ROTINA PARA GRAVAÇÂO DOS ENDEREÇOS CASO TENHA NO CAMPO EXTRA
		if (empty($matriz_gss["cep"]) === true && empty($t_cep) === false) {
			$matriz_gss["cep"]            = $t_cep;
		}
		if (empty($matriz_gss["end_tip_log"]) === true && empty($t_end_tip_log) === false) {
			$matriz_gss["end_tip_log"]    = trim(strtoupper($t_end_tip_log));
		}
		if (empty($matriz_gss["end_nom_log"]) === true && empty($t_end_nom_log) === false) {
			$matriz_gss["end_nom_log"]    = trim(strtoupper($t_end_nom_log));
		}
		if (empty($matriz_gss["end_num"]) === true && empty($t_end_num) === false) {
			$matriz_gss["end_num"]        = trim($t_end_num);
		}
		if (empty($matriz_gss["end_compl"]) === true && empty($t_end_compl) === false) {
			$matriz_gss["end_compl"]      = trim(strtoupper($t_end_compl));
		}
		if (empty($matriz_gss["bairro"]) === true && empty($t_bairro) === false) {
			$matriz_gss["bairro"]         = trim(strtoupper($t_bairro)) ;
		}
		if (empty($matriz_gss["cidade"]) === true && empty($t_cidade) === false) {
			$matriz_gss["cidade"]         = trim(strtoupper($t_cidade));
		}
		if (empty($matriz_gss["uf"]) === true && empty($t_uf) === false) {
			$matriz_gss["uf"]             = trim(strtoupper($t_uf));
		}

		//***************************************************************************
		//***************************************************************************

		if ($nro_modelo != "NE") {
			$matriz_gss["ddd_tel"]              = $atv_ddd_tel;
			$matriz_gss["num_tel"]              = $atv_num_tel;
			$matriz_gss["ramal_tel"]            = $atv_ramal_tel;

			$matriz_gss["ddd_comercial"]        = $atv_ddd_comercial;
			$matriz_gss["fone_comercial"]       = $atv_fone_comercial;
			$matriz_gss["ramal_comercial"]      = $atv_ramal_comercial;

			$matriz_gss["ddd_outro"]            = $atv_ddd_cont;
			$matriz_gss["num_outro"]            = $atv_num_cont;
			$matriz_gss["ramal_outro"]          = $atv_ramal_cont;
		}

		if($where_grava_cliente_gss_id_receptivo){
			$where_grava_cliente_gss = $where_grava_cliente_gss_id_receptivo;
		}

    if ((substr($repre_vendedor,0,8) != "TRIBANCO" && substr($repre_vendedor,0,3) != "BMC") || (substr($repre_vendedor,0,8) == "TRIBANCO" && $where_grava_cliente_gss != "") || (substr($repre_vendedor,0,3) == "BMC" && $cpf_cnpj != "")) {
      insereAlteraClienteGss($cpf_cnpj,$matriz_gss,$mk_numero,$where_grava_cliente_gss);
      // Portocred Consignado
      // Execução de Web Service para alteração de dados cadastrais
      if ($repre_vendedor == "PORTOCRED" && $nro_modelo == "OP") {
      	if ($existe_diferenca === true) {
      		require_once("md_cad_prop_bd_pos.php");
      	}
      }
    }

	}

	if ($bloquear_cliente == "S") {
		if (!$campo_chave) {
			$campo_chave = $atv_campo_chave;
		}
		if (!$campo_chave) {
			$campo_chave = $atv_seq;
		}
		$matriz_bloq_cliente["representante"] = $repre_vendedor;
		$matriz_bloq_cliente["campo_chave"]   = $campo_chave;
		$matriz_bloq_cliente["cpf_cnpj"]      = $cpf_cnpj;
		$matriz_bloq_cliente["nome_razao"]    = $nome_razao;
		$matriz_bloq_cliente["data_cri"]      = Date("Y-m-d");
		$matriz_bloq_cliente["hora_cri"]      = Date("H:i:s");
		$matriz_bloq_cliente["login_cri"]     = $session["operador"];
		$matriz_bloq_cliente["data_atualiza"] = Date("Y-m-d");
		$matriz_bloq_cliente["hora_atualiza"] = Date("H:i:s");
		$matriz_bloq_cliente["login_atualiza"] = $session["operador"];
		$matriz_bloq_cliente["bina_cliente"]   = $mk_ramal["bina_gravacao"];
		$matriz_bloq_cliente["nome_gravacao"]  = $mk_ramal["nome_gravacao"];
		$msg_bloq    = FazInsert($matriz_bloq_cliente,"tb_clientes_bloq",$connectHOST);

		if (substr($msg_bloq,0,2) != "OK") {
			if (strpos($msg_bloq,"duplicada para a chave")== 0) {
				print $msg_bloq;
				exit;
			}
		}
	}

	if (!$atv_nome_razao_ant) {
		$nome_razao_temp = $atv_nome_razao;
	} else {
		$nome_razao_temp = $atv_nome_razao_ant;
	}

	if (!$atv_cpf_cnpj_ant) {
		$cpf_cnpj_temp = $atv_cpf_cnpj;
	} else {
		$cpf_cnpj_temp = $atv_cpf_cnpj_ant;
	}

	if (!$cpf_cnpj_temp) {
		$cpf_cnpj_temp = $cpf_cnpj;
	}

	if ($classe_reg_lig) {
		require_once("rl_funcoes.php");
		if (trim(substr($servico_dac  ,0,4)) == "sem") {
			$grupo_tronco = ValorClasse("MD".$nro_modelo."B","GRUPO_TRONCO","URANET");
			$grupo_grava_rlig = $grupo_tronco;
		} else {
			$grupo_grava_rlig = substr($servico_dac,0,-1);
		}

		$arr_classe_reg_lig = explode("§",$classe_reg_lig);
		$var_classe_reg_lig = $arr_classe_reg_lig[1];
		if (!$$var_classe_reg_lig) {
			$campo_grava_r_lig = "01";
		} else {
			$campo_grava_r_lig = $$var_classe_reg_lig;
		}
		insereRegistroLigacao(Date("Y").Date("m"), date("Y-m-d"),$session["operador"],$repre_vendedor,$grupo_grava_rlig,"P","S","1",$campo_grava_r_lig,$arr_classe_reg_lig[0],"R","lig_hora_".Date("H"));
	}

	//ROTINA PARA DAR BAIXA EM UM CLIENTE NA TABELA ATIVO DO DISCADOR PARAMETRIZADO
	if (($baixa_registro_mailing != "N") && (empty($baixa_registro_mailing) === false)) {
		//******************************************
		//INICIO DA ROTINA DE BAIXA DO MAILING GERAL
		//******************************************
		require_once("mk_funcoes.php");

		//PEGA OS PARAMETROS PARA BAIXA DE MAILING
		$aux_parametro_baixa_registro_mailing = explode("§", $baixa_registro_mailing);

		if (empty($aux_parametro_baixa_registro_mailing[0]) === true) {
			print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING - NÚMERO DOS DISCADORES) INCOMPLETO . <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
			exit();
		}

		if (empty($aux_parametro_baixa_registro_mailing[1]) === true) {
			print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING - CAMPOS WHERE) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
			exit();
		}

		if (empty($aux_parametro_baixa_registro_mailing[2]) === true) {
			print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING - ST_VENDA_CARTAO) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
			exit();
		}

		if (empty($aux_parametro_baixa_registro_mailing[3]) === true) {
			print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING - COD_RECUSA) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
			exit();
		}

		//PEGA OS NUMEROS DOS DISCADORES QUE SERÁ ATUALIZADA A TABELA ATIVO
		$mtr_num_discadores_baixa_mailing = explode(",", $aux_parametro_baixa_registro_mailing[0]);
		//PEGA OS CAMPOS PARA O WHERE DO UPDATE NA TABELA ATIVO
		$mtr_campos_where_baixa_mailing = explode(",", $aux_parametro_baixa_registro_mailing[1]);

		if (empty($mtr_num_discadores_baixa_mailing[0]) === true) {
			print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING - NÚMERO DOS DISCADORES) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
			exit();
		}

		if (empty($mtr_campos_where_baixa_mailing[0]) === true) {
			print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING - CAMPOS WHERE) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
			exit();
		}

		//PEGA O ST_VENDA_CARTAO QUE FOI PARAMETRIZADO PARA O UPDATE
		$st_venda_cartao_baixa_mailing = trim($aux_parametro_baixa_registro_mailing[2]);
		//PEGA O COD_RECUSA QUE FOI PARAMETRIZADO PARA O UPDATE
		$aux_cod_recusa_baixa_mailing = explode("¢", $aux_parametro_baixa_registro_mailing[3]);
		$cod_recusa_baixa_mailing = trim($aux_cod_recusa_baixa_mailing[0]);
		$classe_recusa_baixa_mailing = trim($aux_cod_recusa_baixa_mailing[1]);
		if (strlen($classe_recusa_baixa_mailing) == 5) {
			$update_classe_recusa_baixa_mailing = ", classe_recusa = '".$classe_recusa_baixa_mailing."'";
		} else {
			unset($update_classe_recusa_baixa_mailing);
		}

		if ($fez_insert_na_ativo) {
			$where_insert_tb_ativo = " campo_chave <> '".$matriz_upag["campo_chave"]."' AND ";
		}

		// MONTA O WHERE DO UPDATE DE ACORDO COM OS PARAMETROS
		$where_baixa_mailing = " WHERE st_venda_cartao in ('4', '0') AND ".$where_insert_tb_ativo;

		foreach ($mtr_campos_where_baixa_mailing as $chave => $campos) {
			$aux_campos_baixa = explode("=", $campos);
			$aux_campos_baixa[0] = trim($aux_campos_baixa[0]);
			$aux_campos_baixa[1] = trim($aux_campos_baixa[1]);
			if (empty($aux_campos_baixa[0]) === true || empty($aux_campos_baixa[1]) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING - CAMPOS WHERE) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}
			$where_baixa_mailing.= $aux_campos_baixa[0]." = '".${$aux_campos_baixa[1]}."'";
			$where_baixa_mailing.= " AND ";
		}

		$where_baixa_mailing = substr($where_baixa_mailing, 0, -4);

		//FAZ UPDATE NA TABELA ATIVO NOS DISCADORES PARAMETRIZADOS
		foreach ($mtr_num_discadores_baixa_mailing as $chave => $nro_discador_baixa) {
			if (substr($nro_discador_baixa, 0, 2) == "DK") {
				$nome_tabela = "tabela";
			} else {
				$nome_tabela = "tabela_ativo";
			}

			//pega os parametros de conexão do banco de dados
			$connectMK     = ConnectMKPARAM();
			$q = "SELECT vlr_classe, desc_classe FROM tb_mk_classe WHERE cod_classe = '".$nro_discador_baixa."A' AND representante = 'URANET' AND tipo_reg = 'I' AND status = 'A' AND vlr_classe IN('host', 'user', 'senha', 'bd', '".$nome_tabela."')";
			if ($query = DescExecQuery($q, $connectMK, "N", $session["operador"], $_SERVER['PHP_SELF'])) {
				if ($rec = mysql_fetch_assoc($query)) {
					do{//gera matriz com os barametros do bd
						$arr_parametro_bd_discador_baixa_mailing[$rec["vlr_classe"]] = $rec["desc_classe"];
					}while ($rec = mysql_fetch_assoc($query));
				} else {
					print "<div align=\"center\"><font color=\"red\"><strong>PARÂMETRO DO BANCO DE DADOS DO DISCADOR '".$nro_discador_baixa."' NÃO ENCONTRADO NA CLASSE '".$nro_discador_baixa."A'.<br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
					exit();
				}
				//FAZ O UPDATE
				$connect_bd_baixa_mailing = Conecta($arr_parametro_bd_discador_baixa_mailing["host"], $arr_parametro_bd_discador_baixa_mailing["user"], $arr_parametro_bd_discador_baixa_mailing["senha"], $arr_parametro_bd_discador_baixa_mailing["bd"]);
				$q_baixa_mailing = "UPDATE ".$arr_parametro_bd_discador_baixa_mailing[$nome_tabela]." SET st_venda_cartao = '".$st_venda_cartao_baixa_mailing."' ".$update_classe_recusa_baixa_mailing.", cod_recusa = '".$cod_recusa_baixa_mailing."', representante = '".$repre_vendedor."', status = 'U', ano_mes = '".date("Ym")."', login_operador = '".strtolower($session["operador"])."', data_atualiza = '".$data."', hora_atualiza = '".$hora."', data_agenda = '1111-11-11', hora_agenda = '00:00:00' ".$where_baixa_mailing;
				if ($query = DescExecQuery($q_baixa_mailing, $connect_bd_baixa_mailing, "N", $session["operador"], $_SERVER['PHP_SELF']) === false) {
					print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO BAIXA_REGISTRO_MAILING<br>".mysql_error($connect_bd_baixa_mailing)."<br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
					exit();
				}
			} else {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO BAIXA_REGISTRO_MAILING<br>".mysql_error($connectMK)."<br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}
		}
		//***************************************
		//FIM DA ROTINA DE BAIXA DO MAILING GERAL
		//***************************************
	} else {
		//****************************************************
		//INICIO VERIFICA SE A ROTINA DE BAIXA É POR CONCLUSÃO
		//****************************************************
		switch ($tipo_atend_co){//o radio q o operador escolheu
			case "1": /* Aceitou  */
			$atv_st_venda_cartao_baixa_mailing = "1";
			if(!$cod_recusa_1){
				$cod_recusa_baixa_mailing_tela    = $arr_param_atu_logura[0];
				$classe_recusa_baixa_mailing_tela = $arr_param_atu_logura[1];
			}else{
				$cod_recusa_baixa_mailing_tela    = $cod_recusa_1;
				$classe_recusa_baixa_mailing_tela = $param_classe_venda;
			}
			break;

			case "2"://******* Recusa ***********
			$atv_st_venda_cartao_baixa_mailing = "2";
			$cod_recusa_baixa_mailing_tela    = $cod_recusa_2;
			$classe_recusa_baixa_mailing_tela = $param_classe_recusa;
			break;

			case "3"://******* Contato Impossível ***********
			$atv_st_venda_cartao_baixa_mailing = "3";
			$cod_recusa_baixa_mailing_tela    = $cod_recusa_3;
			$classe_recusa_baixa_mailing_tela = $param_classe_c_imp;
			break;

			case "0"://******* Contato Impossível ***********
			case "4"://******* Contato Impossível ***********
			$atv_st_venda_cartao_baixa_mailing = $tipo_atend_co;
			$cod_recusa_baixa_mailing_tela    = $cod_recusa_4;
			$classe_recusa_baixa_mailing_tela = $param_classe_agenda;
			break;

			case "6"://******* Contato Impossível ***********
			$atv_st_venda_cartao_baixa_mailing = "6";
			$cod_recusa_baixa_mailing_tela    = $cod_recusa_6;
			$classe_recusa_baixa_mailing_tela = $classe_adic_6;
			break;

			case "7"://******* Contato Impossível ***********
			$atv_st_venda_cartao_baixa_mailing = "6";
			$cod_recusa_baixa_mailing_tela    = $cod_recusa_7;
			$classe_recusa_baixa_mailing_tela = $classe_adic_7;
			break;

			case "8"://******* Contato Impossível ***********
			$atv_st_venda_cartao_baixa_mailing = "8";
			$cod_recusa_baixa_mailing_tela    = $cod_recusa_8;
			$classe_recusa_baixa_mailing_tela = $classe_adic_8;
			break;

			case "9"://******* Contato Impossível ***********
			$atv_st_venda_cartao_baixa_mailing = "9";
			$cod_recusa_baixa_mailing_tela    = $cod_recusa_9;
			$classe_recusa_baixa_mailing_tela = $classe_adic_9;
			break;
			default:
				break;
		}

		if ((${"baixa_registro_mailing_".$atv_st_venda_cartao_baixa_mailing} != "N") && (empty(${"baixa_registro_mailing_".$atv_st_venda_cartao_baixa_mailing}) === false)) {
			require_once("mk_funcoes.php");
			//PEGA OS PARAMETROS PARA BAIXA DE MAILING
			$aux_parametro_baixa_registro_mailing = explode("§", ${"baixa_registro_mailing_".$atv_st_venda_cartao_baixa_mailing});

			if (empty($aux_parametro_baixa_registro_mailing[0]) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - NÚMERO DOS DISCADORES) INCOMPLETO . <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			if (empty($aux_parametro_baixa_registro_mailing[1]) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - CAMPOS WHERE) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			if (empty($aux_parametro_baixa_registro_mailing[2]) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - ST_VENDA_CARTAO) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			if (empty($aux_parametro_baixa_registro_mailing[3]) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - COD_RECUSA) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			//PEGA OS NUMEROS DOS DISCADORES QUE SERÁ ATUALIZADA A TABELA ATIVO
			$mtr_num_discadores_baixa_mailing = explode(",", $aux_parametro_baixa_registro_mailing[0]);
			//PEGA OS CAMPOS PARA O WHERE DO UPDATE NA TABELA ATIVO
			$mtr_campos_where_baixa_mailing = explode(",", $aux_parametro_baixa_registro_mailing[1]);

			if (empty($mtr_num_discadores_baixa_mailing[0]) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - NÚMERO DOS DISCADORES) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			if (empty($mtr_campos_where_baixa_mailing[0]) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - CAMPOS WHERE) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			//PEGA O ST_VENDA_CARTAO QUE FOI PARAMETRIZADO PARA O UPDATE
			$st_venda_cartao_baixa_mailing = trim($aux_parametro_baixa_registro_mailing[2]);
			if ($st_venda_cartao_baixa_mailing == "TELA") {
				$st_venda_cartao_baixa_mailing = $atv_st_venda_cartao_baixa_mailing;
			}
			//PEGA O COD_RECUSA QUE FOI PARAMETRIZADO PARA O UPDATE
			$aux_cod_recusa_baixa_mailing = explode("¢", $aux_parametro_baixa_registro_mailing[3]);
			$cod_recusa_baixa_mailing = trim($aux_cod_recusa_baixa_mailing[0]);
			$classe_recusa_baixa_mailing = trim($aux_cod_recusa_baixa_mailing[1]);

			if ($cod_recusa_baixa_mailing == "TELA") {
				$cod_recusa_baixa_mailing = $cod_recusa_baixa_mailing_tela;
			}

			if ($classe_recusa_baixa_mailing == "TELA") {
				$classe_recusa_baixa_mailing = $classe_recusa_baixa_mailing_tela;
			}

			if (empty($st_venda_cartao_baixa_mailing) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - ST_VENDA_CARTAO TELA) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			if (empty($cod_recusa_baixa_mailing) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - COD_RECUSA TELA) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			if (empty($classe_recusa_baixa_mailing) === true) {
				print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - CLASSE_RECUSA TELA) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
				exit();
			}

			if (strlen($classe_recusa_baixa_mailing) == 5) {
				$update_classe_recusa_baixa_mailing = ", classe_recusa = '".$classe_recusa_baixa_mailing."'";
			} else {
				unset($update_classe_recusa_baixa_mailing);
			}

			// MONTA O WHERE DO UPDATE DE ACORDO COM OS PARAMETROS

			if ($fez_insert_na_ativo) {
				$where_insert_tb_ativo = " campo_chave <> '".$matriz_upag["campo_chave"]."' AND ";
			}

			// MONTA O WHERE DO UPDATE DE ACORDO COM OS PARAMETROS
			$where_baixa_mailing = " WHERE st_venda_cartao in ('4', '0') AND ".$where_insert_tb_ativo;

			foreach ($mtr_campos_where_baixa_mailing as $chave => $campos) {
				$aux_campos_baixa = explode("=", $campos);
				$aux_campos_baixa[0] = trim($aux_campos_baixa[0]);
				$aux_campos_baixa[1] = trim($aux_campos_baixa[1]);
				if (empty($aux_campos_baixa[0]) === true || empty($aux_campos_baixa[1]) === true) {
					print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO (BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing." - CAMPOS WHERE) INCOMPLETO. <br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
					exit();
				}
				$where_baixa_mailing.= $aux_campos_baixa[0]." = '".${$aux_campos_baixa[1]}."'";
				$where_baixa_mailing.= " AND ";
			}

			$where_baixa_mailing = substr($where_baixa_mailing, 0, -4);

			//FAZ UPDATE NA TABELA ATIVO NOS DISCADORES PARAMETRIZADOS
			foreach ($mtr_num_discadores_baixa_mailing as $chave => $nro_discador_baixa) {
				if (substr($nro_discador_baixa, 0, 2) == "DK") {
					$nome_tabela = "tabela";
				} else {
					$nome_tabela = "tabela_ativo";
				}

				//pega os parametros de conexão do banco de dados
				$connectMK     = ConnectMKPARAM();
				$q = "SELECT vlr_classe, desc_classe FROM tb_mk_classe WHERE cod_classe = '".$nro_discador_baixa."A' AND representante = 'URANET' AND tipo_reg = 'I' AND status = 'A' AND vlr_classe IN('host', 'user', 'senha', 'bd', '".$nome_tabela."')";
				if ($query = DescExecQuery($q, $connectMK, "N", $session["operador"], $_SERVER['PHP_SELF'])) {
					if ($rec = mysql_fetch_assoc($query)) {
						do{//gera matriz com os barametros do bd
							$arr_parametro_bd_discador_baixa_mailing[$rec["vlr_classe"]] = $rec["desc_classe"];
						}while ($rec = mysql_fetch_assoc($query));
					} else {
						print "<div align=\"center\"><font color=\"red\"><strong>PARÂMETRO DO BANCO DE DADOS DO DISCADOR '".$nro_discador_baixa."' NÃO ENCONTRADO NA CLASSE '".$nro_discador_baixa."A'.<br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
						exit();
					}
					//FAZ O UPDATE
					$connect_bd_baixa_mailing = Conecta($arr_parametro_bd_discador_baixa_mailing["host"], $arr_parametro_bd_discador_baixa_mailing["user"], $arr_parametro_bd_discador_baixa_mailing["senha"], $arr_parametro_bd_discador_baixa_mailing["bd"]);
					$q_baixa_mailing = "UPDATE ".$arr_parametro_bd_discador_baixa_mailing[$nome_tabela]." SET st_venda_cartao = '".$st_venda_cartao_baixa_mailing."' ".$update_classe_recusa_baixa_mailing.", cod_recusa = '".$cod_recusa_baixa_mailing."', representante = '".$repre_vendedor."', status = 'U', ano_mes = '".date("Ym")."', login_operador = '".strtolower($session["operador"])."', data_atualiza = '".$data."', hora_atualiza = '".$hora."', data_agenda = '1111-11-11', hora_agenda = '00:00:00' ".$where_baixa_mailing;
					if ($query = DescExecQuery($q_baixa_mailing, $connect_bd_baixa_mailing, "N", $session["operador"], $_SERVER['PHP_SELF']) === false) {
						print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing."<br>".mysql_error($connect_bd_baixa_mailing)."<br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
						exit();
					}
				} else {
					print "<div align=\"center\"><font color=\"red\"><strong>Erro: PARÂMETRO BAIXA_REGISTRO_MAILING_".$atv_st_venda_cartao_baixa_mailing."<br>".mysql_error($connect)."<br>ENTRE EM CONTATO COM UM ANALISTA.</strong></font></div>";
					exit();
				}
			}
		}
		//*************************************************
		//FIM VERIFICA SE A ROTINA DE BAIXA É POR CONCLUSÃO
		//*************************************************
	}
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//rotina de gravação de Evento no Modelo
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************


	if(substr($matriz_ins["classe_mkpro"],2,2) == "SR" && $matriz_ins["st_venda_cartao"] == '1'){
		$param_grava_evento_atendimento_padrao = "sa";
	}
	if(substr($matriz_ins["classe_mkpro"],2,2) == "AU" && $matriz_ins["st_venda_cartao"] == '1'){
		$param_grava_evento_atendimento_padrao = "sa";
	}

	if(substr($classe_mkpro,2,2) == "AL" && $matriz_ins["st_venda_cartao"] == '1'){
		$param_grava_evento_atendimento_padrao = "sa1";
	}
	if((substr($classe_mkpro,2,2) == "AW" || substr($classe_mkpro,2,2) == "AN") && $matriz_ins["st_venda_cartao"] == '2'){
		$param_grava_evento_atendimento_padrao = "sa3";
	}

	if (($grava_evento_no_especifico == true) || ($grava_proposta == "sim" && $faz_insert_atd_padrao != "nao" && ($insere_evento_atendimento == "sim" || $param_grava_evento_atendimento_padrao != ""))) {
		if($param_grava_evento_atendimento_padrao == "") {
			if($matriz_ins["sistema_aux_status"] == ""){
				$param_grava_evento_atendimento_padrao ="sa";
			}else{
				$param_grava_evento_atendimento_padrao = $matriz_ins["sistema_aux_status"];
			}
		}

		$arrSistemaEvento = carregaParamSA($param_grava_evento_atendimento_padrao,"SA".substr($classe_mkpro,2,2)."B",$param_repre_sistema);

		if($arrSistemaEvento["usar_evento"] > 0) {
			$arr_campos = explode("¢",$arrSistemaEvento["evento_campos"]);
			$arr_vlr_campo1 = explode("£",$arr_campos[0]);
			$arr_vlr_campo2 = explode("£",$arr_campos[1]);
			$arr_vlr_campo3 = explode("£",$arr_campos[2]);
			$arr_vlr_campo4 = explode("£",$arr_campos[3]);


			//***********CAMPOS DO EVENTO

			if($arrSistemaEvento["nome_chave1_evento"]){
				$matriz_evento["chave1"] = $matriz_ins[$arrSistemaEvento["nome_chave1_evento"]];
				$matriz_evento["chave2"] = $matriz_ins[$arrSistemaEvento["nome_chave2_evento"]];
				$matriz_evento["chave3"] = $matriz_ins[$arrSistemaEvento["nome_chave3_evento"]];
			}else{
				$matriz_evento["chave1"] = $matriz_ins[$arrSistemaEvento["nome_chave1"]];
				$matriz_evento["chave2"] = $matriz_ins[$arrSistemaEvento["nome_chave2"]];
				$matriz_evento["chave3"] = $matriz_ins[$arrSistemaEvento["nome_chave3"]];
			}

			$matriz_evento["representante"] = $matriz_ins["representante"];
			$matriz_evento["empresa"]       = $matriz_ins["empresa"];
			$matriz_evento["classe_mkpro"]  = $matriz_ins["classe_mkpro"];
			$matriz_evento["data"]          = $matriz_ins["data_cri"];
			$matriz_evento["hora"]          = $matriz_ins["hora_cri"];
			if($sla_atd_padrao == "S"){//quando utiliza SLA
			    $matriz_evento["data_hora"]     = $matriz_ins["data_cri"]." ".$matriz_ins["hora_cri"];
			}

			$matriz_evento["login"]         = $matriz_ins["login_operador"];
			$matriz_evento["equipe"]         = $matriz_ins["equipe"];

			$matriz_evento["sa_tipo"]                   = "ATD";

			$matriz_evento["status"]                   = $matriz_ins["status"];
			$matriz_evento["sistema_aux_status"]       = $matriz_ins["sistema_aux_status"];
			$matriz_evento["classe_recusa"]            = $matriz_ins["classe_recusa"];
			$matriz_evento["cod_recusa"]               = $matriz_ins["cod_recusa"];

			$matriz_evento["status_ant"]                   = "";
			$matriz_evento["sistema_aux_status_ant"]       = "";
			$matriz_evento["classe_recusa_ant"]            = "";
			$matriz_evento["cod_recusa_ant"]               = "";

			//******grava os dados do cliente capturados na tela anterior******
			$matriz_evento["campo1"]               = $matriz_ins[$arr_vlr_campo1[1]];
			$matriz_evento["campo2"]               = $matriz_ins[$arr_vlr_campo1[2]];
			$matriz_evento["campo3"]               = $matriz_ins[$arr_vlr_campo1[3]];
			$matriz_evento["campo4"]               = $matriz_ins[$arr_vlr_campo1[4]];
			//*********************************************************************************
			$matriz_evento["observacao"]      = $matriz_ins["observacao"];

			$matriz_evento["id_lig"]          = $matriz_ins["id_lig"];
			$matriz_evento["nome_gravacao"]   = $matriz_ins["nome_gravacao"];
			$matriz_evento["ramal"]           = $matriz_ins["ramal"];
			$matriz_evento["servico_dac"]     = $matriz_ins["grupo"];

			//CAMPOS CONTENDO OS DADOS DO EMAIL
			if($email_id){
				$matriz_evento["email_id"]     = $email_id;
			}else{
				$matriz_evento["email_id"]     = $AI_email_id;
			}

			if(!$matriz_evento["email_id"]) { $matriz_evento["email_id"] = $mk_email_id; }
			$matriz_evento["email_grupo"]  = $grupo_email;

			//    $matriz_evento["anexos"]     = $matriz_ins["anexos"];

			if(is_array($matriz_papa_tudo_evento) === true){
				$matriz_evento = array_merge($matriz_evento,$matriz_papa_tudo_evento);
			}

			$retorno_ins_evento = FazInsert($matriz_evento,"tb_prop_evento",$str_connect);
			if($retorno_ins_evento != "OK"){
				print "EVENTO NAO INCLUIDO POIS ERRO NO INSERT<br>";
				print "ERRO::::".$retorno_ins_evento;
				exit;
			}
		}else{
			print "PARAMETRO DE GRAVAR EVENTO DO SA NO ATENDIMENTO PARAMETRIZADO COMO 'SIM' POREM NO '".$matriz_ins["sistema_aux_status"]."' NÃO ESTÁ PARAMETRIZADO O EVENTO";
			PRINT "<BR><BR>CONTATE UM ANALISTA DA URANET PARA CORREÇÃO DA PARAMETRIZAÇÃO";
			EXIT;
		}
	}

	if ($session["operador"] == "expoes002") {
		print "<pre>";
		print "<li>MATRIZ_INS<br>";
		print_r($matriz_ins);
		print "<li>MATRIZ_EVENTO<br>";
		print_r($matriz_evento);
	}

	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//FIMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
	//rotina de gravação de Evento no Modelo
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
	//*********************************************************************************************************************************
}

//if(strtoupper($session["operador"]) == "TFARTHUR"){
//  print "<pre>";
//  var_dump($_REQUEST);
//  $GLOBALS["aiDebugPrint"] = true;
//}

if(($nro_modelo == "LW" || $nro_modelo == "BG") && $atv_st_venda_cartao == "1" && $CPOEXTRA_campo_extra_2) {
  $empresa_im            = "TELEFVDA-PCART";
  $repre_im              = "TELEFVDA-PCART";
  $rotina_envia_im_sigla = "ENVIM";
  $nome_im               = $nome_razao;
  $id_contato_im         = "55".$CPOEXTRA_campo_extra_4;

  if($nro_modelo == "LW") {
    $grupo_im      = "HS0CA1";
  } else {
	$grupo_im      = "HS0CA2";
  }
  $arr_var_im[0] = "MD".$nro_modelo;
  $arr_var_im[1] = $CPOEXTRA_campo_extra_2;

  $deonde_disparo   = "ATIVO_CONTATO";

  global $AI_sms_id;
  mostraRegraScript($repre_im, $rotina_envia_im_sigla, "EXEC_ACAO");
}

if($nro_modelo == "SA" || $simular_ligacao_receptivo != "") {
	$objRamal = new RamalWeb($session["ip_dac"], $session["porta_dac"], $ramal_atend);
	//  if ($objRamal->getStatus("ATEND_DADOS") === true) {
	$objRamal->AtendimentoFim(array("data_hora" => date("Y-m-d H:i:s"), "representante" => $session["representante"]));
	//}
}

if($mk_form_veio_ajax === "SIM") {

	$matriz_conf["trs_do_conf"]      = $trs_do_conf;
	$matriz_conf["msg_ok"]           = $msg_ok;
	$matriz_conf["msg_docs"]         = $msg_docs;
	$matriz_conf["msg_erro"]         = $msg_erro;
	$matriz_conf["atv_nome_razao"]   = $nome_razao_temp;
	$matriz_conf["atv_cpf_cnpj"]     = $cpf_cnpj_temp;
	$matriz_conf["atv_campanha"]     = $atv_campanha;
	$matriz_conf["atv_st_venda_cartao"] = $atv_st_venda_cartao;
	$matriz_conf["tipo_modelo"]         = $tipo_modelo;
	$matriz_conf["tipo"]                = $tipo;


	if($matriz_ins["n_pedido"]){
		$n_pedido = $matriz_ins["n_pedido"];
	}

	$matriz_conf["n_pedido"]                = $n_pedido;
	$matriz_conf["frm_pagto"]               = $matriz_ins["frm_pagto"];
	$matriz_conf["campo_passa1"]            = $campo_passa1;
	$matriz_conf["campo_passa2"]            = $campo_passa2;
	$matriz_conf["campo_passa3"]            = $campo_passa3;

	if (!$num_prop) {
		$num_prop = $idFazInsert;
	}
	$matriz_conf["num_prop"]                  = $num_prop;
	$matriz_conf["envia_prop_janela"]         = $envia_prop_janela;
	$matriz_conf["deonde_sitema_cartao"]      = $deonde_sitema_cartao;

	foreach ($matriz_conf as $key_conf=>$value_conf){
		$str_retorno .= "&".$key_conf."=".urlencode($value_conf) ;
	}
	$str_retorno .= $str_cpoextra_passa_conf;
	print "OK|".$str_retorno;
	exit;

} else {

	if (!$pgm_conf) {
    $pgm_conf = "md_cad_prop_conf.php";
	}
?>

      <html>
      <body>
      <form name="envia_bd" action="<?print $pgm_conf?>" METHOD="POST">

         <?
         print $hiddens_cpoextra_passa_conf;
         ?>
         <input type="hidden" name="ouv_origem"         value="<?print $ouv_origem;?>"   >
         <input type="hidden" name="ligou_na_ficha"     value="<?print $ligou_na_ficha;?>"   >

         <input type="hidden" name="tipo_popup"         value="<?print $tipo_popup;?>"   >
         <input type="hidden" name="lead_n_pedido"      value="<?print $lead_n_pedido;?>">
         <input type="hidden" name="lead_status"        value="<?print $lead_status;?>"  >
         <input type="hidden" name="lead_id"            value="<?print $lead_id;?>"      >
         <input type="hidden" name="lead_grupo"         value="<?print $lead_grupo;?>"   >
         <input type="hidden" name="lead_mkpro"         value="<?print $lead_mkpro;?>"   >

         <input type="hidden" name="lead_data"          value="<?print $lead_data;?>"    >
         <input type="hidden" name="lead_hora"          value="<?print $lead_hora;?>"    >
<?
if ($nro_modelo == "BI") {
?>
         <input type="hidden" name="lead_msg" value="<?print $lead_msg;?>">
<?
}
?>
         <input type="hidden" name="mk_origem_atd" value="<?print $mk_origem_atd;?>">
         <input type="hidden" name="mk_origem_atd_direto" value="<?print $mk_origem_atd_direto;?>">
         <input type="hidden" name="mk_ramal_serialize" value='<?print $mk_ramal_serialize;?>'>

		 <?if(substr($mk_ramal["grupo"],0,1) == "B"){ // grupo simulacao sempre que passar no conf e clicar no botao proximo cliente libera o atendimento para o proximo // david 19/02/2018
				$dk_desliga_dac = "S";
		 }?>
        <input type="hidden" name="abriuMkFrameWork" value="<?=$abriuMkFrameWork;?>">
        <input type="hidden" name="im_classe_mkpro" value="<?=$im_classe_mkpro;?>">
         <input type="hidden" name="dk_desliga_dac"    value="<?print $dk_desliga_dac;?>">
         <input type="hidden" name="nro_modelo"        value="<?print $nro_modelo;?>"      >
         <input type="hidden" name="repre_param"       value="<?print $repre_param;?>"      >
         <input type="hidden" name="ramal_atend" value="<?print $ramal_atend;?>">
         <input type="hidden" name="omni_tipo_atend" value="<?= $GLOBALS['omni_tipo_atend'];?>">
         <input type="hidden" name="omni_grupo_atend" value="<?= $GLOBALS['omni_grupo_atend'];?>">
         <input type="hidden" name="tipo_abertura"     value="<?print $tipo_abertura;?>"   >
         <input type="hidden" name="nivel_atual"       value="<?print $nivel_atual;?>"     >
         <input type="hidden" name="form_volta_outro"  value="<?print $form_volta_outro;?>">
         <input type="hidden" name="trs_do_conf"       value="<?print $trs_do_conf;?>"     >
         <input type="hidden" name="id_receptivo"       value="<?print $id_receptivo;?>"   >

         <input type="hidden" name="dk_campanha"       value="<?print $dk_campanha;?>"    >
         <input type="hidden" name="dk_campo_chave"    value="<?print $dk_campo_chave;?>" >

         <input type="hidden" name="msg_ok"         value="<?print $msg_ok;?>">
         <input type="hidden" name="msg_docs"       value="<?print $msg_docs;?>">
         <input type="hidden" name="msg_erro"       value="<?print $msg_erro;?>">

         <input type="hidden" name="atv_nome_razao"      value="<?print htmlspecialchars($nome_razao_temp, ENT_QUOTES, 'UTF-8');?>">
         <input type="hidden" name="nome_razao"      value="<?print htmlspecialchars($nome_razao, ENT_QUOTES, 'UTF-8');?>">
         <input type="hidden" name="atv_cpf_cnpj"        value="<?print $cpf_cnpj_temp;?>">
         <input type="hidden" name="atv_email"        value="<?print $atv_email;?>">
         <input type="hidden" name="atv_campanha"        value="<?print $atv_campanha;?>">
         <input type="hidden" name="atv_st_venda_cartao" value="<?print $atv_st_venda_cartao;?>">
         <input type="hidden" name="tipo_modelo"         value="<?print $tipo_modelo;?>">
         <input type="hidden" name="tipo"                value="<?print $tipo;?>">
          <?
          if($matriz_ins["n_pedido"]){
          	$n_pedido = $matriz_ins["n_pedido"];
          }
          if (empty($campo_chave) === true) {
          	$campo_chave = $atv_campo_chave;
          }
         ?>
         <input type='hidden' name='campo_chave' value='<?print $campo_chave?>'>
         <input type='hidden' name='atv_campo_chave' value='<?print $atv_campo_chave?>'>
         <input type="hidden" name="n_pedido"        value="<?print $n_pedido?>">
<?
if (($isUraGeraProtocolo === true || (preg_match("/^B[IT]$/", $nro_modelo) == 1)) && ($isRegAtd === true)) {
?>
        <input type="hidden" name="n_pedido_origem" id="n_pedido_origem" value="<?= $n_pedido_origem;?>">
<?
}
?>
         <input type="hidden" name="frm_pagto"       value="<?print $matriz_ins["frm_pagto"]?>">

         <input type='hidden' name='campo_passa1' value='<?print $campo_passa1?>'>
         <input type='hidden' name='campo_passa2' value='<?print $campo_passa2?>'>
         <input type='hidden' name='campo_passa3' value='<?print $campo_passa3?>'>
<?
if (!$num_prop) {
	$num_prop = $idFazInsert;
}

if (empty($info_script_motivo) === false) {
?>
         <input type="hidden" name="info_script_motivo" value="<?print base64_encode(urlencode($info_script_motivo));?>">
<?
}
if (empty($info_script_motivo_cliente) === false) {
?>
         <input type="hidden" name="info_script_motivo_cliente" value="<?print base64_encode(urlencode($info_script_motivo_cliente));?>">
<?
}
if (empty($itens_ativ_tipo_anexo) === false) {
?>
          <input type="hidden" name="itens_ativ_tipo_anexo" value="<?print $itens_ativ_tipo_anexo;?>">
<?
}
if (empty($ativ_data_vecto) === false) {
?>
          <input type="hidden" name="ativ_data_vecto" value="<?print $ativ_data_vecto;?>">
<?
}
?>
         <input type='hidden' name='flw_ativ_num' value='<?print $flw_id_ativ?>'>
         <input type='hidden' name='flw_tema_pai' value='<?print $flw_tema_pai?>'>
         <input type='hidden' name='flw_tema' value='<?print $flw_tema?>'>
         <input type='hidden' name='flw_descricao' value='<?print $flw_descricao?>'>
         <input type='hidden' name='atd_ativ_num' value='<?print $atd_ativ_num?>'>

         <input type="hidden" name="ativ_tempo_max_exec" value="<?print $ativ_tempo_max_exec;?>">

         <input type='hidden' name='num_prop' value='<?print $num_prop?>'>
         <input type='hidden' name='dia_ini' value='<?print $dia_ini?>'>
         <input type='hidden' name='mes_ini' value='<?print $mes_ini?>'>
         <input type='hidden' name='ano_ini' value='<?print $ano_ini?>'>
         <input type='hidden' name='dia_fim' value='<?print $dia_fim?>'>
         <input type='hidden' name='mes_fim' value='<?print $mes_fim?>'>
         <input type='hidden' name='ano_fim' value='<?print $ano_fim?>'>

         <?if($campo_extra_tipo_rotina == "N"){?>

         <?}else{?>
           <input type='hidden' name='cmp_extra_1' value='<?print $cmp_extra_1?>'>
           <input type='hidden' name='cmp_extra_2' value='<?print $cmp_extra_2?>'>
           <input type='hidden' name='cmp_extra_3' value='<?print $cmp_extra_3?>'>
           <input type='hidden' name='cmp_extra_4' value='<?print $cmp_extra_4?>'>
           <input type='hidden' name='cmp_extra_5' value='<?print $cmp_extra_5?>'>
           <input type='hidden' name='cmp_extra_6' value='<?print $cmp_extra_6?>'>
           <input type='hidden' name='cmp_extra_7' value='<?print $cmp_extra_7?>'>
           <input type='hidden' name='cmp_extra_8' value='<?print $cmp_extra_8?>'>
           <input type='hidden' name='cmp_extra_9' value='<?print $cmp_extra_9?>'>
           <input type='hidden' name='cmp_extra_10' value='<?print $cmp_extra_10?>'>
           <input type='hidden' name='cmp_extra_11' value='<?print $cmp_extra_11?>'>
           <input type='hidden' name='cmp_extra_12' value='<?print $cmp_extra_12?>'>
           <input type='hidden' name='cmp_extra_13' value='<?print $cmp_extra_13?>'>
         <?}?>

<input type="hidden" name="titulo_passa"            id="titulo_passa"           value="<?print $titulo_passa;?>">

        <?//******************************CASO O MD SEJA CHAMADO POR OUTRO MD.. UTLIZA PARA GRAVAR A ORIGEM DA CHAMADA//*****************************?>
        <?if($sistema_origem){?>
          <input type="hidden" name="sistema_origem"              id="sistema_origem"             value="<?print $sistema_origem;?>">
          <input type="hidden" name="sistema_origem_empresa"      id="sistema_origem_empresa"     value="<?print $sistema_origem_empresa;?>">
          <input type="hidden" name="sistema_origem_n_pedido"     id="sistema_origem_n_pedido"    value="<?print $sistema_origem_n_pedido;?>">

					<input type="hidden" name="sistema_origem_campanha"            id="sistema_origem_campanha"           value="<?print $sistema_origem_campanha;?>">
					<input type="hidden" name="sistema_origem_classe_campanha"     id="sistema_origem_classe_campanha"    value="<?print $sistema_origem_classe_campanha;?>">
					<input type="hidden" name="sistema_origem_dados_passa"         id="sistema_origem_dados_passa"        value="<?print $sistema_origem_dados_passa;?>">

          <input type="hidden" name="sistema_origem_nome_razao"   id="sistema_origem_nome_razao"     value="<?print htmlspecialchars($sistema_origem_nome_razao, ENT_QUOTES, 'UTF-8');?>">
          <input type="hidden" name="sistema_origem_cpf_cnpj"     id="sistema_origem_cpf_cnpj"    value="<?print $sistema_origem_cpf_cnpj;?>">
        <?}?>


         <?if(!$campo_clique_cliente_passa)      {$campo_clique_cliente_passa       = $campo_clique_cliente;}?>
         <?if(!$campo_campo_clique_cliente_passa){$campo_campo_clique_cliente_passa = $campo_campo_clique_cliente;}


         if (empty($campo_campo_clique_cliente_passa) === true && empty($cpf_cnpj) === false) {
         	$campo_campo_clique_cliente_passa = "cpf_cnpj";
         	$campo_clique_cliente_passa       = $cpf_cnpj;
         }

         ?>
         <input type='hidden' name='campo_clique_cliente'       value='<?print $campo_clique_cliente_passa?>'>
         <input type='hidden' name='campo_campo_clique_cliente' value='<?print $campo_campo_clique_cliente_passa?>'>
         <input type='hidden' name='ano_fim' value='<?print $ano_fim?>'>
         <input type="hidden" name="envia_prop_janela" value="<?print $envia_prop_janela;?>">
         <input type="hidden" name="deonde_sitema_cartao" value="<?print $deonde_sitema_cartao;?>">
      <?
      if (is_array($_POST["arr_campos_volta"]) === true) {
      	foreach ($_POST["arr_campos_volta"] as $indice_arr_campos_volta => $valor_arr_campos_volta) {
      		if (is_array($valor_arr_campos_volta) === false) {
          ?>
            <input type="hidden" name="arr_campos_volta[<?print $indice_arr_campos_volta;?>]" value="<?print htmlspecialchars($valor_arr_campos_volta, ENT_QUOTES, 'UTF-8');?>">
          <?
      		} else {
      			foreach ($valor_arr_campos_volta as $campo1 => $valor1) {
      				if (is_array($valor1) === false) {
            ?>
              <input type="hidden" name="arr_campos_volta[<?print $indice_arr_campos_volta;?>][<?print $campo1;?>]" value="<?print htmlspecialchars($valor1, ENT_QUOTES, 'UTF-8');?>">
            <?
      				}else{
      					foreach ($valor1 as $campo2 => $valor2) {
      						if (is_array($valor2) === false) {
                  ?>
                    <input type="hidden" name="arr_campos_volta[<?print $indice_arr_campos_volta;?>][<?print $campo1;?>][<?print $campo2;?>]" value="<?print htmlspecialchars($valor2, ENT_QUOTES, 'UTF-8');?>">
                  <?
      						}else{
      							//nao gera hidden
      						}

      					}
      				}
      			}
      		}

      ?>
      <?
      	}
      }
      /*<input type="button" value="enviar" onClick="document.envia_bd.submit();">*/

      if (empty($mk_msg_alerta) === false) {
?>
        <input type="hidden" name="mk_msg_alerta" id="mk_msg_alerta" value="<?print htmlspecialchars($mk_msg_alerta, ENT_QUOTES, 'UTF-8');?>">
<?
      }

      if ((empty($botao_finaliza_cliente) === false) && (substr($botao_finaliza_cliente, 0, 1) == "A")) {
      	require_once($_SERVER['DOCUMENT_ROOT']."/libs/func/RegAtd.php");

      	print getRegAtdCampos();
      }
?>
      </form>
      <?

		/**
		 * Subir 27/08/18
		 * Nova rotina para gravação de histórico/jornada
		 * Qualquer dúvida, favor falar com Rodrigo Lemos
		 */
		if ( $utiliza_historico_atendimento == "S" ) {

			if ( $tipo_modelo == 'FOLLOWUP' ) {

				/**
				 * CAC - 200817 (CAOA)
				 * Grava histórico caso atendimento não seja improdutivo
				 */
				if ($filtro_tema_pai != 'ST') {

					/**
					 * Campos para consulta da atividade
					 */
					$arrhist['tb_atividade'] = $tabela_proposta;
					$arrhist['mk_numero']    = substr($classe_mkpro, 2, 2);
					$arrhist['ativ_num'] 	 = $flw_id_ativ;

					require_once($_SERVER["DOCUMENT_ROOT"]."/callcenter/funcoes/HistAtendPadrao.php");
					$objhist = new HistAtendPadrao($repre);
					$objhist->gravaAtendimento('FOLLOWUP', $arrhist);

					if ($objhist->statusexec !== true) {
						echo $objhist->msgexec;
						exit;
					}

				}

			}

		}

      if ($session["operador"] == "expoes002" || $session["operador"] == "opetecaci" || $session["operador"] == "interfileb0001" || $session["operador"] == "opepmo" || ($session["operador"] != "tfdavid" && $nro_modelo != "BF" && ($sistema_identificacao == "teste" || $session["operador"] == "tfarthur" || strtoupper($session["operador"])=="tfarthur" || $session["print_sql"] == "S"))) {
      	print "<input type='button' value='Esse botão só aparece no teste ou com print_sql = S clique para continuar' onclick=\" document.envia_bd.submit();\" >";
      	if ($session["print_sql"] == "S") {
      		print "<li>APARECE SOMENTE COM PRINT_SQL";
      		print "<li>**************GLOBALS****************<br><pre>";
      		print_r($GLOBALS);
      	}
      	$_SESSION["ssitgl_voltou_mk_".$nro_modelo] = true;
      } else {
      	$_SESSION["ssitgl_voltou_mk_".$nro_modelo] = true;
      	print "<script language='javascript'>document.envia_bd.submit();</script>";
      }
?>
  </body>
  </html>
<?
}

// if($flw_id_ativ && $_SESSION["session"]["operador"] == "bmgag0010"){
// 	//Rotina que alimenta os campos de data e hora do expediente
// 	require_once($_SERVER["DOCUMENT_ROOT"]. "/libs/func/FollowRec.php");
// 	$flwRec = new FollowRec($repre_vendedor, $nro_modelo);
// 	$flwRec->gravaDataExpedienteFlwEvento($flw_id_ativ);
// 	exit;
// }


?>